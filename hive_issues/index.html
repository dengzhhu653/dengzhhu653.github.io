<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Zhihua Deng"><meta name="description" content="&amp;#x6743;&amp;#x9650;&amp;#x95EE;&amp;#x9898;&amp;#x5176;&amp;#x5B9E;&amp;#x4E0D;&amp;#x80FD;&amp;#x5C06;&amp;#x6211;&amp;#x6240;&amp;#x9047;&amp;#x5230;&amp;#x7684;&amp;#x573A;&amp;#x666F;&amp;#x5B9"><meta name="keywords" content=""><title>Hive一些问题总结 · null</title><link rel="icon" href="../favicon.ico"><link rel="canonical" href="https://dengzhhu653.github.io/hive_issues/"><link rel="alternate" href="../atom.xml" title="null"><link rel="stylesheet" href="../fonts/iconfont/iconfont.css"><link rel="stylesheet" href="../css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?Your baidu Analytics ID";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'Your Google Analytics ID', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="../." class="logo"></a><ul class="nav"><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/about/" target="_self">À propos</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">Hive一些问题总结</h1><span class="post-time">Oct 24, 2017</span><div id="sidebar" class="post-sidebar"><h3 class="heading">Sommaire</h3><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-text">权限问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-text">内存问题</span></a></li></ol></div><div class="post-content"><p>   </p><h3>&#x6743;&#x9650;&#x95EE;&#x9898;</h3><br>   &#x5176;&#x5B9E;&#x4E0D;&#x80FD;&#x5C06;&#x6211;&#x6240;&#x9047;&#x5230;&#x7684;&#x573A;&#x666F;&#x5B9A;&#x4E49;&#x6210;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x3002;&#x51C6;&#x786E;&#x6765;&#x8BF4;&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x968F;&#x7740;&#x4E1A;&#x52A1;&#x53D1;&#x5C55;&#x548C;&#x94FA;&#x5F00;&#x5E26;&#x6765;&#x7684;&#x4E00;&#x79CD;&#x9700;&#x6C42;&#xFF0C;&#x6211;&#x4EEC;&#x60F3;&#x5EFA;&#x8BBE;&#x4E00;&#x4E2A;&#x901A;&#x7528;&#x7684;&#x6570;&#x636E;&#x4ED3;&#x5E93;&#x5E73;&#x53F0;&#xFF0C;&#x4F9B;&#x6570;&#x636E;&#x5206;&#x6790;&#x4EBA;&#x5458;&#x8FDB;&#x884C;&#x6570;&#x636E;ETL&#x7C7B;&#x4F3C;&#x7684;&#x5DE5;&#x4F5C;&#x3002;&#x8FD9;&#x5C31;&#x6D89;&#x53CA;&#x5230;&#x4E00;&#x4E2A;&#x6743;&#x9650;&#x7684;&#x95EE;&#x9898;&#xFF0C; &#x5728;&#x4F20;&#x7EDF;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#xFF0C;&#x8D85;&#x7EA7;&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x5BF9;&#x666E;&#x901A;&#x7528;&#x6237;&#x505A;&#x4E00;&#x4E9B;&#x7CBE;&#x7EC6;&#x5316;&#x7684;&#x6743;&#x9650;&#x7BA1;&#x7406;&#xFF0C;&#x5982;&#x8D4B;&#x4E88;&#x67D0;&#x4E2A;&#x7528;&#x6237;&#x67D0;&#x4E2A;&#x5E93;&#x8868;&#x7684;&#x67D0;&#x79CD;&#x6743;&#x9650;(&#x589E;&#x5220;&#x6539;&#x67E5;)&#xFF1B; &#x4ED6;&#x4EEC;&#x671F;&#x671B;&#xFF0C;&#x5229;&#x7528;Hive&#x4E5F;&#x80FD;&#x8FBE;&#x5230;&#x8FD9;&#x6837;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x7684;&#x80CC;&#x666F;&#x3002;<p></p>
<p>  &#x6709;&#x5173;hive&#x4EE5;&#x53CA;Hadoop&#x6743;&#x9650;&#x63A7;&#x5236;&#x6587;&#x7AE0;&#xFF0C;&#x53EF;&#x770B;&#x8FD9;&#x91CC;&#xFF1A;<br>  <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Authorization#LanguageManualAuthorization-3DefaultHiveAuthorization(LegacyMode" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Authorization#LanguageManualAuthorization-3DefaultHiveAuthorization(LegacyMode</a>)<br><a href="http://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html" target="_blank" rel="external">http://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html</a></p>
<p>  &#x4ECE;&#x6587;&#x7AE0;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x4E86;&#x89E3;&#x5230;, &#x53EF;&#x4EE5;&#x5728;metastore&#x5C42;&#x9762;&#x4E0A;&#x542F;&#x7528;<em>storage based authorization</em>, &#x4EE5;&#x53CA;&#x540C;&#x65F6;&#x5728;hiveserver2&#x4E0A;&#x5F00;&#x542F;<em>SQL standards based authorization</em>, &#x5373;&#x53EF;&#x6EE1;&#x8DB3;BI&#x7528;&#x6237;&#x90E8;&#x95E8;&#x7684;&#x9700;&#x6C42;&#x3002;</p>
<p>  &#x901A;&#x8FC7;<a href="https://cwiki.apache.org/confluence/display/Hive/SQL+Standard+Based+Hive+Authorization" target="_blank" rel="external">&#x5982;&#x4F55;&#x5F00;&#x542F;SQL standards based authorization</a>&#xFF0C; &#x6211;&#x4EEC;&#x7684;metastore&#x5DF2;&#x7ECF;&#x5F00;&#x542F;&#x4E86;<em>storage based authorization</em>&#xFF0C;&#x4E14;&#x670D;&#x52A1;&#x4E8E;&#x81F3;&#x5C11;3&#x4E2A;&#x4E0D;&#x540C;&#x7684;&#x4E1A;&#x52A1;&#x7EBF;. &#x6309;&#x7167;&#x8981;&#x6C42;&#x914D;&#x7F6E;&#x597D;hiveserver2&#xFF0C; &#x867D;&#x7136;&#x80FD;&#x591F;&#x6B63;&#x5E38;&#x542F;&#x52A8;&#xFF0C;&#x4F46;&#x5F53;&#x5728;beeline&#x6267;&#x884C; <em>set role admin;</em>&#x65F6;&#xFF0C; &#x8FD8;&#x662F;&#x4F1A;&#x63D0;&#x793A;&#x4E00;&#x4E9B;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#xFF0C;&#x663E;&#x793A;&#x6211;&#x4EEC;&#x7F3A;&#x4E4F;&#x4E00;&#x4E9B;&#x6743;&#x9650;&#x4FE1;&#x606F;&#x7684;&#x5B9A;&#x4E49;&#x3002;<em>SQL standards based authorization</em>&#x4FE1;&#x606F;&#x4F1A;&#x5B58;&#x5728;&#x54EA;&#x91CC;&#xFF0C;&#x5BF9;hiveserver2&#x7684;&#x4E86;&#x89E3;&#xFF0C;&#x5176;&#x5E76;&#x6CA1;&#x6709;&#x76F8;&#x5173;&#x6570;&#x636E;&#x5E93;&#x7684;&#x914D;&#x7F6E;&#x548C;&#x5B9A;&#x4E49;&#xFF0C;&#x4F1A;&#x4E0D;&#x4F1A;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x4E5F;&#x88AB;&#x5F53;&#x6210;&#x5143;&#x6570;&#x636E;&#x4FDD;&#x5B58;&#x5728;&#x4E0E;metastore&#x914D;&#x7F6E;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#xFF0C;&#x8FDE;&#x63A5;&#x4E0A;&#x8BE5;&#x5E93;&#xFF0C;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x5E93;&#xFF0C;&#x5728;<em>show tables</em>&#x7684;&#x547D;&#x4EE4;&#x4E0B;&#xFF0C;&#x53EF;&#x4EE5;&#x89C1;&#x5230;&#x4E0B;&#x9762;&#x8FD9;&#x4E9B;&#x8868;&#xFF1A;<br>  <pre><br>  +&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;+<br>| Tables_in_hadoop          |<br>+&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;+                |<br>| GLOBAL_PRIVS              |<br>| IDXS                      |<br>| INDEX_PARAMS              |<br>| NOTIFICATION_SEQUENCE     |<br>| PARTITIONS                |<br>| PARTITION_KEYS            |<br>| PARTITION_KEY_VALS        |<br>| PARTITION_PARAMS          |<br>| PART_COL_PRIVS            |<br>| PART_COL_STATS            |<br>| PART_PRIVS                |<br>| ROLES                     |<br>| ROLE_MAP                  |          |<br>| TABLE_PARAMS              |<br>| TAB_COL_STATS             |<br>| TBLS                      |<br>| TBL_COL_PRIVS             |<br>| TBL_PRIVS                 |<br>| VERSION                   |<br>+&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;+<br>X rows in set (0.00 sec)<br>  </pre><br> &#x5728;&#x8FD9;&#x4E9B;&#x8868;&#x4E2D;&#xFF0C;&#x5F88;&#x5BB9;&#x6613;&#x5C31;&#x53D1;&#x73B0;&#x4E86;<em>ROLES</em>&#x4EE5;&#x53CA;&#x548C; <em>ROLE\</em>_MAP_ &#x8FD9;&#x4E24;&#x5F20;&#x8868;&#xFF0C; &#x5728; <em>ROLE\</em>_MAP_ &#x4E2D;&#x624B;&#x52A8;&#x63D2;&#x5165;&#x4E00;&#x6761;&#x6570;&#x636E;&#xFF1A;</p>
<pre>
|            13 | 1481712838 |            0 | bi      | USER         | xxxx    | USER           |       1 |
</pre>

<p>&#x5F53;&#x518D;&#x6B21;&#x5728;beeline&#x6267;&#x884C;<em>set role admin;</em>&#x65F6;&#xFF0C;&#x547D;&#x4EE4;&#x6210;&#x529F;&#xFF0C;&#x6267;&#x884C;&#x4E00;&#x4E9B;grant select&#x8BED;&#x53E5;&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x4E00;&#x4E9B;&#x6548;&#x679C;&#x3002;</p>
<p>&#x5728;1.2.1&#x7248;&#x672C;&#x7684;hiveserver2&#x4E2D;&#xFF0C; &#x5FC5;&#x987B;&#x5728;&#x542F;&#x52A8;&#x547D;&#x4EE4;&#x4E2D;&#x52A0;&#x5165;(&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x5728;&#x914D;&#x7F6E;&#x91CC;&#x52A0;&#xFF0C;&#x539F;&#x56E0;&#x662F;&#x5176;&#x5B83;&#x7528;&#x6237;&#x4F7F;&#x7528;hive cli&#x547D;&#x4EE4;&#x65F6;&#xFF0C;&#x4F1A;&#x7531;&#x4E8E;&#x8FD9;&#x4E9B;&#x914D;&#x7F6E;&#x51FA;&#x73B0;&#x4E00;&#x4E9B;&#x95EE;&#x9898;&#xFF0C;&#x540E;&#x9762;&#x540E;&#x8BB2;&#x5230;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;)&#x5982;&#xFF1A;</p>
<pre>
hive --service hiveserver2  --hiveconf hive.security.authorization.enabled=true --hiveconf hive.security.authorization.manager=org.apache.hadoop.hive.ql.security.authorization.plugin.sqlstd.SQLStdHiveAuthorizerFactory --hiveconf hive.security.authenticator.manager=org.apache.hadoop.hive.ql.security.SessionStateUserAuthenticator --hiveconf hive.metastore.uris=&apos;&apos;
</pre>
&#x8FD9;&#x6837;&#x624D;&#x4F1A;&#x8BA9;SQL Based Authorization&#x751F;&#x6548;&#x3002;

&#x6309;&#x7167;&#x8FD9;&#x6837;&#x7684;&#x914D;&#x7F6E;&#x542F;&#x52A8;hiveserver2&#x540E;&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x53D1;&#x73B0;&#x539F;&#x6765;&#x53EF;&#x4EE5;&#x5728;hive cli&#x547D;&#x4EE4;&#x4E0B;&#x6267;&#x884C;&#x7684;&#x8BED;&#x53E5;&#x51FA;&#x73B0;&#x4E00;&#x4E9B;&#x7A7A;&#x6307;&#x9488;&#x9519;&#x8BEF;&#xFF0C;&#x4F8B;&#x5982;&#xFF0C;&#x5411;&#x67D0;&#x4E2A;&#x8868;&#x4E2D;&#x589E;&#x52A0;&#x4E00;&#x680F;&#xFF0C;
_alter table hzq add columns(test string)_, &#x6267;&#x884C;&#x8FD9;&#x6837;&#x7684;&#x8BED;&#x53E5;&#x65F6;&#xFF0C;&#x5728;&#x63A7;&#x5236;&#x53F0;&#x4E2D;&#xFF0C;&#x51FA;&#x73B0;&#x8FD9;&#x6837;&#x7684;&#x95EE;&#x9898;&#xFF1A;
FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.DDLTask. null <br>
&#x51FA;&#x73B0;&#x8FD9;&#x6837;&#x95EE;&#x9898;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x662F;&#x56E0;&#x4E3A;&#x5728;hive-site.xml&#x4E2D;&#x914D;&#x7F6E;&#x4E86;&#xFF1A;
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt;</div><div class="line">  &lt;name&gt;hive.security.authenticator.manager&lt;/name&gt;</div><div class="line">  &lt;value&gt;org.apache.hadoop.hive.ql.security.SessionStateUserAuthenticator&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure>


&#x8FD9;&#x6837;&#x7684;&#x5C5E;&#x6027;&#xFF0C;&#x5B83;&#x4ECE;&#x5F53;&#x524D;&#x7684;SessionState&#x4E2D;&#x83B7;&#x5F97;&#x6267;&#x884C;&#x7528;&#x6237;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x800C;&#x5728;hive cli&#x7684;&#x6A21;&#x5F0F;&#x4E0B;&#xFF0C;&#x8FD4;&#x56DE;&#x4E3A;Null&#xFF0C;&#x89E3;&#x51B3;&#x65B9;&#x5F0F;&#x4E5F;&#x8F83;&#x4E3A;&#x7B80;&#x5355;&#xFF0C;&#x5728;&#x542F;&#x52A8;hive &#x65F6;&#xFF0C;&#x52A0;&#x5165;&#x914D;&#x7F6E;:
<pre>
hive --hiveconf hive.security.authenticator.manager=org.apache.hadoop.hive.ql.security.HadoopDefaultAuthenticator</pre>

<p>&#x7136;&#x800C;&#xFF0C;&#x4E8B;&#x60C5;&#x8FD8;&#x672A;&#x7ED3;&#x675F;&#xFF0C;&#x867D;&#x7136;&#x89E3;&#x51B3;&#x4E86;&#x6743;&#x9650;&#x5206;&#x914D;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4F46;&#x5982;&#x4F55;&#x89E3;&#x51B3;&#x7528;&#x6237;&#x8BA4;&#x8BC1;&#x8FD9;&#x4E00;&#x95EE;&#x9898;&#x5462;&#xFF0C;&#x800C;&#x4E14;&#x9700;&#x8981;&#x548C;hue&#x76F8;&#x4E92;&#x7ED3;&#x5408;&#xFF1F; &#x5F53;hiveserver2&#x610F;&#x5916;&#x9000;&#x51FA;&#x65F6;&#xFF0C;&#x8D85;&#x7EA7;&#x7528;&#x6237;&#x8BBE;&#x7F6E;&#x7684;&#x4E00;&#x4E9B;ACL&#x529F;&#x80FD;&#x91CD;&#x542F;&#x65F6;&#x5019;&#x8FD8;&#x4F1A;&#x7EE7;&#x7EED;&#x751F;&#x6548;&#xFF1F; &#x7B54;&#x6848;&#x662F;&#x80AF;&#x5B9A;&#x7684;&#xFF0C;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x4F1A;&#x4FDD;&#x5B58;&#x5728;metastore&#x914D;&#x7F6E;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x3002;</p>
<p>&#x968F;&#x7740;hive beeline&#x7684;&#x4F7F;&#x7528;&#xFF0C;&#x6162;&#x6162;&#x5730;&#x4F1A;&#x53D1;&#x73B0;beeline&#x4F1A;&#x542F;&#x52A8;&#x5F97;&#x8D8A;&#x6765;&#x8D8A;&#x6162;&#x3002;&#x5728;&#x6709;&#x4E9B;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x751A;&#x81F3;&#x629B;&#x51FA;OOM&#x7684;&#x9519;&#x8BEF;&#xFF0C;&#x5373;&#x4F7F;&#x52A0;&#x5927;beeline&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x542F;&#x52A8;beeline&#x4F9D;&#x65E7;&#x53D8;&#x5F97;&#x5F88;&#x6162;&#x3002;&#x5728;&#x8FD9;&#x6837;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6CA1;&#x6709;&#x65E5;&#x5FD7;(&#x5C06;&#x65E5;&#x5FD7;&#x7EA7;&#x522B;&#x8BBE;&#x7F6E;&#x6210;DEBUG&#x4F9D;&#x65E7;)&#x4F7F;&#x5F97;&#x5B9A;&#x4F4D;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x53D8;&#x5F97;&#x56F0;&#x96BE;&#x3002;&#x901A;&#x8FC7;&#x6808;&#x7684;&#x4E00;&#x4E9B;&#x7EAA;&#x5F55;&#x4EE5;&#x53CA;&#x65E5;&#x5FD7;&#x63CF;&#x8FF0;&#xFF0C;&#x5224;&#x65AD;beeline&#x5386;&#x53F2;&#x6570;&#x636E;&#x8FC7;&#x591A;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;&#x7528;&#x6237;&#x76EE;&#x5F55;&#x4E0B;&#x6709;&#x4E2A; <em>.beeline</em> &#x7684;&#x6587;&#x4EF6;&#x5939;&#xFF0C; &#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x5939;&#x627E;&#x5230;&#x4E00;&#x4E2A;history&#x6587;&#x4EF6;(&#x8BB0;&#x5F55;&#x66FE;&#x7ECF;&#x8F93;&#x5165;&#x8FC7;&#x7684;&#x5386;&#x53F2;&#x547D;&#x4EE4;)&#xFF0C;&#x53D1;&#x73B0;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x5F88;&#x5927;&#xFF0C; &#x5C06;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x5220;&#x6389;&#xFF0C; beeline&#x542F;&#x52A8;&#x6062;&#x590D;&#x6B63;&#x5E38;&#x3002;</p>
<p>Hive cli&#x5F00;&#x542F;debug&#x6A21;&#x5F0F;&#xFF1A;<br><strong>hive &#x2013;hiveconf hive.root.logger=DEBUG,console</strong></p>
<p>&#x5728;&#x4E00;&#x4E9B;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5728;&#x540C;&#x4E00;&#x53F0;&#x673A;&#x5668;&#x4E0A;&#x540C;&#x65F6;&#x4F1A;&#x8FD0;&#x884C;&#x7740;beeline, hive cli&#x4EE5;&#x53CA;hiveserver2&#x8FD9;&#x6837;&#x7684;&#x7A0B;&#x5E8F;&#xFF0C;&#x5982;&#x4F55;&#x533A;&#x5206;&#x8FD9;&#x4E9B;&#x65E5;&#x5FD7;&#x662F;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x96BE;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4ED6;&#x4EEC;&#x90FD;&#x540C;&#x4F7F;&#x7528;&#x540C;&#x4E00;&#x4E2A;hive-log4j.properties&#x6587;&#x4EF6;&#xFF0C; &#x5982;&#x679C;&#x5728;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x4E2D;&#x5C06;&#x6587;&#x4EF6;&#x7684;&#x76EE;&#x5F55;&#x548C;&#x6587;&#x4EF6;&#x540D;&#x56FA;&#x5B9A;&#x4E0B;&#x6765;&#xFF0C;&#x5219;&#x9020;&#x6210;&#x65E5;&#x5FD7;&#x76F8;&#x4E92;&#x5F71;&#x54CD;&#x6DF7;&#x4E71;&#x7684;&#x6548;&#x679C;&#x3002;&#x5E78;&#x597D;&#x7684;&#x662F;&#xFF0C;&#x5728;log4j&#x4E0A;&#x53EF;&#x4EE5;&#x914D;&#x7F6E;&#x5C5E;&#x6027;&#x503C;&#x6765;&#x533A;&#x5206;&#x6587;&#x4EF6;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x5982;&#xFF1A;</p>
<pre>
  hive.log.file=${hive.user}.log
</pre>

<p> &#x5728;hive-env.sh&#x4E0A;&#xFF0C;&#x4F7F;&#x7528;&#xFF1A;<br> <pre><br> export HADOOP_OPTS=&#x201D;$HADOOP<em>OPTS -Dhive.user=$SERVICE&#x201D;<br></em></pre><br>log&#x7684;&#x6587;&#x4EF6;&#x540D;&#x65E2;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; $SERVICE_&#x7684;&#x4E0D;&#x540C;&#x800C;&#x4E0D;&#x540C;&#xFF0C; &#x8FD9;&#x4FBF;&#x89E3;&#x51B3;&#x4E86;&#x95EE;&#x9898;&#x3002;</p>
<p>   </p><h3>&#x5185;&#x5B58;&#x95EE;&#x9898;</h3><br>case1 <br><br>   metastore&#x4E2D;&#x63D0;&#x793A;oom&#x7684;&#x9519;&#x8BEF;&#xFF0C;&#x800C;&#x5BFC;&#x81F4;metastore&#x5F02;&#x5E38;&#x9000;&#x51FA;&#xFF0C;<br>   <pre><br>   metastore.RetryingHMSHandler (RetryingHMSHandler.java:invoke(159)) - java.lang.OutOfMemoryError: GC overhead limit exceeded<br>   </pre><br>   &#x5C06; <em>GC overhead limit exceeded</em> &#x8FD9;&#x4E2A;&#x7279;&#x6027;&#x4ECE;JVM&#x542F;&#x52A8;&#x547D;&#x4EE4;&#x4E2D;&#x79FB;&#x9664;&#x540E;&#xFF0C;&#x589E;&#x52A0;JVM&#x5185;&#x5B58;&#xFF0C;&#x8FD0;&#x884C;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x540E;&#xFF0C;metastore&#x7A81;&#x7136;&#x65E0;&#x6CD5;&#x6B63;&#x5E38;&#x54CD;&#x5E94;&#x8BF7;&#x6C42;&#x3002;&#x5728;&#x67E5;&#x770B;metastore&#x7684;GC&#x65E5;&#x5FD7;&#x4E4B;&#x540E;&#xFF0C;&#x53D1;&#x73B0;&#x5982;&#x4E0B;&#x65E5;&#x5FD7;&#x4E0D;&#x505C;&#x7684;&#x5237;&#x5C4F;&#xFF1A;<br>   <pre><br>[Times: user=27.43 sys=0.11, real=1.59 secs]<br>2016-11-24T10:27:31.235+0800: 3951111.303: [CMS-concurrent-sweep-start]<br>2016-11-24T10:27:32.705+0800: 3951112.772: [CMS-concurrent-sweep: 1.469/1.469 secs] [Times: user=1.47 sys=0.00, real=1.47 secs]<br>2016-11-24T10:27:32.705+0800: 3951112.772: [CMS-concurrent-reset-start]<br>2016-11-24T10:27:32.712+0800: 3951112.779: [CMS-concurrent-reset: 0.007/0.007 secs] [Times: user=0.01 sys=0.00, real=0.01 secs]<br>2016-11-24T10:27:34.712+0800: 3951114.780: [GC (CMS Initial Mark) [1 CMS-initial-mark: 2693385K(2796224K)] 3938815K(4054528K), 1.1555810 secs] [Times: user=1.30 sys=0.00, real=1.16 secs]<br>2016-11-24T10:27:35.868+0800: 3951115.935: [CMS-concurrent-mark-start]<br>2016-11-24T10:27:37.319+0800: 3951117.386: [CMS-concurrent-mark: 1.450/1.450 secs] [Times: user=7.26 sys=0.00, real=1.45 secs]<br>2016-11-24T10:27:37.319+0800: 3951117.386: [CMS-concurrent-preclean-start]<br>2016-11-24T10:27:37.327+0800: 3951117.394: [CMS-concurrent-preclean: 0.008/0.008 secs] [Times: user=0.01 sys=0.00, real=0.01 secs]<br>2016-11-24T10:27:37.327+0800: 3951117.394: [CMS-concurrent-abortable-preclean-start]<br>2016-11-24T10:27:37.327+0800: 3951117.394: [CMS-concurrent-abortable-preclean: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]<br>2016-11-24T10:27:37.327+0800: 3951117.394: [CMS-concurrent-abortable-preclean-start]<br>2016-11-24T10:27:37.327+0800: 3951117.394: [CMS-concurrent-abortable-preclean: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]<br>2016-11-24T10:27:37.328+0800: 3951117.395: [GC (CMS Final Remark) [YG occupancy: 1245429 K (1258304 K)]2016-11-24T10:27:37.328+0800: 3951117.395: [GC (CMS Final Remark) 3951117.396: [ParNew: 1245429K-&gt;1245429K(1258304K), 0.0000332 secs] 3938815K-&gt;3938815K(4054528K), 0.0001706 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]<br>   </pre><p></p>
<p>&#x4ECE;GC&#x610F;&#x56FE;&#x6765;&#x7406;&#x89E3;&#xFF0C;&#x610F;&#x5473;&#x7740;metastore cms&#x4E0A;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#x8D85;&#x8FC7;3G&#x4E4B;&#x591A;&#x3002;&#x5BF9;metastore&#x7684;&#x7406;&#x89E3;&#xFF0C;&#x5176;&#x5185;&#x90E8;&#x5B9E;&#x73B0;&#x5E76;&#x6CA1;&#x6709;&#x7279;&#x6B8A;&#x7684;&#x7F13;&#x5B58;&#x6765;&#x7F13;&#x5B58;&#x4E00;&#x4E9B;&#x8868;&#x6570;&#x636E;&#xFF0C;&#x7528;&#x6237;Session&#x6570;&#x636E;&#x4FE1;&#x606F;&#x4E5F;&#x4E0D;&#x4F1A;&#x6709;&#x8FD9;&#x4E48;&#x591A;&#xFF0C;&#x96BE;&#x9053;&#x662F;hive&#x672C;&#x8EAB;&#x7684;BUG&#x5BFC;&#x81F4;&#x7684;&#xFF1F;</p>
<p>&#x5728;dump metastore&#x7684;&#x5806;&#x5185;&#x5B58;&#x540E;&#xFF0C;&#x501F;&#x52A9; <strong>MAT</strong> &#x5DE5;&#x5177;&#x7684;&#x5206;&#x6790;&#xFF0C; &#x95EE;&#x9898;&#x6709;&#x4E86;&#x66F4;&#x52A0;&#x76F4;&#x767D;&#x7684;&#x5C55;&#x73B0;&#xFF0C;&#x5176;&#x4E2D;&#x67D0;&#x4E24;&#x4E2A;&#x7EBF;&#x7A0B;&#x6301;&#x6709;&#x7684;&#x5F15;&#x7528;&#x6570;&#x5927;&#x5C0F;&#x8D85;&#x8FC7;2.7G&#xFF0C; &#x901A;&#x8FC7;&#x8FDB;&#x4E00;&#x6B65;&#x5206;&#x6790;&#x5176;&#x4E2D;&#x67D0;&#x4E2A;&#x7EBF;&#x7A0B;&#x7684;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x95EE;&#x9898;&#x6839;&#x6E90;&#x9010;&#x6E10;&#x6D6E;&#x73B0;&#x3002;</p>
<img src="/hive_issues/stack.png" alt="stack.png" title="">
<p>&#x8FD9;&#x662F;&#x8BF7;&#x6C42;defalut:beacon&#x7684;partitions&#x6570;&#x91CF;(60w)&#x8FC7;&#x591A;&#xFF0C;&#x5BFC;&#x81F4;&#x5185;&#x5B58;&#x4E0D;&#x591F;&#x7528;&#x3002;&#x76F4;&#x63A5;&#x8FDE;&#x4E0A;mysql&#xFF0C; &#x67E5;&#x770B;&#x8FD9;&#x4E2A;&#x8868;&#x7684;partitions&#x6570;&#x91CF;&#xFF0C;&#x53D1;&#x73B0;&#x8FD9;&#x4E2A;&#x8868;&#x6709;70w+&#x7684;partition&#xFF0C;&#x54A8;&#x8BE2;&#x4E00;&#x4E9B;&#x7528;&#x8FD9;&#x8868;&#x7684;&#x4EBA;&#xFF0C;&#x8BF4;&#x8FD9;&#x4E2A;&#x8868;&#x4E2D;&#x5B58;&#x5728;&#x4E00;&#x4E9B;&#x5386;&#x53F2;&#x6570;&#x636E;&#xFF0C;&#x66F4;&#x76F4;&#x89C2;&#x4E00;&#x4E9B;&#xFF1A;<br><br>&#x90A3;&#x4E48;&#xFF0C;&#x662F;&#x4EC0;&#x4E48;&#x6837;&#x7684;sql&#x8BED;&#x53E5;&#x7ADF;&#x7136;&#x4F1A;&#x8BF7;&#x6C42;&#x8FD9;&#x4E48;&#x591A;&#x7684;partitions&#x6570;&#x5462;&#xFF1F;<br>&#x7C7B;&#x4F3C;&#x4E8E; select <em> from beacon limit 10, &#x8FD9;&#x6761;&#x8BED;&#x53E5;&#x662F;&#x80AF;&#x5B9A;&#x7684;&#x4E86;,  &#x6216;&#x8005;<br>select count(</em>) from beacon, &#x8FD8;&#x6709; &#x201C;select app from beacon group by app&#x201D;.</p>
<p>case 2:<br><br>   &#x5728;&#x67D0;&#x4E00;&#x6B21;&#x6BD4;&#x8F83;&#x957F;&#x65F6;&#x95F4;&#x8FD0;&#x884C;metastore&#x4E4B;&#x540E;&#xFF0C;&#x7C7B;&#x4F3C;&#x4E8E;case1&#x7684;&#x73B0;&#x8C61;&#x51FA;&#x73B0;&#x4E86;&#xFF0C;metastore&#x8FDB;&#x7A0B;&#x4E0D;&#x65AD;&#x7684;&#x8FDB;&#x884C;CMS&#xFF0C;&#x5BFC;&#x51FA;&#x5185;&#x5B58;&#x5206;&#x6790;&#x540E;&#xFF0C;&#x53D1;&#x73B0;&#x5728;metastore&#x4E2D;&#xFF0C;<br>  <img src="/hive_issues/heap2.png" alt="heap2.png" title=""><br>JDOPersistenceManagerFactory&#x5BF9;&#x8C61;&#x5360;&#x7528;&#x4E86;&#x7EDD;&#x5927;&#x90E8;&#x5206;&#x5185;&#x5B58;&#xFF0C;&#x7ED3;&#x5408;&#x6E90;&#x7801;&#x4EE5;&#x53CA;&#x5185;&#x5B58;&#x8FDB;&#x4E00;&#x6B65;&#x5206;&#x6790;&#xFF0C;&#x63A8;&#x6D4B;&#x53EF;&#x80FD;&#x7684;&#x539F;&#x56E0;&#x662F;&#x7531;&#x4E8E;JDOPersistenceManagerFactory&#x7684;&#x7F13;&#x5B58;&#x5FD8;&#x8BB0;&#x91CA;&#x653E;&#xFF0C;&#x4E0D;&#x65AD;&#x7684;&#x7D2F;&#x79EF;&#x9020;&#x6210;&#x76EE;&#x524D;&#x5185;&#x5B58;&#x7684;&#x539F;&#x56E0;,&#x9020;&#x6210;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/** The cache of PM&apos;s in use. */</div><div class="line"> private transient Set&lt;JDOPersistenceManager&gt; pmCache = Collections.newSetFromMap(new ConcurrentHashMap());</div></pre></td></tr></table></figure>
<p>&#x8FDB;&#x4E00;&#x6B65;&#x5206;&#x6790;HiveMetastore&#x6E90;&#x7801;&#xFF0C;&#x5F53;&#x9700;&#x8981;&#x4E0E;&#x5E95;&#x5C42;&#x7684;&#x6570;&#x636E;&#x5E93;&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x4F1A;&#x4ECE;ThreadLocal&#x5B9E;&#x4F8B;&#x4E2D;&#x53D6;&#x51FA;PersistenceManager&#xFF0C; &#x5982;&#x679C;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x4E2D;&#x6CA1;&#x6709;&#x8FD9;&#x6837;&#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x90A3;&#x4E48;&#x5979;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;PersistenceManager&#xFF0C;&#x5E76;&#x5C06;&#x8FD9;&#x4E2A;PersistenceManager&#x5B9E;&#x4F8B;&#x7F13;&#x5B58;&#x5230;JDOPersistenceManagerFactory&#x7684;pmCache&#x4E2D;&#x53CA;&#x8BBE;&#x7F6E;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;threadlocal&#x7684;&#x503C;&#xFF0C;&#x91CA;&#x653E;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;PersistenceManager&#x5B9E;&#x4F8B;&#x662F;&#x5728;Client&#x8C03;&#x7528;shutdown&#x65F6;&#xFF0C;&#x7EE7;&#x7EED;&#x67E5;&#x770B;log&#x65E5;&#x5FD7;&#xFF0C;&#x53D1;&#x73B0;&#x622A;&#x81F3;&#x5230;&#x6545;&#x969C;&#x65F6;&#xFF0C;&#x7EA6;&#x6709;2000&#xFF5E;3000&#x4E2A;PersistenceManager&#x5B9E;&#x4F8B;&#x88AB;&#x521B;&#x5EFA;&#xFF0C;&#x8FD9;&#x5E94;&#x662F;&#x4E00;&#x4E2A;Hive&#x672C;&#x8EAB;&#x7684;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x901A;&#x8FC7;&#x67E5;&#x770B;jira&#xFF0C;&#x53D1;&#x73B0;&#x5DF2;&#x7ECF;&#x6709;&#x4EBA;&#x63D0;&#x8FC7;&#x7C7B;&#x4F3C;&#x7684;issue,<a href="https://issues.apache.org/jira/browse/HIVE-14187" target="_blank" rel="external">Hive-14187</a>, &#x5F53;&#x7528;&#x6237;&#x5E76;&#x672A;&#x6309;&#x7167;&#x6B63;&#x786E;&#x7684;&#x65B9;&#x5F0F;(exit;)&#x9000;&#x51FA;&#x67E5;&#x8BE2;&#x65F6;&#xFF0C;&#x5C31;&#x4E0D;&#x4F1A;&#x8C03;&#x7528;shutdown&#x65B9;&#x6CD5;&#xFF0C;&#x65E5;&#x79EF;&#x6708;&#x7D2F;&#xFF0C;&#x5BFC;&#x81F4;&#x5185;&#x5B58;&#x88AB;&#x6324;&#x7206;&#xFF0C; &#x51FA;&#x73B0;&#x4E0A;&#x8FF0;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;case1, &#x901A;&#x8FC7;&#x4E00;&#x4E9B;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E86;&#x89E3;&#x5230;&#xFF0C; &#x53EF;&#x4EE5;&#x901A;&#x8FC7;hive.limit.query.max.table.partition&#x8FD9;&#x4E2A;&#x5C5E;&#x6027;&#x6765;&#x9650;&#x5236;partition&#x6570;&#x91CF;(&#x8FD9;&#x4E2A;&#x53EA;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x751F;&#x6548;), &#x8FD9;&#x4E2A;&#x662F;&#x6CA1;&#x6709;&#x6548;&#x679C;&#x7684;. &#x5728;hive2.2.0&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <em>hive.metastore.limit.partition.request</em> &#x6765;&#x8FDB;&#x884C;&#x8BBE;&#x7F6E;&#xFF0C; &#x5728;&#x5F53;&#x524D;&#x7248;&#x672C;&#x4E2D;&#x5F15;&#x5165;issue&#xFF1A;HIVE-13884,&#x5148;&#x7ECF;&#x8FC7;&#x5224;&#x65AD;&#x8BF7;&#x6C42;&#x7684;partition&#x603B;&#x6570;&#x91CF;&#x4E4B;&#x540E;&#xFF0C;&#x518D;&#x786E;&#x5B9A;&#x662F;&#x5426;&#x7EE7;&#x7EED;&#x5B9E;&#x4F8B;&#x5316;&#x8FD9;&#x4E9B;partitions&#x3002;</p>
<p>&#x5728;&#x521B;&#x5EFA;hive&#x5E93;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x53D1;&#x73B0;&#x8FD9;&#x6837;&#x7684;&#x4E00;&#x6761;&#x8BED;&#x53E5;&#xFF1A;<br> <strong>hive  -e &#x2018;create database if not exists fqz;create database if not exists xyfx;&#x2019;</strong><br>&#x53D1;&#x751F;&#x5982;&#x4E0B;&#x5F02;&#x5E38;&#xFF1A;</p>
<pre>
Exception in thread &quot;main&quot; java.lang.RuntimeException: java.lang.RuntimeException: java.io.IOException: Permission denied
    at org.apache.hadoop.hive.ql.session.SessionState.start(SessionState.java:522)
    at org.apache.hadoop.hive.cli.CliDriver.run(CliDriver.java:677)
    at org.apache.hadoop.hive.cli.CliDriver.main(CliDriver.java:621)
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:497)
    at org.apache.hadoop.util.RunJar.run(RunJar.java:221)
    at org.apache.hadoop.util.RunJar.main(RunJar.java:136)
Caused by: java.lang.RuntimeException: java.io.IOException: Permission denied
    at org.apache.hadoop.hive.ql.session.SessionState.start(SessionState.java:515)
    ... 8 more
Caused by: java.io.IOException: Permission denied
    at java.io.UnixFileSystem.createFileExclusively(Native Method)
    at java.io.File.createTempFile(File.java:2024)
    at org.apache.hadoop.hive.ql.session.SessionState.createTempFile(SessionState.java:818)
    at org.apache.hadoop.hive.ql.session.SessionState.start(SessionState.java:513)
    ... 8 more
</pre>

<p>&#x901A;&#x8FC7;&#x9605;&#x8BFB;&#x6E90;&#x7801;&#x53D1;&#x73B0;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#xFF1A;<br>  <strong>hive -hiveconf hive.exec.local.scratchdir=/tmp/hive -e &#x2018;create database if not exists fqz;create database if not exists xyfx;&#x2019;</strong><br>&#x89E3;&#x51B3;&#x8BE5;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x540C;&#x65F6;&#xFF0C;&#x901A;&#x8FC7;hive -e&#x8FD9;&#x6837;&#x7684;&#x547D;&#x4EE4;&#x65F6;&#xFF0C; sql&#x8BED;&#x53E5;&#x5FC5;&#x987B;&#x7528;&#x5F15;&#x53F7;&#x5F15;&#x8D77;&#x6765;&#xFF0C; &#x800C;&#x5BF9;&#x4E8E; hive -f&#x8FD9;&#x6837;&#x7684;&#x547D;&#x4EE4;&#xFF0C; &#x5199;&#x5728;&#x6587;&#x4EF6;&#x4E2D;&#x7684;sql&#x8BED;&#x53E5;&#x4E0D;&#x8981;&#x7528;&#x5F15;&#x53F7;&#x6765;&#x533A;&#x5206;&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x7EC6;&#x5FAE;&#x7684;&#x5DEE;&#x8DDD;&#xFF0C;&#x6CE8;&#x610F;&#x4E00;&#x4E0B;&#x3002;</p>
</div></article><div class="tags"></div><div class="paginator"><a href="../GC/" class="prev"><i class="iconfont icon-left"></i><span> Précédent</span></a><a href="../log_repeat_2/" class="next"><span>Suivant</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div id="disqus_thread"></div></section><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://dengzhhu653.github.io/hive_issues/';
    this.page.identifier = 'hive_issues/';
    this.page.title = 'Hive一些问题总结';
};
(function() {
var d = document, s = d.createElement('script');

s.src = '//dengzhhu653.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();</script></section><footer><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2018<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Zhihua Deng</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>