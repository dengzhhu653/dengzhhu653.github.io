<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Zhihua Deng"><meta name="description" content="衣带渐宽终不悔"><title></title><link rel="icon" href="/favicon.ico"><link rel="canonical" href="https://dengzhhu653.github.io/"><link rel="alternate" href="atom.xml" title="null"><link rel="stylesheet" href="fonts/iconfont/iconfont.css"><link rel="stylesheet" href="css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?Your baidu Analytics ID";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'Your Google Analytics ID', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="." class="logo"></a><ul class="nav"><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><ul class="home"><li class="post-item"><article class="post"><h2 class="post-title"><a href="update_jar/" class="post-link">Jar Update</a></h2><span class="post-time">Nov 13, 2017</span><div class="post-content"><h2 id="&#x66F4;&#x65B0;jar&#x4E4B;&#x540E;&#x2026;"><a href="#&#x66F4;&#x65B0;jar&#x4E4B;&#x540E;&#x2026;" class="headerlink" title="&#x66F4;&#x65B0;jar&#x4E4B;&#x540E;&#x2026;"></a>&#x66F4;&#x65B0;jar&#x4E4B;&#x540E;&#x2026;</h2><p>&#x95EE;&#x9898;&#x4ECE;&#x4E00;&#x4E2A;&#x5F02;&#x5E38;&#x8BF4;&#x8D77;&#xFF1A;</p>
<pre>

org.apache.hadoop.hbase.client.RetriesExhaustedWithDetailsException: Failed 66 actions: org.apache.hadoop.hbase.DoNotRetryIOException: java.lang.NoClassDefFoundError: org/apache/hadoop/hbase/regionserver/ServerNonceManager$NonceKey

&#x200B;    at org.apache.hadoop.hbase.ipc.RpcServer.call(RpcServer.java:2159)

&#x200B;    at org.apache.hadoop.hbase.ipc.CallRunner.run(CallRunner.java:101)

&#x200B;    at org.apache.hadoop.hbase.ipc.RpcExecutor.consumerLoop(RpcExecutor.java:130)

&#x200B;    at org.apache.hadoop.hbase.ipc.RpcExecutor$1.run(RpcExecutor.java:107)

&#x200B;    at java.lang.Thread.run(Thread.java:745)

Caused by: java.lang.NoClassDefFoundError: org/apache/hadoop/hbase/regionserver/ServerNonceManager$NonceKey

&#x200B;    at org.apache.hadoop.hbase.regionserver.ServerNonceManager.startOperation(ServerNonceManager.java:175)

&#x200B;    at org.apache.hadoop.hbase.regionserver.RSRpcServices.startNonceOperation(RSRpcServices.java:330)

&#x200B;    at org.apache.hadoop.hbase.regionserver.RSRpcServices.increment(RSRpcServices.java:535)

&#x200B;    at org.apache.hadoop.hbase.regionserver.RSRpcServices.doNonAtomicRegionMutation(RSRpcServices.java:608)

&#x200B;    at org.apache.hadoop.hbase.regionserver.RSRpcServices.multi(RSRpcServices.java:2031)

&#x200B;    at org.apache.hadoop.hbase.protobuf.generated.ClientProtos$ClientService$2.callBlockingMethod(ClientProtos.java:32213)

&#x200B;    at org.apache.hadoop.hbase.ipc.RpcServer.call(RpcServer.java:2120)

&#x200B;    ... 4 more

: 66 times,

&#x200B;    at org.apache.hadoop.hbase.client.AsyncProcess$BatchErrors.makeException(AsyncProcess.java:192) ~[hbase-client-0.98.4-hadoop2.jar:0.98.4-hadoop2]

&#x200B;    at org.apache.hadoop.hbase.client.AsyncProcess$BatchErrors.access$500(AsyncProcess.java:176) ~[hbase-client-0.98.4-hadoop2.jar:0.98.4-hadoop2]

&#x200B;    at org.apache.hadoop.hbase.client.AsyncProcess.getErrors(AsyncProcess.java:913) ~[hbase-client-0.98.4-hadoop2.jar:0.98.4-hadoop2]

&#x200B;    at org.apache.hadoop.hbase.client.HConnectionManager$HConnectionImplementation.processBatchCallback(HConnectionManager.java:2359) ~[hbase-client-0.98.4-hadoop2.jar:0.98.4-hadoop2]

&#x200B;    at org.apache.hadoop.hbase.client.HTable.batchCallback(HTable.java:835) ~[hbase-client-0.98.4-hadoop2.jar:0.98.4-hadoop2]

&#x200B;    at org.apache.hadoop.hbase.client.HTable.batch(HTable.java:814) ~[hbase-client-0.98.4-hadoop2.jar:0.98.4-hadoop2]

...

</pre>

<p>&#x200B;       &#x5F53;&#x770B;&#x5230;&#x8FD9;&#x4E2A;&#x5F02;&#x5E38;&#x65F6;&#xFF0C;&#x60F3;&#x5230;&#x7684;&#x662F;&#x53EF;&#x80FD;&#x5BA2;&#x6237;&#x7AEF;classpath&#x4E2D;&#x7F3A;&#x5931;&#x67D0;&#x4E2A;&#x7C7B;&#x9020;&#x6210;&#x7684;&#xFF0C;&#x7ECF;&#x8FC7;&#x6392;&#x67E5;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x73AF;&#x5883;&#x4E4B;&#x540E;&#xFF0C;&#x53D1;&#x73B0;&#x5E76;&#x4E0D;&#x662F;&#x8FD9;&#x6837;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x7136;&#x800C;&#x8FD8;&#x662F;&#x88AB;&#x5BA2;&#x6237;&#x7AEF;&#x8DD1;&#x51FA;&#x8FD9;&#x6837;&#x7684;&#x5F02;&#x5E38;&#x8BE7;&#x5F02;&#x3002;&#x6309;&#x7167;&#x6808;&#x7684;&#x903B;&#x8F91;&#xFF0C;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x662F;&#x5728;RegionServer&#x4E0A;&#x53D1;&#x751F;&#x7684;&#x3002;</p>
<p>&#x200B;       &#x7ECF;&#x8FC7;&#x6392;&#x67E5;RegionServer&#x7684;classpath&#x4E4B;&#x540E;&#xFF0C;&#x786E;&#x5B9A;&#x5728;RegionServer&#x5E76;&#x4E0D;&#x5B58;&#x5728;&#x7C7B;&#x51B2;&#x7A81;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x6392;&#x67E5; RegionServer&#x6253;&#x5F00;&#x7684;hbase-server.jar&#x6587;&#x4EF6;&#xFF0C;&#x53D1;&#x73B0;&#x8FD9;&#x4E2A;jar&#x6587;&#x4EF6;&#x4E2D;&#x786E;&#x5B9E;&#x6709;ServerNonceManager$NonceKey&#x8FD9;&#x4E2A;&#x5185;&#x90E8;&#x7C7B;&#xFF0C;&#x7136;&#x800C;&#x4F7F;&#x7528;jmap -histo:live $pid | grep ServerNonceManager$NonceKey &#x547D;&#x4EE4;&#x4E4B;&#x540E;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x53D1;&#x73B0;&#x8FD9;&#x4E2A;&#x7C7B;&#x52A0;&#x8F7D;&#x8FDB;JVM&#x7684;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x67E5;&#x770B;RegionServer&#x4E0A;&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x53D1;&#x73B0;&#x5E76;&#x6CA1;&#x6709;&#x8FD9;&#x6837;&#x7684;&#x5F02;&#x5E38;&#x8F93;&#x51FA;&#x3002;</p>
<p>&#x200B;       &#x5728;&#x81EA;&#x5DF1;&#x624B;&#x52A8;&#x7528;Java&#x7F16;&#x5199;&#x4E00;&#x4E2A;HBase&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x8FD9;&#x6837;&#x7684;&#x5F02;&#x5E38;&#x4E0D;&#x671F;&#x800C;&#x81F3;&#xFF0C;&#x51E0;&#x4E4E;&#x662F;&#x767E;&#x5206;&#x767E;&#x547D;&#x4E2D;&#x3002;&#x7A81;&#x7136;&#x60F3;&#x8D77;&#x6709;&#x4E2A;&#x5F02;&#x5E38;&#x662F;ClassNotFoundException&#x5F02;&#x5E38;&#xFF0C; &#x6BD4;&#x8F83;&#x8FD9;&#x4E24;&#x79CD;&#x5F02;&#x5E38;&#x7684;&#x533A;&#x522B;&#xFF1A;</p>
<pre>

 1&#xFF0C;ClassNotFoundException&#xFF0C; &#x662F;&#x5728;&#x7A0B;&#x5E8F;&#x4E2D;&#xFF0C;&#x4F7F;&#x7528;Class.forName(&#x201C;$NAME&#x201D;) &#x6765;&#x52A8;&#x6001;&#x7684;&#x52A0;&#x8F7D;&#x67D0;&#x4E2A;&#x7C7B;&#xFF0C; JVM&#x5728;&#x5F53;&#x524D;&#x7684;Classpath&#x4E0B;&#x5E76;&#x6CA1;&#x6709;&#x53D1;&#x73B0;&#x8FD9;&#x4E2A;&#x7C7B;&#x3002;&#x5373;&#x4F7F;&#x6CA1;&#x6709;&#x8FD9;&#x4E2A;&#x7C7B;&#xFF0C; &#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7F16;&#x8BD1;&#x3002;

  2&#xFF0C; NoClassDefFoundError&#xFF0C; &#x662F;&#x5DF2;&#x7ECF;&#x7F16;&#x8BD1;&#x597D;&#x7684;&#x6587;&#x4EF6;&#xFF0C; JVM&#x5728;&#x521B;&#x5EFA;&#x8BE5;&#x7C7B;&#x7684;Class&#x5BF9;&#x8C61;&#x65F6;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x53D1;&#x73B0;&#x8BE5;&#x7C7B;&#x7684;&#x5B9A;&#x4E49;&#xFF0C;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x9700;&#x8981;&#x521B;&#x5EFA;Class&#xFF1F; 

&#x200B;      1&#xFF09; &#x8C03;&#x7528;&#x7C7B;&#x7684;&#x9759;&#x6001;&#x5C5E;&#x6027;&#x6216;&#x65B9;&#x6CD5;&#x65F6;&#x3002;

&#x200B;      2&#xFF09; new &#x4E00;&#x4E2A;&#x7C7B;&#x7684;&#x5BF9;&#x8C61;&#x65F6;

 &#x6B64;&#x65F6;&#x7531;&#x4E8E;&#x5728;jvm&#x4E2D;&#x672A;&#x53D1;&#x73B0;&#x7C7B;&#x7684;&#x5B9A;&#x4E49;&#xFF0C;&#x80AF;&#x5B9A;&#x4E8B;&#x5148;&#x5728;Class&#x8DEF;&#x5F84;&#x4E0B;&#x627E;&#x4E86;&#x4E00;&#x904D;&#xFF0C;&#x4F46;&#x662F;&#x6CA1;&#x6709;&#x627E;&#x5230;&#x3002;

</pre>

<p>&#x200B;       &#x60F3;&#x8D77;&#x524D;&#x4E9B;&#x5929;&#x66F4;&#x65B0;hbase jar&#x6587;&#x4EF6;&#x65F6;&#xFF0C;&#x53EA;&#x662F;&#x7B80;&#x5355;&#x5730;&#x5C06;&#x8BE5;jar&#x6587;&#x4EF6;&#x8986;&#x76D6;&#x6389;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x91CD;&#x542F;&#x76F8;&#x5173;&#x7684;&#x670D;&#x52A1;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x5728;jvm&#x4E2D;&#xFF0C;&#x4F7F;&#x7528;&#x7684;jar&#x6587;&#x4EF6;&#x53E5;&#x67C4;&#x662F;&#x4E00;&#x4E2A;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x53E5;&#x67C4;(&#x901A;&#x8FC7;lsof&#x53EF;&#x4EE5;&#x89C2;&#x5BDF;&#x5230;&#x8FD9;&#x6837;&#x7684;&#x73B0;&#x8C61;)&#x3002;&#x8FD9;&#x5C31;&#x5BFC;&#x81F4;&#x4E86;&#x7C7B;&#x4F3C;&#x4E8E;&#x5728;&#x8FD0;&#x884C;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x5176;&#x4F9D;&#x8D56;&#x7684;jar&#x6587;&#x4EF6;&#x5220;&#x9664;&#xFF0C;&#x5F53;&#x4F9D;&#x7167;&#x7C7B;&#x8DEF;&#x5F84;&#x4ECE;&#x78C1;&#x76D8;&#x4E2D;&#x52A0;&#x8F7D;&#x8BE5;&#x7C7B;&#x65F6;&#xFF0C;&#x7C7B;&#x5DF2;&#x7ECF;&#x88AB;&#x5220;&#x9664;&#xFF0C;&#x8FD9;&#x6837;&#x4FBF;&#x5BFC;&#x81F4;&#x4E86;&#x8BE5;&#x95EE;&#x9898;&#x7684;&#x51FA;&#x73B0;&#x3002;&#x5C06;RegionServer&#x670D;&#x52A1;&#x91CD;&#x542F;&#x4E4B;&#x540E;&#xFF0C;&#x8BE5;&#x95EE;&#x9898;&#x6D88;&#x5931;&#x3002;</p>
<p>&#x4E00;&#x4E9B;&#x7ED3;&#x8BBA;&#xFF1A;</p>
<p>1&#xFF0C; &#x5F53;&#x670D;&#x52A1;&#x53D1;&#x751F;jar&#x6587;&#x4EF6;&#x66F4;&#x65B0;&#x65F6;&#xFF0C;&#x4E0D;&#x7BA1;&#x600E;&#x4E48;&#x6837;&#xFF0C;&#x90FD;&#x8981;&#x91CD;&#x542F;&#x6574;&#x4E2A;&#x670D;&#x52A1;&#xFF0C;&#x5426;&#x5219;&#xFF0C;&#x4F1A;&#x6709;&#x83AB;&#x540D;&#x5176;&#x5999;&#x7684;&#x95EE;&#x9898;&#x7B49;&#x7740;&#x53BB;&#x89E3;&#x51B3;&#x3002;</p>
<p>2&#xFF0C; &#x5728;&#x53D1;&#x73B0;&#x6709;&#x7C7B;&#x51B2;&#x7A81;&#x65F6;&#xFF0C; &#x53EF;&#x4EE5;&#x5728;JVM&#x542F;&#x52A8;&#x53C2;&#x6570;&#x4E0A;&#xFF0C; &#x52A0;&#x4E0A; -verbose:class &#x53C2;&#x6570;&#x6765;&#x89C2;&#x5BDF;&#x7C7B;&#x52A0;&#x8F7D;&#x7684;&#x8DEF;&#x5F84;&#x3002;</p>
<p>&#x200B;      </p>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="GC/" class="post-link">Java GC</a></h2><span class="post-time">Nov 11, 2017</span><div class="post-content"><h1><center>Java GC &#x8C03;&#x4F18;&#x7ECF;&#x5386;</center></h1>

<p></p><h2>&#x57FA;&#x672C;&#x6982;&#x5FF5;</h2><br>&#x4E4B;&#x524D;&#xFF0C;&#x770B;&#x8FC7;&#x5F88;&#x591A;&#x5173;&#x4E8E;GC&#x7684;&#x6587;&#x7AE0;&#xFF0C;&#x5374;&#x4E00;&#x76F4;&#x6CA1;&#x6709;&#x5B9E;&#x8DF5;&#x7684;&#x673A;&#x4F1A;&#x3002;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x7B97;&#x662F;&#x4E00;&#x7247;&#x6765;&#x7684;&#x6BD4;&#x8F83;&#x8FDF;&#x7684;&#x603B;&#x7ED3;&#xFF0C;&#x66F4;&#x591A;&#x7684;&#x662F;&#x4E00;&#x6B21;&#x96BE;&#x5F97;GC&#x8C03;&#x4F18;&#x7ECF;&#x5386;&#x7684;&#x603B;&#x7ED3;&#x3002;<p></p>
<p>&#x5173;&#x4E8E;Java GC&#x7684;&#x539F;&#x7406;&#xFF0C;oracle&#x5B98;&#x7F51;&#x548C;&#x4E00;&#x4E9B;&#x7F51;&#x7AD9;&#x4E0A;&#x6709;&#x4E86;&#x6BD4;&#x8F83;&#x8BE6;&#x5C3D;&#x7684;&#x5206;&#x6790;&#x548C;&#x63CF;&#x8FF0;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x8C08;&#x8C08;&#x4E00;&#x4E0B;&#x81EA;&#x5DF1;&#x7684;&#x7406;&#x89E3;&#x548C;&#x603B;&#x7ED3;:</p>
<p>&#x6839;&#x636E;&#x4E00;&#x4E9B;&#x7EDF;&#x8BA1;&#x7ECF;&#x9A8C;&#xFF0C;&#x5927;&#x90E8;&#x5206;&#x5E94;&#x7528;&#x521B;&#x5EFA;&#x7684;&#x5BF9;&#x8C61;&#x751F;&#x5B58;&#x671F;&#x6BD4;&#x8F83;&#x77ED;&#xFF0C;&#x6BD4;&#x5982;&#x5728;java&#x65B9;&#x6CD5;&#x4E2D;&#x521B;&#x5EFA;&#x7684;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#xFF0C;&#x8FD9;&#x4E9B;&#x5BF9;&#x8C61;&#x968F;&#x7740;&#x65B9;&#x6CD5;&#x6808;&#x7684;&#x9000;&#x51FA;&#x800C;&#x53D8;&#x6210;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x751F;&#x547D;&#x5468;&#x671F;&#x4E0E;&#x51FD;&#x6570;&#x7684;&#x8C03;&#x7528;&#x957F;&#x77ED;&#x76F8;&#x5173;&#x3002;&#x53EA;&#x6709;&#x5C11;&#x6570;&#x7684;&#x5BF9;&#x8C61;&#x6211;&#x4EEC;&#x5E0C;&#x671B;&#x80FD;&#x591F;&#x5E38;&#x9A7B;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x52A0;&#x5FEB;&#x7A0B;&#x5E8F;&#x7684;&#x6267;&#x884C;&#x6548;&#x7387;&#x3002;<br><br><img src="/GC/demography.png" alt="demography.png" title=""></p>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4EBA;&#x4E3A;&#x5730;&#x53EF;&#x4EE5;&#x5C06;&#x8FD9;&#x4E9B;&#x5BF9;&#x8C61;&#x5206;&#x6210;&#x5E74;&#x8F7B;&#x4EE3;&#x548C;&#x5E74;&#x8001;&#x4EE3;&#xFF0C;&#x7531;&#x4E8E;JVM&#x5E76;&#x4E0D;&#x6E05;&#x695A;&#x54EA;&#x4E9B;&#x5BF9;&#x8C61;&#x662F;&#x5E0C;&#x671B;&#x6C38;&#x9A7B;&#x5E94;&#x7528;&#x5185;&#x5B58;&#x7684;&#xFF0C;&#x800C;&#x662F;&#x4F7F;&#x7528;&#x4E00;&#x79CD;&#x7B80;&#x5355;&#x6709;&#x6548;&#x7684;&#x89C4;&#x5219;&#xFF1A;&#x5F53;&#x5904;&#x4E8E;&#x5E74;&#x8F7B;&#x4EE3;&#x4E2D;&#x7684;&#x5BF9;&#x8C61;&#x6BCF;&#x7ECF;&#x5386;&#x4E00;&#x6B21;GC&#x65F6;&#xFF0C;&#x5BF9;&#x8C61;&#x7684;age&#x5C31;&#x589E;&#x52A0;1&#xFF0C;&#x5F53;&#x8FBE;&#x5230;&#x9884;&#x5148;&#x8BBE;&#x7F6E;&#x7684;&#x9608;&#x503C;&#x540E;&#xFF0C;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x4FBF;&#x5347;&#x7EA7;&#x4E3A;&#x4E00;&#x4E2A;&#x8001;&#x5E74;&#x4EE3;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x521A;&#x5206;&#x914D;&#x7684;&#x5BF9;&#x8C61;&#x5176;age&#x4E3A;0&#x3002;&#x8FD9;&#x4E9B;&#x5BF9;&#x8C61;&#x90FD;&#x5B58;&#x50A8;&#x5728;JVM&#x5B9A;&#x4E49;&#x7684;&#x5806;&#x4E2D;&#xFF0C;&#x5806;&#x4E5F;&#x53EF;&#x4EE5;&#x6309;&#x7167;&#x8FD9;&#x6837;&#x7684;&#x89C4;&#x5219;&#xFF0C;&#x5206;&#x4E3A;&#x5E74;&#x8F7B;&#x4EE3;&#x548C;&#x5E74;&#x8001;&#x4EE3;&#x3002;</p>
<p>&#x5E74;&#x8F7B;&#x4EE3;&#x7684;&#x5BF9;&#x8C61;&#x6D3B;&#x8DC3;&#x4E0D;&#x7A33;&#x5B9A;&#xFF0C;&#x521B;&#x5EFA;&#x7684;&#x5FEB;&#xFF0C;&#x53D8;&#x6210;&#x5783;&#x573E;&#x7684;&#x65F6;&#x95F4;&#x4E5F;&#x5FEB;&#xFF1B;&#x800C;&#x5E74;&#x8001;&#x4EE3;&#x5219;&#x4E0D;&#x540C;&#xFF0C;&#x5B83;&#x4EEC;&#x5219;&#x5386;&#x7ECF;&#x78E8;&#x7EC3;&#xFF0C;&#x76F8;&#x5BF9;&#x5E74;&#x8F7B;&#x4EE3;&#x6765;&#x8BF4;&#xFF0C;&#x5B83;&#x4EEC;&#x53EF;&#x80FD;&#x4E0D;&#x4EC5;&#x4EC5;&#x4F5C;&#x7528;&#x4E0E;&#x67D0;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6BD4;&#x8F83;&#x800C;&#x8A00;&#xFF0C;&#x66F4;&#x52A0;&#x7A33;&#x5B9A;&#x3002;&#x5BF9;&#x4E8E;&#x8FD9;&#x4E24;&#x4EE3;&#x7684;&#x5BF9;&#x8C61;&#x7684;GC&#xFF0C;&#x53EF;&#x4EE5;&#x533A;&#x522B;&#x5BF9;&#x5F85;&#x3002;&#x5E38;&#x89C1;&#x7684;GC&#x7B97;&#x6CD5;&#x6709;copy(&#x590D;&#x5236;)&#x7B97;&#x6CD5;&#x548C;&#x6807;&#x8BB0;&#xFF0D;&#x6574;&#x7406;&#x6CD5;&#x3002;</p>
<p>&#x5728;&#x5E74;&#x8F7B;&#x4EE3;&#x4E2D;&#xFF0C;&#x4F9D;&#x636E;&#x7EDF;&#x8BA1;&#x6570;&#x636E;&#xFF0C;age&#x8D85;&#x8FC7;&#x67D0;&#x4E00;&#x4E2A;&#x503C;&#x65F6;&#xFF0C;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x7684;&#x6570;&#x91CF;&#x663E;&#x8457;&#x7684;&#x51CF;&#x5C11;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x5728;&#x5E74;&#x8F7B;&#x4EE3;&#x4E2D;&#xFF0C;&#x5185;&#x5B58;&#x5927;&#x90E8;&#x5206;&#x7684;&#x5BF9;&#x8C61;&#x90FD;&#x662F;&#x5783;&#x573E;&#x5BF9;&#x8C61;&#xFF0C;&#x8FD9;&#x4E2D;GC&#x7684;&#x56DE;&#x6536;&#x9002;&#x7528;copy&#x7B97;&#x6CD5;&#xFF0C;&#x5C06;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#x62F7;&#x8D1D;&#x5230;&#x53E6;&#x4E00;&#x4E2A;&#x7A7A;&#x7F6E;&#x7684;&#x5185;&#x5B58;&#x533A;&#x57DF;&#x5185;&#xFF0C;&#x539F;&#x6765;&#x5206;&#x914D;&#x5BF9;&#x8C61;&#x7684;&#x533A;&#x57DF;&#x662F;&#x4E00;&#x4E2A;&#x6CA1;&#x6709;&#x788E;&#x7247;&#x7684;&#x5185;&#x5B58;&#x533A;&#x57DF;&#xFF0C;&#x8FD9;&#x6837;&#x7684;&#x7B97;&#x6CD5;&#x7B80;&#x5355;&#x6709;&#x6548;&#xFF0C;&#x517C;&#x987E;&#x6548;&#x7387;&#x4EE5;&#x53CA;GC&#x540E;&#x5BF9;&#x8C61;&#x521B;&#x5EFA;&#xFF0C;&#x9700;&#x8981;&#x8FDE;&#x7EED;&#x5185;&#x5B58;&#x7684;&#x73B0;&#x5B9E;&#x9700;&#x6C42;&#x3002;&#x8FD9;&#x4E5F;&#x5C31;&#x597D;&#x6BD4;&#xFF0C;&#x5728;&#x67D0;&#x4E9B;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x63D2;&#x5165;&#x6392;&#x5E8F;&#x8981;&#x597D;&#x8FC7;&#x5FEB;&#x6392;(&#x8FD9;&#x4E5F;&#x89E3;&#x91CA;&#x4E86;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6709;&#x4E24;&#x4E2A;survivor&#x7684;&#x539F;&#x56E0;)&#x3002;</p>
<p>&#x5E74;&#x8001;&#x4EE3;&#x7684;&#x5BF9;&#x8C61;&#x5219;&#x4E0D;&#x540C;&#xFF0C;&#x53EF;&#x80FD;&#x8D85;&#x8FC7;50%&#x7684;&#x5BF9;&#x8C61;&#x5728;GC&#x5230;&#x6765;&#x65F6;&#xFF0C;&#x662F;&#x53EF;&#x8FBE;&#x7684;&#x3002;&#x4F7F;&#x7528;&#x590D;&#x5236;&#x7B97;&#x6CD5;&#x867D;&#x7136;&#x6709;&#x5229;&#x4E8E;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x7684;&#x6574;&#x7406;&#x3002;&#x4F46;&#x662F;&#x8981;&#x6C42;&#x5728;GC&#x671F;&#x95F4;&#xFF0C;&#x8981;&#x505C;&#x6B62;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;&#x7136;&#x800C;&#xFF0C;&#x62F7;&#x8D1D;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#xFF0C;&#x4E3A;&#x5BF9;&#x8C61;&#x627E;&#x4E00;&#x4E2A;&#x9002;&#x5408;&#x7684;&#x5185;&#x5B58;&#x533A;&#x57DF;&#xFF0C;&#x8FD9;&#x4E9B;&#x90FD;&#x6697;&#x793A;&#x505C;&#x6B62;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x65F6;&#x95F4;&#x53D8;&#x957F;&#xFF0C;&#x8FD9;&#x5BF9;&#x4E8E;&#x8981;&#x6C42;&#x4F4E;&#x5EF6;&#x8FDF;&#x7684;&#x5E94;&#x7528;&#x6765;&#x8BF4;&#xFF0C;&#x662F;&#x4E0D;&#x5E0C;&#x671B;&#x7684;&#xFF0C;&#x5C24;&#x5176;&#x662F;&#x5F53;&#x5E94;&#x7528;&#x9700;&#x8981;&#x5F88;&#x5927;&#x7684;&#x5E74;&#x8001;&#x4EE3;&#x6765;&#x7F13;&#x5B58;&#x4E00;&#x4E9B;&#x6570;&#x636E;&#x65F6;&#x3002;&#x8FD9;&#x6837;&#x590D;&#x5236;&#x7684;&#x7B97;&#x6CD5;&#x5E76;&#x4E0D;&#x9002;&#x5408;&#x5E74;&#x8001;&#x4EE3;&#xFF0C;&#x800C;&#x6807;&#x8BB0;&#x6574;&#x7406;&#x7B97;&#x6CD5;&#x5374;&#x53EF;&#x80DC;&#x4EFB;&#x8FD9;&#x6837;&#x7684;&#x573A;&#x666F;&#x3002;</p>
<p>Java&#x7684;CMS&#x5783;&#x573E;&#x56DE;&#x6536;&#x673A;&#x5236;&#xFF0C;&#x4ECE;&#x601D;&#x60F3;&#x4E0A;&#x770B;&#xFF0C;&#x662F;&#x6807;&#x8BB0;&#x6574;&#x7406;&#x7B97;&#x6CD5;&#x7684;&#x4E00;&#x79CD;&#x5347;&#x7EA7;&#xFF0C;&#x4E3A;&#x4E86;&#x9002;&#x5E94;&#x4F4E;&#x5EF6;&#x8FDF;&#x7684;&#x9700;&#x6C42;&#xFF0C;CMS&#x5C06;&#x56DE;&#x6536;&#x673A;&#x5236;&#x5206;&#x6210;7&#x4E2A;&#x9636;&#x6BB5;&#xFF0C;&#x8FD9;&#x4E9B;&#x9636;&#x6BB5;&#x53EF;&#x4EE5;&#x5728;&#x65E5;&#x5FD7;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF1A;</p>
<pre>
2016-08-25T19:46:17.113+0800: 3.424: [GC (CMS Initial Mark) [1 CMS-initial-mark: 0K(11354112K)] 52106K(12460032K), 0.0032642 secs] [Times: user=0.01 sys=0.00, real=0.01 secs]
2016-08-25T19:46:17.116+0800: 3.427: [CMS-concurrent-mark-start]
2016-08-25T19:46:17.119+0800: 3.430: [CMS-concurrent-mark: 0.002/0.002 secs] [Times: user=0.03 sys=0.01, real=0.00 secs]
2016-08-25T19:46:17.119+0800: 3.430: [CMS-concurrent-preclean-start]
2016-08-25T19:46:17.150+0800: 3.461: [CMS-concurrent-preclean: 0.031/0.031 secs] [Times: user=0.10 sys=0.00, real=0.03 secs]
2016-08-25T19:46:17.150+0800: 3.461: [CMS-concurrent-abortable-preclean-start]
 CMS: abort preclean due to time 2016-08-25T19:46:18.169+0800: 4.480: [CMS-concurrent-abortable-preclean: 0.832/1.018 secs] [Times: user=3.47 sys=0.12, real=1.02 secs]
2016-08-25T19:46:18.169+0800: 4.480: [GC (CMS Final Remark) [YG occupancy: 248283 K (1105920 K)]2016-08-25T19:46:18.169+0800: 4.480: [GC (CMS Final Remark) 2016-08-25T19:46:18.169+0800: 4.480: [ParNew
Desired survivor size 106954752 bytes, new threshold 6 (max 6)
- age   1:    6159048 bytes,    6159048 total
- age   2:    6537288 bytes,   12696336 total
  : 248283K-&gt;15319K(1105920K), 0.0257818 secs] 248283K-&gt;15319K(12460032K), 0.0259120 secs] [Times: user=0.37 sys=0.02, real=0.02 secs]
  2016-08-25T19:46:18.195+0800: 4.506: [Rescan (parallel) , 0.0044843 secs]2016-08-25T19:46:18.200+0800: 4.511: [weak refs processing, 0.0000427 secs]2016-08-25T19:46:18.200+0800: 4.511: [class unloading, 0.0050959 secs]2016-08-25T19:46:18.205+0800: 4.516: [scrub symbol table, 0.0043472 secs]2016-08-25T19:46:18.209+0800: 4.520: [scrub string table, 0.0006284 secs][1 CMS-remark: 0K(11354112K)] 15319K(12460032K), 0.0418459 secs] [Times: user=0.46 sys=0.02, real=0.04 secs]
  2016-08-25T19:46:18.211+0800: 4.522: [CMS-concurrent-sweep-start]
  2016-08-25T19:46:18.211+0800: 4.522: [CMS-concurrent-sweep: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
  2016-08-25T19:46:18.211+0800: 4.522: [CMS-concurrent-reset-start]
  2016-08-25T19:46:18.271+0800: 4.582: [CMS-concurrent-reset: 0.057/0.060 secs] [Times: user=0.15 sys=0.05, real=0.06 secs]
  </pre>

<p>&#x6211;&#x4EEC;&#x91CD;&#x70B9;&#x5173;&#x6CE8;&#x4E00;&#x4E0B;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6709;&#x8FD9;&#x4E9B;&#x9636;&#x6BB5;&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x4E9B;&#xFF0C;&#x4FBF;&#x4F1A;&#x660E;&#x767D;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;CMS&#x79F0;&#x5F97;&#x4E0A;&#x662F;&#x4E00;&#x4E2A;&#x4F4E;&#x5EF6;&#x65F6;&#x7684;&#x7B97;&#x6CD5;&#xFF0C;&#x76F8;&#x6BD4;&#x5176;&#x4ED6;&#x7B97;&#x6CD5;&#x3002;<br></p>
<p>&#x6309;&#x7167;&#x7B97;&#x6CD5;&#x7684;&#x63CF;&#x8FF0;&#xFF0C;&#x6807;&#x8BB0;&#x662F;&#x6574;&#x4E2A;&#x7B97;&#x6CD5;&#x7684;&#x7B2C;&#x4E00;&#x6B65;&#xFF0C;&#x4E5F;&#x662F;&#x6574;&#x4E2A;&#x7B97;&#x6CD5;&#x7684;&#x57FA;&#x7840;&#x3002;&#x4E0D;&#x7BA1;&#x662F;&#x4E0A;&#x6587;&#x63D0;&#x5230;&#x7684;&#x590D;&#x5236;&#x7B97;&#x6CD5;&#x8FD8;&#x662F;&#x5176;&#x4ED6;&#x5404;&#x79CD;&#x5783;&#x573E;&#x56DE;&#x6536;&#x7B97;&#x6CD5;&#xFF0C;&#x90FD;&#x9700;&#x8981;&#x5C06;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#x5148;&#x6807;&#x8BB0;&#x51FA;&#x6765;&#x3002;&#x5BF9;&#x8C61;&#x4E0E;&#x5BF9;&#x8C61;&#x4E4B;&#x95F4;&#xFF0C;&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x5F15;&#x7528;&#x4EE5;&#x53CA;&#x88AB;&#x5F15;&#x7528;&#x7684;&#x5173;&#x7CFB;&#x3002;&#x53EF;&#x4EE5;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#x5173;&#x7CFB;&#xFF1A;</p>
<pre>
  A-&gt;B, A&#x5BF9;&#x8C61;&#x6709;&#x4E2A;&#x5F15;&#x7528;&#x6307;&#x5411;B&#x5BF9;&#x8C61;&#xFF0C;&#x79F0;A&#x5BF9;&#x8C61;&#x4E0E;B&#x5BF9;&#x8C61;&#x4E4B;&#x95F4;&#x7684;&#x8DDD;&#x79BB;&#x4E3A;1.
  A B, A&#x4E0E;B&#x5BF9;&#x8C61;&#x76F8;&#x4E92;&#x72EC;&#x7ACB;&#xFF0C;&#x5219;A&#x5BF9;&#x8C61;&#x4E0E;B&#x5BF9;&#x8C61;&#x7684;&#x8DDD;&#x79BB;&#x4E3A;0.
  A -&gt; B -&gt;C, &#x4F20;&#x9012;&#x4F9D;&#x8D56;&#xFF0C;A&#x5BF9;&#x8C61;&#x4E0E;C&#x5BF9;&#x8C61;&#x7684;&#x8DDD;&#x79BB;&#x4E3A;2.
</pre>
CMS&#x4E2D;&#x7684;```initial mark```&#x9636;&#x6BB5;&#xFF0C;&#x5176;&#x4E3B;&#x8981;&#x7684;&#x4EFB;&#x52A1;&#xFF0C;&#x662F;&#x4ECE;&#x7EBF;&#x7A0B;&#x6808;&#x96C6;&#x4E2D;&#x6216;&#x8005;&#x5E74;&#x8F7B;&#x4EE3;&#x4E2D;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x79F0;&#x4E4B;&#x4E3A;&#x6839;&#x96C6;&#xFF0C;&#x987A;&#x85E4;&#x6478;&#x74DC;&#x5F0F;&#x7684;&#x627E;&#x51FA;&#x5728;old&#x533A;&#x57DF;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x8FD9;&#x4E2A;&#x9636;&#x6BB5;&#x9700;&#x8981;&#x505C;&#x6B62;&#x5E94;&#x7528;&#x7EBF;&#x7A0B;&#xFF0C;&#x83B7;&#x5F97;&#x4E00;&#x4E2A;&#x8001;&#x5E74;&#x533A;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x7684;&#x4E00;&#x4E2A;&#x5FEB;&#x7167;&#x3002;&#x4E3A;&#x4E86;&#x51CF;&#x5C11;&#x6682;&#x505C;&#x5E94;&#x7528;&#x65F6;&#x95F4;&#xFF0C;&#x53EA;&#x6807;&#x8BB0;old&#x533A;&#x57DF;&#x5185;&#x90A3;&#x4E9B;&#x4E0E;&#x6839;&#x96C6;&#x5BF9;&#x8C61;&#x4E2D;&#x8DDD;&#x79BB;&#x4E3A;1&#x7684;&#x5BF9;&#x8C61;&#x96C6;S. &#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x7684;&#x6682;&#x505C;&#x65F6;&#x95F4;&#x4E00;&#x822C;&#x8BF4;&#x6765;&#xFF0C;&#x662F;&#x6BD4;&#x5E74;&#x8F7B;&#x4EE3;&#x7684;&#x5783;&#x573E;&#x56DE;&#x6536;&#x65F6;&#x95F4;&#x8981;&#x77ED;&#x3002;

&#x4E0B;&#x4E00;&#x6B65;&#xFF0C;&#x8FDB;&#x884C;&#x7684;&#x5219;&#x662F;```CMS-concurrent-mark```&#x3002;&#x5728;&#x524D;&#x4E00;&#x4E2A;&#x9636;&#x6BB5;&#x7684;&#x57FA;&#x7840;&#x4E4B;&#x4E0A;&#xFF0C;&#x5B8C;&#x6210;mark&#x5E94;&#x8BE5;&#x8981;&#x5B8C;&#x6210;&#x7684;&#x4E8B;&#x4E1A;&#xFF0C;&#x6700;&#x5927;&#x9650;&#x5EA6;&#x7684;&#x6807;&#x8BB0;&#x8001;&#x5E74;&#x4EE3;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#x3002;&#x4ECE;&#x4E0A;&#x4E00;&#x6B65;&#x627E;&#x5230;&#x7684;&#x96C6;&#x5408;S&#x51FA;&#x53D1;&#xFF0C;&#x627E;&#x51FA;&#x4E0E;&#x96C6;&#x5408;S&#x5BF9;&#x8C61;&#x8DDD;&#x79BB;&gt;0&#x7684;&#x6240;&#x6709;&#x8001;&#x5E74;&#x4EE3;&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x5C06;&#x5B83;&#x4EEC;&#x6807;&#x8BB0;&#xFF0C;&#x5C06;&#x8FD9;&#x4E2A;&#x9636;&#x6BB5;&#x4EA7;&#x751F;&#x7684;&#x96C6;&#x5408;&#x6807;&#x8BB0;&#x4E3A;T&#x3002; &#x8FD9;&#x4E00;&#x9636;&#x6BB5;&#x662F;&#x4E2A;&#x5E94;&#x7528;&#x4E00;&#x8D77;&#x5E76;&#x884C;&#x6267;&#x884C;&#x7684;&#x3002;
&#x5728;mark&#x9636;&#x6BB5;&#xFF0C;&#x5E94;&#x7528;&#x662F;&#x548C;GC&#x7EBF;&#x7A0B;&#x4E00;&#x8D77;&#x5E76;&#x53D1;&#x53BB;&#x6267;&#x884C;&#x7684;&#xFF0C;&#x5728;&#x8FD9;&#x671F;&#x95F4;&#xFF0C;&#x53EF;&#x80FD;&#x53D1;&#x751F;&#x539F;&#x6765;&#x88AB;&#x6807;&#x8BB0;&#x4E3A;_alive_&#x7684;&#x5BF9;&#x8C61;&#x7684;&#x5F15;&#x7528;&#x53D1;&#x751F;&#x66F4;&#x6539;&#xFF0C;&#x6307;&#x5411;mark&#x9636;&#x6BB5;&#x672A;&#x88AB;&#x6807;&#x8BB0;&#x7684;&#x5BF9;&#x8C61;;&#x6216;&#x8005;&#xFF0C;&#x5728;&#x8FD9;&#x671F;&#x95F4;&#x4E00;&#x4E9B;&#x5BF9;&#x8C61;&#x4ECE;&#x5E74;&#x8F7B;&#x4EE3;promote&#x5230;&#x8001;&#x5E74;&#x4EE3;&#x4E2D;&#x3002;&#x56E0;&#x6B64;mark&#x9636;&#x6BB5;&#x7ED3;&#x675F;&#x540E;&#xFF0C;&#x5E76;&#x4E0D;&#x80FD;&#x5F97;&#x5230;&#x4E00;&#x4E2A;&#x771F;&#x6B63;&#x8001;&#x5E74;&#x4EE3;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x7684;&#x5FEB;&#x7167;&#xFF0C;&#x7136;&#x800C;&#x5374;&#x4FDD;&#x5B58;&#x5728;&#x53D1;&#x751F;&#x53D8;&#x66F4;&#x7684;&#x5BF9;&#x8C61;&#x7684;&#x8BB0;&#x5F55;&#x3002;Remark&#x9636;&#x6BB5;&#x7684;&#x90E8;&#x5206;&#x5DE5;&#x4F5C;&#xFF0C;&#x5C31;&#x662F;&#x91CD;&#x65B0;&#x626B;&#x63CF;&#x88AB;&#x5E94;&#x7528;&#x7EBF;&#x7A0B;&#x66F4;&#x6539;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5305;&#x62EC;&#x5E74;&#x8F7B;&#x4EE3;&#x4E2D;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5F97;&#x5230;&#x6700;&#x7EC8;&#x7684;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x96C6;.&#x4E3A;&#x4E86;&#x51CF;&#x5C11;Remark&#x9636;&#x6BB5;&#x7684;&#x5DE5;&#x4F5C;&#x91CF;&#xFF0C;&#x4E8E;&#x662F;&#x4E00;&#x4E2A;concurrent preclean&#x7684;&#x9636;&#x6BB5;&#x5E2E;&#x52A9;Remark&#x9636;&#x6BB5;&#x505A;&#x4E00;&#x4E9B;&#x8FD9;&#x6837;&#x7684;&#x5DE5;&#x4F5C;&#xFF0C;&#x5F53;&#x6EE1;&#x8DB3;&#x9884;&#x8BBE;&#x7684;&#x8FED;&#x4EE3;&#x6B21;&#x6570;&#x6216;&#x8005;&#x6EE1;&#x8DB3;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x540E;&#xFF0C;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x9000;&#x51FA;&#xFF0C;&#x5728;&#x9000;&#x51FA;&#x4E4B;&#x524D;&#xFF0C;&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x8BA9;Ramark&#x7EBF;&#x7A0B;&#x5E76;&#x884C;&#x7684;&#x53BB;&#x626B;&#x63CF;&#x5E74;&#x8F7B;&#x4EE3;&#xFF0C;&#x6BCF;&#x4E2A;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#xFF0C;&#x4ECE;&#x5E74;&#x8F7B;&#x4EE3;&#x4E2D;&#x53D6;&#x51FA;&#x4E00;&#x4E2A;&#x5730;&#x5740;(&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x662F;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x7684;&#x5F00;&#x59CB;&#x5730;&#x5740;&#xFF09;&#xFF0C;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;Remark&#x5E76;&#x884C;&#x626B;&#x63CF;&#x65F6;&#x5E74;&#x8F7B;&#x4EE3;&#x65F6;&#x5F00;&#x59CB;&#x7684;&#x4F4D;&#x7F6E;(&#x5982;&#x679C;&#x968F;&#x4FBF;&#x7ED9;&#x5B9A;&#x4E00;&#x4E2A;&#x5E74;&#x8F7B;&#x4EE3;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x5F88;&#x6709;&#x53EF;&#x80FD;&#x5728;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x7684;&#x4E2D;&#x95F4;&#x4F4D;&#x7F6E;&#xFF0C;JVM&#x5E76;&#x4E0D;&#x6E05;&#x695A;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#x7ED3;&#x675F;&#x4E3A;&#x6B62;&#xFF0C;&#x9664;&#x975E;&#x4ECE;&#x5E74;&#x8F7B;&#x4EE3;&#x7684;&#x5F00;&#x59CB;&#x4E3A;&#x6B62;&#x4E00;&#x904D;&#x4E00;&#x904D;&#x7684;&#x626B;&#x63CF;&#xFF0C;&#x7136;&#x800C;&#x8FD9;&#x6837;&#x7684;&#x64CD;&#x4F5C;&#x8D39;&#x65F6;&#xFF0C;&#x56E0;&#x6B64;&#x91C7;&#x7528;&#x4E86;&#x91C7;&#x6837;&#x7684;&#x529E;&#x6CD5;&#x6765;&#x786E;&#x5B9A;Remark&#x5E76;&#x884C;&#x626B;&#x63CF;&#x65F6;&#x5F00;&#x59CB;&#x7684;&#x4F4D;&#x7F6E;&#x3002;&#x90A3;&#x4E48;&#x5982;&#x4F55;&#x4F7F;&#x6BCF;&#x4E2A;Remark&#x626B;&#x63CF;&#x7EBF;&#x7A0B;&#x62E5;&#x6709;&#x5DEE;&#x4E0D;&#x591A;&#x7684;&#x626B;&#x63CF;&#x91CF;&#xFF1F;&#x6700;&#x597D;&#x7684;&#x65B9;&#x5F0F;&#x662F;&#x5728;Remark&#x4E4B;&#x524D;&#x5E74;&#x8F7B;&#x4EE3;&#x80FD;&#x591F;&#x53D1;&#x751F;&#x4E00;&#x6B21;GC&#xFF0C;&#x901A;&#x8FC7;&#x590D;&#x5236;&#x7B97;&#x6CD5;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x5BF9;&#x8C61;&#x4F4D;&#x7F6E;&#xFF0C;&#x8FD9;&#x6837;preclean&#x5728;&#x91C7;&#x6837;&#x65F6;&#xFF0C;&#x80FD;&#x591F;&#x505A;&#x5230;&#x5927;&#x81F4;&#x5747;&#x5300;&#x7684;&#x6548;&#x679C;&#x3002;&#x901A;&#x8FC7;&#x914D;&#x7F6E;&#x53C2;&#x6570;```CMSMaxAbortablePrecleanTime```&#x6765;&#x7B49;&#x5F85;&#x8FD9;&#x6837;&#x7684;&#x53D1;&#x751F;&#x3002;
<img src="/GC/GC.png" alt="GC.png" title="">

&gt; &#x5728;Remark&#x4E4B;&#x524D;&#x53D1;&#x751F;&#x4E00;&#x6B21;minor GC&#xFF0C; Remark&#x7684;&#x5E76;&#x884C;&#x626B;&#x63CF;&#x4EFB;&#x52A1;&#x53EF;&#x4EE5;&#x88AB;&#x5207;&#x5206;&#x6210;&#x5F88;&#x5747;&#x5300;&#xFF0C;&#x4ECE;&#x800C;&#x5728;&#x6574;&#x4F53;&#x4E0A;&#x63D0;&#x9AD8;&#x4E86;&#x6807;&#x8BB0;&#x7684;&#x901F;&#x5EA6;&#x3002;<br>

&#x5F53;&#x8001;&#x5E74;&#x4EE3;&#x4E2D;&#x6240;&#x6709;&#x7684;&#x5BF9;&#x8C61;&#x90FD;&#x88AB;&#x6807;&#x8BB0;&#x5B8C;&#x6210;&#x4E4B;&#x540E;&#xFF0C;&#x4E0B;&#x4E00;&#x6B65;&#x5C31;&#x662F;&#x5C06;&#x5783;&#x573E;&#x5BF9;&#x8C61;&#x4ECE;&#x5185;&#x5B58;&#x4E2D;&#x79FB;&#x9664;&#xFF0C;&#x56DE;&#x6536;&#x5360;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#xFF0C;&#x56DE;&#x6536;&#x53EF;&#x7528;&#x7684;&#x7A7A;&#x95F4;&#x4EE5;&#x94FE;&#x8868;&#x5F62;&#x5F0F;&#x7EF4;&#x62A4;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;**&#x5728;CMS&#x4E2D;&#xFF0C;&#x8FD9;&#x4E00;&#x6B65;&#x64CD;&#x4F5C;&#x5E76;&#x4E0D;&#x4F1A;&#x538B;&#x7F29;&#x8001;&#x5E74;&#x4EE3;&#x3002;**  &#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x968F;&#x7740;&#x65F6;&#x95F4;&#x63A8;&#x79FB;&#xFF0C;&#x8001;&#x5E74;&#x4EE3;&#x53EF;&#x80FD;&#x4EA7;&#x751F;&#x5F88;&#x591A;&#x5185;&#x5B58;&#x788E;&#x7247;&#xFF0C;&#x5F53;&#x8001;&#x5E74;&#x4EE3;&#x6CA1;&#x5408;&#x9002;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x6765;&#x5BB9;&#x7EB3;&#x5E74;&#x8F7B;&#x4EE3;&#x63D0;&#x5347;&#x7684;&#x5BF9;&#x8C61;&#x65F6;, &#x4E00;&#x4E2A;```promotion failed```&#x7684;&#x73B0;&#x8C61;&#x5C06;&#x4F1A;&#x4ECE;GC&#x65E5;&#x5FD7;&#x4E2D;&#x770B;&#x51FA;&#x6765;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;
<pre>
2016-08-19T15:48:11.956+0800: 560178.485: [GC (Allocation Failure) 2016-08-19T15:48:11.956+0800: 560178.485: [ParNew (promotion failed): <br>1839059K-&gt;1887488K(1887488K), 0.6432587 secs]2016-08-19T15:48:12.599+0800: 560179.129: [CMS: 7287285K-&gt;1382254K(10485760K), 49.4752022 secs] <br>8980348K-&gt;1382254K(12373248K), [Metaspace: 51114K-&gt;51114K(1095680K)], 50.1263301 secs] [Times: user=5.94 sys=0.58, real=50.12 secs]
</pre>
&#x5F53;&#x5E74;&#x8F7B;&#x4EE3;&#x53D1;&#x751F;```promotion failed```&#x73B0;&#x8C61;&#x65F6;&#xFF0C;&#x89E6;&#x53D1;&#x4E00;&#x4E2A;[```Concurrent Mode Failure```](https://blogs.oracle.com/poonam/entry/troubleshooting_long_gc_pauses)&#x7684;mark&#xFF0D;sweep-compact&#x7684;&#x5783;&#x573E;&#x56DE;&#x6536;&#x673A;&#x5236;(&#x5B9E;&#x9645;&#x4E0A;&#x662F;[Serial Old](https://blogs.oracle.com/jonthecollector/entry/our_collectors),&#x4E00;&#x79CD;&#x5355;&#x7EBF;&#x7A0B;&#x4E32;&#x884C;&#x7684;&#x5783;&#x573E;&#x56DE;&#x6536;&#x673A;&#x5236;)&#xFF0C;&#x8FD9;&#x79CD;&#x5783;&#x573E;&#x56DE;&#x6536;&#x673A;&#x5236;&#x4F1A;&#x5C06;&#x8FD9;&#x4E2A;&#x5E94;&#x7528;&#x6682;&#x505C;(stop-the-world), &#x538B;&#x7F29;&#x8001;&#x5E74;&#x4EE3;&#x3002;&#x8FD9;&#x6761;&#x65E5;&#x5FD7;&#x8868;&#x660E;&#xFF0C;&#x5F53;&#x5E74;&#x8F7B;&#x4EE3;&#x5C1D;&#x8BD5;&#x53D1;&#x751F;GC&#x65F6;(&#x5728;&#x5B9E;&#x9645;&#x4E0A;&#x5E76;&#x672A;&#x53D1;&#x751F;)&#xFF0C;&#x9884;&#x4F30;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x7684;&#x91CF;&#x8981;&#x5927;&#x4E8E;&#x5E74;&#x8001;&#x4EE3;&#x53EF;&#x7528;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;(&#x5E74;&#x8001;&#x4EE3;&#x5B58;&#x5728;&#x5185;&#x5B58;&#x788E;&#x7247;), &#x6B64;&#x65F6;&#x5728;&#x8001;&#x5E74;&#x4EE3;&#x4E2D;&#xFF0C;&#x53D1;&#x751F;&#x4E86;&#x4E00;&#x4E2A;&#x957F;&#x8FBE;50.12s&#x7684;&#x6682;&#x505C;&#x5E94;&#x7528;&#x7684;&#x5783;&#x573E;&#x56DE;&#x6536;&#x5E76;&#x538B;&#x7F29;&#x8001;&#x5E74;&#x4EE3;&#x3002;&#x8FD9;&#x8868;&#x660E;&#xFF0C;promote&#x5BF9;&#x8C61;&#x7684;&#x5927;&#x5C0F;&#x5728;&#x6700;&#x574F;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x53EF;&#x80FD;&#x662F;&#x6574;&#x4E2A;&#x5E74;&#x8F7B;&#x4EE3;&#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x3002;

&#x5F88;&#x5947;&#x7279;&#xFF0C;&#x5728;&#x6211;&#x4EEC;&#x7684;gc&#x65E5;&#x5FD7;&#x4E2D;&#xFF0C;&#x540C;&#x6837;&#x53D1;&#x73B0;&#x6709;&#x8FD9;&#x6837;&#x7684;&#x4E00;&#x6761;&#x65E5;&#x5FD7;&#xFF1A;
<pre>
2016-08-22T05:37:00.136+0800: 2045776.564: [Full GC (Allocation Failure) 2045776.564: [CMS: 9204801K-&gt;2109938K(11049408K), <br>3.2929131 secs] 10530771K-&gt;2109938K(12429568K), [Metaspace: 52418K-&gt;52418K(1097728K)], 3.2931250 secs] [Times: user=3.26 sys=0.02, real=3.29 secs]
</pre>

<p>&#x8FD9;&#x6761;&#x65E5;&#x5FD7;&#x8868;&#x660E;&#xFF0C;&#x5F53;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x5927;&#x7684;&#x5BF9;&#x8C61;&#x65F6;&#xFF0C;&#x5BF9;&#x8C61;&#x662F;&#x76F4;&#x63A5;&#x5206;&#x914D;&#x5230;&#x8001;&#x5E74;&#x4EE3;&#x4E2D;&#xFF0C;&#x7136;&#x800C;&#x5728;&#x8001;&#x5E74;&#x4EE3;&#x5E76;&#x6CA1;&#x6709;&#x5408;&#x9002;&#x7684;&#x5185;&#x5B58;&#x6765;&#x653E;&#x7F6E;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#xFF0C;&#x5F15;&#x53D1;&#x7684;&#x4E00;&#x6B21;Full GC(stop-the-world).<br></p>
<p>&#x884C;&#x4E3A;&#x81F3;&#x6B64;&#xFF0C;&#x4E4B;&#x524D;&#x4E00;&#x76F4;&#x542C;&#x522B;&#x4EBA;&#x8BF4;&#x5230;&#xFF0C;&#x8981;&#x9632;&#x6B62;Full GC&#xFF0C;&#x5176;&#x5B9E;&#x8FD9;&#x5E76;&#x4E0D;&#x6307;&#x7684;&#x662F;&#x8001;&#x5E74;&#x4EE3;&#x53D1;&#x751F;&#x7684;GC&#xFF0C;&#x800C;&#x662F;&#x5B58;&#x5728;&#x538B;&#x7F29;&#x5185;&#x5B58;&#x4EFB;&#x52A1;(&#x8FD9;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x53C2;&#x6570;&#x914D;&#x7F6E;&#xFF0C;&#x5F53;&#x53D1;&#x751F;&#x591A;&#x5C11;&#x6B21;&#x8FD9;&#x6837;&#x7684;&#x60C5;&#x51B5;&#x65F6;&#xFF0C;&#x5BF9;&#x8001;&#x5E74;&#x4EE3;&#x8FDB;&#x884C;&#x538B;&#x7F29;)&#x7684;GC&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x53EF;&#x4EE5;&#x7ED9;&#x51FA;&#x4EE5;&#x4E0B;&#x4E00;&#x4E9B;&#x5B9A;&#x4E49;&#xFF1A;</p>
<pre>
  1, minor GC,  &#x6307;&#x7684;&#x662F;&#x53D1;&#x751F;&#x5728;&#x5E74;&#x8F7B;&#x4EE3;&#x4E0A;&#x7684;mark&#xFF0D;copy&#x5783;&#x573E;&#x56DE;&#x6536;&#xFF0C;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x4F1A;&#x6682;&#x505C;&#x6574;&#x4E2A;&#x5E94;&#x7528;&#xFF1B;
  2&#xFF0C;major GC&#xFF0C;  &#x6307;&#x7684;&#x662F;&#x53D1;&#x751F;&#x5728;&#x8001;&#x5E74;&#x4EE3;&#x4E0A;&#x7684;GC&#xFF0C;CMS&#x7B97;&#x6CD5;&#x5927;&#x90E8;&#x5206;&#x7684;&#x8FC7;&#x7A0B;&#x90FD;&#x4E0D;&#x7528;&#x6682;&#x505C;&#x5E94;&#x7528;&#xFF1B;
  3&#xFF0C;Full GC&#xFF0C;   &#x5B58;&#x5728;&#x538B;&#x7F29;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x5408;&#x5E76;&#x788E;&#x7247;&#x4EFB;&#x52A1;&#x7684;&#x5783;&#x573E;&#x56DE;&#x6536;&#x3002;&#x5F53;&#x53D1;&#x751F;&#x65F6;&#xFF0C;concurrent-mark-sweep&#x53D8;&#x6210;mark-sweep-compact&#x5783;&#x573E;&#x56DE;&#x6536;&#x673A;&#x5236;&#x3002;
</pre>

<p>&#x7136;&#x800C;&#xFF0C;&#x4F1A;&#x5B58;&#x5728;&#x4E00;&#x4E9B;&#x8BEF;&#x533A;&#xFF0C;&#x5F53;&#x4F7F;&#x7528;jstat&#x547D;&#x4EE4;&#x67E5;&#x770B;&#x67D0;&#x4E2A;&#x8FDB;&#x7A0B;&#x7684;GC&#x60C5;&#x51B5;&#x65F6;&#xFF0C;&#x53D1;&#x73B0;FGC&#x4E00;&#x680F;&#x7684;&#x6307;&#x6807;&#x4E2D;&#xFF0C;&#x5B58;&#x5728;FGC &gt; 0&#x7684;&#x73B0;&#x8C61;&#xFF0C;&#x7136;&#x800C;&#x5728;GC&#x65E5;&#x5FD7;&#x4E2D;&#xFF0C;&#x5374;&#x53C8;&#x770B;&#x4E0D;&#x5230;mark-sweep-compact&#x5783;&#x573E;&#x56DE;&#x6536;&#x7684;&#x5B58;&#x5728;&#x3002;<strong>&#x8FD9;&#x4E2A;&#x6307;&#x6807;&#x7684;&#x542B;&#x4E49;&#x662F;major GC&#x4EE5;&#x53CA;Full GC&#x6682;&#x505C;&#x5E94;&#x7528;&#x7684;&#x6B21;&#x6570;&#xFF0C;&#x4E00;&#x6B21;CMS&#x7684;major GC&#x6682;&#x505C;&#x5E94;&#x7528;&#x4E24;&#x6B21;&#xFF0C;&#x4E00;&#x6B21;Full GC&#x6682;&#x505C;&#x4E00;&#x6B21;&#xFF0C; &#x8FD9;&#x4E2A;&#x53EF;&#x4EE5;&#x548C;&#x65E5;&#x5FD7;&#x4E0A;&#x7684;&#x8BB0;&#x5F55;&#x5339;&#x914D;&#xFF0C;&#x603B;&#x8017;&#x8D39;&#x65F6;&#x95F4;&#x4E5F;&#x5339;&#x914D;&#x5F97;&#x4E0A;&#x3002;</strong></p>
<p>&#x5E74;&#x8F7B;&#x4EE3;&#x7684;GC&#xFF0C;&#x662F;&#x7531;&#x4E8E;&#x5728;&#x5E74;&#x8F7B;&#x4EE3;&#x7684;Eden&#x533A;&#x57DF;&#x5185;&#x6CA1;&#x6709;&#x5408;&#x9002;&#x7684;&#x5185;&#x5B58;&#x6765;&#x5206;&#x914D;&#x8BE5;&#x5BF9;&#x8C61;&#x3002;&#x5728;&#x8FD9;&#x6837;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4F4D;&#x4E8E;eden&#x4EE5;&#x53CA;survivor&#x533A;&#x57DF;&#x5185;&#x7684;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#x5C06;&#x4F1A;&#x88AB;&#x62F7;&#x8D1D;&#x5230;&#x53E6;&#x4E00;&#x4E2A;survivor&#x533A;&#xFF0C;&#x540C;&#x65F6;&#x8FD9;&#x4E24;&#x4E2A;&#x533A;&#x57DF;&#x4F1A;&#x88AB;&#x6E05;&#x7A7A;&#xFF0C;&#x5728;&#x4EFB;&#x610F;&#x65F6;&#x523B;&#xFF0C;&#x6709;&#x4E14;&#x4EC5;&#x6709;&#x4E00;&#x4E2A;survivor&#x662F;active&#x7684;(&#x53CC;buffer)&#xFF08;&#x8FD9;&#x4E2A;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x65E5;&#x5FD7;&#x60C5;&#x51B5;&#x6765;&#x8BC1;&#x660E;&#xFF09;&#xFF0C; &#x5F53;&#x4E00;&#x4E9B;&#x5BF9;&#x8C61;&#x53CD;&#x590D;&#x7ECF;&#x8FC7;&#x8FD9;&#x6837;&#x7684;&#x64CD;&#x4F5C;&#x540E;(age &gt; MaxTenuringThreshold)&#xFF0C;&#x5BF9;&#x8C61;&#x4FBF;&#x4F1A;&#x63D0;&#x5347;&#x5230;&#x8001;&#x5E74;&#x4EE3;&#x3002;&#x7136;&#x800C;&#x5728;&#x5E74;&#x8F7B;&#x4EE3;&#x53D1;&#x751F;GC&#x4E4B;&#x524D;&#xFF0C;&#x5979;&#x4F1A;&#x9996;&#x5148;&#x4F30;&#x7B97;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;(&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#x6BD4;&#x5B9E;&#x9645;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#x8981;&#x7B2C;&#xFF09;&#xFF0C;&#x786E;&#x4FDD;&#x8001;&#x5E74;&#x4EE3;&#x6709;&#x8DB3;&#x591F;&#x53EF;&#x7528;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x6765;&#x5BB9;&#x7EB3;&#x4F30;&#x7B97;&#x7684;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#xFF1B;&#x5E74;&#x8001;&#x4EE3;&#x7684;GC&#x5219;&#x4E0D;&#x540C;&#xFF0C;&#x4F46;&#x539F;&#x7406;&#x7C7B;&#x4F3C;&#xFF0C;&#x90FD;&#x662F;&#x5F53;&#x89E6;&#x53D1;&#x67D0;&#x4E9B;&#x6761;&#x4EF6;&#x4E4B;&#x540E;&#x8FDB;&#x884C;&#x7684;&#x3002;&#x5B83;&#x4EEC;&#x90FD;&#x662F;&#x4E00;&#x79CD;&#x57FA;&#x4E8E;&#x4E8B;&#x4EF6;&#x89E6;&#x53D1;&#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x4E0D;&#x53EF;&#x9884;&#x6D4B;&#x4E8B;&#x4EF6;&#x53D1;&#x751F;&#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x4F46;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;GC&#x53D1;&#x751F;&#x7684;&#x76F8;&#x5173;&#x6761;&#x4EF6;&#xFF0C;&#x8FD9;&#x4E5F;&#x5C31;&#x662F;GC&#x8C03;&#x4F18;&#x3002;<br>&#x5728;&#x5E74;&#x8F7B;&#x4EE3;&#x4E2D;&#xFF0C;&#x5982;&#x4F55;&#x5206;&#x914D;&#x5185;&#x5B58;&#x7684;&#xFF0C;&#x7EC6;&#x8282;&#x53EF;&#x53C2;&#x8003;<a href="https://blogs.oracle.com/daviddetlefs/entry/tlab_sizing_an_annoying_little" target="_blank" rel="external">Thread Local Allocation Buffer</a>.</p>
<p>&#x6700;&#x540E;&#xFF0C;&#x5F15;&#x5165;&#x4E00;&#x5F20;&#x8001;&#x56FE;&#x7247;&#x8BF4;&#x660E;CMS GC&#x4E3A;&#x4EC0;&#x4E48;&#x662F;&#x4E00;&#x4E2A;&#x4F4E;&#x5EF6;&#x8FDF;&#x7684;GC&#xFF1A;<br><img src="/GC/CMS_GC.png" alt="CMS_GC.png" title=""></p>
<p>&#x5BF9;&#x4E8E;&#x5982;&#x4F55;&#x9632;&#x6CBB;CMS&#x5185;&#x5B58;&#x788E;&#x7247;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x51CF;&#x5C11;promotion&#x7684;&#x6B21;&#x6570;&#xFF0C;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x5E38;&#x89C4;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x8BA9;&#x8001;&#x5E74;&#x4EE3;&#x7684;&#x5783;&#x573E;&#x56DE;&#x6536;&#x63D0;&#x524D;&#x5230;&#x6765;&#x3002;<a href="https://blogs.oracle.com/jonthecollector/entry/when_the_sum_of_the" target="_blank" rel="external">&#x67E5;&#x770B;&#x5982;&#x4F55;&#x6CBB;&#x7406;&#x5185;&#x5B58;&#x788E;&#x7247;</a></p>
<blockquote>
<p>&#x4E24;&#x4E2A;&#x6307;&#x6807;<br></p>
</blockquote>
<p>  <em>Latency</em>:&#x5355;&#x4E2A;&#x4EFB;&#x52A1;&#x5B8C;&#x6210;&#x7684;&#x65F6;&#x95F4;&#xFF0C;&#x5173;&#x6CE8;&#x7684;&#x662F;&#x4E2A;&#x4F53;&#x6027;&#x7684;&#x4EFB;&#x52A1;&#x5B8C;&#x6210;&#x65F6;&#x95F4;&#x3002;&#x4E00;&#x4E9B;&#x5E38;&#x89C1;&#x7684;&#x63CF;&#x8FF0;&#x6709;&#xFF1A;<br><br>  <pre><br>    1, 99%&#x7684;&#x8BF7;&#x6C42;&#x9700;&#x8981;&#x5728;1s&#x4E4B;&#x5185;&#x8FD4;&#x56DE;&#xFF1B;<br>    2&#xFF0C;&#x6240;&#x6709;&#x4E8B;&#x52A1;&#x6027;&#x64CD;&#x4F5C;&#x4E0D;&#x8D85;&#x8FC7;10s&#xFF1B;<br>  </pre></p>
<p>  &#x5982;&#x4F55;&#x8BC4;&#x4F30;&#xFF1F;&#x6267;&#x884C;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#xFF0C;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x83B7;&#x53D6;&#x8BA1;&#x7B97;&#x8D44;&#x6E90;&#xFF0C;&#x8BA1;&#x7B97;&#x4EE5;&#x53CA;&#x5B58;&#x50A8;&#x7ED3;&#x679C;&#xFF0C;&#x8FD9;&#x9700;&#x8981;&#x8017;&#x8D39;&#x4E00;&#x5B9A;&#x7684;&#x65F6;&#x95F4;&#x3002;&#x901A;&#x8FC7;&#x5404;&#x79CD;&#x65E5;&#x5FD7;&#x5DE5;&#x5177;&#x5206;&#x6790;&#xFF0C;&#x53EF;&#x4EE5;&#x5927;&#x81F4;&#x5F97;&#x5230;&#x8FD9;&#x6837;&#x7684;&#x65F6;&#x95F4;&#x3002;&#x5047;&#x8BBE;&#x7531;&#x4E8E;GC&#x5BFC;&#x81F4;&#x7684;&#x6682;&#x505C;&#x65F6;&#x95F4;&#x4E0D;&#x8D85;&#x8FC7;&#x4E2D;&#x8BF7;&#x6C42;&#x65F6;&#x95F4;&#x7684;10%, &#x5219;&#x53EF;&#x4EE5;&#x5F97;&#x51FA;99%&#x7684;GC&#x4E0D;&#x80FD;&#x8D85;&#x8FC7;100ms&#xFF0C;&#x6240;&#x6709;&#x7684;GC&#x6700;&#x957F;&#x65F6;&#x95F4;&#x4E0D;&#x53EF;&#x4EE5;&#x8D85;&#x8FC7;1s&#x3002;</p>
<p>  <em>Throughput</em>:&#x5728;&#x67D0;&#x4E2A;&#x65F6;&#x95F4;&#x5355;&#x4F4D;&#x5185;&#xFF0C;&#x5B8C;&#x6210;&#x7684;&#x4EFB;&#x52A1;&#x603B;&#x91CF;&#xFF0C;&#x5173;&#x6CE8;&#x4E8E;&#x603B;&#x4F53;&#x6548;&#x679C;&#x3002;&#x7C7B;&#x4F3C;&#x7684;&#x63CF;&#x8FF0;&#x6709;&#xFF1A;<br></p>
<pre>
   1, &#x7CFB;&#x7EDF;&#x9700;&#x8981;1min&#x5904;&#x7406;1000&#x6761;&#x4E8B;&#x52A1;&#xFF1B;
   2&#xFF0C;&#x6240;&#x6709;&#x987E;&#x5BA2;&#x7684;&#x4E00;&#x5468;&#x5185;&#x7684;&#x5206;&#x6790;&#x6570;&#x636E;&#x5FC5;&#x987B;&#x5728;&#x5468;&#x4E00;6&#x70B9;&#x4E4B;&#x524D;&#x5B8C;&#x6210;&#xFF0C;&#x4ECE;&#x51CC;&#x6668;0&#x70B9;&#x5F00;&#x59CB;&#xFF0C;&#x4E0D;&#x8D85;&#x8FC7;6&#x4E2A;&#x5C0F;&#x65F6;&#x3002;
</pre>

<p>&#x4F9D;&#x7136;&#x5206;&#x6790;&#x8FD9;&#x6837;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x5047;&#x8BBE;&#x6700;&#x591A;10%&#x7684;&#x65F6;&#x95F4;&#x53EF;&#x7528;&#x4E8E;GC&#xFF0C;&#x90A3;&#x4E48;&#x5728;&#x4EFB;&#x610F;1min&#x4E2D;&#x5185;&#xFF0C;GC&#x7684;&#x603B;&#x65F6;&#x95F4;&#x4E0D;&#x8D85;&#x8FC7;6s&#x3002;</p>
<p></p><h2>&#x8C03;&#x4F18;&#x76EE;&#x6807;</h2><p></p>
<li>&#x5355;&#x6B21;GC&#x7684;&#x6700;&#x5927;&#x65F6;&#x95F4;&#x4E0D;&#x5F97;&#x8D85;&#x8FC7;1s&#x3002;</li><br><li>99%&#x7684;minor GC&#x9700;&#x8981;&#x5728;30ms &#xFF5E; 40ms&#x3002;</li><br><li>&#x5F53;&#x7CFB;&#x7EDF;&#x7E41;&#x5FD9;&#x65F6;&#xFF0C;1min&#x4E4B;&#x5185;&#xFF0C;minor GC&#x603B;&#x65F6;&#x95F4;&#x4E0D;&#x5F97;&#x8D85;&#x8FC7;1s</li>


<p><strong>GC&#x6700;&#x96BE;&#x7684;&#x90E8;&#x5206;&#xFF0C;&#x5982;&#x4F55;&#x5728;&#x65B0;&#x751F;&#x4EE3;&#x548C;&#x8001;&#x5E74;&#x4EE3;&#x4E4B;&#x95F4;&#x53D6;&#x5F97;&#x4E00;&#x4E2A;&#x5E73;&#x8861;&#x3002;</strong>&#x5E86;&#x5E78;&#x7684;&#x662F;&#xFF0C;&#x5728;&#x8FD9;&#x65B9;&#x9762;&#x53EF;&#x4EE5;&#x6709;&#x5F88;&#x591A;&#x7684;&#x7ECF;&#x9A8C;&#x503C;&#x503C;&#x5F97;&#x501F;&#x9274;&#xFF0C;&#x6709;<a href="https://docs.oracle.com/cd/E19900-01/819-4742/abeik/index.html" target="_blank" rel="external">1/3</a>, &#x4E5F;&#x6709;&#x8BBE;&#x7F6E;<a href="https://engineering.linkedin.com/garbage-collection/garbage-collection-optimization-high-throughput-and-low-latency-java-applications" target="_blank" rel="external">1/6</a>,&#x66FE;&#x7ECF;&#x4E5F;&#x770B;&#x5230;&#x8FC7;&#x5E74;&#x8F7B;&#x4EE3;&#x53EA;&#x6709;200m&#xFF0C;&#x800C;&#x5E74;&#x8001;&#x4EE3;&#x5360;&#x7528;10+g&#x7684;&#xFF0C;&#x7B49;&#x7B49;&#x3002;&#x611F;&#x89C9;&#x8FD9;&#x6837;&#x7684;&#x95EE;&#x9898;&#x4F3C;&#x4E4E;&#x662F;&#x6BEB;&#x65E0;&#x7AE0;&#x6CD5;&#x53EF;&#x8A00;&#xFF0C;&#x4E5F;&#x8BB8;&#x5C31;&#x50CF;<a href="https://docs.oracle.com/cd/E19900-01/819-4742/abeik/index.html" target="_blank" rel="external">&#x8FD9;&#x91CC;</a>&#x63CF;&#x8FF0;&#xFF0C;&#x6839;&#x636E;&#x6027;&#x80FD;&#x6307;&#x6807;&#xFF0C;&#x753B;&#x51FA;&#x4E00;&#x4E2A;&#x56FE;&#xFF0C;&#x5728;&#x56FE;&#x4E2D;&#x627E;&#x51FA;&#x4E00;&#x4E2A;&#x6700;&#x4F73;&#x7684;&#x5339;&#x914D;&#x70B9;?</p>
<p>&#x5728;&#x8D44;&#x6E90;&#x65E0;&#x9650;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5E94;&#x7528;&#x7684;&#x5EF6;&#x8FDF;&#x548C;&#x541E;&#x5410;&#x91CF;&#x4E0D;&#x4F1A;&#x53D7;&#x5230;GC&#x7684;&#x5F71;&#x54CD;&#x3002;&#x4F46;&#x5728;&#x5B9E;&#x9645;&#x4E2D;&#xFF0C;&#x60C5;&#x51B5;&#x5374;&#x5E76;&#x975E;&#x8FD9;&#x6837;&#xFF0C;&#x4F46;&#x6211;&#x4EEC;&#x4ECD;&#x7136;&#x60F3;&#x5C3D;&#x91CF;&#x8BA9;GC&#x5BF9;&#x5E94;&#x7528;&#x9020;&#x6210;&#x7684;&#x5F71;&#x54CD;&#x8FBE;&#x5230;&#x6700;&#x5C0F;&#x3002;&#x5BF9;&#x4E8E;&#x4E00;&#x4E2A;&#x590D;&#x6742;&#x7684;&#x7CFB;&#x7EDF;&#x6765;&#x8BF4;&#xFF0C;&#x4E00;&#x4E9B;&#x8C03;&#x4F18;&#x7684;&#x7ECF;&#x9A8C;&#x5177;&#x6709;&#x5F88;&#x5927;&#x7684;&#x6307;&#x5BFC;&#x610F;&#x4E49;&#x3002;&#x7136;&#x800C;&#x5343;&#x4EBA;&#x5343;&#x9762;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x4E00;&#x4E2A;&#x89E3;&#x51B3;&#x6240;&#x6709;&#x95EE;&#x9898;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<p>GC&#x65E5;&#x5FD7;&#x662F;&#x8C03;&#x4F18;&#x8FC7;&#x7A0B;&#x6700;&#x4E0D;&#x53EF;&#x6216;&#x7F3A;&#x7684;&#x6750;&#x6599;&#xFF0C;&#x521D;&#x671F;&#x8981;&#x5C3D;&#x91CF;&#x4E30;&#x5BCC;&#x65E5;&#x5FD7;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x8FD9;&#x91CC;&#x4E00;&#x4E9B;&#x6BD4;&#x8F83;&#x5E38;&#x89C1;&#x7684;&#x547D;&#x4EE4;&#x6709;&#xFF1A;</p>
<pre>
-XX:+PrintTenuringDistribution
-XX:+PrintPromotionFailure
-XX:+PrintGCDateStamps
-XX:+PrintGCDetails
-XX:+PrintHeapAtGC
-Xloggc:$file
-XX:+PrintGCApplicationStoppedTime
</pre>

<p>&#x5BF9;&#x4E8E;&#x5E74;&#x8F7B;&#x4EE3;&#x6765;&#x8BF4;&#xFF0C;&#x5C3D;&#x91CF;&#x4E0D;&#x8BA9;&#x5BF9;&#x8C61;&#x5728;&#x4E24;&#x4E2A;survivor&#x533A;&#x57DF;&#x5185;&#x62F7;&#x6765;&#x62F7;&#x53BB;&#xFF0C;&#x964D;&#x4F4E;minorGC&#x7684;&#x9891;&#x5EA6;&#xFF0C;&#x964D;&#x4F4E;&#x5411;&#x8001;&#x5E74;&#x4EE3;&#x63D0;&#x5347;&#x5BF9;&#x8C61;&#x7684;&#x5927;&#x5C0F;&#x548C;&#x9891;&#x5EA6;&#x3002;&#x5BF9;&#x4E8E;&#x8001;&#x5E74;&#x4EE3;&#x6765;&#x8BF4;&#xFF0C;&#x5219;&#x8981;&#x6C42;&#x8001;&#x5E74;&#x4EE3;GC&#x9891;&#x5EA6;&#x8D8A;&#x597D;&#xFF0C;&#x8001;&#x5E74;&#x4EE3;&#x80FD;&#x591F;&#x63D0;&#x524D;GC&#xFF0C;&#x51CF;&#x5C11;&#x53D1;&#x751F;promotion fail&#x7684;&#x73B0;&#x8C61;&#x3002;&#x9274;&#x4E8E;&#x4F4E;&#x5EF6;&#x8FDF;&#x7684;&#x9700;&#x6C42;&#xFF0C;&#x6211;&#x4EEC;&#x4F9D;&#x636E;&#x4E00;&#x4E9B;&#x7ECF;&#x9A8C;&#xFF0C;&#x9009;&#x62E9;&#x4E86;CMS&#x6765;&#x56DE;&#x6536;&#x8001;&#x5E74;&#x4EE3;&#xFF0C;&#x4F7F;&#x7528;&#x4E0E;&#x4E4B;&#x914D;&#x5957;&#x7684;UseParNewGC&#x6765;&#x56DE;&#x6536;&#x5E74;&#x8F7B;&#x4EE3;&#x3002;</p>
<pre>
-XX:+UseParNewGC
-XX:+UseConcMarkSweepGC
</pre>

<p>&#x4E4B;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x7CFB;&#x7EDF;&#x5E76;&#x6CA1;&#x6709;&#x8BBE;&#x7F6E;&#x5E74;&#x8F7B;&#x4EE3;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x53EA;&#x8BBE;&#x7F6E;&#x4E86;&#x6700;&#x5927;&#x53EF;&#x7528;&#x7684;&#x5185;&#x5B58;(-Xmx)&#x3002; &#x8FD9;&#x6837;&#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x5728;&#x6709;&#x4E9B;&#x673A;&#x5668;&#x4E0A;&#x4E5F;&#x53EF;&#x4EE5;&#x8FBE;&#x5230;&#x4E00;&#x4E9B;&#x5F88;&#x597D;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x541E;&#x5410;&#x91CF;&#x8FBE;&#x5230;99.83%&#xFF0C;&#x7136;&#x800C;&#x5176;&#x6700;&#x5927;GC&#x65F6;&#x95F4;&#x8FBE;&#x5230;32s&#xFF0C;&#x6709;&#x4E9B;&#x673A;&#x5668;&#x6682;&#x505C;&#x65F6;&#x95F4;&#x8D85;&#x8FC7;60s&#x800C;&#x88AB;&#x8BEF;&#x8BA4;&#x4E3A;&#x662F;&#x4E00;&#x4E2A;&#x5DF2;&#x7ECF;&#x5954;&#x6E83;&#x7684;&#x673A;&#x5668;&#xFF0C;&#x5BFC;&#x81F4;&#x6574;&#x4E2A;&#x5E94;&#x7528;&#x9000;&#x51FA;&#x3002;</p>
<blockquote>
<p>GC&#x4E00;&#x4E9B;&#x6027;&#x80FD;&#x6307;&#x6807;&#x3002;<br><img src="/GC/gc_states.png" alt="gc_states.png" title=""><br>GC &#x65F6;&#x95F4;&#x8D85;&#x8FC7;60s&#x5BFC;&#x81F4;&#x5E94;&#x7528;&#x9000;&#x51FA;&#x3002;</p>
<pre>
2016-08-13 04:11:37,655 WARN  [JvmPauseMonitor] util.JvmPauseMonitor: Detected pause in JVM or host machine (eg GC): pause of approximately 99244ms
GC pool &apos;ParNew&apos; had collection(s): count=1 time=1091ms
GC pool &apos;ConcurrentMarkSweep&apos; had collection(s): count=1 time=98532ms
</pre>

</blockquote>
<p>&#x8FD9;&#x5E76;&#x4E0D;&#x662F;&#x6211;&#x4EEC;&#x6240;&#x671F;&#x671B;&#x7684;&#x3002;&#x4F5C;&#x4E3A;&#x540E;&#x53F0;&#x670D;&#x52A1;&#xFF0C;&#x6211;&#x4EEC;&#x6240;&#x671F;&#x671B;&#x7684;&#x662F;&#x670D;&#x52A1;&#x7A33;&#x5B9A;&#xFF0C;&#x5728;&#x7A33;&#x5B9A;&#x7684;&#x57FA;&#x7840;&#x4E4B;&#x4E0A;&#xFF0C;&#x5173;&#x6CE8;&#x6027;&#x80FD;&#x7684;&#x63D0;&#x5347;&#x3002;<br><br><strong>1, &#x8BBE;&#x7F6E;&#x5E74;&#x8F7B;&#x4EE3;&#x5927;&#x5C0F;&#x4E3A;2g&#xFF0C;&#x5E74;&#x8F7B;&#x4EE3;maxAge&#xFF1D;10(&#x9ED8;&#x8BA4;&#x4E3A;8)&#xFF0C; &#x5E76;&#x589E;&#x52A0;gc&#x65E5;&#x5FD7;&#x5BF9;&#x8C61;&#x5E74;&#x9F84;&#x5206;&#x5E03;&#x8F93;&#x51FA;&#x3002;</strong></p>
<pre>
  -Xmn2g
  -XX:MaxTenuringThreshold=10
  -XX:+PrintTenuringDistribution
</pre>

<p>&#x7136;&#x800C;&#xFF0C;&#x5728;&#x9AD8;&#x5CF0;&#x671F;&#x65F6;&#xFF0C;GC&#x6682;&#x505C;&#x65F6;&#x95F4;&#x8D85;&#x8FC7;50s&#xFF0C;&#x5BFC;&#x81F4;&#x5E94;&#x7528;&#x9000;&#x51FA;&#x3002;&#x8FD9;&#x6837;&#x7684;&#x60C5;&#x51B5;&#x6BD4;&#x539F;&#x6765;&#x66F4;&#x7CDF;&#x7CD5;&#xFF1A;</p>
<pre>
2016-08-19T15:47:53.882+0800: 560160.411: [GC (Allocation Failure) 2016-08-19T15:47:53.882+0800: 560160.411: [ParNew
Desired survivor size 107347968 bytes, new threshold 1 (max 10)
- age   1:  160893280 bytes,  160893280 total
  : 1887488K-&gt;161235K(1887488K), 3.3464076 secs] 8970842K-&gt;7302524K(12373248K), 3.3466849 secs] [Times: user=57.36 sys=0.00, real=3.35 secs]
  2016-08-19T15:48:11.956+0800: 560178.485: [GC (Allocation Failure) 2016-08-19T15:48:11.956+0800: 560178.485: [ParNew (promotion failed): 1839059K-&gt;1887488K(1887488K), 0.6432587 secs]2016-08-19T15:48:12.599+0800: 560179.129: [CMS: 7287285K-&gt;1382254K(10485760K), 49.4752022 secs] 8980348K-&gt;1382254K(12373248K), [Metaspace: 51114K-&gt;51114K(1095680K)], 50.1263301 secs] [Times: user=5.94 sys=0.58, real=50.12 secs]
  </pre>

<p>&#x5206;&#x6790;&#x8FD9;&#x6BB5;GC&#x65E5;&#x5FD7;&#xFF0C;&#x4E0A;&#x4E00;&#x6B21;GC&#x53D1;&#x751F;&#x65F6;&#xFF0C;survivor&#x5185;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#x5927;&#x81F4;&#x6709;161M&#x3002;eden&#x533A;&#x57DF;&#x5185;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#x5728;107M&#xFF0C;&#x8FD9;&#x4E9B;&#x5BF9;&#x8C61;&#x8981;&#x88AB;&#x62F7;&#x8D1D;&#x5230;survivor&#x4E2D;&#xFF0C;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x7684;&#x5927;&#x5C0F;&#x8D85;&#x8FC7;&#x4E00;&#x4E2A;survivor&#x5185;&#x5B58;&#x7684;50%(&#x4E00;&#x4E2A;survivor&#x7684;&#x5927;&#x5C0F;&#x5728;188.7M&#xFF09;&#xFF0C;&#x4E8E;&#x662F;&#x5C06;&#x5BF9;&#x8C61;&#x7684;tenure age&#x4ECE;10&#x53D8;&#x6210;1, age 1 &#x6EE1;&#x8DB3;total(age1&#xFF0B;&#x2026;+agex)&#xFF0F;young &gt; 50%. &#x56E0;&#x6B64;&#x5F53;&#x4E0B;&#x4E00;&#x6B21;&#x5E74;&#x8F7B;&#x4EE3;GC&#x53D1;&#x751F;&#x65F6;&#xFF0C;&#x6574;&#x4E2A;&#x5E74;&#x8F7B;&#x4EE3;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#x5C06;&#x88AB;&#x76F4;&#x63A5;&#x63D0;&#x5347;&#x5230;&#x8001;&#x5E74;&#x4EE3;&#x4E2D;&#x3002;&#x5728;&#x8FDB;&#x884C;young GC&#x65F6;&#xFF0C;jvm&#x9996;&#x5148;&#x8981;&#x4FDD;&#x8BC1;&#x5728;&#x8001;&#x5E74;&#x4EE3;&#x4E2D;&#x6709;&#x8DB3;&#x591F;&#x5927;&#x7684;&#x7A7A;&#x95F4;&#x80FD;&#x591F;&#x5BB9;&#x7EB3;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x7136;&#x800C;&#x8FD9;&#x5E76;&#x4E0D;&#x80FD;&#x88AB;&#x4FDD;&#x8BC1;&#x3002;&#x4E00;&#x6B21;&#x957F;&#x8FBE;50s&#x7684;Full GC&#x88AB;&#x89E6;&#x53D1;&#x2026;</p>
<p>&#x51FA;&#x73B0;&#x8FD9;&#x4E2A;&#x65E5;&#x5FD7;&#xFF0C;&#x8868;&#x660E;&#x5728;&#x7CFB;&#x7EDF;&#x7E41;&#x5FD9;&#x65F6;&#xFF0C;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x5927;&#x7684;&#x5E74;&#x8F7B;&#x4EE3;&#x5E76;&#x4E0D;&#x4F1A;&#x8D77;&#x5230;&#x5E94;&#x6709;&#x7684;&#x4F5C;&#x7528;&#xFF1B;&#x540C;&#x65F6;&#xFF0C;&#x901A;&#x8FC7;&#x65E5;&#x5FD7;&#xFF0C;&#x53D1;&#x73B0;&#x5927;&#x90E8;&#x5206;&#x5BF9;&#x8C61;&#x5728;4 &#xFF5E; 6&#x4EE3;&#x65F6;&#xFF0C;&#x8FDB;&#x5165;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x7A33;&#x5B9A;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x5C06;tenure age&#x8BBE;&#x7F6E;&#x4E3A;10&#xFF0C;&#x6765;&#x56DE;&#x589E;&#x52A0;&#x4E86;4&#x6B21;&#x62F7;&#x8D1D;&#xFF0C;&#x5F71;&#x54CD;&#x5230;&#x5E74;&#x8F7B;&#x4EE3;GC&#x7684;&#x6548;&#x7387;&#x3002;</p>
<p>&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x6559;&#x8BAD;&#xFF0C;&#x9996;&#x5148;&#x60F3;&#x5230;&#x7684;&#x662F;&#x964D;&#x4F4E;&#x5E74;&#x8F7B;&#x4EE3;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x901A;&#x8FC7;&#x4E00;&#x4E9B;&#x5C31;&#x6709;&#x7684;&#x65E5;&#x5FD7;&#x53D1;&#x73B0;&#xFF0C;&#x5728;&#x672A;&#x8BBE;&#x7F6E;&#x5E74;&#x8F7B;&#x4EE3;&#x5927;&#x5C0F;&#x4E14;&#x670D;&#x52A1;&#x5DF2;&#x7ECF;&#x8FDE;&#x7EED;30&#x5929;&#x4E0D;&#x4E2D;&#x65AD;&#x7684;&#x73AF;&#x5883;&#x4E0B;&#xFF0C;&#x5E74;&#x8F7B;&#x4EE3;&#x6500;&#x5230;&#x7684;&#x6700;&#x5927;&#x503C;&#x4E3A;1.32g&#x3002;&#x901A;&#x8FC7;&#x8FD9;&#x5219;&#x4FE1;&#x606F;&#xFF0C;&#x5C06;&#x5E74;&#x8F7B;&#x4EE3;&#x7684;&#x5927;&#x5C0F;&#x53D8;&#x6210;1200m&#xFF0C;&#x5C06;tenure age&#x8BBE;&#x7F6E;&#x4E3A;6&#xFF0C;&#x540C;&#x65F6;CMSInitiatingOccupancyFraction&#x4ECE;75&#x8BBE;&#x7F6E;&#x6210;70&#xFF0C;&#x91CD;&#x65B0;&#x89C2;&#x6D4B;&#x670D;&#x52A1;GC&#x65E5;&#x5FD7;&#x3002;</p>
<pre>
   -Xmn1200m
   -XX:MaxTenuringThreshold=6
   -XX:CMSInitiatingOccupancyFraction=70
</pre>

<p>&#x4E00;&#x4E9B;&#x5173;&#x952E;&#x6307;&#x6807;&#x6570;&#x636E;&#xFF1A;<br><br>A:<br><br><img src="/GC/gc_a_states.png" alt="gc_a_states.png" title=""><br><img src="/GC/gc_a_summary.png" alt="gc_a_summary.png" title=""></p>
<p>&#x53D1;&#x73B0;&#x5728;&#x8001;&#x5E74;&#x4EE3;&#x4E2D;&#xFF0C;GC&#x8FC7;&#x4E8E;&#x9891;&#x7E41;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x8BD5;&#x56FE;&#x5C06;-XX:TargetSurvivorRatio&#x8C03;&#x5347;&#x5230;80&#x65F6;&#xFF0C;&#x867D;&#x7136;&#x8001;&#x5E74;&#x4EE3;GC&#x6574;&#x4F53;&#x4E0A;&#x6709;&#x4E86;&#x4E0B;&#x964D;&#x7684;&#x8D8B;&#x52BF;&#xFF0C;&#x7136;&#x800C;&#x5BF9;&#x4E8E;&#x5E94;&#x7528;&#x6765;&#x8BF4;&#xFF0C;&#x8FD9;&#x6837;&#x7684;&#x8C03;&#x4F18;&#x4E0D;&#x7BA1;&#x5E74;&#x8F7B;&#x4EE3;&#xFF0C;&#x8FD8;&#x662F;&#x8001;&#x5E74;&#x4EE3;&#xFF0C;&#x5E73;&#x5747;&#x7684;gc&#x6682;&#x505C;&#x65F6;&#x95F4;&#x90FD;&#x6709;&#x6240;&#x4E0A;&#x5347;&#xFF1A;<br><img src="/GC/gc_b_states.png" alt="gc_b_states.png" title=""><br><img src="/GC/gc_b_summary.png" alt="gc_b_summary.png" title=""><br>&#x8FD9;&#x6837;&#x7684;&#x8C03;&#x4F18;&#x65B9;&#x5F0F;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x4F18;&#x5316;&#x591A;&#x5C11;&#xFF0C;&#x8BE5;&#x65B9;&#x6848;&#x88AB;&#x653E;&#x5F03;&#x3002;&#x7136;&#x800C;&#x5176;&#x80FD;&#x964D;&#x4F4E;&#x8001;&#x5E74;&#x4EE3;GC&#x7684;&#x9891;&#x7387;&#x8FD8;&#x662F;&#x7ED9;&#x4EBA;&#x5370;&#x8C61;&#x6DF1;&#x523B;&#x3002; </p>
<p>&#x7B2C;&#x4E00;&#x79CD;&#x65B9;&#x6848;&#xFF0C;&#x4E5F;&#x8FD8;&#x6CA1;&#x6709;&#x8FBE;&#x5230;&#x6211;&#x4EEC;&#x7684;&#x8981;&#x6C42;&#xFF0C;&#x5BF9;&#x4E8E;&#x6211;&#x4EEC;&#x6765;&#x8BF4;&#xFF0C;&#x5C3D;&#x91CF;&#x5C06;&#x6700;&#x5927;&#x5EF6;&#x8FDF;&#x964D;&#x4F4E;&#x5230;1s&#x3002;&#x7136;&#x800C;&#x5728;GC&#x65E5;&#x5FD7;&#x4E2D;&#xFF0C;&#x8FD8;&#x662F;&#x770B;&#x5230;&#x4E86;&#x7531;&#x4E8E;promotion failed&#x7684;&#x53D1;&#x751F;&#xFF0C;&#x5C06;&#x5E94;&#x7528;&#x7684;&#x6682;&#x505C;&#x65F6;&#x95F4;&#x62C9;&#x9AD8;&#x5230;2&#xFF5E;3s&#xFF0C;10&#x5929;&#x7684;&#x65F6;&#x95F4;&#x91CC;&#xFF0C;&#x53D1;&#x751F;&#x4E86;&#x4E09;&#x6B21;&#x8FD9;&#x6837;&#x7684;&#x4E8B;&#xFF0C;&#x8FD9;&#x5BF9;&#x4E8E;&#x4E00;&#x4E2A;&#x9700;&#x6C42;&#x4F4E;&#x5EF6;&#x8FDF;&#x7684;&#x670D;&#x52A1;&#x6765;&#x8BF4;&#xFF0C;&#x8FD9;&#x6837;&#x7684;&#x6548;&#x679C;&#x8FD8;&#x662F;&#x6709;&#x4E9B;&#x4E0D;&#x592A;&#x6EE1;&#x610F;&#x7684;&#x3002;</p>
<p>&#x901A;&#x8FC7;&#x5206;&#x6790;&#x65E5;&#x5FD7;&#xFF0C;&#x53D1;&#x73B0;&#x6211;&#x4EEC;&#x7684;&#x7CFB;&#x7EDF;&#x5728;&#x7E41;&#x5FD9;&#x65F6;&#xFF0C;1s&#x4E4B;&#x5185;&#x5927;&#x6982;&#x4EA7;&#x751F;1&#xFF5E;2g&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5927;&#x6982;9/10&#x91CF;&#x7684;&#x5BF9;&#x8C61;&#x5728;&#x4E0B;&#x4E00;&#x6B21;GC&#x65F6;&#xFF0C;&#x662F;&#x88AB;&#x5F53;&#x4F5C;&#x5783;&#x573E;&#x56DE;&#x6536;&#x7684;&#xFF0C;&#x7EA6;1/10&#x7684;&#x5BF9;&#x8C61;&#x88AB;&#x62F7;&#x8D1D;&#x5230;survivor&#x533A;&#x57DF;&#xFF0C; &#x7B2C;&#x4E8C;&#x6B21;GC&#x53D1;&#x751F;&#x65F6;&#xFF0C;&#x7EA6;&#x6709;95%&#x7684;&#x5BF9;&#x8C61;&#x5B58;&#x6D3B;&#xFF0C;&#x7ECF;&#x8FC7;&#x8FD9;&#x4E24;&#x6B21;GC&#x65F6;&#xFF0C;1g&#x7684;&#x5BF9;&#x8C61;&#x53D8;&#x6210;&#xFF1A; 1000 <em> 0.1 </em> 0.95 = 95M&#x5DE6;&#x53F3;&#xFF0C;&#x5F53;&#x5E74;&#x8F7B;&#x4EE3;&#x518D;&#x53D1;&#x751F;&#x4E00;&#x6B21;GC&#x65F6;&#xFF0C;&#x8FD9;&#x4E9B;&#x5BF9;&#x8C61;&#x7684;age&#x5C06;&#x53D8;&#x6210;3&#xFF0C;&#x7EA6;70&#xFF05;&#x7684;&#x5BF9;&#x8C61;&#x5B58;&#x6D3B;&#xFF0C;&#x8FD9;&#x4E9B;&#x5BF9;&#x8C61;&#x53EF;&#x4EE5;&#x8BA4;&#x4E3A;&#x8FD9;&#x4E9B;&#x5BF9;&#x8C61;&#x53EF;&#x4EE5;&#x88AB;&#x62F7;&#x8D1D;&#x5230;&#x8001;&#x5E74;&#x4EE3;&#x4E2D;&#x3002;</p>
<p>&#x4E8E;&#x662F;&#xFF0C;&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x4F30;&#x7B97;&#x4E00;&#x4E0B;&#xFF1A;<br>  <pre><br>                eden    survivor<br>     1st:        0      1g-&gt;100M<br>     2nd:        0      1g-&gt;100M + 95M(1st)<br>     3rd:        0      1g-&gt;100M + 95M(2nd)  70M(1st -&gt; tenured age)<br>  </pre></p>
<p>&#x56E0;&#x6B64;&#xFF0C;&#x5728;survivor&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x81F3;&#x5C11;&#x8981;&#x5927;&#x4E8E;300M&#xFF0C;&#x624D;&#x53EF;&#x80FD;&#x9002;&#x5E94;&#x9AD8;&#x5CF0;&#x9700;&#x6C42;&#x3002;</p>
<p>&#x56E0;&#x6B64;&#xFF0C;&#x53EF;&#x4EE5;&#x6709;&#x8FD9;&#x6837;&#x7684;&#x4E00;&#x4E9B;&#x5206;&#x914D;&#xFF1A;</p>
<pre>
eden 1000M
survivor 2 * 300M
</pre>
&#x5E74;&#x8F7B;&#x4EE3;&#x603B;&#x5171;&#x7684;&#x5927;&#x5C0F;&#x4E3A;1600M&#xFF0C;&#x53EF;&#x4EE5;&#x786E;&#x5B9A;&#x4EE5;&#x4E0B;&#x7684;&#x4E00;&#x4E9B;&#x53C2;&#x6570;&#xFF1A;
<pre>
-Xmn1500m
-XX:MaxTenuringThreshold=5
-XX:TargetSurvivorRatio=66
</pre>

<p>&#x901A;&#x8FC7;&#x914D;&#x7F6E;&#x8FD9;&#x4E9B;&#x53C2;&#x6570;&#x4E4B;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x8001;&#x5E74;&#x4EE3;&#x6BD4;&#x539F;&#x6765;&#x7684;&#x8BBE;&#x7F6E;&#x6765;&#x8BF4;&#xFF0C;&#x589E;&#x957F;&#x53D8;&#x5F97;&#x7F13;&#x6162;&#x8D77;&#x6765;&#x3002;&#x7136;&#x800C;&#x5E74;&#x8F7B;&#x4EE3;&#x4E2D;&#x7684;GC&#x5374;&#x53D8;&#x957F;&#xFF0C;&#x4ECE;&#x539F;&#x6765;&#x7684;&#x5E73;&#x5747;30 ~ 50ms&#x53D8;&#x6210;80 &#xFF5E; 150ms(&#x67D0;&#x4E00;&#x65F6;&#x6BB5;&#x7684;&#x5E73;&#x5747;&#x503C;)&#xFF0C;&#x6709;&#x4E9B;&#x5E74;&#x8F7B;&#x4EE3;&#x7684;GC&#x751A;&#x81F3;&#x8D85;&#x8FC7;1s&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740;&#xFF0C;&#x5E74;&#x8F7B;&#x4EE3;&#x7684;GC&#x8FD8;&#x662F;&#x6709;&#x7740;&#x8C03;&#x4F18;&#x7684;&#x7A7A;&#x95F4;&#x3002;&#x8FD9;&#x662F;&#x4E00;&#x6BB5;&#x6BD4;&#x8F83;&#x7279;&#x522B;&#x7684;GC&#x65E5;&#x5FD7;&#xFF1A;<br>&#x4ECE;&#x65E5;&#x5FD7;&#x4E2D;&#x89C2;&#x5BDF;&#x5230;&#xFF0C;&#x5F53;&#x4E0A;&#x5347;&#x5230;3w&#xFF0F;qps&#x65F6;&#xFF0C; &#x5E74;&#x8F7B;&#x4EE3;&#x7684;GC&#x53D8;&#x5F97;&#x4E0D;&#x7A33;&#x5B9A;&#xFF0C;&#x6709;&#x4E9B;&#x751A;&#x81F3;&#x9AD8;&#x8FBE;7s&#x3002;<br>&#x5C06;&#x5E74;&#x8F7B;&#x4EE3;&#x5927;&#x5C0F;&#x4ECE;1200M&#x63D0;&#x5347;&#x5230;1500M&#xFF0C;&#x4ECE;GC&#x7684;&#x65E5;&#x5FD7;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C; &#x53D1;&#x751F;<em>promotion failed</em>&#x7684;&#x6B21;&#x6570;&#x964D;&#x4F4E;&#x4E86;&#x8BB8;&#x591A;&#xFF0C;&#x540C;&#x65F6;&#x7EDF;&#x8BA1;&#x5728;GC&#x65F6;&#x95F4;&#x6570;&#x8D85;&#x8FC7;1s&#x7684;&#x6B21;&#x6570;&#x4ECE;112&#x6B21;(dn2)&#x964D;&#x4F4E;&#x5230;70&#x6B21;(dn18), &#x5728;&#x4E24;&#x53F0;RegionServer&#x670D;&#x52A1;&#x5CF0;&#x7C7B;&#x4F3C;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x3002;</p>
<p><strong>&#x600E;&#x6837;&#x8C03;&#x6574;&#x5E74;&#x8F7B;&#x4EE3;</strong></p>
<p>&#x5F53;&#x5728;&#x8001;&#x5E74;&#x4EE3;&#x4E2D;&#xFF0C;&#x5360;&#x7528;&#x7684;&#x5185;&#x5B58;&#x53D8;&#x6210;&#x8F83;&#x5927;&#x6BD4;&#x4F8B;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x6B64;&#x65F6;&#x5728;&#x53D1;&#x751F;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;&#x9AD8;&#x5CF0;(&#x5F02;&#x5E38;&#x8BF7;&#x6C42;&#x9AD8;&#x5CF0;)&#xFF0C;&#x521B;&#x5EFA;&#x5927;&#x91CF;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x6B64;&#x65F6;&#x4FBF;&#x6709;&#x53EF;&#x80FD;&#x51FA;&#x73B0;<code>promotion failed</code>&#x5F02;&#x5E38;&#xFF0C;&#x8FD9;&#x4E2A;&#x5F02;&#x5E38;&#x5C06;&#x5BFC;&#x81F4;&#x670D;&#x52A1;&#x88AB;&#x4E2D;&#x65AD; 2 &#xFF5E; 5s&#x3002;</p>
<p>&#x5982;&#x4F55;&#x89E3;&#x51B3;&#x8FD9;&#x6837;&#x7684;&#x95EE;&#x9898;&#xFF1F;</p>
<p>&#x53E6;&#x5916;&#xFF0C;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x5BF9;&#x4E8E;&#x4E00;&#x4E9B;&#x7A33;&#x5B9A;&#x7684;&#x670D;&#x52A1;&#x6765;&#x8BF4;&#xFF0C;gc&#x65E5;&#x5FD7;&#x4F1A;&#x968F;&#x7740;&#x65F6;&#x95F4;&#x7684;&#x79EF;&#x7D2F;&#x800C;&#x6162;&#x6162;&#x53D8;&#x5927;&#xFF0C;&#x8FD9;&#x65F6;&#x5C31;&#x9700;&#x8981;&#x5F00;&#x542F;gc&#x65E5;&#x5FD7;&#x81EA;&#x52A8;roll&#x7684;&#x529F;&#x80FD;(&#x8FD9;&#x6837;&#x7684;&#x529F;&#x80FD;&#x5728;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x662F;&#x672A;&#x5F00;&#x542F;&#x7684;),</p>
<p><pre><br>-XX:+UseGCLogFileRotation<br>-XX:NumberOfGCLogFiles=5<br>-XX:GCLogFileSize=80M<br></pre><br>&#x5F53;&#x6587;&#x4EF6;&#x8FC7;&#x5927;&#x65F6;&#xFF0C;&#x4E3A;&#x4E86;&#x4E0D;&#x8BA9;&#x670D;&#x52A1;&#x91CD;&#x542F;&#x6682;&#x505C;&#xFF0C;&#x4E0D;&#x5F97;&#x5DF2;&#x91C7;&#x53D6;<strong>jinfo -J-d64 -flag -PrintGCDetails 93411</strong>&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x51CF;&#x5C11;GC&#x65E5;&#x5FD7;&#x7684;&#x8F93;&#x51FA;&#x91CF;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E5F;&#x7B97;&#x5176;&#x4E2D;&#x7684;&#x7ECF;&#x9A8C;&#x6559;&#x8BAD;&#x4E4B;&#x4E00;&#x3002;</p>
<p>&#x5728;openJDK1.8&#x4E2D;&#xFF0C;&#x5F53;&#x672A;&#x8BBE;&#x7F6E;GC&#x7B56;&#x7565;&#x65F6;&#x5019;&#xFF0C;&#x5F53;&#x8BBE;&#x7F6E;&#x7684;&#x5185;&#x5B58;(-Xmx)&#x6BD4;&#x8F83;&#x5C0F;&#x65F6;(&#x5728;&#xFF0D;Xmx1500m&#x89C2;&#x6D4B;&#x5230;&#x8FD9;&#x4E00;&#x73B0;&#x8C61;&#xFF0C;64&#x4F4D;JVM)&#xFF0C;&#x91C7;&#x7528;&#x7684;&#x662F;&#x4E00;&#x79CD;&#xFF1A;<em>UseParallelGC</em> + <em>UseParallelOldGC( a multithreaded STW compacting collector for old generation(do copy memories as well))</em>&#x7684;&#x5783;&#x573E;&#x56DE;&#x6536;&#x7B56;&#x7565;(&#x5373;&#x4F7F;&#x8BBE;&#x7F6E;&#xFF0D;Xmn&#xFF0C;&#x7ED3;&#x679C;&#x4E5F;&#x4E00;&#x6837;)&#xFF0C;&#x5728;&#x53E6;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x4E2D;(-Xmx&gt;15g),&#x53D1;&#x73B0;&#x5176;&#x5783;&#x573E;&#x56DE;&#x6536;&#x673A;&#x5236;&#x53D8;&#x6210;CMS&#xFF0B;ParNewGC&#x7684;&#x65B9;&#x5F0F;&#x3002;&#x56E0;&#x6B64;&#x5728;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x65F6;&#xFF0C;&#x6700;&#x597D;&#x5148;&#x663E;&#x5F0F;&#x6307;&#x5B9A;&#x5783;&#x573E;&#x56DE;&#x6536;&#x7B56;&#x7565;&#xFF0C;&#x8FD9;&#x6837;&#x65B9;&#x4FBF;&#x4E8E;&#x540E;&#x671F;&#x7EF4;&#x62A4;&#x548C;&#x8C03;&#x4F18;&#x3002;&#x5728;&#x540E;&#x6765;&#x7684;&#x7EF4;&#x62A4;&#x4E2D;&#xFF0C;&#x53D1;&#x73B0;&#x52A0;&#x5165;&#x201D;-XX:-UseBiasedLocking -XX:+PerfDisableSharedMem&#x201D; &#x8FD9;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x5BF9;&#x4E8E;&#x5728;&#x9AD8;&#x5E76;&#x53D1;&#x7684;&#x573A;&#x666F;&#x4E0B;&#xFF0C;&#x53EF;&#x4EE5;&#x51CF;&#x5C11;GC&#x7684;&#x505C;&#x987F;&#x65F6;&#x95F4;&#x3002; &#x53E6;&#x5916;&#xFF0C;&#x7CFB;&#x7EDF;&#x7684;swappiness&#x53C2;&#x6570;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x91CD;&#x8981;&#x7684;&#x8C03;&#x4F18;&#x9879;&#xFF0C;&#x5BF9;&#x4E8E;&#x670D;&#x52A1;GC&#x548C;&#x6027;&#x80FD;&#x6709;&#x5F88;&#x5927;&#x7684;&#x4F5C;&#x7528;&#xFF0C;&#x540E;&#x7EED;&#x4F1A;&#x6709;&#x4E00;&#x4E9B;&#x6587;&#x7AE0;&#x4ECB;&#x7ECD;&#x5230;&#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#x3002;</p>
<p>&#x76EE;&#x524D;&#xFF0C;&#x670D;&#x52A1;&#x53EF;&#x4EE5;&#x5728;&#x4E0D;&#x5C0F;&#x4E8E;&#x4EE5;&#x524D;&#x7684;&#x8BBF;&#x95EE;&#x538B;&#x529B;&#x4E0B;&#xFF0C;&#x8FDE;&#x7EED;&#x5927;&#x4E8E;&#x534A;&#x5E74;&#x7A33;&#x5B9A;&#x8FD0;&#x884C;&#xFF0C;&#x8FBE;&#x5230;&#x6700;&#x521D;&#x7684;&#x76EE;&#x7684;(&#x5728;&#x7A33;&#x5B9A;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#x63D0;&#x5347;&#x6027;&#x80FD;)&#xFF0C; &#x540E;&#x7EED;&#x5C06;&#x6301;&#x7EED;&#x5173;&#x6CE8;GC&#x8C03;&#x4F18;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4E00;&#x4E9B;&#x8C03;&#x4F18;&#x7ED3;&#x679C;&#x53EF;&#x4EE5;&#x89C1;&#x4E4B;&#x524D;&#x53D1;&#x8FC7;&#x7684;&#x4E00;&#x7BC7;HBase ppt&#x3002;</p>
<blockquote>
<p>Reference</p>
</blockquote>
<li><a href="https://plumbr.eu/handbook/gc-tuning/throughput-vs-latency-vs-capacity" target="_blank" rel="external">https://plumbr.eu/handbook/gc-tuning/throughput-vs-latency-vs-capacity</a></li><br><li><a href="https://blogs.oracle.com/jonthecollector/entry/when\_the\_sum\_of\_the" target="_blank" rel="external">https://blogs.oracle.com/jonthecollector/entry/when\_the\_sum\_of\_the</a></li><br><li><a href="https://blogs.oracle.com/jonthecollector/entry/our_collectors" target="_blank" rel="external">https://blogs.oracle.com/jonthecollector/entry/our_collectors</a></li><br><li><a href="https://issues.apache.org/jira/browse/CASSANDRA-8150" target="_blank" rel="external">https://issues.apache.org/jira/browse/CASSANDRA-8150</a></li><br><li><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/heap-sizing.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/guide/current/heap-sizing.html</a></li><br><li><a href="http://www.oracle.com/technetwork/tutorials/tutorials-1876574.html" target="_blank" rel="external">http://www.oracle.com/technetwork/tutorials/tutorials-1876574.html</a></li>





</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="hive_issues/" class="post-link">Hive一些问题总结</a></h2><span class="post-time">Oct 24, 2017</span><div class="post-content"><p>   </p><h3>&#x6743;&#x9650;&#x95EE;&#x9898;</h3><br>   &#x5176;&#x5B9E;&#x4E0D;&#x80FD;&#x5C06;&#x6211;&#x6240;&#x9047;&#x5230;&#x7684;&#x573A;&#x666F;&#x5B9A;&#x4E49;&#x6210;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x3002;&#x51C6;&#x786E;&#x6765;&#x8BF4;&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x968F;&#x7740;&#x4E1A;&#x52A1;&#x53D1;&#x5C55;&#x548C;&#x94FA;&#x5F00;&#x5E26;&#x6765;&#x7684;&#x4E00;&#x79CD;&#x9700;&#x6C42;&#xFF0C;&#x6211;&#x4EEC;&#x60F3;&#x5EFA;&#x8BBE;&#x4E00;&#x4E2A;&#x901A;&#x7528;&#x7684;&#x6570;&#x636E;&#x4ED3;&#x5E93;&#x5E73;&#x53F0;&#xFF0C;&#x4F9B;&#x6570;&#x636E;&#x5206;&#x6790;&#x4EBA;&#x5458;&#x8FDB;&#x884C;&#x6570;&#x636E;ETL&#x7C7B;&#x4F3C;&#x7684;&#x5DE5;&#x4F5C;&#x3002;&#x8FD9;&#x5C31;&#x6D89;&#x53CA;&#x5230;&#x4E00;&#x4E2A;&#x6743;&#x9650;&#x7684;&#x95EE;&#x9898;&#xFF0C; &#x5728;&#x4F20;&#x7EDF;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#xFF0C;&#x8D85;&#x7EA7;&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x5BF9;&#x666E;&#x901A;&#x7528;&#x6237;&#x505A;&#x4E00;&#x4E9B;&#x7CBE;&#x7EC6;&#x5316;&#x7684;&#x6743;&#x9650;&#x7BA1;&#x7406;&#xFF0C;&#x5982;&#x8D4B;&#x4E88;&#x67D0;&#x4E2A;&#x7528;&#x6237;&#x67D0;&#x4E2A;&#x5E93;&#x8868;&#x7684;&#x67D0;&#x79CD;&#x6743;&#x9650;(&#x589E;&#x5220;&#x6539;&#x67E5;)&#xFF1B; &#x4ED6;&#x4EEC;&#x671F;&#x671B;&#xFF0C;&#x5229;&#x7528;Hive&#x4E5F;&#x80FD;&#x8FBE;&#x5230;&#x8FD9;&#x6837;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x7684;&#x80CC;&#x666F;&#x3002;<p></p>
<p>  &#x6709;&#x5173;hive&#x4EE5;&#x53CA;Hadoop&#x6743;&#x9650;&#x63A7;&#x5236;&#x6587;&#x7AE0;&#xFF0C;&#x53EF;&#x770B;&#x8FD9;&#x91CC;&#xFF1A;<br>  <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Authorization#LanguageManualAuthorization-3DefaultHiveAuthorization(LegacyMode" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Authorization#LanguageManualAuthorization-3DefaultHiveAuthorization(LegacyMode</a>)<br><a href="http://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html" target="_blank" rel="external">http://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html</a></p>
<p>  &#x4ECE;&#x6587;&#x7AE0;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x4E86;&#x89E3;&#x5230;, &#x53EF;&#x4EE5;&#x5728;metastore&#x5C42;&#x9762;&#x4E0A;&#x542F;&#x7528;<em>storage based authorization</em>, &#x4EE5;&#x53CA;&#x540C;&#x65F6;&#x5728;hiveserver2&#x4E0A;&#x5F00;&#x542F;<em>SQL standards based authorization</em>, &#x5373;&#x53EF;&#x6EE1;&#x8DB3;BI&#x7528;&#x6237;&#x90E8;&#x95E8;&#x7684;&#x9700;&#x6C42;&#x3002;</p>
<p>  &#x901A;&#x8FC7;<a href="https://cwiki.apache.org/confluence/display/Hive/SQL+Standard+Based+Hive+Authorization" target="_blank" rel="external">&#x5982;&#x4F55;&#x5F00;&#x542F;SQL standards based authorization</a>&#xFF0C; &#x6211;&#x4EEC;&#x7684;metastore&#x5DF2;&#x7ECF;&#x5F00;&#x542F;&#x4E86;<em>storage based authorization</em>&#xFF0C;&#x4E14;&#x670D;&#x52A1;&#x4E8E;&#x81F3;&#x5C11;3&#x4E2A;&#x4E0D;&#x540C;&#x7684;&#x4E1A;&#x52A1;&#x7EBF;. &#x6309;&#x7167;&#x8981;&#x6C42;&#x914D;&#x7F6E;&#x597D;hiveserver2&#xFF0C; &#x867D;&#x7136;&#x80FD;&#x591F;&#x6B63;&#x5E38;&#x542F;&#x52A8;&#xFF0C;&#x4F46;&#x5F53;&#x5728;beeline&#x6267;&#x884C; <em>set role admin;</em>&#x65F6;&#xFF0C; &#x8FD8;&#x662F;&#x4F1A;&#x63D0;&#x793A;&#x4E00;&#x4E9B;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#xFF0C;&#x663E;&#x793A;&#x6211;&#x4EEC;&#x7F3A;&#x4E4F;&#x4E00;&#x4E9B;&#x6743;&#x9650;&#x4FE1;&#x606F;&#x7684;&#x5B9A;&#x4E49;&#x3002;<em>SQL standards based authorization</em>&#x4FE1;&#x606F;&#x4F1A;&#x5B58;&#x5728;&#x54EA;&#x91CC;&#xFF0C;&#x5BF9;hiveserver2&#x7684;&#x4E86;&#x89E3;&#xFF0C;&#x5176;&#x5E76;&#x6CA1;&#x6709;&#x76F8;&#x5173;&#x6570;&#x636E;&#x5E93;&#x7684;&#x914D;&#x7F6E;&#x548C;&#x5B9A;&#x4E49;&#xFF0C;&#x4F1A;&#x4E0D;&#x4F1A;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x4E5F;&#x88AB;&#x5F53;&#x6210;&#x5143;&#x6570;&#x636E;&#x4FDD;&#x5B58;&#x5728;&#x4E0E;metastore&#x914D;&#x7F6E;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#xFF0C;&#x8FDE;&#x63A5;&#x4E0A;&#x8BE5;&#x5E93;&#xFF0C;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x5E93;&#xFF0C;&#x5728;<em>show tables</em>&#x7684;&#x547D;&#x4EE4;&#x4E0B;&#xFF0C;&#x53EF;&#x4EE5;&#x89C1;&#x5230;&#x4E0B;&#x9762;&#x8FD9;&#x4E9B;&#x8868;&#xFF1A;<br>  <pre><br>  +&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;+<br>| Tables_in_hadoop          |<br>+&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;+                |<br>| GLOBAL_PRIVS              |<br>| IDXS                      |<br>| INDEX_PARAMS              |<br>| NOTIFICATION_SEQUENCE     |<br>| PARTITIONS                |<br>| PARTITION_KEYS            |<br>| PARTITION_KEY_VALS        |<br>| PARTITION_PARAMS          |<br>| PART_COL_PRIVS            |<br>| PART_COL_STATS            |<br>| PART_PRIVS                |<br>| ROLES                     |<br>| ROLE_MAP                  |          |<br>| TABLE_PARAMS              |<br>| TAB_COL_STATS             |<br>| TBLS                      |<br>| TBL_COL_PRIVS             |<br>| TBL_PRIVS                 |<br>| VERSION                   |<br>+&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;+<br>X rows in set (0.00 sec)<br>  </pre><br> &#x5728;&#x8FD9;&#x4E9B;&#x8868;&#x4E2D;&#xFF0C;&#x5F88;&#x5BB9;&#x6613;&#x5C31;&#x53D1;&#x73B0;&#x4E86;<em>ROLES</em>&#x4EE5;&#x53CA;&#x548C; <em>ROLE\</em>_MAP_ &#x8FD9;&#x4E24;&#x5F20;&#x8868;&#xFF0C; &#x5728; <em>ROLE\</em>_MAP_ &#x4E2D;&#x624B;&#x52A8;&#x63D2;&#x5165;&#x4E00;&#x6761;&#x6570;&#x636E;&#xFF1A;</p>
<pre>
|            13 | 1481712838 |            0 | bi      | USER         | xxxx    | USER           |       1 |
</pre>

<p>&#x5F53;&#x518D;&#x6B21;&#x5728;beeline&#x6267;&#x884C;<em>set role admin;</em>&#x65F6;&#xFF0C;&#x547D;&#x4EE4;&#x6210;&#x529F;&#xFF0C;&#x6267;&#x884C;&#x4E00;&#x4E9B;grant select&#x8BED;&#x53E5;&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x4E00;&#x4E9B;&#x6548;&#x679C;&#x3002;</p>
<p>&#x5728;1.2.1&#x7248;&#x672C;&#x7684;hiveserver2&#x4E2D;&#xFF0C; &#x5FC5;&#x987B;&#x5728;&#x542F;&#x52A8;&#x547D;&#x4EE4;&#x4E2D;&#x52A0;&#x5165;(&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x5728;&#x914D;&#x7F6E;&#x91CC;&#x52A0;&#xFF0C;&#x539F;&#x56E0;&#x662F;&#x5176;&#x5B83;&#x7528;&#x6237;&#x4F7F;&#x7528;hive cli&#x547D;&#x4EE4;&#x65F6;&#xFF0C;&#x4F1A;&#x7531;&#x4E8E;&#x8FD9;&#x4E9B;&#x914D;&#x7F6E;&#x51FA;&#x73B0;&#x4E00;&#x4E9B;&#x95EE;&#x9898;&#xFF0C;&#x540E;&#x9762;&#x540E;&#x8BB2;&#x5230;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;)&#x5982;&#xFF1A;</p>
<pre>
hive --service hiveserver2  --hiveconf hive.security.authorization.enabled=true --hiveconf hive.security.authorization.manager=org.apache.hadoop.hive.ql.security.authorization.plugin.sqlstd.SQLStdHiveAuthorizerFactory --hiveconf hive.security.authenticator.manager=org.apache.hadoop.hive.ql.security.SessionStateUserAuthenticator --hiveconf hive.metastore.uris=&apos;&apos;
</pre>
&#x8FD9;&#x6837;&#x624D;&#x4F1A;&#x8BA9;SQL Based Authorization&#x751F;&#x6548;&#x3002;

&#x6309;&#x7167;&#x8FD9;&#x6837;&#x7684;&#x914D;&#x7F6E;&#x542F;&#x52A8;hiveserver2&#x540E;&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x53D1;&#x73B0;&#x539F;&#x6765;&#x53EF;&#x4EE5;&#x5728;hive cli&#x547D;&#x4EE4;&#x4E0B;&#x6267;&#x884C;&#x7684;&#x8BED;&#x53E5;&#x51FA;&#x73B0;&#x4E00;&#x4E9B;&#x7A7A;&#x6307;&#x9488;&#x9519;&#x8BEF;&#xFF0C;&#x4F8B;&#x5982;&#xFF0C;&#x5411;&#x67D0;&#x4E2A;&#x8868;&#x4E2D;&#x589E;&#x52A0;&#x4E00;&#x680F;&#xFF0C;
_alter table hzq add columns(test string)_, &#x6267;&#x884C;&#x8FD9;&#x6837;&#x7684;&#x8BED;&#x53E5;&#x65F6;&#xFF0C;&#x5728;&#x63A7;&#x5236;&#x53F0;&#x4E2D;&#xFF0C;&#x51FA;&#x73B0;&#x8FD9;&#x6837;&#x7684;&#x95EE;&#x9898;&#xFF1A;
FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.DDLTask. null <br>
&#x51FA;&#x73B0;&#x8FD9;&#x6837;&#x95EE;&#x9898;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x662F;&#x56E0;&#x4E3A;&#x5728;hive-site.xml&#x4E2D;&#x914D;&#x7F6E;&#x4E86;&#xFF1A;
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt;</div><div class="line">  &lt;name&gt;hive.security.authenticator.manager&lt;/name&gt;</div><div class="line">  &lt;value&gt;org.apache.hadoop.hive.ql.security.SessionStateUserAuthenticator&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure>


&#x8FD9;&#x6837;&#x7684;&#x5C5E;&#x6027;&#xFF0C;&#x5B83;&#x4ECE;&#x5F53;&#x524D;&#x7684;SessionState&#x4E2D;&#x83B7;&#x5F97;&#x6267;&#x884C;&#x7528;&#x6237;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x800C;&#x5728;hive cli&#x7684;&#x6A21;&#x5F0F;&#x4E0B;&#xFF0C;&#x8FD4;&#x56DE;&#x4E3A;Null&#xFF0C;&#x89E3;&#x51B3;&#x65B9;&#x5F0F;&#x4E5F;&#x8F83;&#x4E3A;&#x7B80;&#x5355;&#xFF0C;&#x5728;&#x542F;&#x52A8;hive &#x65F6;&#xFF0C;&#x52A0;&#x5165;&#x914D;&#x7F6E;:
<pre>
hive --hiveconf hive.security.authenticator.manager=org.apache.hadoop.hive.ql.security.HadoopDefaultAuthenticator</pre>

<p>&#x7136;&#x800C;&#xFF0C;&#x4E8B;&#x60C5;&#x8FD8;&#x672A;&#x7ED3;&#x675F;&#xFF0C;&#x867D;&#x7136;&#x89E3;&#x51B3;&#x4E86;&#x6743;&#x9650;&#x5206;&#x914D;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4F46;&#x5982;&#x4F55;&#x89E3;&#x51B3;&#x7528;&#x6237;&#x8BA4;&#x8BC1;&#x8FD9;&#x4E00;&#x95EE;&#x9898;&#x5462;&#xFF0C;&#x800C;&#x4E14;&#x9700;&#x8981;&#x548C;hue&#x76F8;&#x4E92;&#x7ED3;&#x5408;&#xFF1F; &#x5F53;hiveserver2&#x610F;&#x5916;&#x9000;&#x51FA;&#x65F6;&#xFF0C;&#x8D85;&#x7EA7;&#x7528;&#x6237;&#x8BBE;&#x7F6E;&#x7684;&#x4E00;&#x4E9B;ACL&#x529F;&#x80FD;&#x91CD;&#x542F;&#x65F6;&#x5019;&#x8FD8;&#x4F1A;&#x7EE7;&#x7EED;&#x751F;&#x6548;&#xFF1F; &#x7B54;&#x6848;&#x662F;&#x80AF;&#x5B9A;&#x7684;&#xFF0C;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x4F1A;&#x4FDD;&#x5B58;&#x5728;metastore&#x914D;&#x7F6E;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x3002;</p>
<p>&#x968F;&#x7740;hive beeline&#x7684;&#x4F7F;&#x7528;&#xFF0C;&#x6162;&#x6162;&#x5730;&#x4F1A;&#x53D1;&#x73B0;beeline&#x4F1A;&#x542F;&#x52A8;&#x5F97;&#x8D8A;&#x6765;&#x8D8A;&#x6162;&#x3002;&#x5728;&#x6709;&#x4E9B;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x751A;&#x81F3;&#x629B;&#x51FA;OOM&#x7684;&#x9519;&#x8BEF;&#xFF0C;&#x5373;&#x4F7F;&#x52A0;&#x5927;beeline&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x542F;&#x52A8;beeline&#x4F9D;&#x65E7;&#x53D8;&#x5F97;&#x5F88;&#x6162;&#x3002;&#x5728;&#x8FD9;&#x6837;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6CA1;&#x6709;&#x65E5;&#x5FD7;(&#x5C06;&#x65E5;&#x5FD7;&#x7EA7;&#x522B;&#x8BBE;&#x7F6E;&#x6210;DEBUG&#x4F9D;&#x65E7;)&#x4F7F;&#x5F97;&#x5B9A;&#x4F4D;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x53D8;&#x5F97;&#x56F0;&#x96BE;&#x3002;&#x901A;&#x8FC7;&#x6808;&#x7684;&#x4E00;&#x4E9B;&#x7EAA;&#x5F55;&#x4EE5;&#x53CA;&#x65E5;&#x5FD7;&#x63CF;&#x8FF0;&#xFF0C;&#x5224;&#x65AD;beeline&#x5386;&#x53F2;&#x6570;&#x636E;&#x8FC7;&#x591A;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;&#x7528;&#x6237;&#x76EE;&#x5F55;&#x4E0B;&#x6709;&#x4E2A; <em>.beeline</em> &#x7684;&#x6587;&#x4EF6;&#x5939;&#xFF0C; &#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x5939;&#x627E;&#x5230;&#x4E00;&#x4E2A;history&#x6587;&#x4EF6;(&#x8BB0;&#x5F55;&#x66FE;&#x7ECF;&#x8F93;&#x5165;&#x8FC7;&#x7684;&#x5386;&#x53F2;&#x547D;&#x4EE4;)&#xFF0C;&#x53D1;&#x73B0;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x5F88;&#x5927;&#xFF0C; &#x5C06;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x5220;&#x6389;&#xFF0C; beeline&#x542F;&#x52A8;&#x6062;&#x590D;&#x6B63;&#x5E38;&#x3002;</p>
<p>Hive cli&#x5F00;&#x542F;debug&#x6A21;&#x5F0F;&#xFF1A;<br><strong>hive &#x2013;hiveconf hive.root.logger=DEBUG,console</strong></p>
<p>&#x5728;&#x4E00;&#x4E9B;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5728;&#x540C;&#x4E00;&#x53F0;&#x673A;&#x5668;&#x4E0A;&#x540C;&#x65F6;&#x4F1A;&#x8FD0;&#x884C;&#x7740;beeline, hive cli&#x4EE5;&#x53CA;hiveserver2&#x8FD9;&#x6837;&#x7684;&#x7A0B;&#x5E8F;&#xFF0C;&#x5982;&#x4F55;&#x533A;&#x5206;&#x8FD9;&#x4E9B;&#x65E5;&#x5FD7;&#x662F;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x96BE;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4ED6;&#x4EEC;&#x90FD;&#x540C;&#x4F7F;&#x7528;&#x540C;&#x4E00;&#x4E2A;hive-log4j.properties&#x6587;&#x4EF6;&#xFF0C; &#x5982;&#x679C;&#x5728;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x4E2D;&#x5C06;&#x6587;&#x4EF6;&#x7684;&#x76EE;&#x5F55;&#x548C;&#x6587;&#x4EF6;&#x540D;&#x56FA;&#x5B9A;&#x4E0B;&#x6765;&#xFF0C;&#x5219;&#x9020;&#x6210;&#x65E5;&#x5FD7;&#x76F8;&#x4E92;&#x5F71;&#x54CD;&#x6DF7;&#x4E71;&#x7684;&#x6548;&#x679C;&#x3002;&#x5E78;&#x597D;&#x7684;&#x662F;&#xFF0C;&#x5728;log4j&#x4E0A;&#x53EF;&#x4EE5;&#x914D;&#x7F6E;&#x5C5E;&#x6027;&#x503C;&#x6765;&#x533A;&#x5206;&#x6587;&#x4EF6;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x5982;&#xFF1A;</p>
<pre>
  hive.log.file=${hive.user}.log
</pre>

<p> &#x5728;hive-env.sh&#x4E0A;&#xFF0C;&#x4F7F;&#x7528;&#xFF1A;<br> <pre><br> export HADOOP_OPTS=&#x201D;$HADOOP<em>OPTS -Dhive.user=$SERVICE&#x201D;<br></em></pre><br>log&#x7684;&#x6587;&#x4EF6;&#x540D;&#x65E2;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; $SERVICE_&#x7684;&#x4E0D;&#x540C;&#x800C;&#x4E0D;&#x540C;&#xFF0C; &#x8FD9;&#x4FBF;&#x89E3;&#x51B3;&#x4E86;&#x95EE;&#x9898;&#x3002;</p>
<p>   </p><h3>&#x5185;&#x5B58;&#x95EE;&#x9898;</h3><br>case1 <br><br>   metastore&#x4E2D;&#x63D0;&#x793A;oom&#x7684;&#x9519;&#x8BEF;&#xFF0C;&#x800C;&#x5BFC;&#x81F4;metastore&#x5F02;&#x5E38;&#x9000;&#x51FA;&#xFF0C;<br>   <pre><br>   metastore.RetryingHMSHandler (RetryingHMSHandler.java:invoke(159)) - java.lang.OutOfMemoryError: GC overhead limit exceeded<br>   </pre><br>   &#x5C06; <em>GC overhead limit exceeded</em> &#x8FD9;&#x4E2A;&#x7279;&#x6027;&#x4ECE;JVM&#x542F;&#x52A8;&#x547D;&#x4EE4;&#x4E2D;&#x79FB;&#x9664;&#x540E;&#xFF0C;&#x589E;&#x52A0;JVM&#x5185;&#x5B58;&#xFF0C;&#x8FD0;&#x884C;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x540E;&#xFF0C;metastore&#x7A81;&#x7136;&#x65E0;&#x6CD5;&#x6B63;&#x5E38;&#x54CD;&#x5E94;&#x8BF7;&#x6C42;&#x3002;&#x5728;&#x67E5;&#x770B;metastore&#x7684;GC&#x65E5;&#x5FD7;&#x4E4B;&#x540E;&#xFF0C;&#x53D1;&#x73B0;&#x5982;&#x4E0B;&#x65E5;&#x5FD7;&#x4E0D;&#x505C;&#x7684;&#x5237;&#x5C4F;&#xFF1A;<br>   <pre><br>[Times: user=27.43 sys=0.11, real=1.59 secs]<br>2016-11-24T10:27:31.235+0800: 3951111.303: [CMS-concurrent-sweep-start]<br>2016-11-24T10:27:32.705+0800: 3951112.772: [CMS-concurrent-sweep: 1.469/1.469 secs] [Times: user=1.47 sys=0.00, real=1.47 secs]<br>2016-11-24T10:27:32.705+0800: 3951112.772: [CMS-concurrent-reset-start]<br>2016-11-24T10:27:32.712+0800: 3951112.779: [CMS-concurrent-reset: 0.007/0.007 secs] [Times: user=0.01 sys=0.00, real=0.01 secs]<br>2016-11-24T10:27:34.712+0800: 3951114.780: [GC (CMS Initial Mark) [1 CMS-initial-mark: 2693385K(2796224K)] 3938815K(4054528K), 1.1555810 secs] [Times: user=1.30 sys=0.00, real=1.16 secs]<br>2016-11-24T10:27:35.868+0800: 3951115.935: [CMS-concurrent-mark-start]<br>2016-11-24T10:27:37.319+0800: 3951117.386: [CMS-concurrent-mark: 1.450/1.450 secs] [Times: user=7.26 sys=0.00, real=1.45 secs]<br>2016-11-24T10:27:37.319+0800: 3951117.386: [CMS-concurrent-preclean-start]<br>2016-11-24T10:27:37.327+0800: 3951117.394: [CMS-concurrent-preclean: 0.008/0.008 secs] [Times: user=0.01 sys=0.00, real=0.01 secs]<br>2016-11-24T10:27:37.327+0800: 3951117.394: [CMS-concurrent-abortable-preclean-start]<br>2016-11-24T10:27:37.327+0800: 3951117.394: [CMS-concurrent-abortable-preclean: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]<br>2016-11-24T10:27:37.327+0800: 3951117.394: [CMS-concurrent-abortable-preclean-start]<br>2016-11-24T10:27:37.327+0800: 3951117.394: [CMS-concurrent-abortable-preclean: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]<br>2016-11-24T10:27:37.328+0800: 3951117.395: [GC (CMS Final Remark) [YG occupancy: 1245429 K (1258304 K)]2016-11-24T10:27:37.328+0800: 3951117.395: [GC (CMS Final Remark) 3951117.396: [ParNew: 1245429K-&gt;1245429K(1258304K), 0.0000332 secs] 3938815K-&gt;3938815K(4054528K), 0.0001706 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]<br>   </pre><p></p>
<p>&#x4ECE;GC&#x610F;&#x56FE;&#x6765;&#x7406;&#x89E3;&#xFF0C;&#x610F;&#x5473;&#x7740;metastore cms&#x4E0A;&#x5B58;&#x6D3B;&#x7684;&#x5BF9;&#x8C61;&#x8D85;&#x8FC7;3G&#x4E4B;&#x591A;&#x3002;&#x5BF9;metastore&#x7684;&#x7406;&#x89E3;&#xFF0C;&#x5176;&#x5185;&#x90E8;&#x5B9E;&#x73B0;&#x5E76;&#x6CA1;&#x6709;&#x7279;&#x6B8A;&#x7684;&#x7F13;&#x5B58;&#x6765;&#x7F13;&#x5B58;&#x4E00;&#x4E9B;&#x8868;&#x6570;&#x636E;&#xFF0C;&#x7528;&#x6237;Session&#x6570;&#x636E;&#x4FE1;&#x606F;&#x4E5F;&#x4E0D;&#x4F1A;&#x6709;&#x8FD9;&#x4E48;&#x591A;&#xFF0C;&#x96BE;&#x9053;&#x662F;hive&#x672C;&#x8EAB;&#x7684;BUG&#x5BFC;&#x81F4;&#x7684;&#xFF1F;</p>
<p>&#x5728;dump metastore&#x7684;&#x5806;&#x5185;&#x5B58;&#x540E;&#xFF0C;&#x501F;&#x52A9; <strong>MAT</strong> &#x5DE5;&#x5177;&#x7684;&#x5206;&#x6790;&#xFF0C; &#x95EE;&#x9898;&#x6709;&#x4E86;&#x66F4;&#x52A0;&#x76F4;&#x767D;&#x7684;&#x5C55;&#x73B0;&#xFF0C;&#x5176;&#x4E2D;&#x67D0;&#x4E24;&#x4E2A;&#x7EBF;&#x7A0B;&#x6301;&#x6709;&#x7684;&#x5F15;&#x7528;&#x6570;&#x5927;&#x5C0F;&#x8D85;&#x8FC7;2.7G&#xFF0C; &#x901A;&#x8FC7;&#x8FDB;&#x4E00;&#x6B65;&#x5206;&#x6790;&#x5176;&#x4E2D;&#x67D0;&#x4E2A;&#x7EBF;&#x7A0B;&#x7684;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x95EE;&#x9898;&#x6839;&#x6E90;&#x9010;&#x6E10;&#x6D6E;&#x73B0;&#x3002;</p>
<img src="/hive_issues/stack.png" alt="stack.png" title="">
<p>&#x8FD9;&#x662F;&#x8BF7;&#x6C42;defalut:beacon&#x7684;partitions&#x6570;&#x91CF;(60w)&#x8FC7;&#x591A;&#xFF0C;&#x5BFC;&#x81F4;&#x5185;&#x5B58;&#x4E0D;&#x591F;&#x7528;&#x3002;&#x76F4;&#x63A5;&#x8FDE;&#x4E0A;mysql&#xFF0C; &#x67E5;&#x770B;&#x8FD9;&#x4E2A;&#x8868;&#x7684;partitions&#x6570;&#x91CF;&#xFF0C;&#x53D1;&#x73B0;&#x8FD9;&#x4E2A;&#x8868;&#x6709;70w+&#x7684;partition&#xFF0C;&#x54A8;&#x8BE2;&#x4E00;&#x4E9B;&#x7528;&#x8FD9;&#x8868;&#x7684;&#x4EBA;&#xFF0C;&#x8BF4;&#x8FD9;&#x4E2A;&#x8868;&#x4E2D;&#x5B58;&#x5728;&#x4E00;&#x4E9B;&#x5386;&#x53F2;&#x6570;&#x636E;&#xFF0C;&#x66F4;&#x76F4;&#x89C2;&#x4E00;&#x4E9B;&#xFF1A;<br><br>&#x90A3;&#x4E48;&#xFF0C;&#x662F;&#x4EC0;&#x4E48;&#x6837;&#x7684;sql&#x8BED;&#x53E5;&#x7ADF;&#x7136;&#x4F1A;&#x8BF7;&#x6C42;&#x8FD9;&#x4E48;&#x591A;&#x7684;partitions&#x6570;&#x5462;&#xFF1F;<br>&#x7C7B;&#x4F3C;&#x4E8E; select <em> from beacon limit 10, &#x8FD9;&#x6761;&#x8BED;&#x53E5;&#x662F;&#x80AF;&#x5B9A;&#x7684;&#x4E86;,  &#x6216;&#x8005;<br>select count(</em>) from beacon, &#x8FD8;&#x6709; &#x201C;select app from beacon group by app&#x201D;.</p>
<p>case 2:<br><br>   &#x5728;&#x67D0;&#x4E00;&#x6B21;&#x6BD4;&#x8F83;&#x957F;&#x65F6;&#x95F4;&#x8FD0;&#x884C;metastore&#x4E4B;&#x540E;&#xFF0C;&#x7C7B;&#x4F3C;&#x4E8E;case1&#x7684;&#x73B0;&#x8C61;&#x51FA;&#x73B0;&#x4E86;&#xFF0C;metastore&#x8FDB;&#x7A0B;&#x4E0D;&#x65AD;&#x7684;&#x8FDB;&#x884C;CMS&#xFF0C;&#x5BFC;&#x51FA;&#x5185;&#x5B58;&#x5206;&#x6790;&#x540E;&#xFF0C;&#x53D1;&#x73B0;&#x5728;metastore&#x4E2D;&#xFF0C;<br>  <img src="/hive_issues/heap2.png" alt="heap2.png" title=""><br>JDOPersistenceManagerFactory&#x5BF9;&#x8C61;&#x5360;&#x7528;&#x4E86;&#x7EDD;&#x5927;&#x90E8;&#x5206;&#x5185;&#x5B58;&#xFF0C;&#x7ED3;&#x5408;&#x6E90;&#x7801;&#x4EE5;&#x53CA;&#x5185;&#x5B58;&#x8FDB;&#x4E00;&#x6B65;&#x5206;&#x6790;&#xFF0C;&#x63A8;&#x6D4B;&#x53EF;&#x80FD;&#x7684;&#x539F;&#x56E0;&#x662F;&#x7531;&#x4E8E;JDOPersistenceManagerFactory&#x7684;&#x7F13;&#x5B58;&#x5FD8;&#x8BB0;&#x91CA;&#x653E;&#xFF0C;&#x4E0D;&#x65AD;&#x7684;&#x7D2F;&#x79EF;&#x9020;&#x6210;&#x76EE;&#x524D;&#x5185;&#x5B58;&#x7684;&#x539F;&#x56E0;,&#x9020;&#x6210;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/** The cache of PM&apos;s in use. */</div><div class="line"> private transient Set&lt;JDOPersistenceManager&gt; pmCache = Collections.newSetFromMap(new ConcurrentHashMap());</div></pre></td></tr></table></figure>
<p>&#x8FDB;&#x4E00;&#x6B65;&#x5206;&#x6790;HiveMetastore&#x6E90;&#x7801;&#xFF0C;&#x5F53;&#x9700;&#x8981;&#x4E0E;&#x5E95;&#x5C42;&#x7684;&#x6570;&#x636E;&#x5E93;&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x4F1A;&#x4ECE;ThreadLocal&#x5B9E;&#x4F8B;&#x4E2D;&#x53D6;&#x51FA;PersistenceManager&#xFF0C; &#x5982;&#x679C;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x4E2D;&#x6CA1;&#x6709;&#x8FD9;&#x6837;&#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x90A3;&#x4E48;&#x5979;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;PersistenceManager&#xFF0C;&#x5E76;&#x5C06;&#x8FD9;&#x4E2A;PersistenceManager&#x5B9E;&#x4F8B;&#x7F13;&#x5B58;&#x5230;JDOPersistenceManagerFactory&#x7684;pmCache&#x4E2D;&#x53CA;&#x8BBE;&#x7F6E;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;threadlocal&#x7684;&#x503C;&#xFF0C;&#x91CA;&#x653E;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;PersistenceManager&#x5B9E;&#x4F8B;&#x662F;&#x5728;Client&#x8C03;&#x7528;shutdown&#x65F6;&#xFF0C;&#x7EE7;&#x7EED;&#x67E5;&#x770B;log&#x65E5;&#x5FD7;&#xFF0C;&#x53D1;&#x73B0;&#x622A;&#x81F3;&#x5230;&#x6545;&#x969C;&#x65F6;&#xFF0C;&#x7EA6;&#x6709;2000&#xFF5E;3000&#x4E2A;PersistenceManager&#x5B9E;&#x4F8B;&#x88AB;&#x521B;&#x5EFA;&#xFF0C;&#x8FD9;&#x5E94;&#x662F;&#x4E00;&#x4E2A;Hive&#x672C;&#x8EAB;&#x7684;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x901A;&#x8FC7;&#x67E5;&#x770B;jira&#xFF0C;&#x53D1;&#x73B0;&#x5DF2;&#x7ECF;&#x6709;&#x4EBA;&#x63D0;&#x8FC7;&#x7C7B;&#x4F3C;&#x7684;issue,<a href="https://issues.apache.org/jira/browse/HIVE-14187" target="_blank" rel="external">Hive-14187</a>, &#x5F53;&#x7528;&#x6237;&#x5E76;&#x672A;&#x6309;&#x7167;&#x6B63;&#x786E;&#x7684;&#x65B9;&#x5F0F;(exit;)&#x9000;&#x51FA;&#x67E5;&#x8BE2;&#x65F6;&#xFF0C;&#x5C31;&#x4E0D;&#x4F1A;&#x8C03;&#x7528;shutdown&#x65B9;&#x6CD5;&#xFF0C;&#x65E5;&#x79EF;&#x6708;&#x7D2F;&#xFF0C;&#x5BFC;&#x81F4;&#x5185;&#x5B58;&#x88AB;&#x6324;&#x7206;&#xFF0C; &#x51FA;&#x73B0;&#x4E0A;&#x8FF0;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;case1, &#x901A;&#x8FC7;&#x4E00;&#x4E9B;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E86;&#x89E3;&#x5230;&#xFF0C; &#x53EF;&#x4EE5;&#x901A;&#x8FC7;hive.limit.query.max.table.partition&#x8FD9;&#x4E2A;&#x5C5E;&#x6027;&#x6765;&#x9650;&#x5236;partition&#x6570;&#x91CF;(&#x8FD9;&#x4E2A;&#x53EA;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x751F;&#x6548;), &#x8FD9;&#x4E2A;&#x662F;&#x6CA1;&#x6709;&#x6548;&#x679C;&#x7684;. &#x5728;hive2.2.0&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <em>hive.metastore.limit.partition.request</em> &#x6765;&#x8FDB;&#x884C;&#x8BBE;&#x7F6E;&#xFF0C; &#x5728;&#x5F53;&#x524D;&#x7248;&#x672C;&#x4E2D;&#x5F15;&#x5165;issue&#xFF1A;HIVE-13884,&#x5148;&#x7ECF;&#x8FC7;&#x5224;&#x65AD;&#x8BF7;&#x6C42;&#x7684;partition&#x603B;&#x6570;&#x91CF;&#x4E4B;&#x540E;&#xFF0C;&#x518D;&#x786E;&#x5B9A;&#x662F;&#x5426;&#x7EE7;&#x7EED;&#x5B9E;&#x4F8B;&#x5316;&#x8FD9;&#x4E9B;partitions&#x3002;</p>
<p>&#x5728;&#x521B;&#x5EFA;hive&#x5E93;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x53D1;&#x73B0;&#x8FD9;&#x6837;&#x7684;&#x4E00;&#x6761;&#x8BED;&#x53E5;&#xFF1A;<br> <strong>hive  -e &#x2018;create database if not exists fqz;create database if not exists xyfx;&#x2019;</strong><br>&#x53D1;&#x751F;&#x5982;&#x4E0B;&#x5F02;&#x5E38;&#xFF1A;</p>
<pre>
Exception in thread &quot;main&quot; java.lang.RuntimeException: java.lang.RuntimeException: java.io.IOException: Permission denied
    at org.apache.hadoop.hive.ql.session.SessionState.start(SessionState.java:522)
    at org.apache.hadoop.hive.cli.CliDriver.run(CliDriver.java:677)
    at org.apache.hadoop.hive.cli.CliDriver.main(CliDriver.java:621)
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:497)
    at org.apache.hadoop.util.RunJar.run(RunJar.java:221)
    at org.apache.hadoop.util.RunJar.main(RunJar.java:136)
Caused by: java.lang.RuntimeException: java.io.IOException: Permission denied
    at org.apache.hadoop.hive.ql.session.SessionState.start(SessionState.java:515)
    ... 8 more
Caused by: java.io.IOException: Permission denied
    at java.io.UnixFileSystem.createFileExclusively(Native Method)
    at java.io.File.createTempFile(File.java:2024)
    at org.apache.hadoop.hive.ql.session.SessionState.createTempFile(SessionState.java:818)
    at org.apache.hadoop.hive.ql.session.SessionState.start(SessionState.java:513)
    ... 8 more
</pre>

<p>&#x901A;&#x8FC7;&#x9605;&#x8BFB;&#x6E90;&#x7801;&#x53D1;&#x73B0;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#xFF1A;<br>  <strong>hive -hiveconf hive.exec.local.scratchdir=/tmp/hive -e &#x2018;create database if not exists fqz;create database if not exists xyfx;&#x2019;</strong><br>&#x89E3;&#x51B3;&#x8BE5;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x540C;&#x65F6;&#xFF0C;&#x901A;&#x8FC7;hive -e&#x8FD9;&#x6837;&#x7684;&#x547D;&#x4EE4;&#x65F6;&#xFF0C; sql&#x8BED;&#x53E5;&#x5FC5;&#x987B;&#x7528;&#x5F15;&#x53F7;&#x5F15;&#x8D77;&#x6765;&#xFF0C; &#x800C;&#x5BF9;&#x4E8E; hive -f&#x8FD9;&#x6837;&#x7684;&#x547D;&#x4EE4;&#xFF0C; &#x5199;&#x5728;&#x6587;&#x4EF6;&#x4E2D;&#x7684;sql&#x8BED;&#x53E5;&#x4E0D;&#x8981;&#x7528;&#x5F15;&#x53F7;&#x6765;&#x533A;&#x5206;&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x7EC6;&#x5FAE;&#x7684;&#x5DEE;&#x8DDD;&#xFF0C;&#x6CE8;&#x610F;&#x4E00;&#x4E0B;&#x3002;</p>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="log_repeat_2/" class="post-link">HDFS 日志刷屏问题探究（2）</a></h2><span class="post-time">Sep 24, 2017</span><div class="post-content"><h3 id="&#x89E3;&#x51B3;&#x601D;&#x8DEF;&#x53CA;&#x65B9;&#x6848;"><a href="#&#x89E3;&#x51B3;&#x601D;&#x8DEF;&#x53CA;&#x65B9;&#x6848;" class="headerlink" title="&#x89E3;&#x51B3;&#x601D;&#x8DEF;&#x53CA;&#x65B9;&#x6848;"></a>&#x89E3;&#x51B3;&#x601D;&#x8DEF;&#x53CA;&#x65B9;&#x6848;</h3><p>   &#x4ECE;&#x7B2C;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4E0D;&#x65AD;&#x590D;&#x73B0;&#x95EE;&#x9898;&#xFF0C;&#x5206;&#x6790;&#x65E5;&#x5FD7;&#x548C;&#x6E90;&#x7801;&#xFF0C;&#x589E;&#x52A0;&#x65E5;&#x5FD7;&#x7684;&#x4E30;&#x5BCC;&#x6027;&#xFF0C;&#x4E0D;&#x65AD;&#x7F29;&#x5C0F;&#x95EE;&#x9898;&#x53EF;&#x80FD;&#x7684;&#x8303;&#x56F4;&#xFF0C;&#x8FD9;&#x7BC7;&#x6587;&#x4EF6;&#x5C06;&#x7EE7;&#x7EED;&#x8BB0;&#x5F55;&#x5206;&#x6790;&#x95EE;&#x9898;&#x7684;&#x8FC7;&#x7A0B;&#x4EE5;&#x53CA;&#x89E3;&#x51B3;&#x601D;&#x8DEF;&#x3002;<br>   &#x4E0A;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x672B;&#x5C3E;&#x4E2D;&#x5931;&#x8D25;&#x7684;&#x5047;&#x8BBE;&#x5E76;&#x975E;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x5F71;&#x54CD;&#xFF0C;&#x5728;&#x786E;&#x5B9A;DFSInputStream&#x7684;pos&#x53EF;&#x80FD;&#x4F1A;&#x5F71;&#x54CD;&#x8FDE;&#x63A5;&#x91CD;&#x5EFA;&#x540E;&#xFF0C;&#x5728;DFSInputStream#seek(long position)&#x4E0A;&#x52A0;&#x4E0A;&#x4E00;&#x4E9B;LOG&#x65E5;&#x5FD7;,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">if (pos &gt; targetPos) {</div><div class="line">   DFSClient.LOG.info(dfsClient.getClientName() + &quot; seek &quot; + getCurrentDatanode() + &quot; for &quot; + getCurrentBlock() +</div><div class="line">     &quot;. pos: &quot; + pos + &quot;, targetPos: &quot; + targetPos);</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x5F53;&#x7528;&#x6237;&#x8981;seek&#x7684;&#x6D41;&#x4F4D;&#x7F6E;&#x5C0F;&#x4E8E;&#x5F53;&#x524D;&#x6D41;&#x5DF2;&#x88AB;&#x8BFB;&#x53D6;&#x7684;&#x4F4D;&#x7F6E;&#x65F6;(&#x6B64;&#x65F6;&#x8F93;&#x5165;&#x6D41;&#x5DF2;&#x88AB;&#x8D85;&#x524D;&#x8BFB;)&#xFF0C; DFSInputStream&#x7684;seek&#x65B9;&#x6CD5;&#x4F1A;&#x5C06; blockEnd &#x7F6E;&#x6210; &#xFF0D;1&#xFF1B;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">if (!done) {</div><div class="line">  pos = targetPos;</div><div class="line">  blockEnd = -1;</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x7528;&#x6237;&#x8C03;&#x7528;read&#x65B9;&#x6CD5;&#x4ECE;&#x6D41;&#x4E2D;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x65F6;&#xFF0C; &#x7B26;&#x5408;&#x91CD;&#x65B0;&#x9009;&#x53D6;DataNode&#x7684;&#x6761;&#x4EF6;: pos &gt; blockEnd,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">if (pos &gt; blockEnd || currentNode == null) {</div><div class="line">  currentNode = blockSeekTo(pos);</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x63A5;&#x7740;&#xFF0C;&#x6839;&#x636E;&#x9009;&#x62E9;DataNode&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x91CD;&#x65B0;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;reader&#xFF0C; &#x5728;&#x8FD9;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x52A0;&#x5165;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#x89C2;&#x5BDF;&#x8FDE;&#x63A5;&#xFF1A;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if (getCurrentDatanode()!= null &amp;&amp; getCurrentDatanode() == chosenNode) {</div><div class="line">    DFSClient.LOG.info(dfsClient.getClientName() + &quot; close current block reader for &quot; + getCurrentBlock().getBlockId() + &quot; stored in &quot; +</div><div class="line">      getCurrentDatanode() + &quot;, a new  block reader for &quot; + targetBlock.getBlock().getBlockId() + &quot; stored in &quot; +</div><div class="line">      chosenNode + &quot; is created. pos =&quot; + target);</div><div class="line"> }</div></pre></td></tr></table></figure></p>
<p>&#x5373;&#xFF1A;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x8BFB;&#x8BF7;&#x6C42;&#x5728;&#x8F93;&#x5165;&#x6D41;&#x4E2D;&#x8BFB;&#x53D6;&#x7684;&#x5F00;&#x59CB;&#x4F4D;&#x7F6E;(seek)&#x5C0F;&#x4E8E;&#x8BE5;&#x6D41;&#x5DF2;&#x88AB;&#x8BFB;&#x53D6;&#x7684;&#x5B57;&#x8282;&#x6570;&#x65F6;&#xFF0C;&#x8BE5;&#x6D41;&#x5BF9;&#x5E94;&#x7684;&#x8FDE;&#x63A5;&#x4F1A;&#x88AB;&#x5173;&#x95ED;&#x6389;&#xFF0C;&#x91CD;&#x65B0;&#x65B0;&#x5EFA;&#x4E00;&#x6761;&#x8FDE;&#x63A5;&#x3002;&#x800C;&#x5728;DataNode&#x4E2D;&#x8BA4;&#x4E3A;&#x65E7;&#x7684;&#x8FDE;&#x63A5;&#x6240;&#x5BF9;&#x5E94;&#x7684;&#x8BF7;&#x6C42;&#x6570;&#x636E;&#x8FD8;&#x672A;&#x88AB;&#x5B8C;&#x5168;&#x5199;&#x5B8C;&#xFF0C;&#x5F53;&#x5F80;&#x4E00;&#x6761;&#x88AB;&#x5BA2;&#x6237;&#x7AEF;&#x5173;&#x95ED;&#x7684;&#x8FDE;&#x63A5;&#x7EE7;&#x7EED;&#x5199;&#x5165;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x5219;&#x629B;&#x51FA;IOException: Connection reset by peer&#x7684;&#x5F02;&#x5E38;&#x3002; &#x5F53;&#x8FDE;&#x7EED;&#x51FA;&#x73B0;&#x8FD9;&#x6837;&#x7684;&#x95EE;&#x9898;&#x65F6;&#xFF0C;&#x5219;&#x51FA;&#x73B0;DataNode&#x9891;&#x7E41;&#x5199;&#x51FA;&#x201D;datanode.VolumeScanner: VolumeScanner(xxx) Not scheduling suspect block $block for rescanning, because we rescanned it recently.&#x201C;&#x7684;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#x3002;<br>&#x52A0;&#x5165;&#x8FD9;&#x4E9B;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#xFF0C;&#x91CD;&#x542F;&#x4E00;&#x53F0;RegionServer&#x4E4B;&#x540E;&#xFF0C;&#x5728;RegionServer&#x7684;&#x65E5;&#x5FD7;&#x4E2D;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x4EE5;&#x4E0B;&#x65E5;&#x5FD7;&#xFF1A;</p>
<pre>
2016-07-10 21:31:42,147 INFO  [B.defaultRpcServer.handler=22,queue=1,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 111506876, targetPos: 111506843
2016-07-10 21:31:42,715 INFO  [B.defaultRpcServer.handler=25,queue=1,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 113544644, targetPos: 113544611
2016-07-10 21:31:43,341 INFO  [B.defaultRpcServer.handler=27,queue=0,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 115547269, targetPos: 115547236
2016-07-10 21:31:43,950 INFO  [B.defaultRpcServer.handler=16,queue=1,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 117532235, targetPos: 117532202
2016-07-10 21:31:43,988 INFO  [B.defaultRpcServer.handler=7,queue=1,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 119567867, targetPos: 119567834
2016-07-10 21:31:45,228 INFO  [B.defaultRpcServer.handler=19,queue=1,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 121787264, targetPos: 121787231
2016-07-10 21:31:45,254 INFO  [B.defaultRpcServer.handler=0,queue=0,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 123910032, targetPos: 123909999
2016-07-10 21:31:46,402 INFO  [B.defaultRpcServer.handler=26,queue=2,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 125905163, targetPos: 125905130
2016-07-10 21:31:47,027 INFO  [B.defaultRpcServer.handler=24,queue=0,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 128028947, targetPos: 128028914
2016-07-10 21:31:47,649 INFO  [B.defaultRpcServer.handler=10,queue=1,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 130057763, targetPos: 130057730
</pre>

<p>DataNode&#x7684;&#x65E5;&#x5FD7;&#xFF1A;</p>
<pre>
DataNode&#x65E5;&#x5FD7;&#xFF1A;
2016-07-10 21:31:34,263 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55243, bytes: 2555904, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 82832384, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 1083375057
2016-07-10 21:31:35,080 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55248, bytes: 3080192, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 84848128, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 815747374
2016-07-10 21:31:36,197 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55256, bytes: 3080192, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 88945152, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 1090853556
2016-07-10 21:31:36,223 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55263, bytes: 2293760, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 91109888, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 25682183
2016-07-10 21:31:38,693 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55272, bytes: 2949120, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 97212928, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 1184669690
2016-07-10 21:31:38,718 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55278, bytes: 2424832, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 99258880, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 25330867
2016-07-10 21:31:41,033 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55296, bytes: 2686976, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 107441152, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 30907800
attractive feature
2016-07-10 21:31:43,343 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55304, bytes: 2621440, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 113544192, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 625555154
2016-07-10 21:31:43,953 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55309, bytes: 2752512, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 115547136, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 608916868
2016-07-10 21:31:45,230 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55316, bytes: 2949120, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 119567360, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 1239121220
2016-07-10 21:31:47,679 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55338, bytes: 2490368, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 130057728, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 26523774
</pre>
&#x7531;hbase&#x4E0E;DataNode&#x4E2D;&#x7684;clientId&#x53EF;&#x4EE5;&#x786E;&#x5B9A;&#x5728;&#x8FD9;&#x7247;&#x65E5;&#x5FD7;&#x4E2D;&#x8BE5;DataNode&#x4E2D;&#x8BFB;&#x8BF7;&#x6C42;&#x6765;&#x81EA;regionserver&#x3002;&#x5728;DataNode&#x4E2D;&#x6839;&#x636E;&#x65E5;&#x5FD7;&#x8F93;&#x51FA;&#x7684;&#x65F6;&#x95F4; &#x52A0;&#x4E0A;&#x65E5;&#x5FD7;&#x4E2D;duration&#x7684;&#x503C;&#xFF0C;&#x53EF;&#x4EE5;&#x786E;&#x5B9A;DataNode&#x6536;&#x5230;&#x8BFB;&#x8BF7;&#x6C42;&#x7684;&#x65F6;&#x95F4;&#x3002;&#x5728;hbase&#x7684;&#x65E5;&#x5FD7;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x65B0;&#x65E7;&#x8FDE;&#x63A5;&#x521B;&#x5EFA;&#x7684;&#x8FC7;&#x7A0B;&#xFF1A;
2016-07-10 21:31:47,649 INFO  [B.defaultRpcServer.handler=10,queue=1,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 close current block reader for 1109360829 stored in DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK], a new  block reader for 1109360829 stored in DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] is created. pos =130057730

&#x7ED3;&#x679C;&#x8BBA;&#x8BC1;&#x4E86;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x7684;&#x5047;&#x8BBE;&#xFF0C;&#x65E5;&#x5FD7;&#x5927;&#x91CF;&#x5237;&#x5C4F;&#x7684;&#x539F;&#x56E0;&#x662F;&#x7531;&#x4E8E;RegionServer&#x8BFB;&#x53D6;HFile&#x6587;&#x4EF6;&#x5BFC;&#x81F4;&#x7684;&#x3002; &#x5728;HBase&#x96C6;&#x7FA4;&#x4E0A;&#xFF0C;&#x6709;&#x4E00;&#x4E9B;Scan&#x64CD;&#x4F5C;&#x53EF;&#x80FD;&#x662F;&#x5BFC;&#x81F4;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x7684;&#x4E3B;&#x56E0;&#x3002; &#x90A3;&#x4E48;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x662F;&#x5982;&#x4F55;&#x5F15;&#x8D77;&#x7684;&#x5462;&#xFF1F;

&#x91CD;&#x65B0;&#x5728;&#x5206;&#x6790;&#x4E00;&#x4E0B;&#x4E0A;&#x9762;&#x7684;HBase&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;pos&#x548C;targetPos&#x4E24;&#x4E2A;&#x72B6;&#x6001;&#x7684;&#x4E00;&#x4E9B;&#x89C4;&#x5F8B;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#xFF1A;<strong>pos - targetPos = 33</strong>, &#x5206;&#x6790;HBase&#x6E90;&#x7801;(HFileBlock)&#x53EF;&#x77E5;, 33&#x5B57;&#x8282;&#x5927;&#x5C0F;&#x7684;&#x957F;&#x5EA6;&#x7B49;&#x4E8E;&#x4E00;&#x4E2A;HFileBlock header&#x7684;&#x957F;&#x5EA6;&#xFF0C;&#x5728;33&#x4E2A;&#x5B57;&#x8282;&#x7684;&#x4FE1;&#x606F;&#x4E2D;&#xFF0C;&#x7EF4;&#x62A4;&#x4E86;HFileBlock onDiskSize&#x7B49;&#x4E00;&#x4E9B;&#x4FE1;&#x606F;&#x3002;&#x5F53;&#x8BFB;&#x53D6;&#x5F53;&#x524D;&#x7684;block&#x4FE1;&#x606F;&#x65F6;&#xFF0C;HBase&#x53EF;&#x4EE5;&#x9884;&#x5148;&#x8BFB;&#x53D6;&#x4E0B;&#x4E00;&#x5757;&#x7684;&#x5934;&#x4FE1;&#x606F;&#xFF0C;&#x8FD9;&#x6837;&#x53EF;&#x4EE5;&#x51CF;&#x5C11;&#x4E00;&#x4E9B;IO&#x64CD;&#x4F5C;&#xFF0C;&#x63D0;&#x9AD8;RegionServer&#x7684;&#x8BFB;&#x6027;&#x80FD;&#x3002;<br>
&#x5728;hbase&#x7684; HFileBlock#readAtOffset&#x7684;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x5728;&#x5728;&#x6D41;&#x4E2D;&#x6267;&#x884C;seek&#x64CD;&#x4F5C;&#xFF0C;&#x7136;&#x540E;&#x5728;read&#xFF1A;

<pre>
protected int readAtOffset(FSDataInputStream istream,
                                          byte[] dest, int destOffset, int size,
                                           boolean peekIntoNextBlock, long fileOffset, boolean pread) throws IOException {

    ...
    if (!pread &amp;&amp; streamLock.tryLock()) {
       // Seek + read. Better for scanning.
       try {
         istream.seek(fileOffset);
        }
         // Try to read the next block header.
         if (!readWithExtra(istream, dest, destOffset, size, hdrSize))
           return -1;
         } finally {
           streamLock.unlock();
         }
       ...
    }
</pre>

<p>&#x8FD9;&#x6837;&#x4ECD;&#x7136;&#x8BF4;&#x670D;&#x4E0D;&#x4E86;&#xFF0C; &#x5728;&#x5206;&#x6790;&#x4E00;&#x4E0B;HBase RegionServer&#x4E2D;&#x7684;&#x65E5;&#x5FD7;(&#x8FD9;&#x4E2A;&#x5728;&#x6CA1;&#x6709;&#x5177;&#x4F53;&#x601D;&#x8DEF;&#x7684;&#x65F6;&#x5019;&#x53D1;&#x73B0;&#x7684;), &#x53D1;&#x73B0;&#x8FD9;&#x4E9B;&#x65E5;&#x5FD7;&#x7684;&#x7EBF;&#x7A0B;&#x662F;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#xFF0C;</p>
<p><pre><br> [B.defaultRpcServer.handler=22,queue=1,port=16020]<br> [B.defaultRpcServer.handler=25,queue=1,port=16020]<br> &#x2026;<br></pre><br>&#x5728;HFileBlock#FsReader&#x4E2D;&#xFF0C;&#x9884;&#x8BFB;&#x53D6;&#x7684;33&#x4E2A;&#x5B57;&#x8282;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;HFileBlock&#x7684;&#x5934;&#x4FE1;&#x606F;&#x7F13;&#x5B58;&#x5728;&#x4E00;&#x4E2A;ThreadLocal&#x7684;&#x7F13;&#x5B58;&#x4E2D;&#xFF0C;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">PrefetchedHeader prefetchedHeader =&#xA0;prefetchedHeaderForThread.get();</div><div class="line">ByteBuffer&#xA0;headerBuf = prefetchedHeader.offset&#xA0;== offset? prefetchedHeader.buf:&#xA0;null;</div></pre></td></tr></table></figure></p>
<p>&#x5728;&#x8FDB;&#x884C;&#x8BFB;block&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x9996;&#x5148;&#x4ECE;ThreadLocal&#x4E2D;&#x53D6;&#x51FA;&#x4E0A;&#x4E00;&#x6B21;&#x9884;&#x8BFB;&#x7684;block&#x5934;&#x4FE1;&#x606F;&#x3002; &#x6839;&#x636E;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#xFF0C;&#x8FD9;&#x4E9B;&#x64CD;&#x4F5C;&#x53EF;&#x80FD;&#x5728;&#x4E0D;&#x540C;&#x7684;&#x7EBF;&#x7A0B;&#x4E0A;&#x8FD0;&#x884C;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF1A;</p>
<p><pre><br>   A&#x7EBF;&#x7A0B;&#x9884;&#x8BFB;&#x4E86;&#x4E0B;&#x4E00;&#x4E2A;block blk&#x7684;&#x5934;&#x4FE1;&#x606F;&#xFF0C;<br>   B&#x7EBF;&#x7A0B;&#x4ECE;threadlocal&#x4E2D;&#x53D6;&#x51FA;&#x5934;&#x4FE1;&#x606F;&#xFF0C;&#x7531;&#x4E8E;B&#x7EBF;&#x7A0B;&#x7684;prefetchedHeader.offset &#xFF1D; &#xFF0D;1&#xFF0C; &#x6B64;&#x65F6;prefetchedHeader.offset == offset &#x7B49;&#x5F0F;&#x4E0D;&#x6210;&#x7ACB;&#xFF0C; &#x56E0;&#x6B64;&#x6B64;&#x6B21;&#x64CD;&#x4F5C;&#x9700;&#x8981;&#x8BFB;&#x53D6;blk&#x7684;&#x5934;&#x4FE1;&#x606F;&#x3002;<br>   &#x540C;&#x4E00;&#x4E2A;&#x8F93;&#x5165;&#x6D41;&#x5728;&#x5E95;&#x5C42;&#x5B9E;&#x73B0;&#x4E0A;,&#x7531;&#x4E8E;&#x9884;&#x8BFB;&#x4E86;blk&#x7684;&#x5934;&#x4FE1;&#x606F;&#x3002;&#x56E0;&#x6B64;&#xFF0C; &#x6B64;&#x65F6;&#x51FA;&#x73B0; pos &gt; targetPos&#x7684;&#x73B0;&#x8C61;, &#x4E14;&#x5DEE;&#x503C;&#x6070;&#x597D;&#x4E3A;33&#x3002;<br>&#x4E8E;&#x662F;&#x51FA;&#x73B0;&#x4E86;&#x7C7B;&#x4F3C;&#x4E8E;&#x6587;&#x4E2D;&#x63CF;&#x8FF0;&#x7684;&#x73B0;&#x8C61;&#x3002;<br></pre></p>
<h3 id="&#x89E3;&#x51B3;&#x65B9;&#x6848;"><a href="#&#x89E3;&#x51B3;&#x65B9;&#x6848;" class="headerlink" title="&#x89E3;&#x51B3;&#x65B9;&#x6848;"></a>&#x89E3;&#x51B3;&#x65B9;&#x6848;</h3><p>&#x4E00;&#x4E9B;&#x63CF;&#x8FF0;&#x548C;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x53EF;&#x89C1;<a href="https://issues.apache.org/jira/browse/HBASE-16212" target="_blank" rel="external">HBASE-16212</a>&#x3002;</p>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="hdfs_log_repeat/" class="post-link">HDFS "Not scheduling suspect block xxx for rescanning"日志刷屏问题探究（1）</a></h2><span class="post-time">Sep 24, 2017</span><div class="post-content"><h3 id="&#x73B0;&#x8C61;"><a href="#&#x73B0;&#x8C61;" class="headerlink" title="&#x73B0;&#x8C61;"></a>&#x73B0;&#x8C61;</h3><p>   &#x5728;DataNode&#x7684;&#x65E5;&#x5FD7;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x6709;&#x8BB8;&#x591A;&#x7C7B;&#x4F3C;&#x4E8E;&#xFF0C;</p>
<pre>
2016-07-01 05:53:29,328 INFO org.apache.hadoop.hdfs.server.datanode.VolumeScanner: VolumeScanner(/data12/hadoop/dfs, DS-086bc494-d862-470c-86e8-9cb7929985c6): Not scheduling suspect block BP-360285305-10.130.x.xx-1444619256876:blk_1095475173_21737939 for rescanning, because we rescanned it recently.
2016-07-01 05:53:29,330 INFO org.apache.hadoop.hdfs.server.datanode.VolumeScanner: VolumeScanner(/data12/hadoop/dfs, DS-086bc494-d862-470c-86e8-9cb7929985c6): Not scheduling suspect block BP-360285305-10.130.x.xx-1444619256876:blk_1095475173_21737939 for rescanning, because we rescanned it recently.
2016-07-01 05:53:29,334 INFO org.apache.hadoop.hdfs.server.datanode.VolumeScanner: VolumeScanner(/data12/hadoop/dfs, DS-086bc494-d862-470c-86e8-9cb7929985c6): Not scheduling suspect block BP-360285305-10.130.x.xx-1444619256876:blk_1095475173_21737939 for rescanning, because we rescanned it recently.
</pre>

<p>&#x8FD9;&#x6837;&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x867D;&#x7136;&#x5728;<a href="https://issues.apache.org/jira/browse/HDFS-8659" target="_blank" rel="external">HDFS-8659</a>&#x4E2D;&#x6709;&#x8FC7;&#x7C7B;&#x4F3C;&#x7684;&#x63CF;&#x8FF0;&#x53CA;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#xFF0C;&#x4F46;&#x6CA1;&#x6709;&#x5177;&#x4F53;&#x63CF;&#x8FF0;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x51FA;&#x73B0;&#x8FD9;&#x6837;&#x95EE;&#x9898;&#x7684;&#x539F;&#x56E0;&#x3002;&#x5728;HDFS&#x7684;&#x65E5;&#x5FD7;&#x4E0A;&#x548C;DataNode&#x8868;&#x73B0;&#x770B;&#xFF0C;&#x4E5F;&#x5E76;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x5F02;&#x5E38;&#x65E5;&#x5FD7;&#x6216;&#x8005;&#x73B0;&#x8C61;&#x53D1;&#x751F;&#xFF0C;&#x8FD9;&#x7ED9;&#x5982;&#x4F55;&#x627E;&#x5230;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x51FA;&#x73B0;&#x7684;&#x539F;&#x56E0;&#x5E26;&#x6765;&#x5F88;&#x5927;&#x7684;&#x56F0;&#x96BE;&#x3002;</p>
<h3 id="&#x89E3;&#x51B3;&#x601D;&#x8DEF;&#x53CA;&#x65B9;&#x6848;"><a href="#&#x89E3;&#x51B3;&#x601D;&#x8DEF;&#x53CA;&#x65B9;&#x6848;" class="headerlink" title="&#x89E3;&#x51B3;&#x601D;&#x8DEF;&#x53CA;&#x65B9;&#x6848;"></a>&#x89E3;&#x51B3;&#x601D;&#x8DEF;&#x53CA;&#x65B9;&#x6848;</h3><p>   &#x7ECF;&#x8FC7;&#x4E00;&#x4E9B;&#x6E90;&#x7801;&#x7684;&#x8DDF;&#x8E2A;&#xFF0C;&#x53D1;&#x73B0;&#x65E5;&#x5FD7;&#x5237;&#x5C4F;&#x7684;&#x539F;&#x56E0;&#x53EF;&#x80FD;&#x548C;&#x7528;&#x6237;&#x4F7F;&#x7528;HDFS&#x76F8;&#x5173;&#x3002;&#x627E;&#x51FA;&#x5176;&#x4E2D;&#x4E00;&#x53F0;DataNode&#x4E4B;&#x540E;&#xFF0C;&#x8C03;&#x4F4E;Log&#x7684;&#x65E5;&#x5FD7;&#x8F93;&#x51FA;&#x7EA7;&#x522B;(&#x4ECE;Info&#x5230;Trace), &#x679C;&#x7136;&#x5728;&#x5BF9;&#x5E94;&#x7684;&#x65E5;&#x5FD7;&#x4E0A;&#xFF0C;&#x53D1;&#x73B0;&#x4E0E;&#x95EE;&#x9898;&#x76F8;&#x5173;&#x7684;&#x5F02;&#x5E38;&#x6808;&#x4FE1;&#x606F;&#xFF1A;</p>
<pre>
2016-06-30 11:21:34,320 TRACE org.apache.hadoop.hdfs.server.datanode.DataNode: DatanodeRegistration(10.130.x.xx:50010, datanodeUuid=f3d795cc-2b3b-43b9-90c3-e4157c031d2c, infoPort=50075, infoSecurePort=0, ipcPort=50020, storageInfo=lv=-56;cid=CID-a99b693d-6f26-48fe-ad37-9f8162f70b22;nsid=920937379;c=0):Ignoring exception while serving BP-360285305-10.130.x.xx-1444619256876:blk_1105510536_31776579 to /10.130.x.xx:39933
java.net.SocketException: Original Exception : java.io.IOException: Connection reset by peer
    at sun.nio.ch.FileChannelImpl.transferTo0(Native Method)
    at sun.nio.ch.FileChannelImpl.transferToDirectlyInternal(FileChannelImpl.java:427)
    at sun.nio.ch.FileChannelImpl.transferToDirectly(FileChannelImpl.java:492)
    at sun.nio.ch.FileChannelImpl.transferTo(FileChannelImpl.java:607)
    at org.apache.hadoop.net.SocketOutputStream.transferToFully(SocketOutputStream.java:223)
    at org.apache.hadoop.hdfs.server.datanode.BlockSender.sendPacket(BlockSender.java:579)
    at org.apache.hadoop.hdfs.server.datanode.BlockSender.doSendBlock(BlockSender.java:759)
    at org.apache.hadoop.hdfs.server.datanode.BlockSender.sendBlock(BlockSender.java:706)
    at org.apache.hadoop.hdfs.server.datanode.DataXceiver.readBlock(DataXceiver.java:551)
    at org.apache.hadoop.hdfs.protocol.datatransfer.Receiver.opReadBlock(Receiver.java:116)
    at org.apache.hadoop.hdfs.protocol.datatransfer.Receiver.processOp(Receiver.java:71)
    at org.apache.hadoop.hdfs.server.datanode.DataXceiver.run(DataXceiver.java:251)
    at java.lang.Thread.run(Thread.java:745)
Caused by: java.io.IOException: Connection reset by peer
    ... 13 more
</pre>

<p>&#x4ECE;&#x8FD9;&#x6BB5;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x4EE5;&#x4E0B;&#x4FE1;&#x606F;&#xFF1A;</p>
<pre>
      1, &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x8BFB;&#x64CD;&#x4F5C;(Receiver.opReadBlock)&#x3002;
      2, &#x8BFB;&#x53D6;&#x7684;block&#x4E3A;blk_1105510536_31776579&#x3002;
      3&#xFF0C;client&#x8EAB;&#x4EFD;&#x6807;&#x8BC6;&#x4E3A;CID-a99b693d-6f26-48fe-ad37-9f8162f70b22&#x3002;
      4&#xFF0C;&#x4ECE;&#x5F02;&#x5E38;&#x7684;&#x4FE1;&#x606F;&#x6765;&#x770B;&#xFF08;Connection reset by peer)&#xFF0C;DataNode&#x662F;&#x4ECE;&#x4E00;&#x4E2A;&#x5DF2;&#x7ECF;&#x88AB;&#x5BA2;&#x6237;&#x7AEF;&#x5173;&#x95ED;&#x7684;&#x8FDE;&#x63A5;&#x53D1;&#x9001;packet&#x65F6;&#x51FA;&#x73B0;&#x5F02;&#x5E38;&#x3002;
</pre>

<p>&#x4ECE;&#x670D;&#x52A1;&#x7AEF;&#x8868;&#x73B0;&#x7ED3;&#x5408;&#x65E5;&#x5FD7;&#x4E0A;&#x6765;&#x770B;&#xFF0C;&#x8FD9;&#x66F4;&#x50CF;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x53EF;&#x80FD;&#x548C;&#x7528;&#x6237;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x76F8;&#x5173;&#x3002; &#x7528;&#x6237;&#x76F8;&#x5173;&#x7684;&#x4FE1;&#x606F;&#x8868;&#x73B0;&#x5728;&#x8981;&#x8BFB;&#x53D6;&#x7684;block&#x4EE5;&#x53CA;&#x5BA2;&#x6237;&#x7AEF;&#x8EAB;&#x4EFD;&#x6807;&#x8BC6;(CID)&#xFF0C;&#x901A;&#x8FC7;CID&#x627E;&#x5230;&#x662F;&#x54EA;&#x4E2A;&#x5E94;&#x7528;&#x6709;&#x4E00;&#x4E9B;&#x56F0;&#x96BE;&#xFF0C;&#x53EF;&#x80FD;&#x662F;yarn&#x4E0A;&#x8FD0;&#x884C;&#x7684;&#x4F5C;&#x4E1A;&#xFF0C;&#x4E5F;&#x6709;&#x53EF;&#x80FD;&#x662F;&#x5982;&#x722C;&#x866B;&#x7B49;&#x5176;&#x5B83;&#x670D;&#x52A1;&#x3002;&#x770B;&#x8D77;&#x6765;&#xFF0C;&#x901A;&#x8FC7;block&#x4FE1;&#x606F;&#x5F97;&#x5230;&#x76F8;&#x5E94;&#x7684;&#x6587;&#x4EF6;&#x4FE1;&#x606F;&#xFF0C;&#x770B;&#x54EA;&#x4E9B;&#x7528;&#x6237;&#x6709;&#x64CD;&#x4F5C;&#x8FD9;&#x4E9B;&#x4E2A;&#x6587;&#x4EF6;&#xFF0C;&#x662F;&#x4E00;&#x6761;&#x6BD4;&#x8F83;&#x5FEB;&#x6377;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x5982;&#x4F55;&#x901A;&#x8FC7;block&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6587;&#x4EF6;&#x4FE1;&#x606F;&#x5462;&#xFF1F;&#x4E00;&#x4E2A;&#x5F88;&#x76F4;&#x63A5;&#x7684;&#x60F3;&#x6CD5;&#x662F;&#xFF0C;&#x5206;&#x6790;hdfs fsimage&#x6587;&#x4EF6;&#xFF0C;&#x5728;&#x624B;&#x5199;&#x4E00;&#x4E2A;&#x63D2;&#x4EF6;&#x540E;&#xFF1A;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">public class BlockLookUpWriter extends  PBImageTextWriter</div><div class="line">{</div><div class="line">    private final static Logger LOG = Logger.getLogger(BlockLookUpWriter.class);</div><div class="line">    public BlockLookUpWriter(PrintStream out, String tempPath, String blockIds)</div><div class="line">       throws IOException, IllegalArgumentException{</div><div class="line">        super(out, tempPath);</div><div class="line">        String[] blks = StringUtils.split(blockIds, &apos;,&apos;);</div><div class="line">        for (String blockId : blks) {</div><div class="line">            if (blockId.startsWith(&quot;blk_&quot;)) {</div><div class="line">                blockId = blockId.substring(4);</div><div class="line">            }</div><div class="line">            int split = -1;</div><div class="line">            if ((split = blockId.indexOf(&quot;_&quot;)) &gt; 0) {</div><div class="line">                blockId = blockId.substring(0, split);</div><div class="line">            }</div><div class="line">            Pattern pattern = Pattern.compile(&quot;^\\d+$&quot;);</div><div class="line">            Matcher matcher = pattern.matcher(blockId);</div><div class="line">            if (!matcher.find())</div><div class="line">                throw new IllegalArgumentException(&quot;blockIds: &quot; + blockIds);</div><div class="line">            blockMapping.put(Long.parseLong(blockId), &quot;&quot;);</div><div class="line">        }</div><div class="line"></div><div class="line">        if (blockMapping.isEmpty())</div><div class="line">           throw new IllegalArgumentException(&quot;blockIds: &quot; + blockIds);</div><div class="line">    }</div><div class="line"></div><div class="line">    private final Map&lt;Long, String&gt; blockMapping = new HashMap&lt;&gt;();</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected String getEntry(String parent, FsImageProto.INodeSection.INode inode) {</div><div class="line">       if (FsImageProto.INodeSection.INode.Type.FILE == inode.getType()) {</div><div class="line">           FsImageProto.INodeSection.INodeFile file = inode.getFile();</div><div class="line">           List&lt;HdfsProtos.BlockProto&gt; blocks = file.getBlocksList();</div><div class="line">           for (HdfsProtos.BlockProto bp : blocks) {</div><div class="line">               if (blockMapping.containsKey(bp.getBlockId())) {</div><div class="line">                  String fileName = inode.getName().toStringUtf8();</div><div class="line">                  if (!parent.endsWith(&quot;/&quot;)) {</div><div class="line">                      parent = parent + &quot;/&quot;;</div><div class="line">                  }</div><div class="line">                  this.blockMapping.put(bp.getBlockId(), parent + fileName);</div><div class="line">                  LOG.info(&quot;found block: blk_&quot; + bp.getBlockId() + &quot;, fileName: &quot; + (parent + fileName));</div><div class="line">               }</div><div class="line">           }</div><div class="line">	</div><div class="line">       }</div><div class="line">       return null;</div><div class="line">    }</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void opOnEntry(String entry) {</div><div class="line">      //do nothing</div><div class="line">    }</div><div class="line"></div><div class="line">    public void print() throws IOException {</div><div class="line">      for (Map.Entry&lt;Long, String&gt; entry : blockMapping.entrySet()) {</div><div class="line">          out.println( &quot;blk_&quot; + entry.getKey() + &quot;:&quot; + entry.getValue());</div><div class="line">      }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x5229;&#x7528;&#x8FD9;&#x4E2A;&#x7C7B;&#x6765;&#x627E;&#x51FA;&#x5BF9;&#x5E94;&#x7684;&#x6587;&#x4EF6;(java -cp), &#x53D1;&#x73B0;&#x8FD9;&#x4E9B;blk&#x4FE1;&#x606F;&#x5BF9;&#x5E94;&#x7684;&#x6587;&#x4EF6;&#x7ADF;&#x7136;&#x662F;HBase HFile&#x6587;&#x4EF6;(&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x5176;&#x5B9E;&#x8D70;&#x4E86;&#x4E00;&#x4E9B;&#x5F2F;&#x8DEF;&#xFF0C;&#x5728;&#x6211;&#x4EEC;&#x7684;hadoop&#x7248;&#x672C;(2.7.1)&#x4E0A;&#xFF0C;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x901A;&#x8FC7;hdfs&#x547D;&#x4EE4;&#x53EF;&#x4EE5;&#x83B7;&#x53D6;blk&#x5BF9;&#x5E94;&#x7684;&#x6587;&#x4EF6;&#x4FE1;&#x606F;)&#xFF1A;</p>
<p><pre><br>/hbase/data/yisou/unifer_jhjj/053bc95da7a6fc9c4856cb92cfcbdce2/data/f7239ccdd9194c388b772a6117bd12ca<br>/hbase/data/yisou/unifer_jhjj/63db62674aeea84ade0fc291c6f9370d/data/8f7966c3a64240b2b9ed1b50db3d1b0c<br>/hbase/data/yisou/unifer_jhjj/be1bafb3804974673b73001e0ba9a656/data/7f733cad1f1b4b2790a6019208f05d24<br></pre><br>&#x7ECF;&#x8FC7;&#x4E00;&#x756A;&#x6392;&#x67E5;&#xFF0C;&#x53EF;&#x4EE5;&#x5927;&#x6982;&#x7387;&#x7684;&#x786E;&#x5B9A;&#xFF0C;&#x8FD9;&#x4E2A;&#x548C;RegionServer&#x4F7F;&#x7528;HDFS&#x76F8;&#x5173;&#x3002;</p>
<p>&#x627E;&#x5230;&#x65B9;&#x5411;&#x540E;&#xFF0C;&#x719F;&#x6089;&#x4E86;&#x4E00;&#x4E0B;&#x5BA2;&#x6237;&#x7AEF;&#x5982;&#x4F55;&#x8BFB;&#x53D6;HDFS&#x6587;&#x4EF6;&#x4E0A;&#x7684;&#x6E90;&#x7801;&#xFF0C;&#x7ED3;&#x5408;DataNode&#x4E0A;&#x7684; <em>java.io.IOException: Connection reset by peer</em> &#x5F02;&#x5E38;&#xFF0C;&#x8BD5;&#x56FE;&#x89E3;&#x91CA;&#x95EE;&#x4EC0;&#x4E48;client&#x8981;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x3002; &#x68B3;&#x7406;DFSInputStream&#x7684;&#x521B;&#x5EFA;&#x903B;&#x8F91;&#xFF0C;</p>
<p><pre><br> &#x521B;&#x5EFA;&#x4E00;&#x4E2A; InputStream  &#x2014;&gt; BlockReaderFactory&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;BlockReader<br>                                           blockReader&#x4E2D;&#x53EF;&#x4EE5;&#x83B7;&#x53D6;&#x4E0E;DN&#x76F8;&#x5173;&#x7684;&#x8F93;&#x5165;&#x8F93;&#x51FA;&#x6D41;<br>          &#x521B;&#x5EFA;&#x6D41;&#x7684;&#x8FC7;&#x7A0B;&#xFF1A;<br>              if(PeerCache&#x4E2D;&#x5305;&#x542B;&#x4E0E;DN&#x7684;&#x8FDE;&#x63A5; &amp;&amp; &#x8BE5;blockreader&#x4F7F;&#x7528;&#x7F13;&#x5B58;&#x8FDE;&#x63A5;&#x7684;&#x6B21;&#x6570;  &lt; 3 &#xFF09; {<br>                   1&#xFF0C; &#x4ECE;&#x7F13;&#x5B58;&#x4E2D;&#x53D6;&#x51FA;&#x6539;&#x8FDE;&#x63A5;&#xFF0C; &#x5E76;&#x5C06;&#x8BE5;&#x8FDE;&#x63A5;&#x4ECE;PeerCache&#x4E2D;&#x79FB;&#x9664;<br>                   2&#xFF0C; &#x5229;&#x7528;&#x8BE5;&#x8FDE;&#x63A5;&#x521B;&#x5EFA;&#x6B64;&#x6B21;&#x8BFB;&#x8FC7;&#x7A0B;&#x7684;&#x8F93;&#x5165;&#x8F93;&#x51FA;&#x6D41;<br>             }   else {<br>                    &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x8FDE;&#x63A5;<br>             }<br></pre><br>&#x5728;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x65F6;&#xFF0C;&#x5224;&#x65AD;&#x8BE5;&#x8FDE;&#x63A5;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x88AB;&#x8BFB;&#x53D6;&#x5B8C;&#x6BD5;&#xFF0C;&#x5982;&#x679C;&#x8BFB;&#x53D6;&#x5B8C;&#x6BD5;&#xFF0C;&#x5219;&#x8BA4;&#x4E3A;&#x662F;&#x4E00;&#x4E2A;&#x5E72;&#x51C0;&#x7684;&#x8FDE;&#x63A5;&#xFF0C; &#x53EF;&#x4EE5;&#x5C06;&#x8BE5;&#x8FDE;&#x63A5;&#x4EA4;&#x7ED9;PeerCache&#x6765;&#x7BA1;&#x7406;&#xFF0C;&#x5426;&#x5219;&#x8C03;&#x7528;close&#x65B9;&#x6CD5;&#x6765;&#x5F3A;&#x5236;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x3002;PeerCache&#x7EF4;&#x62A4;&#x7F13;&#x5B58;&#x7684;&#x8FDE;&#x63A5;&#xFF0C;&#x5C06;&#x8FC7;&#x671F;&#x7684;&#x8FDE;&#x63A5;&#x4ECE;&#x7F13;&#x5B58;&#x4E2D;&#x79FB;&#x9664;&#xFF0C;&#x5E76;&#x7EF4;&#x62A4;&#x7F13;&#x5B58;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x8FDE;&#x63A5;&#x7684;&#x8FC7;&#x671F;&#x65F6;&#x95F4;&#x9ED8;&#x8BA4;&#x4E3A;3s, &#x7F13;&#x5B58;&#x5927;&#x5C0F;&#x4E3A;16&#x3002;&#x7531;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x53EF;&#x77E5;&#xFF0C; &#x4E00;&#x4E2A;&#x8F93;&#x5165;&#x6D41;&#x5B9E;&#x4F8B;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;&#x8FDE;&#x63A5;&#x5B9E;&#x4F8B;&#xFF0C; &#x540C;&#x4E00;&#x65F6;&#x523B;&#x4E0D;&#x5B58;&#x5728;&#x4E24;&#x4E2A;&#x8F93;&#x5165;&#x6D41;&#x5B9E;&#x4F8B;&#x8D21;&#x732E;&#x540C;&#x4E00;&#x4E2A;&#x8FDE;&#x63A5;&#x5B9E;&#x4F8B;&#x3002; &#x5171;&#x4EAB;&#x540C;&#x4E00;&#x4E2A;&#x8FDE;&#x63A5;&#x5B9E;&#x4F8B;&#x7684;&#x8F93;&#x5165;&#x6D41;&#x6709;&#x5148;&#x540E;&#x987A;&#x5E8F;&#x3002;<br></p>
<p>&#x4E00;&#x4E2A;InputStream close&#x64CD;&#x4F5C;&#x53D1;&#x751F;&#x7684;&#x65F6;&#x673A;&#xFF1A;<br><br>  1&#xFF0C; &#x4E0A;&#x5C42;&#x663E;&#x5F0F;&#x8C03;&#x7528;&#xFF1B;<br><br>  2&#xFF0C; DFSInputStream&#x8BFB;&#x53D6;&#x65F6;block&#x5207;&#x6362;&#x6216;&#x8005;DN&#x5BB9;&#x9519;(&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x53D1;&#x751F;&#x5728;&#x4E0E;DN&#x901A;&#x4FE1;&#x6709;&#x95EE;&#x9898;&#x6216;&#x8005;&#x53D1;&#x751F;checksum error&#x9519;&#x8BEF;&#x65F6;&#x53D1;&#x751F;&#x3002;<br><br>  3&#xFF0C; PeerCache&#x79FB;&#x9664;&#x8FC7;&#x671F;&#x7684;&#x8FDE;&#x63A5;&#x3002;<br><br> &#x4E5F;&#x5373;&#xFF0C; &#x8FDE;&#x63A5;&#x7684;close&#x64CD;&#x4F5C;&#x662F;&#x7531;&#x552F;&#x4E00;&#x7684;&#x8F93;&#x5165;&#x6D41;&#x672C;&#x8EAB;&#x6765;&#x63A7;&#x5236;&#x7684;&#xFF0C; &#x7ED3;&#x5408;&#x4E4B;&#x524D;&#x51FA;&#x73B0;&#x7684;&#x5F02;&#x5E38;&#xFF0C;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x4EE5;&#x4E0B;&#x7ED3;&#x8BBA;&#xFF1A;<br></p>
<p>  <strong> &#x7B2C;&#x4E09;&#x79CD;&#x60C5;&#x51B5;&#xFF0C; &#x7531;PeerCache&#x6765;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#xFF0C; PeerCache&#x7BA1;&#x7406;&#x7684;&#x8FDE;&#x63A5;&#x662F;&#x4E00;&#x6761;&#x5E72;&#x51C0;&#x7684;&#x8FDE;&#x63A5;&#xFF0C;&#x8FD9;&#x6837;&#x7684;&#x8FDE;&#x63A5;&#x6CA1;&#x6709;&#x6267;&#x884C;&#x4E0A;&#x4E0B;&#x6587;(&#x53EF;&#x7C7B;&#x6BD4;&#x6700;&#x521D;&#x65B0;&#x5EFA;&#x7ACB;&#x7684;&#x8FDE;&#x63A5;)&#xFF0C;&#x4ECE;DN&#x629B;&#x51FA;&#x7684;&#x5F02;&#x5E38;&#x6765;&#x770B;&#xFF0C;&#x8FDE;&#x63A5;&#x8FD8;&#x5728;&#x670D;&#x52A1;&#x8BF7;&#x6C42;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#xFF0C;&#x56E0;&#x6B64;&#x6392;&#x51FA;&#x7531;PeerCache&#x6765;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x7684;&#x53EF;&#x80FD;&#x6027;&#x3002;</strong><br><br>  <strong> &#x7B2C;&#x4E8C;&#x79CD;&#x60C5;&#x51B5;&#xFF0C; &#x4F7F;&#x7528;hdfs fsck&#x547D;&#x4EE4;&#x68C0;&#x67E5;&#x8BE5;blk&#x65F6;&#xFF0C;&#x5E76;&#x672A;&#x53D1;&#x751F;checksum&#x53D1;&#x751F;&#x9519;&#x8BEF;&#x7684;block&#x5757;&#xFF0C;&#x6392;&#x51FA;checksum error&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x4E5F;&#x5E76;&#x975E;DN&#x7684;&#x95EE;&#x9898;&#xFF0C; &#x5728;hbase&#x7684;region&#x4E2D;&#x4E5F;&#x672A;&#x53D1;&#x73B0;&#x8FD9;&#x6837;&#x7C7B;&#x4F3C;&#x7684;&#x65E5;&#x5FD7;&#x3002;&#xFF08;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x8FD8;&#x9700;&#x786E;&#x5B9A;)</strong><br><br></p>
<p>  &#x518D;&#x5206;&#x6790;&#x4E00;&#x4E0B;HDFS&#x7684;&#x65E5;&#x5FD7;&#xFF1A;<br> <pre><br>2016-07-07 19:41:41,077 INFO org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.48:35358, bytes: 327680, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1151551783_1, offset: 44174336, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1108372123_34638287, duration: 13597476738896301, endOffset:50168268<br>2016-07-07 19:41:41,426 INFO org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.48:35364, bytes: 327680, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1151551783_1, offset: 44240384, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1108372123_34638287, duration: 13597477088563567, endOffset:50168268<br>2016-07-07 19:41:41,643 INFO org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.48:35368, bytes: 393216, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1151551783_1, offset: 44305920, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1108372123_34638287, duration: 13597477304937745, endOffset:50168268<br>2016-07-07 19:41:41,844 INFO org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.48:35373, bytes: 327680, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1151551783_1, offset: 44437504, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1108372123_34638287, duration: 13597477506783816, endOffset:50168268<br>2016-07-07 19:41:42,290 INFO org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.48:35377, bytes: 262144, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1151551783_1, offset: 44503040, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1108372123_34638287, duration: 13597477952726051, endOffset:50168268<br>2016-07-07 19:41:42,541 INFO org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.48:35389, bytes: 589824, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1151551783_1, offset: 44568576, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1108372123_34638287, duration: 13597478203646763, endOffset:50168268<br>2016-07-07 19:41:42,761 INFO org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.48:35393, bytes: 327680, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1151551783_1, offset: 44766208, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1108372123_34638287, duration: 13597478422925409, endOffset:50168268<br>2016-07-07 19:41:42,954 INFO org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.48:35396, bytes: 327680, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1151551783_1, offset: 44963328, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1108372123_34638287, duration: 13597478616454260, endOffset:50168268<br>2016-07-07 19:41:43,305 INFO org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.48:35402, bytes: 327680, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1151551783_1, offset: 45028864, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1108372123_34638287, duration: 13597478967544152, endOffset:50168268<br>2016-07-07 19:41:43,530 INFO org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.48:35414, bytes: 196608, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1151551783_1, offset: 45094912, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1108372123_34638287, duration: 13597479192103744, endOffset:50168268<br></pre><br>&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C; &#x540C;&#x4E00;&#x4E2A;DFSClient&#x662F;&#x5411;DN&#x53D1;&#x8D77;&#x591A;&#x6B21;&#x4E0D;&#x540C;&#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x8BF7;&#x6C42;&#x540C;&#x4E00;&#x4E2A;block&#x3002;&#x8FD9;&#x4E9B;&#x4E0D;&#x540C;&#x7684;&#x8BF7;&#x6C42;&#x6709;&#x7740;&#x76F8;&#x540C;&#x7684;endOffset, &#x5176;&#x4E2D;&#x5229;&#x7528;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#xFF0C; &#x53EF;&#x83B7;&#x5F97;&#x4E00;&#x4E2A;&#x5927;&#x81F4;&#x7684;&#x8BF7;&#x6C42;&#x56FE;&#xFF1A;</p>
<p><pre><br> | &#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x6570;&#x636E;&#x533A;&#x95F4; &#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF5C;<br> | &#xFF0D;&#xFF0D;&#xFF5C;  -&gt; 1<br>         |&#x2014;&#x2014;| -&gt;2<br>               |&#x2014;&#x2014;| -&gt;3<br>                     |&#x2014;&#x2014;&#x2014;| -&gt;4<br>                               |&#x2014;&#x2014;&#x2014;| -&gt;5<br>                                       &#x2026;.<br>  &#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&#xFF0D;&gt; &#x65F6;&#x95F4;<br></pre><br>&#x8FD9;&#x4E9B;&#x8BF7;&#x6C42;&#x5728;&#x65F6;&#x95F4;&#x4E0A;&#x4E5F;&#x6709;&#x4E25;&#x683C;&#x7684;&#x5148;&#x540E;&#x987A;&#x5E8F;&#xFF08;&#x4ECE;&#x4E4B;&#x524D;&#x7684;&#x65E5;&#x5FD7;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;&#x8FD9;&#x90E8;&#x5206;&#x65E5;&#x5FD7;&#x7684;duration&#x503C;&#x662F;&#x5F53;&#x524D;&#x65F6;&#x95F4;&#x7684;ns&#x8868;&#x793A;)&#xFF0C; &#x53EF;&#x4EE5;&#x5047;&#x8BBE;&#xFF0C;&#x8FD9;&#x4E9B;&#x8BF7;&#x6C42;&#x90FD;&#x5F52;&#x5C5E;&#x4E8E;&#x67D0;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x5927;&#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x7528;&#x4E8E;&#x67D0;&#x79CD;&#x539F;&#x56E0;&#xFF0C;&#x8FD9;&#x4E9B;&#x8BF7;&#x6C42;&#x88AB;&#x5206;&#x5272;&#x6210;&#x8FD9;&#x4E9B;&#x5C0F;&#x8BF7;&#x6C42;&#x3002;<br>&#x5206;&#x6790;DFSInputStream&#x7684;read&#x65B9;&#x6CD5;&#xFF0C;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">read(final byte buf[], int off, int len)  </div><div class="line">                -&gt; readWithStrategy(ReaderStrategy strategy, int off, int len)</div><div class="line">                           &#x5206;&#x4E3A;&#x4E24;&#x6B65;&#xFF1A;</div><div class="line">                              1&#xFF0C; int result = readBuffer(strategy, off, realLen, corruptedBlockMap);  realLen &#x662F;&#x6B64;&#x6B21;read&#x64CD;&#x4F5C;&#x6700;&#x5927;&#x8BFB;&#x53D6;&#x7684;&#x5B57;&#x8282;&#x6570;&#xFF0C;&#x8FD9;&#x4E2A;&#x548C;&#x7528;&#x6237;&#x7ED9;&#x4E86;&#x591A;&#x5927;&#x7684;buffer&#x4EE5;&#x53CA;&#x5F53;&#x524D;&#x8981;&#x8BFB;&#x53D6;&#x7684;block&#x5269;&#x4F59;&#x5927;&#x5C0F;&#x76F8;&#x5173;&#x3002;</div><div class="line">                              2&#xFF0C; pos += result,  &#x79FB;&#x52A8;pos</div><div class="line">                 -&gt;  return result</div><div class="line"></div><div class="line">&#x5728;&#x4E0A;&#x4E00;&#x6B65;&#x7684;readBuffer&#x4E2D;&#xFF0C; </div><div class="line">       readBuffer(strategy, off, realLen, corruptedBlockMap) </div><div class="line">            -&gt; return reader.doRead(blockReader, off, len); </div><div class="line">                -&gt; &#x8C03;&#x7528;RemoteBlockReader2&#x7684;reader.doRead(blockReader, off, len);&#x65B9;&#x6CD5;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x5C06;&#x5E95;&#x5C42;&#x8BFB;&#x53D6;&#x7684;&#x6570;&#x636E;&#x62F7;&#x8D1D;&#x5230;&#x7528;&#x6237;&#x7684;buf&#x4E2D;&#xFF0C;&#x62F7;&#x8D1D;&#x6570;&#x636E;&#x7684;&#x5927;&#x5C0F;&#x4E3A;min{buf&#x9700;&#x8981;&#x8BFB;&#x53D6;&#x7684;len&#xFF0C; &#x5E95;&#x5C42;&#x5269;&#x4F59;&#x5F85;&#x62F7;&#x8D1D;&#x7684;&#x5B57;&#x8282;&#x6570;&#xFF5D;&#xFF0C;&#x5F53;&#x5E95;&#x5C42;&#x6570;&#x636E;&#x90FD;&#x88AB;&#x62F7;&#x8D1D;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x518D;&#x9700;&#x8981;&#x8BFB;&#x53D6;&#x65F6;&#xFF0C;&#x5219;&#x7EE7;&#x7EED;&#x8BFB;&#x53D6;&#x4E00;&#x4E2A;packet&#x7684;&#x6570;&#x636E;&#x91CF;&#x3002;</div><div class="line">                -&gt; &#x53D1;&#x751F;&#x5F02;&#x5E38;&#x65F6;(CheckSumException&#x9664;&#x5916;), &#x5C1D;&#x8BD5;&#x4E0E;&#x5F53;&#x524D;&#x7684;datanode&#x91CD;&#x65B0;&#x5EFA;&#x7ACB;&#x4E00;&#x6761;&#x65B0;&#x7684;&#x8FDE;&#x63A5;,  &#x518D;&#x6B21;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#xFF0C;</div></pre></td></tr></table></figure></p>
<p>&#x6BCF;&#x4E00;&#x6B21;&#x53D1;&#x751F;&#x6570;&#x636E;&#x7684;&#x62F7;&#x8D1D;&#xFF0C; DFSInputStream&#x7684;&#x5B9E;&#x4F8B;&#x90FD;&#x4F1A;&#x5C06;pos += result, &#x5F53;&#x62F7;&#x8D1D;&#x53D1;&#x751F;&#x5F02;&#x5E38;&#x65F6;&#xFF0C;DFSInputStream&#x4F1A;&#x4ECE;&#x4E0A;&#x6B21;&#x8BFB;&#x53D6;&#x6210;&#x529F;&#x7684;&#x4F4D;&#x7F6E;&#xFF08;pos&#xFF09;&#x4ECE;&#x65B0;&#x5C1D;&#x8BD5;&#x4E0E;&#x5F53;&#x524D;&#x7684;DataNode&#x521B;&#x5EFA;&#x4E00;&#x6761;&#x65B0;&#x7684;&#x8FDE;&#x63A5;&#xFF0C; &#x8FD9;&#x4E0E;&#x5F53;&#x524D;DataNode&#x8FD9;&#x6837;&#x7684;&#x65E5;&#x5FD7;&#x8F93;&#x51FA;&#x7B26;&#x5408;&#xFF0C;<br>&#x4E5F;&#x5C31;&#x662F;&#x8BF7;&#x6C42;2&#x4E4B;&#x524D;&#xFF0C; DFSInputStream&#x8BFB;&#x53D6;&#x8BF7;&#x6C42;1&#x7684;&#x6570;&#x636E;&#x5931;&#x8D25;&#xFF0C; &#x5C1D;&#x8BD5;&#x91CD;&#x65B0;&#x4E0E;c1-hd-dn10&#x5EFA;&#x7ACB;&#x4E00;&#x6761;&#x65B0;&#x7684;&#x8FDE;&#x63A5;(&#x8BF7;&#x6C42;2&#xFF09;&#xFF0C; &#x4ECE;&#x65B0;&#x8FDE;&#x63A5;&#x4E2D;&#x8BFB;&#x53D6;&#x76F8;&#x5E94;&#x91CF;&#x7684;&#x6570;&#x636E;&#x5E76;&#x6210;&#x529F;&#x8FD4;&#x56DE;&#x6B64;&#x6B21;&#x7684;&#x8BFB;&#x53D6;&#x8FC7;&#x7A0B;&#xFF0C; &#x5F53;&#x7528;&#x6237;&#x8BFB;&#x53D6;n&#x6B21;&#x64CD;&#x4F5C;&#x540E;( &#x5373;&#x91CD;&#x590D;&#x8C03;&#x7528;n&#x6B21;DFSInputStream&#x7684;read&#x65B9;&#x6CD5;&#xFF09;&#xFF0C;&#x6B64;&#x65F6;&#x53D1;&#x751F;&#x5F02;&#x5E38;&#xFF0C;&#x91CD;&#x65B0;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;3&#xFF0C;&#x7EE7;&#x7EED;&#x5F80;&#x4E0A;&#x6B21;&#x6210;&#x529F;&#x8BFB;&#x53D6;&#x7684;&#x5730;&#x65B9;&#x5F00;&#x59CB;&#x8BFB;&#x53D6;&#xFF0C;&#x4F9D;&#x6B64;&#x7C7B;&#x63A8;&#xFF0C;&#x76F4;&#x5230;&#x8BE5;DataNode&#x88AB;&#x6807;&#x8BB0;&#x4E3A;DeadNode&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x5927;&#x8BF7;&#x6C42;&#x88AB;&#x5206;&#x5272;&#x6210;&#x5F88;&#x591A;&#x4E2A;&#x5E76;&#x4E0D;&#x6210;&#x529F;&#x7684;&#x5B50;&#x8BF7;&#x6C42;&#x3002;&#x8FD9;&#x4E5F;&#x5C31;&#x89E3;&#x91CA;&#x4E86;DataNode&#x4F1A;&#x88AB;&#x8FD9;&#x4E9B;&#x65E5;&#x5FD7;&#x5237;&#x5C4F;&#x7684;&#x539F;&#x56E0;&#x3002;<br>&#x5728;DFSInputstream&#x4E0A;&#x52A0;&#x5165;&#x76F8;&#x5E94;&#x7684;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#x540E;&#xFF0C;&#x5C06;&#x8BE5;jar&#x66FF;&#x6362;&#x5230;hbase lib&#x76EE;&#x5F55;&#x4E0B;&#x7684;&#x5BF9;&#x5E94;&#x7684;jar&#x6587;&#x4EF6;&#xFF0C;&#x6B64;&#x65F6;&#x663E;&#x793A;&#x5E76;&#x975E;&#x5982;&#x4E0A;&#x7684;&#x5047;&#x8BBE;&#xFF0C; &#x4E5F;&#x5373;&#x5728;Client&#x7AEF;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x65F6;&#x5E76;&#x6CA1;&#x6709;&#x53D1;&#x751F;&#x8FD9;&#x6837;&#x7684;&#x5F02;&#x5E38;&#xFF0C;&#x8FD9;&#x79CD;&#x53EF;&#x80FD;&#x6027;&#x60C5;&#x51B5;&#x6392;&#x9664;&#x5728;&#x5916;&#x3002;</p>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="hbase_spark/" class="post-link">HBase & Spark ppt</a></h2><span class="post-time">Aug 21, 2017</span><div class="post-content"><p>&#x8FD9;&#x662F;&#x5728;&#x67D0;&#x4E24;&#x6B21;&#x6D3B;&#x52A8;&#x4E0A;&#x5206;&#x4EAB;&#x6240;&#x7528;&#x7684;ppt!</p>
<h3 id="HBase"><a href="#HBase" class="headerlink" title="HBase"></a>HBase</h3><iframe src="hbase.pdf" style="width:100%; height:800px"></iframe>

<h3 id="Spark"><a href="#Spark" class="headerlink" title="Spark"></a>Spark</h3><iframe src="spark.pdf" style="width:100%; height:800px"></iframe>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="hive-llap/" class="post-link">Hive Llap尝试（0）</a></h2><span class="post-time">Mar 15, 2017</span><div class="post-content"><h2 id="Hive-llap&#x5C1D;&#x8BD5;"><a href="#Hive-llap&#x5C1D;&#x8BD5;" class="headerlink" title="Hive llap&#x5C1D;&#x8BD5;"></a>Hive llap&#x5C1D;&#x8BD5;</h2><p> &#x5728;Hive2.0&#x7248;&#x672C;&#x4E0A;&#x5F15;&#x8FDB;&#x4E86;<code>Hive llap(Live Long and Process)</code>&#x8FD9;&#x79CD;&#x65B0;&#x7279;&#x6027;&#xFF0C;&#x4E0E;Tez&#x8BA1;&#x7B97;&#x5F15;&#x64CE;&#x7ED3;&#x5408;&#x7D27;&#x5BC6;&#xFF0C;&#x7C7B;&#x4F3C;&#x4E8E;Presto&#x548C;Impala&#xFF0C; &#x5979;&#x9884;&#x5148;&#x542F;&#x52A8;&#x4E00;&#x7EC4;&#x8FDB;&#x7A0B;&#xFF0C;&#x7B49;&#x5F85;&#x6709;&#x89E3;&#x6790;&#x597D;&#x7684;task&#x7684;&#x5230;&#x6765;&#x5E76;&#x6267;&#x884C;&#x3002; &#x5728;&#x8FD9;&#x8BA1;&#x7B97;&#x6A21;&#x578B;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#xFF0C;&#x5979;&#x8FD8;&#x5F15;&#x5165;&#x4E00;&#x4E9B;&#x52A0;&#x5FEB;task&#x8BA1;&#x7B97;&#x7684;&#x7279;&#x6027;&#xFF1A;<br> <ol><br>   <li>&#x5F02;&#x6B65;&#x6570;&#x636E;&#x611F;&#x77E5;IO</li><br>   <li>&#x8BA1;&#x7B97;&#x6570;&#x636E;&#x9884;&#x8BFB;&#x53D6;&#x548C;&#x5217;&#x7F13;&#x5B58;</li><br>   <li>&#x826F;&#x597D;&#x5730;&#x5E76;&#x884C;&#x5316;&#x6267;&#x884C;task</li><br> </ol><br>&#x5F97;&#x76CA;&#x4E8E;&#x8FC7;&#x53BB;&#x4E24;&#x5E74;&#x91CC;&#x793E;&#x533A;&#x63D0;&#x4EA4;&#x7684;&#x5404;&#x79CD;&#x7279;&#x6027;&#x548C;&#x6539;&#x8FDB;&#xFF0C;Hive&#x80FD;&#x591F;&#x663E;&#x8457;&#x7684;&#x53D8;&#x5FEB;.<br><br> <ul><br>   <li><a href="https://cwiki.apache.org/confluence/display/Hive/LLAP" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LLAP</a></li><br>   <li><a href="http://www.slideshare.net/Hadoop_Summit/llap-longlived-execution-in-hive" target="_blank" rel="external">http://www.slideshare.net/Hadoop_Summit/llap-longlived-execution-in-hive</a></li><br> </ul></p>
<h2 id="&#x90E8;&#x7F72;&#x5B89;&#x88C5;"><a href="#&#x90E8;&#x7F72;&#x5B89;&#x88C5;" class="headerlink" title="&#x90E8;&#x7F72;&#x5B89;&#x88C5;"></a>&#x90E8;&#x7F72;&#x5B89;&#x88C5;</h2> <table><tr><th> &#x8F6F;&#x4EF6; </th><th> &#x7248;&#x672C; </th><th> &#x5B89;&#x88C5;&#x8BF4;&#x660E; </th></tr><tr><td>tez</td><td>0.8.4</td><td><a href="https://tez.apache.org/install.html" target="_blank" rel="external">tez&#x5B89;&#x88C5;</a>&#xFF0C;&#x4FEE;&#x6539;&#x4F9D;&#x8D56;&#x7684;hadoop&#x7248;&#x672C;&#x548C;guava&#x7248;&#x672C;&#xFF0C;&#x91CD;&#x65B0;&#x7F16;&#x8BD1;&#xFF0C;&#x5728;tez-dist&#x76EE;&#x5F55;&#x4E2D;&#xFF0C;&#x627E;&#x5230;tez-0.8.4-minimal.tar.gz&#x6587;&#x4EF6;&#x3002;</td></tr><tr><td>hadoop&#xFF0C;&#x5305;&#x62EC;yarn&#xFF0C;hdfs</td><td>&#x57FA;&#x4E8E;2.7.1</td><td>&#x7565;</td></tr><tr><td>zookeeper</td><td>3.4.6</td><td><a href="https://zookeeper.apache.org/doc/r3.4.8/zookeeperStarted.html#sc_RunningReplicatedZooKeeper" target="_blank" rel="external">zookeeper&#x5B89;&#x88C5;</a></td></tr><tr><td>slider</td><td>slider-0.81.1-incubating</td><td><a href="https://slider.incubator.apache.org/docs/getting_started.html#install" target="_blank" rel="external">slider&#x5B89;&#x88C5;&#x914D;&#x7F6E;</a>&#xFF0C;&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x540E;&#x5C06;bin&#x76EE;&#x5F55;&#x52A0;&#x5165;&#x5230;$PATH&#x53D8;&#x91CF;&#x4E2D;</td></tr><tr><td>hive</td><td>apache-hive-2.1.1</td><td>&#x4ECE;apache&#x5B98;&#x7F51;&#x540E;&#x4E0B;&#x8F7D;&#x53EF;&#x6267;&#x884C;&#x7684;&#x5305;&#xFF0C;&#x89E3;&#x538B;&#x5230;&#x76F8;&#x5173;&#x7684;&#x76EE;&#x5F55;&#x4E2D;</td></tr></table>

<h2 id="&#x914D;&#x7F6E;"><a href="#&#x914D;&#x7F6E;" class="headerlink" title="&#x914D;&#x7F6E;"></a>&#x914D;&#x7F6E;</h2><table><tr><th>&#x5C5E;&#x6027;</th><th>&#x4F4D;&#x7F6E;</th> <th>&#x8BF4;&#x660E;</th></tr><tr><td>hive.execution.engine</td><td>hive-site.xml</td><td>&#x76EE;&#x524D;llap&#x4EC5;&#x652F;&#x6301;tez&#xFF0C;&#x8BE5;&#x5C5E;&#x6027;&#x503C;&#x987B;&#x4E3A;tez</td></tr><tr><td>hive.llap.execution.mode</td><td>hive-site.xml</td><td>value&#x53EF;&#x4EE5;&#x4E3A;all, auto, map, none. &#x6211;&#x4EEC;&#x914D;&#x7F6E;&#x6210;all<br>&#x8BA9;&#x6240;&#x6709;&#x7684;task&#x90FD;&#x5728;llap&#x8FDB;&#x7A0B;&#x5185;&#x6267;&#x884C;&#x3002;</td></tr><tr><td>hive.execution.mode</td><td>hive-site.xml</td><td>value&#x4E3A;llap</td></tr><tr><td>hive.llap.daemon.service.hosts</td><td>hive-site.xml</td><td>&#x670D;&#x52A1;&#x7684;&#x540D;&#x79F0;&#xFF0C;&#x5982;&#x901A;&#x8FC7;&#x201D;hive &#x2013;service llap &#x2013;name llap_service&#x201D;&#x751F;&#x6210;&#x542F;&#x52A8;&#x811A;&#x672C;&#x65F6;,&#x5C06;&#x8BE5;&#x5C5E;&#x6027;&#x914D;&#x7F6E;&#x6210;@llap_service</td></tr><tr><td>hive.llap.daemon.work.dirs</td><td>hive-site.xml</td><td>&#x7F3A;&#x5C11;&#x8BE5;&#x914D;&#x7F6E;&#x65E0;&#x6CD5;&#x542F;&#x52A8;llap daemon, &#x53EF;&#x80FD;&#x662F;&#x542F;&#x52A8;&#x7528;&#x6237;&#x6CA1;&#x6709;yarn.nodemanager.local-dirs&#x914D;&#x7F6E;&#x4E0A;&#x76EE;&#x5F55;&#x7684;&#x8BFB;&#x5199;&#x6743;&#x9650;&#x3002;</td></tr><tr><td>hive.zookeeper.quorum</td><td>hive-site.xml</td><td>&#x7F3A;&#x5C11;&#x8BE5;&#x914D;&#x7F6E;&#x65E0;&#x6CD5;&#x542F;&#x52A8;llap daemon&#xFF0C;zk&#x8282;&#x70B9;&#x7528;&#x9017;&#x53F7;&#x5206;&#x9694;</td></tr><tr><td>hive.zookeeper.client.port</td><td>hive-site.xml</td><td>2181</td></tr><tr><td>hive.llap.daemon.memory.per.instance.mb</td><td>hive-site.xml</td><td>&#x8FD9;&#x4E2A;&#x5F88;&#x5947;&#x602A;&#xFF0C;&#x5373;&#x4F7F;&#x5728;&#x542F;&#x52A8;&#x547D;&#x4EE4;&#x4E2D;&#x6307;&#x5B9A;daemon&#x5185;&#x5B58;&#x548C;executor&#x7684;&#x6570;&#x91CF;&#xFF0C;&#x542F;&#x52A8;llap&#x670D;&#x52A1;&#x65F6;&#x4E5F;&#x4F1A;&#x5931;&#x8D25;&#xFF0C;&#x5FC5;&#x987B;&#x914D;&#x7F6E;&#x5728;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x4E2D;</td></tr><tr><td>hive.llap.daemon.num.executors</td><td>hive-site.xml</td><td>&#x540C;&#x4E0A;</td></tr><tr><td>tez.tez-ui.history-url.base</td><td>tez-site.xml</td><td>tez ui&#x8DEF;&#x5F84;</td></tr><tr><td>tez.lib.uris</td><td>tez-site.xml</td><td>hdfs&#x4E0A;tez-0.8.4-minimal.tar.gz&#x7684;&#x8DEF;&#x5F84;</td></tr> <tr><td>tez.use.cluster.hadoop-libs</td><td>tez-site.xml</td><td>&#x4F7F;&#x7528;&#x7684;&#x662F;tez-0.8.4-minimal.tar.gz&#xFF0C;&#x987B;&#x5C06;&#x8BE5;&#x914D;&#x7F6E;&#x8BBE;&#x7F6E;&#x6210;true</td></tr><tr><td>hive.server2.enable.doAs</td><td>hive-site.xml</td><td>&#x8FD9;&#x91CC;&#x8BBE;&#x7F6E;&#x6210;false</td></tr><tr><td>hadoop.bin.path</td><td>hive-site.xml</td><td>&#x96C6;&#x7FA4;&#x4E0A;hadoop&#x7684;bin&#x8DEF;&#x5F84;</td></tr></table>


<p>&#x914D;&#x7F6E;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x6267;&#x884C;&#x547D;&#x4EE4;&#xFF1A;</p>
<blockquote>
<p>hive &#x2013;service llap &#x2013;name llap_service &#x2013;instances 16 &#x2013;size 7g &#x2013;loglevel INFO &#x2013;args &#x201C; -XX:MaxMetaspaceSize=128m -verbose:class -XX:+UseParNewGC -Xmn1g -XX:+UseConcMarkSweepGC -XX:-UseBiasedLocking -XX:+PerfDisableSharedMem&#x201D; &#x2013;cache 5g &#x2013;executors 30 &#x2013;iothreads 10 &#x2013;slider-am-container-mb 1024</p>
</blockquote>
<p>&#x5F53;&#x770B;&#x5230;&#x65E5;&#x5FD7;&#x8F93;&#x51FA;&#x884C;&#x91CC;&#x6709;&#xFF1A;</p>
<pre>
  Prepared llap-slider-ddMMyyyy/run.sh for running LLAP on Slider
</pre>
&#x540E;&#x610F;&#x5473;&#x7740;&#x73AF;&#x5883;&#x5E94;&#x8BE5;&#x6CA1;&#x4EC0;&#x4E48;&#x95EE;&#x9898;&#x4E86;&#xFF0C; &#x5728;&#x5F53;&#x524D;&#x7684;&#x76EE;&#x5F55;&#x4E0B;&#xFF0C; &#x53EF;&#x4EE5;&#x627E;&#x5230;llap-slider-ddMMyyyy&#x8FD9;&#x4E2A;&#x76EE;&#x5F55;&#xFF0C;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x6709;&#x56DB;&#x4E2A;&#x6587;&#x4EF6;&#xFF1A;<br>
 <em>appConfig.json  llap-09Mar2017.zip  resources.json  run.sh</em><br>&#x6253;&#x5F00;run.sh&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#xFF0C; &#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x542F;&#x52A8;&#x548C;&#x505C;&#x6B62;llap&#x670D;&#x52A1;&#x7684;&#x547D;&#x4EE4;&#xFF1A;
 <pre>
slider stop llap_service
slider destroy llap_service --force || slider destroy llap_service
slider install-package --name LLAP --package  $BASEDIR/llap-09Mar2017.zip --replacepkg
slider create llap_service --resources $BASEDIR/resources.json --template $BASEDIR/appConfig.json
 </pre>

<p>&#x6267;&#x884C;run.sh&#x811A;&#x672C;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5728;yarn web&#x7BA1;&#x7406;&#x754C;&#x9762;&#x4E2D;&#xFF0C;&#x770B;&#x5230;Application Type&#x4E3A;org-apache-slider&#xFF0C; Name&#x4E3A;llap_service&#x7684;&#x4E00;&#x4E2A;&#x4F5C;&#x4E1A;&#x4E86;&#x3002;&#x5982;&#x679C;&#x8FD9;&#x4E2A;&#x4F5C;&#x4E1A;&#x80FD;&#x6301;&#x7EED;4&#xFF5E;6&#x5206;&#x949F;&#x8FD0;&#x884C;&#xFF0C;&#x90A3;&#x4E48;&#x53EF;&#x4EE5;&#x542F;&#x52A8;hive cli&#xFF0C; &#x6267;&#x884C;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#x7684;sql&#x6765;&#x63A2;&#x7D22;llap&#x4E86;(mode&#x4E00;&#x680F;&#x663E;&#x793A;&#x4E3A;llap)&#x3002; </p>
<pre><code>Status: Running (Executing on YARN cluster with App id application_xxxx)
----------------------------------------------------------------------------------------------
    VERTICES      MODE        STATUS  TOTAL  COMPLETED  RUNNING  PENDING  FAILED  KILLED
----------------------------------------------------------------------------------------------
Map 1 ..........      llap     SUCCEEDED     24         24        0        0       0       0
Reducer 2 ......      llap     SUCCEEDED      1          1        0        0       0       0
----------------------------------------------------------------------------------------------
VERTICES: 02/02  [==========================&gt;&gt;] 100%  ELAPSED TIME: 15.01 s
----------------------------------------------------------------------------------------------
</code></pre><p>&#x5982;&#x679C;&#x51FA;&#x73B0;&#x95EE;&#x9898;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x8981;&#x4ED4;&#x7EC6;&#x89C2;&#x5BDF;application&#x4F5C;&#x4E1A;&#x7684;&#x65E5;&#x5FD7;&#x4E86;&#xFF0C; &#x4ECE;&#x4E2D;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x5F53;&#x524D;&#x96C6;&#x7FA4;&#x4E2D;&#x8FD8;&#x6709;&#x54EA;&#x4E9B;&#x6761;&#x4EF6;&#x8FD8;&#x6CA1;&#x88AB;&#x6EE1;&#x8DB3;&#xFF0C;&#x53EF;&#x4EE5;&#x5C06;&#x8C03;&#x6574;yarn nodemanager&#x4E2D;&#x7684;&#x53C2;&#x6570;&#xFF1A;</p>
<pre><code>&lt;property&gt;
    &lt;name&gt;yarn.nodemanager.delete.debug-delay-sec&lt;/name&gt;
    &lt;value&gt;3600&lt;/value&gt;
&lt;/property&gt;
</code></pre><p>&#x8FDB;&#x5165;daemon&#x542F;&#x52A8;&#x5931;&#x8D25;&#x7684;nodemanager&#x8282;&#x70B9;&#x4E2D;&#xFF0C;&#x901A;&#x8FC7;&#x672C;&#x5730;&#x542F;&#x52A8;&#x547D;&#x4EE4;&#x548C;&#x65E5;&#x5FD7;&#x8F93;&#x51FA;&#xFF0C;&#x67E5;&#x770B;&#x5931;&#x8D25;&#x7684;&#x539F;&#x56E0;&#x3002;</p>
<h2 id="&#x95EE;&#x9898;&#x89E3;&#x51B3;"><a href="#&#x95EE;&#x9898;&#x89E3;&#x51B3;" class="headerlink" title="&#x95EE;&#x9898;&#x89E3;&#x51B3;"></a>&#x95EE;&#x9898;&#x89E3;&#x51B3;</h2><pre><code>1, llap daemon&#x8FDB;&#x7A0B;&#x4E0D;&#x7A33;&#x5B9A;&#xFF0C;&#x670D;&#x52A1;&#x542F;&#x52A8;&#x5931;&#x8D25;&#x3002;
</code></pre><p>&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x4ECE;&#x76EE;&#x524D;&#x603B;&#x7ED3;&#x6765;&#x770B;&#xFF0C;&#x4E3B;&#x8981;&#x5206;&#x4E3A;3&#x7C7B;&#xFF1A;</p>
<ul><br> <li>hive-site.xml&#x4E0A;&#x7F3A;&#x5C11;&#x4E00;&#x4E9B;&#x914D;&#x7F6E;</li><br> <li>hadoop&#x96C6;&#x7FA4;&#x548C;hive&#x4E4B;&#x95F4;&#x7684;&#x7C7B;&#x51B2;&#x7A81;</li><br> <li>&#x627E;&#x4E0D;&#x5230;&#x76F8;&#x5E94;&#x7684;hadoop&#x7C7B;</li><br></ul> 

<pre><code>1.1 &#x7F3A;&#x5C11;&#x914D;&#x7F6E;
</code></pre><p>&#x8FD9;&#x4E2A;&#x53EF;&#x4EE5;&#x7ED3;&#x5408;&#x65E5;&#x5FD7;&#x548C;&#x4EE3;&#x7801;&#xFF0C;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x7F3A;&#x5C11;&#x4EC0;&#x4E48;&#x914D;&#x7F6E;&#xFF0C;&#x5728;hive-site.xml&#x6587;&#x4EF6;&#x52A0;&#x5165;&#x76F8;&#x5173;&#x7684;&#x914D;&#x7F6E;&#x9879;&#x5373;&#x53EF;&#x3002;</p>
<pre><code>1.2 hadoop&#xFF0C; hive&#x4E4B;&#x95F4;&#x7C7B;&#x51B2;&#x7A81;
</code></pre><p>&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x7ED9;&#x4E88;hadoop&#x4E0A;&#x505A;&#x4E86;&#x4E00;&#x4E9B;&#x6539;&#x8FDB;&#xFF0C;&#x5BFC;&#x81F4;&#x6709;&#x4E00;&#x4E9B;&#x627E;&#x4E0D;&#x5230;&#x7C7B;&#x65B9;&#x6CD5;&#x4EE5;&#x53CA;&#x7C7B;&#x5B9A;&#x4E49;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x4E00;&#x4E9B;&#x95EE;&#x9898;&#xFF0C;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x662F;&#xFF0C;&#x6309;&#x7167;&#x6307;&#x5B9A;&#x7684;&#x7248;&#x672C;&#x91CD;&#x65B0;&#x7F16;&#x8BD1;tez&#xFF0C;&#x7F16;&#x8BD1;&#x6CA1;&#x51FA;&#x73B0;&#x95EE;&#x9898;&#xFF0C;&#x9009;&#x62E9;minimal&#x538B;&#x7F29;&#x5305;&#x4F5C;&#x4E3A;tez&#x7684;&#x5B89;&#x88C5;&#x8DEF;&#x5F84;&#x5E76;&#x4E0A;&#x4F20;&#x5230;hdfs&#x4E0A;&#x3002;</p>
<pre><code>1.3 &#x627E;&#x4E0D;&#x5230;&#x76F8;&#x5E94;&#x7684;hadoop&#x7C7B;
</code></pre><p>&#x5728;Hadoop&#x73AF;&#x5883;&#x4E2D;&#x627E;&#x4E0D;&#x5230;hadoop&#x7C7B;&#xFF0C;&#x8FD9;&#x786E;&#x5B9E;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x8BE1;&#x5F02;&#x7684;&#x95EE;&#x9898;&#x3002;&#x901A;&#x8FC7;&#x8C03;&#x7814;&#x53D1;&#x73B0;&#xFF0C;llap&#x8FDB;&#x7A0B;&#x7684;&#x542F;&#x52A8;&#x662F;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;runLlapDaemon.sh&#x811A;&#x672C;&#x547D;&#x4EE4;&#x542F;&#x52A8;&#x7684;&#xFF0C;&#x800C;&#x8FD9;&#x4E2A;&#x811A;&#x672C;&#x662F;&#x5728;<code>llap-slider-ddMMyyyy/llap-ddMMyyyy.zip</code> &#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x5728;&#x89E3;&#x538B;&#x540E;&#x7684;package/files&#x76EE;&#x5F55;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x627E;&#x5230;&#x4E00;&#x4E2A;llap-ddMMyyyy.tar.gz&#x538B;&#x7F29;&#x5305;&#xFF0C;&#x89E3;&#x538B;&#x8FD9;&#x4E2A;tar.gz&#x7684;&#x538B;&#x7F29;&#x5305;&#xFF0C;&#x53D1;&#x73B0;&#x5728;&#x540C;&#x7EA7;&#x7684;&#x76EE;&#x5F55;&#x4E0B;&#x51FA;&#x73B0;bin&#x76EE;&#x5F55;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;<code>runLlapDaemon.sh</code>&#x811A;&#x672C;&#x7684;&#x4F4D;&#x7F6E;&#x3002;<br>&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x542F;&#x52A8;&#x811A;&#x672C;&#x4E2D;&#x5BF9;&#x4E8E;CLASSPATH&#x7684;&#x5B9A;&#x4E49;&#xFF1A;</p>
<pre><code>CLASSPATH=${LLAP_DAEMON_CONF_DIR}:${LLAP_DAEMON_HOME}/lib/*:${LLAP_DAEMON_HOME}/lib/tez/*:${LLAP_DAEMON_HOME}/lib/udfs/*:.
</code></pre><p>  &#x5728;&#x4E0A;&#x5C42;&#x7684;lib&#x76EE;&#x5F55;&#x4E2D;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x53D1;&#x73B0;&#x76F8;&#x5173;&#x7684;hadoop jar&#x6587;&#x4EF6;&#xFF0C;&#x56E0;&#x6B64;&#x5BFC;&#x81F4;llap daemon&#x65E0;&#x6CD5;&#x627E;&#x5230;&#x76F8;&#x5E94;&#x7684;&#x7C7B;&#xFF0C;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x4E5F;&#x5C31;&#x662F;&#x5728;&#x8FD9;&#x4E2A;CLASSPATH&#x7684;&#x672B;&#x5C3E;&#xFF0C;&#x52A0;&#x4E0A;<code>hadoop classpath</code>:</p>
<pre><code>CLASSPATH=${LLAP_DAEMON_CONF_DIR}:${LLAP_DAEMON_HOME}/lib/*:${LLAP_DAEMON_HOME}/lib/tez/*:${LLAP_DAEMON_HOME}/lib/udfs/*:.:`hadoop classpath`
</code></pre><p>&#x8FD9;&#x4E2A;&#x6700;&#x597D;&#x52A0;&#x5728;&#x540E;&#x9762;&#xFF0C;&#x56E0;&#x4E3A;&#x4E00;&#x4E9B;hive-site.xml&#x7684;&#x914D;&#x7F6E;&#x662F;&#x5728;&#x5B89;&#x88C5;&#x5305;&#x7684;conf&#x76EE;&#x5F55;&#x4E0B;&#xFF0C;&#x5982;&#x679C;&#x52A0;&#x5728;&#x524D;&#x9762;&#xFF0C;&#x5982;&#x679C;hadoop&#x73AF;&#x5883;&#x7684;&#x914D;&#x7F6E;&#x5305;&#x542B;&#x6709;hive-site.xml&#x6587;&#x4EF6;&#xFF0C;&#x90A3;&#x4E48;&#x4F1A;&#x52A0;&#x8F7D;&#x8BE5;&#x6587;&#x4EF6;&#x800C;&#x6452;&#x5F03;&#x4E86;&#x5BA2;&#x6237;&#x7AEF;llap hive-site.xml&#x7684;&#x5B9A;&#x4E49;&#xFF0C;&#x4F1A;&#x5BFC;&#x81F4;&#x51FA;&#x73B0;<code>1.1</code>&#x63CF;&#x8FF0;&#x7684;&#x95EE;&#x9898;&#x3002;<br><br>&#x4FEE;&#x6539;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x91CD;&#x65B0;&#x6253;&#x5305;&#xFF0C;&#x518D;&#x6B21;&#x6267;&#x884C;run.sh&#x811A;&#x672C;&#x5373;&#x53EF;&#x3002;</p>
<p>&#x6309;&#x7167;&#x8FD9;&#x6837;&#x7684;&#x601D;&#x8DEF;&#xFF0C;&#x89E3;&#x51B3;&#x5176;&#x4ED6;&#x95EE;&#x9898;&#x4E5F;&#x5C31;&#x5BB9;&#x6613;&#x5F88;&#x591A;&#x4E86;&#xFF0C;&#x53D1;&#x73B0;&#x67D0;&#x4E2A;udf&#x5F15;&#x5165;&#x4E86;&#x5176;&#x4ED6;&#x7684;jar&#x5305;&#x5BFC;&#x81F4;&#x7C7B;&#x51B2;&#x7A81;&#xFF0C;&#x90A3;&#x4E48;&#x5C06;&#x8FD9;&#x4E2A;jar&#x4ECE;lib/udf&#x76EE;&#x5F55;&#x4E0B;&#x79FB;&#x9664;&#x51FA;&#x53BB;&#xFF0C;&#x8FD8;&#x53EF;&#x4EE5;&#x4FEE;&#x6539;&#x4E00;&#x4E9B;&#x914D;&#x7F6E;&#x7B49;&#x7B49;&#x3002;</p>
<pre><code>2, &#x67E5;&#x8BE2;&#x6548;&#x679C;&#x6CA1;&#x660E;&#x663E;&#x5DEE;&#x5F02;
</code></pre><p>&#x5C06;&#x8868;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x65B9;&#x5F0F;&#x6539;&#x6210;&#x4EE5;&#x5217;&#x5F0F;&#x6765;&#x5B58;&#x50A8;&#x3002; Llap&#x9ED8;&#x8BA4;&#x4F7F;&#x7528;off-heap&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x7F13;&#x5B58;&#x6570;&#x636E;&#xFF0C;&#x5728;&#x4F7F;&#x7528;&#x5982;&#x4E0B;&#x547D;&#x4EE4;&#x751F;&#x6210;&#x811A;&#x672C;&#x65F6;&#xFF0C;<code>hive --service llap --name llap_service --size 4g --loglevel INFO  --cache 4g</code>&#xFF0C; &#x63D0;&#x793A;</p>
<pre><code>java.lang.IllegalArgumentException: Cache size (4.00GB) has to be smaller than the container sizing (4.00GB)
    at com.google.common.base.Preconditions.checkArgument(Preconditions.java:92)
    at org.apache.hadoop.hive.llap.cli.LlapServiceDriver.run(LlapServiceDriver.java:207)
    at org.apache.hadoop.hive.llap.cli.LlapServiceDriver.main(LlapServiceDriver.java:104)
</code></pre><p>&#x4E5F;&#x5C31;&#x662F;&#x5806;&#x5916;&#x7F13;&#x5B58;&#x7684;&#x5927;&#x5C0F;&#x8981;&#x5C0F;&#x4E8E;llap container&#x8BBE;&#x7F6E;&#x7684;&#x5185;&#x5B58;, &#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x6709;&#x8FD9;&#x4E2A;&#x7EA6;&#x675F;? &#x4ECE;&#x4E0E;&#x793E;&#x533A;&#x7684;&#x4EA4;&#x6D41;&#x6765;&#x770B;&#xFF0C;size&#x8868;&#x793A;&#x7684;&#x542B;&#x4E49;&#x662F;executor&#x5DE5;&#x4F5C;&#x5185;&#x5B58;&#x548C;&#x5806;&#x5916;&#x5185;&#x5B58;&#x4E4B;&#x548C;&#x3002;&#x5728;&#x5B9E;&#x8DF5;&#x4E2D;&#xFF0C;&#x5374;&#x53D1;&#x73B0;size&#x51B3;&#x5B9A;&#x4E00;&#x4E2A;yarn container JVM&#x7684;&#x5B9E;&#x9645;&#x5927;&#x5C0F;&#xFF0C;&#x5E76;&#x672A;&#x6709;&#x6240;&#x6709;&#x5185;&#x5B58;&#x4E4B;&#x548C;&#x7684;&#x542B;&#x4E49;&#x3002;&#x4ECE;&#x4EE3;&#x7801;&#x6CE8;&#x91CA;&#x6765;&#x770B;&#xFF0C;&#x52A0;&#x4E0A;&#x8FD9;&#x4E00;&#x7EA6;&#x675F;&#x662F;&#x4E3A;&#x4E86;&#x66F4;&#x5B89;&#x5168;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;&#x5206;&#x914D;&#xFF1F; &#x76EE;&#x524D;&#x91C7;&#x7528;&#x7684;&#x662F;&#x7528;size&#x8868;&#x793A;container&#x7684;&#x5B9E;&#x9645;JVM&#x5185;&#x5B58;&#xFF0C;&#x7528;cache&#x8868;&#x793A;&#x5806;&#x5916;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x3002;</p>
<p>&#x53E6;&#x5916;&#x4E5F;&#x53EF;&#x4EE5;&#x5C06;&#x7F13;&#x5B58;&#x8BBE;&#x7F6E;&#x6210;on heap&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;&#xFF1A;</p>
<pre><code>&lt;property&gt;
     &lt;name&gt;hive.llap.io.allocator.direct&lt;/name&gt;
     &lt;value&gt;false&lt;/value&gt;
 &lt;/property&gt;
</code></pre><p>&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;llap&#x4E3A;&#x6BCF;&#x4E2A;executor&#x914D;&#x4E86;&#x4E00;&#x5B9A;&#x7684;&#x5185;&#x5B58;&#x9650;&#x989D;&#xFF1A;</p>
<pre><code>this.memoryPerExecutor = (long)(totalMemoryAvailableBytes * 0.8 / (float) numExecutors);
</code></pre><p>&#x8FD9;&#x8981;&#x6C42;tez task&#x7684;&#x4E34;&#x65F6;&#x5DE5;&#x4F5C;&#x5185;&#x5B58;&#x9700;&#x8981;&#x5C0F;&#x4E8E;&#x8FD9;&#x4E2A;&#x503C;&#xFF0C;&#x5982;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#xFF1A;</p>
<pre><code> &lt;property&gt;
  &lt;name&gt;tez.runtime.io.sort.mb&lt;/name&gt;
  &lt;defaultValue&gt;100&lt;/defaultValue&gt;
  &lt;type&gt;integer&lt;/type&gt;
&lt;/property&gt;    
</code></pre></div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="storm-core/" class="post-link">storm-core</a></h2><span class="post-time">Oct 21, 2016</span><div class="post-content"><p>&#x8FD9;&#x662F;&#x4E00;&#x6B21;&#x9177;&#x8BAF;&#x516C;&#x53F8;&#x5185;&#x90E8;&#x4E00;&#x6B21;Storm&#x5B66;&#x4E60;&#x5206;&#x4EAB;&#xFF0C;&#x611F;&#x8C22;&#x8001;&#x516C;&#x53F8;&#xFF0C;&#x5728;&#x90A3;&#x91CC;&#x6210;&#x957F;&#x4E86;&#x5F88;&#x591A;&#x3002;</p>
<iframe src="storm3.pdf" style="width:100%; height:800px"></iframe>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="spark-serializable/" class="post-link">Spark作业提交及序列化</a></h2><span class="post-time">Oct 21, 2016</span><div class="post-content"><p>  &#x5728;&#x5206;&#x6790;Spark&#x63D0;&#x4EA4;&#x4F5C;&#x4E1A;&#x4E4B;&#x524D;&#xFF0C;&#x5148;&#x7B80;&#x5355;&#x68B3;&#x7406;&#x4E00;&#x4E0B;&#x6709;&#x5173;Java&#x5E8F;&#x5217;&#x5316;&#x7684;&#x77E5;&#x8BC6;&#x4EE5;&#x53CA;&#x4E00;&#x4E9B;&#x7406;&#x89E3;&#x3002;</p>
<p><strong><em>Java&#x5E8F;&#x5217;&#x5316;</em></strong></p>
<p>  &#x4E00;&#x4E2A;Java&#x5BF9;&#x8C61;&#x5728;&#x5176;&#x751F;&#x547D;&#x5468;&#x671F;&#x5185;&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x6709;&#x591A;&#x79CD;&#x4E0D;&#x540C;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x8FD9;&#x4E9B;&#x72B6;&#x6001;&#x533A;&#x5206;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;&#x7C7B;&#x7684;&#x5176;&#x5B83;&#x5BF9;&#x8C61;&#x3002;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x5DE5;&#x4F5C;&#xFF0C;&#x5C31;&#x662F;&#x5C06;&#x5BF9;&#x8C61;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x4EE5;&#x4E8C;&#x8FDB;&#x5236;&#x7684;&#x5F62;&#x6001;&#x8F93;&#x51FA;&#x51FA;&#x6765;&#xFF0C;&#x5728;&#x9075;&#x5FAA;&#x8F93;&#x51FA;&#x534F;&#x8BAE;&#x7684;&#x524D;&#x63D0;&#x4E0B;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x4E9B;&#x5B57;&#x8282;&#x6062;&#x590D;&#x5BF9;&#x8C61;&#x5728;&#x67D0;&#x4E00;&#x65F6;&#x523B;&#x7684;&#x72B6;&#x6001;(&#x53CD;&#x5E8F;&#x5217;&#x5316;), &#x8FD9;&#x5BF9;&#x4E8E;&#x5FEB;&#x901F;&#x6062;&#x590D;&#x4EE5;&#x53CA;&#x8DE8;JVM&#x4FE1;&#x606F;&#x4EA4;&#x6D41;&#x5E26;&#x6765;&#x5DE8;&#x5927;&#x7684;&#x4FBF;&#x5229;&#x6027;&#x3002;<br>  &#x5BF9;&#x8C61;&#x4E0E;&#x5BF9;&#x8C61;&#x4E4B;&#x95F4;&#x5B58;&#x5728;&#x7740;&#x5F15;&#x7528;&#x4E0E;&#x88AB;&#x5F15;&#x7528;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x9488;&#x5BF9;&#x4E8E;&#x5BF9;&#x8C61;&#x672C;&#x8EAB;&#xFF0C;&#x5219;&#x53EF;&#x80FD;&#x4F1A;&#x6709;&#x4E0D;&#x540C;&#x7684;&#x8FED;&#x4EE3;&#x7248;&#x672C;&#x3002;&#x5F53;&#x5BF9;&#x8C61;&#x5C1D;&#x8BD5;&#x5C06;&#x5BF9;&#x8C61;&#x7684;&#x5F15;&#x7528;&#x5173;&#x7CFB;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x4FDD;&#x8BC1;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#x4E5F;&#x80FD;&#x5E8F;&#x5217;&#x5316;&#x3002;&#x5982;&#x4E0B;&#x9762;&#x7684;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;serializable(JavaSerializable) -&gt; sc(Serializable1) -&gt;ns(NonSerializable), &#x7531;&#x4E8E;ns&#x5BF9;&#x8C61;&#x5E76;&#x4E0D;&#x80FD;&#x5E8F;&#x5217;&#x5316;&#xFF0C;&#x5BFC;&#x81F4;&#x5728;main&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x5E8F;&#x5217;&#x5316;serializable&#x64CD;&#x4F5C;&#x5931;&#x8D25;&#x3002;</p>
<p><pre><br>  public class JavaSerializable implements Serializable {<br>  Serializable1 sc;<br>  private JavaSerializable() { }<br>  public JavaSerializable(Serializable1 sc) {<br>    this.sc = sc;<br>  }<br>  public static void main(String[] args) throws IOException {<br>    JavaSerializable serializable = new JavaSerializable(new Serializable1());<br>    ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&#x201C;/tmp/obj.ser&#x201D;));<br>    //&#x8FD9;&#x91CC;&#x4F1A;&#x629B;&#x51FA;&#x4E00;&#x4E2A; &#x201C;java.io.NotSerializableException: cn.creditease.basic.NonSerializable&#x201D; &#x5F02;&#x5E38;<br>    objectOutputStream.writeObject(serializable);<br>    objectOutputStream.flush();<br>    objectOutputStream.close();<br>  }<br>}<br>class Serializable1 implements Serializable {<br>  NonSerializable ns = new NonSerializable(&#x201C;hello&#x201D;);<br>}</pre></p>
<p>class NonSerializable {<br>    int tf1;<br>    String tf2;<br>    public NonSerializable(String tf2) {<br>      this.tf2 = tf2;<br>    }<br>}<br><br>&#x7136;&#x800C;&#x9700;&#x8981;&#x8BA4;&#x8BC6;&#x5230;&#xFF0C;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x5DE5;&#x4F5C;&#x662F;&#x5C06;&#x5BF9;&#x8C61;&#x7684;&#x72B6;&#x6001;&#x901A;&#x8FC7;&#x4E8B;&#x5148;&#x7EA6;&#x5B9A;&#xFF0C;&#x8F93;&#x51FA;&#x6210;&#x4E8C;&#x8FDB;&#x5236;&#x3002;&#x5BF9;&#x4E8E;&#x67D0;&#x4E00;&#x4E2A;&#x7C7B;&#x6765;&#x8BF4;&#xFF0C;&#x5982;&#x4F55;&#x5E8F;&#x5217;&#x5316;&#x4EE5;&#x53CA;&#x5E8F;&#x5217;&#x5316;&#x90A3;&#x4E9B;&#x72B6;&#x6001;&#xFF0C;&#x8FD9;&#x4E9B;&#x90FD;&#x662F;&#x5C5E;&#x4E8E;&#x7C7B;&#x7684;&#x884C;&#x4E3A;&#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x7C7B;&#x6CA1;&#x5FC5;&#x8981;&#x77E5;&#x9053;&#x8FD9;&#x4E9B;&#x7EC6;&#x8282;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x5F53;&#x8981;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x5BF9;&#x8C61;&#x4F9D;&#x8D56;&#x7684;&#x5F15;&#x7528;&#x662F;&#x4E00;&#x4E2A;null&#x65F6;&#xFF0C;&#x8FD9;&#x4E2A;&#x662F;&#x4E0D;&#x4F1A;&#x5E8F;&#x5217;&#x5316;&#x8FD9;&#x4E2A;&#x4F9D;&#x8D56;&#x5BF9;&#x8C61;&#x7684;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x5728;&#x4E0A;&#x8FF0;&#x7684;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x5F53;serializable&#x5BF9;&#x8C61;&#x4E2D;sc&#x7684;&#x5F15;&#x7528;&#x4E3A;NUll&#x65F6;&#xFF0C;&#x5E8F;&#x5217;&#x5316;serializable&#x5BF9;&#x8C61;&#x662F;&#x6CA1;&#x6709;&#x95EE;&#x9898;&#x7684;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>{</div><div class="line">    <span class="comment">//&#x4E0D;&#x521D;&#x59CB;&#x5316;sc</span></div><div class="line">    JavaSerializable serializable = <span class="keyword">new</span> JavaSerializable();</div><div class="line">    ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;/tmp/obj.ser&quot;</span>));</div><div class="line">    <span class="comment">//&#x6210;&#x529F;&#x5E8F;&#x5217;&#x5316;serializable&#x5BF9;&#x8C61;</span></div><div class="line">    objectOutputStream.writeObject(serializable);</div><div class="line">  }</div></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6062;&#x590D;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x65F6;&#xFF0C;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x5E76;&#x4E0D;&#x4F1A;&#x8C03;&#x7528;&#x7C7B;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x3002;<br>&#x6709;&#x5173;&#x66F4;&#x8FC7;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x77E5;&#x8BC6;&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#xFF1A;<br>  <a href="http://docs.oracle.com/javase/7/docs/api/java/io/Serializable.html" target="_blank" rel="external">http://docs.oracle.com/javase/7/docs/api/java/io/Serializable.html</a></p>
<p>&#x968F;&#x7740;&#x5206;&#x5E03;&#x5F0F;&#x7CFB;&#x7EDF;&#x7684;&#x53D1;&#x5C55;&#x548C;&#x6D41;&#x884C;&#xFF0C;&#x5F88;&#x591A;&#x6846;&#x67B6;&#x91C7;&#x7528;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x673A;&#x5236;&#x6765;&#x5B9E;&#x73B0;&#x8FDB;&#x7A0B;&#x4E4B;&#x95F4;&#x901A;&#x4FE1;&#xFF0C;&#x4E2D;&#x95F4;&#x7ED3;&#x679C;&#x4FDD;&#x5B58;&#x4EE5;&#x53CA;&#x8FDB;&#x7A0B;&#x4E2D;&#x4E00;&#x4E9B;&#x72B6;&#x6001;&#x7684;&#x6301;&#x4E45;&#x5316;&#x3002;&#x5982;<a href="http://storm.apache.org/" target="_blank" rel="external">storm</a>&#x4E2D;&#x7684;worker&#x4F1A;&#x5468;&#x671F;&#x6027;&#x7684;&#x5C06;&#x4E00;&#x4E9B;&#x72B6;&#x6001;&#x4FE1;&#x606F;&#x5199;&#x5165;&#x5230;&#x6307;&#x5B9A;&#x7684;&#x76EE;&#x5F55;&#x4E2D;&#xFF0C;Supervisor&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#xFF0C;&#x5F97;&#x5230;worker&#x7684;&#x8FD0;&#x884C;&#x72B6;&#x6001;&#xFF1B;hadoop MapReduce&#x4F1A;&#x5C06;Mapper&#x8F93;&#x51FA;&#x7684;&#x4E2D;&#x95F4;&#x7ED3;&#x679C;&#x5E8F;&#x5217;&#x5316;&#x6210;&#x4E8C;&#x8FDB;&#x5236;&#x6587;&#x4EF6;&#xFF1B;thrift&#x4F1A;&#x5C06;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8C03;&#x7528;&#x5E8F;&#x5217;&#x5316;(&#x5305;&#x62EC;&#x65B9;&#x6CD5;&#x540D;&#xFF0C;&#x4EE5;&#x53CA;&#x65B9;&#x6CD5;&#x4E2D;&#x5305;&#x542B;&#x7684;&#x53C2;&#x6570;&#x4FE1;&#x606F;)&#xFF0C;&#x5C06;&#x5E8F;&#x5217;&#x5316;&#x540E;&#x4E8C;&#x8FDB;&#x5236;&#x6D41;&#x4EA4;&#x7ED9;&#x670D;&#x52A1;&#x7AEF;&#x6765;&#x89E3;&#x6790;&#xFF0C;&#x5B9E;&#x73B0;&#x8FDC;&#x7A0B;&#x8C03;&#x7528;&#x7B49;&#x7B49;&#x3002;&#x9488;&#x5BF9;Java&#x5E8F;&#x5217;&#x5316;&#x6539;&#x8FDB;&#x7684;&#x5E8F;&#x5217;&#x5316;&#x6846;&#x67B6;&#x4E5F;&#x5F00;&#x59CB;&#x53D8;&#x5F97;&#x591A;&#x8D77;&#x6765;,&#x5982;<a href="https://github.com/eishay/jvm-serializers/wiki" target="_blank" rel="external">&#x4E00;&#x4E9B;&#x5E8F;&#x5217;&#x5316;&#x5BF9;&#x6BD4;&#x548C;&#x6D4B;&#x8BD5;</a>&#x3002;</p>
<p><strong><em>Spark&#x4E0E;&#x5E8F;&#x5217;&#x5316;</em></strong></p>
<p>   &#x5BF9;&#x4E8E;&#x8BA1;&#x7B97;&#x6846;&#x67B6;&#x6765;&#x8BF4;&#xFF0C;&#x4ECE;&#x8BA1;&#x7B97;&#x4EA7;&#x751F;&#x7684;&#x539F;&#x56E0;&#x7684;&#x89D2;&#x5EA6;&#x4E0A;&#x770B;&#xFF0C;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;&#x4E24;&#x7C7B;&#xFF1A;&#x4E00;&#x79CD;&#x662F;&#x57FA;&#x4E8E;&#x4E8B;&#x4EF6;&#x9A71;&#x52A8;&#x7684;&#x8BA1;&#x7B97;&#x6A21;&#x578B;&#xFF0C;&#x5982;storm&#xFF1B;&#x53E6;&#x4E00;&#x79CD;&#x662F;&#x57FA;&#x4E8E;&#x6570;&#x636E;&#x9A71;&#x52A8;&#x7684;&#x8BA1;&#x7B97;&#x6A21;&#x578B;&#xFF0C;&#x5982;MapReduce&#x3002;&#x4EE5;&#x8FD9;&#x4E24;&#x79CD;&#x7C7B;&#x578B;&#x6765;&#x5206;&#x7C7B;&#x7684;&#x8BDD;&#xFF0C; Spark&#x662F;&#x5C5E;&#x4E8E;&#x6570;&#x636E;&#x9A71;&#x52A8;&#x7684;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x5FC5;&#x987B;&#x5148;&#x6709;&#x6570;&#x636E;&#xFF0C;&#x800C;&#x540E;&#x624D;&#x80FD;&#x8FDB;&#x884C;&#x4E00;&#x4E9B;&#x6570;&#x636E;&#x64CD;&#x4F5C;&#xFF0C;&#x6570;&#x636E;&#x4E0E;&#x64CD;&#x4F5C;&#x4E4B;&#x95F4;&#x662F;&#x76F8;&#x4E92;&#x5206;&#x79BB;&#x7684;&#x3002;&#x8FD9;&#x4E9B;&#x6570;&#x636E;&#x7531;&#x4E00;&#x6761;&#x6761;&#x8BB0;&#x5F55;&#x6784;&#x6210;(&#x53EF;&#x7C7B;&#x6BD4;&#x6210;&#x4F20;&#x7EDF;&#x5173;&#x7CFB;&#x578B;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x884C;&#x7684;&#x6982;&#x5FF5;)&#xFF0C;&#x8FD9;&#x4E9B;&#x8BB0;&#x5F55;&#x4E4B;&#x95F4;&#x5173;&#x7CFB;&#x677E;&#x6563;, &#x6CA1;&#x6709;&#x4E0A;&#x4E0B;&#x6587;(&#x8BED;&#x4E49;)&#x3002;&#x5728;&#x5BF9;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x62BD;&#x8C61;&#x51FA;&#x67D0;&#x4E9B;&#x884C;&#x4E3A;&#x7279;&#x5F81;&#xFF0C;&#x5C3D;&#x7BA1;&#x5BF9;&#x8BB0;&#x5F55;&#x7684;&#x64CD;&#x4F5C;(&#x7EC6;&#x8282;)&#x4F1A;&#x5343;&#x5DEE;&#x4E07;&#x522B;&#xFF0C;Spark&#x5B9A;&#x4E49;&#x4E86;&#x8FD9;&#x4E9B;&#x8BB0;&#x5F55;&#x96C6;(RDD), &#x4EE5;&#x53CA;&#x9488;&#x5BF9;&#x8FD9;&#x4E9B;&#x8BB0;&#x5F55;&#x96C6;&#x7684;&#x4E00;&#x4E9B;&#x64CD;&#x4F5C;(&#x63A5;&#x53E3;)&#xFF0C;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x5219;&#x7531;&#x7528;&#x6237;&#x81EA;&#x5DF1;&#x6765;&#x5B9E;&#x73B0;&#x3002;</p>
<p>   &#x62BD;&#x8C61;&#x662F;Spark&#x4E00;&#x4E2A;&#x5F88;&#x663E;&#x8457;&#x7684;&#x7279;&#x5F81;&#xFF0C;&#x6570;&#x636E;&#x88AB;&#x62BD;&#x8C61;&#x6210;&#x6570;&#x636E;&#x96C6;(RDD)&#xFF0C;&#x5728;&#x6BCF;&#x4E2A;&#x6570;&#x636E;&#x96C6;&#x4E0A;&#x8BB0;&#x5F55;&#x4E86;&#xFF1A;</p>
<ul>
<li>A list of partitions &#x7531;&#x90A3;&#x4E9B;&#x6570;&#x636E;&#x5B50;&#x96C6;&#x6784;&#x6210;</li>
<li>A function for computing each split &#x5B50;&#x96C6;&#x4E2D;&#x6BCF;&#x6761;&#x8BB0;&#x5F55;&#x5982;&#x4F55;&#x8BA1;&#x7B97;(&#x8BA1;&#x7B97;&#x56E0;&#x5B50;&#xFF09;</li>
<li>A list of dependencies on other RDDs &#x4F9D;&#x8D56;&#x4E8E;&#x7684;&#x6570;&#x636E;&#x96C6;(parent RDD&#xFF09;</li>
<li>Optionally, a Partitioner for key-value RDDs (e.g. to say that the RDD is hash-partitioned) &#x5982;&#x4F55;&#x5C06;&#x8BE5;&#x6570;&#x636E;&#x96C6;&#x7684;&#x8F93;&#x51FA;&#x7ED3;&#x679C;&#x5B9A;&#x4F4D;&#x5230;&#x4E0B;&#x4E00;&#x4E2A;RDD&#x4E2D;</li>
<li><p>Optionally, a list of preferred locations to compute each split on (e.g. block locations foran HDFS file) &#x4F4D;&#x7F6E;&#x4FE1;&#x606F;</p>
<p>RDD&#x4E2D;&#x7684;&#x8FD9;&#x4E9B;&#x7279;&#x5F81;&#x5305;&#x542B;&#x4E86;&#xFF1A; 1&#xFF0C; &#x6211;&#x8981;&#x8BA1;&#x7B97;&#x7684;&#x6570;&#x636E;&#x4ECE;&#x4F55;&#x800C;&#x6765;&#xFF1B; 2&#xFF0C;&#x6211;&#x8981;&#x600E;&#x6837;&#x8BA1;&#x7B97;&#x6E90;&#x6570;&#x636E;&#xFF0C;&#x4EE5;&#x6B64;&#x6765;&#x5F97;&#x5230;&#x6570;&#x636E;&#x96C6;&#xFF1B; 3&#xFF0C; &#x6211;&#x5982;&#x4F55;&#x5C06;&#x6211;&#x7684;&#x8BA1;&#x7B97;&#x7ED3;&#x679C;&#x8F93;&#x51FA;&#x4EE5;&#x53CA;&#x4E00;&#x4E9B;&#x4F18;&#x5316;&#x63AA;&#x65BD;&#xFF08;&#x8BA1;&#x7B97;&#x4E0E;&#x6570;&#x636E;&#x672C;&#x5730;&#x5316;)&#x3002;&#x8BA1;&#x7B97;&#x6570;&#x636E;&#x672C;&#x8EAB;&#x6CA1;&#x6709;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x4F18;&#x52BF;&#xFF0C;&#x9002;&#x7528;&#x5206;&#x6CBB;&#x7B97;&#x6CD5;&#x7684;&#x57FA;&#x672C;&#x601D;&#x8DEF;&#xFF0C;&#x5C06;&#x6570;&#x636E;&#x5207;&#x5272;&#x6210;&#x4E00;&#x4E2A;&#x4E2A;&#x76F8;&#x4E92;&#x72EC;&#x7ACB;&#x7684;&#x788E;&#x7247;&#xFF0C;&#x5229;&#x7528;&#x5E76;&#x884C;&#x4F18;&#x52BF;&#x6765;&#x52A0;&#x901F;&#x8BA1;&#x7B97;&#x3002; &#x8FD9;&#x4E0D;&#x4EC5;&#x53EF;&#x4EE5;&#x7F29;&#x77ED;&#x89E3;&#x51B3;&#x95EE;&#x9898;&#x7684;&#x65F6;&#x95F4;&#xFF0C;&#x540C;&#x65F6;&#x4E5F;&#x9002;&#x7528;&#x4E8E;&#x6D77;&#x91CF;&#x6570;&#x636E;&#x7684;&#x95EE;&#x9898;&#x3002;MapReduce, Spark&#x5C31;&#x662F;&#x8FD9;&#x6837;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x3002;</p>
<p>&#x7EFC;&#x4E0A;&#x6240;&#x53D9;&#xFF0C;&#x4ECE;&#x5B8F;&#x89C2;&#x4E0A;&#x770B;&#xFF0C;&#x53EF;&#x4EE5;&#x8FD9;&#x6837;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;RDD:</p>
<p>  <em>rdd = f(g(h(&#x2026;rdd0&#x2026;)))</em></p>
<p>f,g,h &#x4E3A;&#x8BA1;&#x7B97;&#x56E0;&#x5B50;&#xFF0C;&#x5982;filter&#xFF0C;map&#xFF0C;groupByKey&#x7B49;&#x3002;</p>
<p>&#x5982;&#x4E0A;&#xFF0C;&#x8FD9;&#x4E9B;f,g,h&#x51FD;&#x6570;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x662F;&#x6211;&#x4EEC;&#x5B9A;&#x4E49;&#x7684;&#x3002;&#x4ECE;&#x63D0;&#x4EA4;&#x4F5C;&#x4E1A;&#x6765;&#x770B;&#xFF0C;&#x6211;&#x4EEC;&#x6240;&#x505A;&#x7684;&#x5DE5;&#x4F5C;&#x662F;&#x63D0;&#x4EA4;&#x4E00;&#x4E2A;jar&#x6587;&#x4EF6;&#xFF0C;Spark&#x8981;&#x505A;&#x7684;&#x5C31;&#x662F;&#x5C06;jar&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x7C7B;&#x4F3C;&#x4E8E;f&#xFF0C;g&#xFF0C;h&#x8FD9;&#x6837;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x5206;&#x53D1;&#x5230;&#x5206;&#x5E03;&#x5F0F;&#x96C6;&#x7FA4;&#x4E0A;&#xFF0C;&#x5B9E;&#x73B0;&#x5E76;&#x884C;&#x8BA1;&#x7B97;&#xFF0C;&#x5F53;&#x7136;&#x5305;&#x62EC;&#x4E00;&#x4E9B;&#x5BB9;&#x9519;&#x63AA;&#x65BD;&#x3002;<br>&#x8981;&#x5B9E;&#x73B0;&#x8FD9;&#x4E9B;&#x7279;&#x70B9;&#xFF0C;&#x5219;&#x5FC5;&#x987B;&#x56DE;&#x7B54;&#x4EE5;&#x4E0B;&#x4E00;&#x4E9B;&#x95EE;&#x9898;&#xFF1A;<br>1, &#x600E;&#x6837;&#x62C9;&#x53D6;&#x8981;&#x8BA1;&#x7B97;&#x7684;&#x6570;&#x636E;&#x3002;<br>2&#xFF0C;&#x5982;&#x4F55;&#x5C06;f&#x51FD;&#x6570;&#x5206;&#x53D1;&#x5230;&#x5408;&#x9002;&#x7684;&#x673A;&#x5668;&#x4E0A;&#x8FDB;&#x884C;&#x8BA1;&#x7B97;<br>3&#xFF0C;&#x5982;&#x4F55;&#x8BA1;&#x7B97;&#x3002;<br>&#x4EE5;&#x4E00;&#x4E2A;WordCount&#x4E3A;&#x4F8B;&#xFF1A;</p>
</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">val</span> textFile = sc.textFile(<span class="string">&quot;hdfs:///tmp/spark.text&quot;</span>)</div><div class="line"> <span class="keyword">val</span> counts = textFile.flatMap(line =&gt; line.split(<span class="string">&quot;\\s+&quot;</span>))</div><div class="line">                 .map(word =&gt; (word, <span class="number">1</span>))</div><div class="line">                 .reduceByKey(_ + _)</div><div class="line"> counts.saveAsTextFile(<span class="string">&quot;hdfs:///tmp/result&quot;</span>)</div><div class="line">``` </div><div class="line"></div><div class="line">&#x6267;&#x884C; <span class="keyword">val</span> textFile &#xFF1D; sc.textFile(<span class="string">&quot;hdfs:///tmp/spark.text&quot;</span>) &#x8FD9;&#x6761;&#x8BED;&#x53E5;&#x65F6;&#xFF0C;&#x8FD4;&#x56DE;&#x7684;&#x662F;<span class="type">HadoopRDD</span>&#xFF0C; &#x8FD9;&#x4E2A;<span class="type">HadoopRDD</span>&#x7531;&#xFF0C;</div><div class="line"></div><div class="line">```scala</div><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getPartitions</span></span>: <span class="type">Array</span>[<span class="type">Partition</span>] = {</div><div class="line">    <span class="keyword">val</span> jobConf = getJobConf()</div><div class="line">    <span class="comment">// add the credentials here as this can be called before SparkContext initialized</span></div><div class="line">    <span class="type">SparkHadoopUtil</span>.get.addCredentials(jobConf)</div><div class="line">    <span class="keyword">val</span> inputFormat = getInputFormat(jobConf)</div><div class="line">    <span class="keyword">val</span> inputSplits = inputFormat.getSplits(jobConf, minPartitions)</div><div class="line">    <span class="keyword">val</span> array = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">Partition</span>](inputSplits.size)</div><div class="line">    <span class="keyword">for</span> (i &lt;- <span class="number">0</span> until inputSplits.size) {</div><div class="line">      array(i) = <span class="keyword">new</span> <span class="type">HadoopPartition</span>(id, i, inputSplits(i))</div><div class="line">    }</div><div class="line">    array</div><div class="line">  }</div></pre></td></tr></table></figure>
<p>&#x6BCF;&#x4E2A;&#x5177;&#x4F53;&#x7684;RDD&#x5B9E;&#x4F8B;&#x4E0A;&#x63D0;&#x4F9B;&#x4E86;&#x8FED;&#x4EE3;&#x5668;&#x6A21;&#x5F0F;&#x6765;&#x5C01;&#x88C5;RDD&#x5185;&#x90E8;&#x4E00;&#x6761;&#x6761;&#x8BB0;&#x5F55;&#x7684;&#x8BBF;&#x95EE;, &#x5982;HadoopRDD&#xFF1A;</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> iter = <span class="keyword">new</span> <span class="type">NextIterator</span>[(<span class="type">K</span>, <span class="type">V</span>)] {</div><div class="line">     <span class="keyword">val</span> split = theSplit.asInstanceOf[<span class="type">HadoopPartition</span>]</div><div class="line">     logInfo(<span class="string">&quot;Input split: &quot;</span> + split.inputSplit)</div><div class="line">     <span class="keyword">val</span> jobConf = getJobConf()</div><div class="line">     ...</div><div class="line">     <span class="keyword">var</span> reader: <span class="type">RecordReader</span>[<span class="type">K</span>, <span class="type">V</span>] = <span class="literal">null</span></div><div class="line">     <span class="keyword">val</span> inputFormat = getInputFormat(jobConf)</div><div class="line">     <span class="comment">//&#x5F97;&#x5230;&#x8BE5;RDD&#x5B9E;&#x4F8B;&#x8981;&#x5904;&#x7406;&#x7684;InputSplit&#xFF0C;&#x6839;&#x636E;&#x8FD9;&#x4E2A;InputSplit&#x4EE5;&#x53CA;InputFormat&#x5F97;&#x5230;&#x5C06;&#x5185;&#x5BB9;&#x89E3;&#x6790;&#x6210;&#x4E00;&#x6761;&#x6761;&lt;key value&gt;&#x7684;reader</span></div><div class="line">     reader = inputFormat.getRecordReader(split.inputSplit.value, jobConf, <span class="type">Reporter</span>.<span class="type">NULL</span>)</div><div class="line">    </div><div class="line">     <span class="keyword">val</span> key: <span class="type">K</span> = reader.createKey()</div><div class="line">     <span class="keyword">val</span> value: <span class="type">V</span> = reader.createValue()</div><div class="line"></div><div class="line">     <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getNext</span></span>(): (<span class="type">K</span>, <span class="type">V</span>) = {</div><div class="line">       <span class="keyword">try</span> {</div><div class="line">         finished = !reader.next(key, value)</div><div class="line">       } <span class="keyword">catch</span> {</div><div class="line">         <span class="keyword">case</span> eof: <span class="type">EOFException</span> =&gt;</div><div class="line">           finished = <span class="literal">true</span></div><div class="line">       }</div><div class="line">       <span class="keyword">if</span> (!finished) {</div><div class="line">         inputMetrics.incRecordsRead(<span class="number">1</span>)</div><div class="line">       }</div><div class="line">       (key, value)</div><div class="line">     }</div><div class="line"></div><div class="line"> }</div><div class="line">  <span class="keyword">new</span> <span class="type">InterruptibleIterator</span>[(<span class="type">K</span>, <span class="type">V</span>)](context, iter)</div></pre></td></tr></table></figure>
<p> <em>val textFile &#xFF1D; sc.textFile(&#x201C;hdfs:///tmp/spark.text&#x201D;)</em> &#x8FD9;&#x4E00;&#x6B65;&#x8FD4;&#x56DE;&#x4E86;HadoopRDD&#x7684;&#x5B9A;&#x4E49;(&#x5176;&#x5B9E;&#x8FD4;&#x56DE;&#x7684;&#x662F;MapPartitionsRDD&#xFF0C;HadoopRDD&#x8FD4;&#x56DE;&#x7684;<long, text="">&#x952E;&#x503C;&#x5BF9;&#x66F4;&#x6539;&#x6210;value.toString, &#x4E3A;&#x4E86;&#x63CF;&#x8FF0;&#x7B80;&#x4FBF;&#xFF0C;&#x7701;&#x7565;&#x4E86;&#x8FD9;&#x4E00;&#x6B65;&#xFF0C;&#x5177;&#x4F53;&#x8FC7;&#x7A0B;&#x53EF;&#x67E5;&#x770B;SparkContext.textFile&#x6E90;&#x7801;)&#xFF0C;&#x5305;&#x62EC;HadoopRDD&#x5305;&#x542B;&#x54EA;&#x4E9B;partition&#xFF0C;&#x4EE5;&#x53CA;HadoopRDD&#x5B9E;&#x4F8B;&#x662F;&#x600E;&#x6837;&#x83B7;&#x5F97;&#x6570;&#x636E;(compute).<br>&#x5F53;&#x6267;&#x884C;&#x5230;&#x8FD9;&#x4E00;&#x8BED;&#x53E5;&#x65F6;&#xFF0C;<br>  textFile.flatMap(line =&gt; line.split(&#x201C;\s+&#x201D;))&#xFF0C; &#x8FD4;&#x56DE;&#x4E00;&#x4E2A;MapPartitionsRDD&#xFF0C;</long,></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> *  Return a new RDD by first applying a function to all elements of this</div><div class="line"> *  RDD, and then flattening the results.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">flatMap</span></span>[<span class="type">U</span>: <span class="type">ClassTag</span>](f: <span class="type">T</span> =&gt; <span class="type">TraversableOnce</span>[<span class="type">U</span>]): <span class="type">RDD</span>[<span class="type">U</span>] = withScope {</div><div class="line">  <span class="keyword">val</span> cleanF = sc.clean(f)</div><div class="line">  <span class="keyword">new</span> <span class="type">MapPartitionsRDD</span>[<span class="type">U</span>, <span class="type">T</span>](<span class="keyword">this</span>, (context, pid, iter) =&gt; iter.flatMap(cleanF))</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x6211;&#x4EEC;&#x81EA;&#x5B9A;&#x4E49;flatMap&#x7684;&#x903B;&#x8F91;f: line =&gt; line.split(&#x201C;\s+&#x201D;)&#xFF0C;&#x7ECF;&#x8FC7;<em>val cleanF = sc.clean(f)</em>&#x6E05;&#x6D17;&#x52A0;&#x5DE5;(&#x53BB;&#x9664;&#x539F;f&#x4E2D;&#x4E00;&#x4E9B;&#x65E0;&#x6548;&#x7684;&#x53D8;&#x91CF;&#x6216;&#x903B;&#x8F91;&#xFF1F;&#xFF09;&#xFF0C;&#x5F53;&#x8BA1;&#x7B97;&#x8BE5;MapPartitionsRDD&#x5B9E;&#x4F8B;&#x4E2D;&#x7684;&#x8BB0;&#x5F55;&#x65F6;&#xFF0C;</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span>[spark] <span class="class"><span class="keyword">class</span> <span class="title">MapPartitionsRDD</span>[<span class="type">U</span>: <span class="type">ClassTag</span>, <span class="type">T</span>: <span class="type">ClassTag</span>](<span class="params"></span></span></div><div class="line">    var prev: <span class="type">RDD</span>[<span class="type">T</span>],</div><div class="line">    f: (<span class="type">TaskContext</span>, <span class="type">Int</span>, <span class="type">Iterator</span>[<span class="type">T</span>]) <span class="title">=&gt;</span> <span class="title">Iterator</span>[<span class="type">U</span>],  <span class="title">//</span> (<span class="params"><span class="type">TaskContext</span>, partition index, iterator</span>)</div><div class="line">    preservesPartitioning: <span class="type">Boolean</span> = <span class="literal">false</span>)</div><div class="line">  <span class="keyword">extends</span> <span class="type">RDD</span>[<span class="type">U</span>](prev) {</div><div class="line">  <span class="comment">//&#x5728;&#x8BE5;&#x5B9E;&#x4F8B;&#x4E2D;&#xFF1A; firstParent -&gt; HadoopRDD</span></div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">compute</span></span>(split: <span class="type">Partition</span>, context: <span class="type">TaskContext</span>): <span class="type">Iterator</span>[<span class="type">U</span>] = {</div><div class="line">    <span class="keyword">val</span> iter = firstParent[<span class="type">T</span>].iterator(split, context);</div><div class="line">    <span class="keyword">val</span> index = split.index</div><div class="line">    f(context, index, iter)</div><div class="line">  }</div></pre></td></tr></table></figure>
<p>&#x5F53;MapPartitionsRDD&#x5B9E;&#x4F8B;&#x8C03;&#x7528;compute&#x65B9;&#x6CD5;&#xFF0C;&#x751F;&#x6210;&#x8BE5;RDD&#x4E0A;&#x7684;&#x8FED;&#x4EE3;&#x5668;&#x65F6;&#x3002;&#x9996;&#x5148;&#x67E5;&#x770B;&#x5B83;&#x4F9D;&#x8D56;&#x7684;RDD(firstParent)&#x8981;&#x4E00;&#x4E2A;&#x5BF9;&#x5E94;split&#x7684;&#x8FED;&#x4EE3;&#x5668;&#xFF0C;spark&#x9996;&#x5148;&#x67E5;&#x770B;&#x8BE5;rdd split&#x662F;&#x5426;&#x88AB;&#x7F13;&#x5B58;&#xFF0C;&#x5982;&#x679C;&#x88AB;&#x7F13;&#x5B58;&#x5219;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#xFF0C;&#x5219;&#x8C03;&#x7528;parent rdd&#x7684;compute&#x65B9;&#x6CD5;&#x8BA1;&#x7B97;&#x51FA;&#x6765;&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x9012;&#x5F52;&#x8BA1;&#x7B97;&#x7684;&#x8FC7;&#x7A0B;&#x3002;MapPartitionsRDD&#x5728;&#x8C03;&#x7528;compute&#x65F6;&#xFF0C;&#x6709;&#x4E2A;<em>f(context, index, iter)</em>, &#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x8C03;&#x7528;&#x7B49;&#x4EF7;&#x4E8E;&#xFF1A;<em>iter(HadoopRDD&#x8FED;&#x4EE3;&#x5668;).flatMap(line =&gt; line.split(&#x201C;\s+&#x201D;)</em> </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">flatMap</span></span>[<span class="type">B</span>](f: <span class="type">A</span> =&gt; <span class="type">GenTraversableOnce</span>[<span class="type">B</span>]): <span class="type">Iterator</span>[<span class="type">B</span>] = <span class="keyword">new</span> <span class="type">AbstractIterator</span>[<span class="type">B</span>] {</div><div class="line">   <span class="keyword">private</span> <span class="keyword">var</span> cur: <span class="type">Iterator</span>[<span class="type">B</span>] = empty</div><div class="line">   <span class="function"><span class="keyword">def</span> <span class="title">hasNext</span></span>: <span class="type">Boolean</span> =</div><div class="line">     cur.hasNext || self.hasNext &amp;&amp; { cur = f(self.next).toIterator; hasNext }</div><div class="line">   <span class="function"><span class="keyword">def</span> <span class="title">next</span></span>(): <span class="type">B</span> = (<span class="keyword">if</span> (hasNext) cur <span class="keyword">else</span> empty).next()</div><div class="line"> }</div></pre></td></tr></table></figure>
<p>&#x53EF;&#x89C1;&#xFF0C;&#x6211;&#x4EEC;&#x5177;&#x4F53;&#x7684;&#x4E1A;&#x52A1;&#x903B;&#x8F91;(line =&gt; line.split(&#x201C;\s+&#x201D;))&#x662F;&#x5728;<em>f(self.next)</em>&#x8FD9;&#x8C03;&#x7528;&#x7684;&#xFF0C; &#x800C;self.next&#x83B7;&#x5F97;&#x7684;&#x662F;HadoopRDD&#x8FED;&#x4EE3;&#x5668;&#x4E2D;&#x4E0B;&#x4E00;&#x6761;&#x8BB0;&#x5F55;&#x3002;</p>
<p>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x5F53;Spark driver&#x6267;&#x884C;&#x5230;&#x8FD9;&#x4E00;&#x6B65;&#x65F6;&#xFF0C;&#x5C5E;&#x4E8E;&#x8FD9;&#x4E2A;Application&#x7684;&#x8FDB;&#x7A0B;&#x96C6;&#x5408;&#x5E76;&#x6CA1;&#x6709;task&#x5728;&#x8FD0;&#x884C;&#xFF0C;&#x56E0;&#x4E3A;RDD&#x5B9E;&#x4F8B;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;iterator&#x63A5;&#x53E3;&#xFF0C;&#x5176;&#x5185;&#x90E8;&#x6570;&#x636E;&#x5982;&#x4F55;&#x8BA1;&#x7B97;&#x4EE5;&#x53CA;&#x8981;&#x8BA1;&#x7B97;&#x7684;&#x6570;&#x636E;&#x600E;&#x6837;&#x88AB;&#x83B7;&#x53D6;&#xFF0C;&#x8FD9;&#x5BF9;&#x4E8E;&#x5176;&#x5B83;&#x7684;RDD&#x6765;&#x8BF4;&#x662F;&#x4E0D;&#x53EF;&#x89C1;&#x7684;&#xFF0C;&#x4E5F;&#x6CA1;&#x5FC5;&#x8981;&#x77E5;&#x9053;&#x3002; &#x8981;&#x60F3;&#x771F;&#x6B63;&#x8BA9;&#x6570;&#x636E;&#x52A8;&#x8D77;&#x6765;(rdd.action)&#xFF0C;&#x5219;&#x9700;&#x8981;&#x8FD9;&#x6837;&#xFF1A;</p>
<p><pre><br>  while (iter.hasNext) {<br>     func(iter.next)<br>  }<br> iter.hasNext -&gt; iter1.hasNext -&gt; iter2.hasNext -&gt; &#x2026;.. -&gt; itern.hasNext<br> iter.next -&gt; iter1.next -&gt; &#x2026;&#x2026;. -&gt; itern.next<br> </pre><br> &#x6211;&#x4EEC;&#x5B9A;&#x4E49;&#x7684;&#x51FD;&#x6570;&#x903B;&#x8F91;&#xFF0C;&#x5219;&#x662F;&#x5728;&#x8C03;&#x7528;&#x8FD9;&#x4E9B;iter1.hasNext&#x6216;&#x8005;iter.next&#x7684;&#x65F6;&#x5019;&#x88AB;&#x6267;&#x884C;(rdd&#x6709;&#x4E2A;mapPartitions&#x65B9;&#x6CD5;&#x548C;&#x8FD9;&#x91CC;&#x8BF4;&#x7684;&#x4E0D;&#x4E00;&#x81F4;&#xFF09;<br> &#x5982;rdd.reduce:</p>
 <figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">reduce</span></span>(f: (<span class="type">T</span>, <span class="type">T</span>) =&gt; <span class="type">T</span>): <span class="type">T</span> = withScope {</div><div class="line">   <span class="keyword">val</span> cleanF = sc.clean(f)</div><div class="line">   <span class="comment">//reducePartition&#x88AB;&#x5E8F;&#x5217;&#x5316;&#x5230;executors&#x4E2D;&#x6267;&#x884C;</span></div><div class="line">   <span class="keyword">val</span> reducePartition: <span class="type">Iterator</span>[<span class="type">T</span>] =&gt; <span class="type">Option</span>[<span class="type">T</span>] = iter =&gt; {</div><div class="line">     <span class="keyword">if</span> (iter.hasNext) {</div><div class="line">       <span class="type">Some</span>(iter.reduceLeft(cleanF))</div><div class="line">     } <span class="keyword">else</span> {</div><div class="line">       <span class="type">None</span></div><div class="line">     }</div><div class="line">   }</div><div class="line">   ...</div><div class="line"> }</div></pre></td></tr></table></figure>
<p>&#x56DE;&#x5230;&#x6700;&#x521D;&#x7684;&#x95EE;&#x9898;&#xFF0C;Spark&#x4E0E;&#x5E8F;&#x5217;&#x5316;&#x6709;&#x4F55;&#x5173;&#x7CFB;&#xFF1F;<br>&#x7531;&#x4E0A;&#x6587;&#x7684;&#x5206;&#x6790;&#x53EF;&#x77E5;&#xFF0C;&#x6211;&#x4EEC;&#x5B9A;&#x4E49;&#x7684;&#x51FD;&#x6570;&#x903B;&#x8F91;&#x88AB;&#x5185;&#x5D4C;&#x5230;RDD&#x7684;&#x5B9A;&#x4E49;&#x4E2D;(&#x901A;&#x8FC7;&#x6784;&#x9020;&#x51FD;&#x6570;), &#x8FD9;&#x4E9B;&#x903B;&#x8F91;&#x968F;RDD&#x4E00;&#x8D77;&#x88AB;&#x5206;&#x53D1;&#x5230;application&#x53EF;&#x7528;&#x7684;&#x8FDB;&#x7A0B;&#x4E0A;&#x53BB;&#x6267;&#x884C;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x6211;&#x4EEC;&#x5B9A;&#x4E49;&#x7684;&#x903B;&#x8F91;&#x662F;RDD&#x4E2D;&#x4E00;&#x4E2A;&#x6709;&#x72B6;&#x6001;&#x7684;&#x6210;&#x5458;&#x53D8;&#x91CF;&#xFF0C;Spark driver&#x901A;&#x8FC7;&#x5C06;RDD&#x5E8F;&#x5217;&#x5316;&#xFF0C;&#x5C06;&#x7ED3;&#x679C;&#x5C01;&#x88C5;&#x5230;&#x76F8;&#x5E94;&#x7684;Task&#x4E2D;&#xFF0C;&#x8FD9;&#x90E8;&#x5206;&#x7EC6;&#x8282;&#x53EF;&#x5728;DAGScheduler.submitMissingTasks&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF1A;</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> taskBinary: <span class="type">Broadcast</span>[<span class="type">Array</span>[<span class="type">Byte</span>]] = <span class="literal">null</span></div><div class="line">    <span class="keyword">try</span> {</div><div class="line">      <span class="comment">// For ShuffleMapTask, serialize and broadcast (rdd, shuffleDep).</span></div><div class="line">      <span class="comment">// For ResultTask, serialize and broadcast (rdd, func).</span></div><div class="line">      <span class="keyword">val</span> taskBinaryBytes: <span class="type">Array</span>[<span class="type">Byte</span>] = stage <span class="keyword">match</span> {</div><div class="line">        <span class="keyword">case</span> stage: <span class="type">ShuffleMapStage</span> =&gt;</div><div class="line">          closureSerializer.serialize((stage.rdd, stage.shuffleDep): <span class="type">AnyRef</span>).array()</div><div class="line">        <span class="keyword">case</span> stage: <span class="type">ResultStage</span> =&gt;</div><div class="line">          closureSerializer.serialize((stage.rdd, stage.func): <span class="type">AnyRef</span>).array()</div><div class="line">      }</div><div class="line"></div><div class="line">      taskBinary = sc.broadcast(taskBinaryBytes)</div><div class="line">    }</div><div class="line">    </div><div class="line">  <span class="comment">//...</span></div><div class="line">     <span class="keyword">case</span> stage: <span class="type">ShuffleMapStage</span> =&gt;</div><div class="line">          partitionsToCompute.map { id =&gt;</div><div class="line">            <span class="keyword">val</span> locs = taskIdToLocations(id)</div><div class="line">            <span class="keyword">val</span> part = stage.rdd.partitions(id)</div><div class="line">            <span class="keyword">new</span> <span class="type">ShuffleMapTask</span>(stage.id, stage.latestInfo.attemptId,</div><div class="line">              taskBinary, part, locs, stage.internalAccumulators)</div><div class="line">          }</div><div class="line"></div><div class="line">        <span class="keyword">case</span> stage: <span class="type">ResultStage</span> =&gt;</div><div class="line">          <span class="keyword">val</span> job = stage.activeJob.get</div><div class="line">          partitionsToCompute.map { id =&gt;</div><div class="line">            <span class="keyword">val</span> p: <span class="type">Int</span> = stage.partitions(id)</div><div class="line">            <span class="keyword">val</span> part = stage.rdd.partitions(p)</div><div class="line">            <span class="keyword">val</span> locs = taskIdToLocations(id)</div><div class="line">            <span class="keyword">new</span> <span class="type">ResultTask</span>(stage.id, stage.latestInfo.attemptId,</div><div class="line">              taskBinary, part, locs, id, stage.internalAccumulators)</div><div class="line">     }</div></pre></td></tr></table></figure>
<p>&#x5C06;&#x6211;&#x4EEC;&#x7684;&#x903B;&#x8F91;&#x5E8F;&#x5217;&#x5316;&#x540E;&#xFF0C;&#x901A;&#x8FC7;&#x6784;&#x9020;&#x51FD;&#x6570;&#x4F20;&#x5165;&#x5230;&#x76F8;&#x5E94;&#x7684;Task&#x4E2D;&#xFF0C;TaskSetManager&#x518D;&#x5C06;task&#x5E8F;&#x5217;&#x5316;&#xFF0C;driver&#x5C06;&#x5E8F;&#x5217;&#x5316;&#x7ED3;&#x679C;&#x53D1;&#x9001;&#x5230;executor&#xFF0C; executor&#x5148;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5F97;&#x5230;task&#x5B9E;&#x4F8B;&#xFF0C;&#x63A5;&#x7740;&#x518D;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5F97;&#x5230;rdd&#x548C;&#x4F9D;&#x8D56;&#x5173;&#x7CFB;(dependency)&#x3002;<br>&#x5728;<a href="https://issues.apache.org/jira/browse/SPARK-7708" target="_blank" rel="external">SPARK-7708</a>&#x63D0;&#x5230;&#xFF0C;&#x76EE;&#x524D;&#x5E76;&#x4E0D;&#x80FD;&#x652F;&#x6301;kyro&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x5E8F;&#x5217;&#x5316;&#x8FD9;&#x4E9B;&#x5B9A;&#x4E49;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x5728;&#x672A;&#x53EF;&#x66FF;&#x4EE3;&#x7684;&#x524D;&#x63D0;&#x4E0B;&#xFF0C;&#x4F7F;&#x7528;&#x7684;&#x662F;Java&#x672C;&#x8EAB;&#x63D0;&#x4F9B;&#x7684;&#x5E8F;&#x5217;&#x5316;&#x673A;&#x5236;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x5199;&#x6211;&#x4EEC;&#x7684;&#x903B;&#x8F91;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x9075;&#x5FAA;Java&#x5E8F;&#x5217;&#x5316;&#x63D0;&#x4F9B;&#x7684;&#x89C4;&#x5219;&#x3002;&#x5305;&#x62EC;&#xFF0C;<strong>&#x5728;&#x6211;&#x4EEC;&#x5199;&#x7684;&#x903B;&#x8F91;&#x4E2D;&#x5305;&#x542B;&#x4F9D;&#x8D56;&#x7684;&#x7C7B;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x72B6;&#x6001;&#x7684;&#x5168;&#x5C40;&#x53D8;&#x91CF;(&#x9012;&#x5F52;&#xFF0C;&#x5BF9;&#x8C61;&#x76F8;&#x5173;)&#x4E0D;&#x80FD;&#x5E8F;&#x5217;&#x5316;&#xFF0C;&#x5219;&#x4F1A;&#x51FA;&#x73B0;&#x5E8F;&#x5217;&#x5316;&#x95EE;&#x9898;&#x7B49;</strong>&#xFF0C; &#x8FD9;&#x4E2A;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<em>spark.closure.serializer</em>&#x53EF;&#x914D;&#x7F6E;&#x3002; &#x540C;&#x65F6;&#xFF0C;&#x4E86;&#x89E3;&#x5230;&#x6211;&#x4EEC;&#x5B9A;&#x4E49;&#x7684;&#x51FD;&#x6570;&#x903B;&#x8F91;f&#xFF0C;&#x4F1A;&#x5206;&#x53D1;&#x5728;&#x4E0D;&#x540C;&#x7684;JVM&#x4E0A;&#x6267;&#x884C;&#xFF0C;&#x610F;&#x5473;&#x7740;&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x4E00;&#x4E9B;&#x8FD9;&#x6837;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x8FD9;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x7F16;&#x7A0B;&#x7279;&#x522B;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x95EE;&#x9898;&#xFF1A;</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> counter = <span class="number">0</span></div><div class="line"><span class="keyword">var</span> rdd = sc.parallelize(data)</div><div class="line"></div><div class="line"><span class="comment">// Wrong: Don&apos;t do this!!</span></div><div class="line">rdd.foreach(x =&gt; counter += x)</div><div class="line"><span class="comment">//&#x5728;&#x5206;&#x5E03;&#x5F0F;&#x73AF;&#x5883;&#x4E0B;&#xFF0C;&#x53EF;&#x80FD;&#x6BCF;&#x6B21;&#x8FD4;&#x56DE;&#x7684;&#x503C;&#x51FA;&#x73B0;&#x4E0D;&#x4E00;&#x81F4;</span></div><div class="line">println(<span class="string">&quot;Counter value: &quot;</span> + counter)</div></pre></td></tr></table></figure>
<p><a href="http://spark.apache.org/docs/latest/programming-guide.html#understanding-closures-a-nameclosureslinka" target="_blank" rel="external">Prior to execution, Spark computes the task&#x2019;s closure. The closure is those variables and methods which must be visible for the executor to perform its computations on the RDD (in this case foreach()). This closure is serialized and sent to each executor.<br>The variables within the closure sent to each executor are now copies and thus, when counter is referenced within the foreach function, it&#x2019;s no longer the counter on the driver node. There is still a counter in the memory of the driver node but this is no longer visible to the executors! The executors only see the copy from the serialized closure. Thus, the final value of counter will still be zero since all operations on counter were referencing the value within the serialized closure.</a><br>&#x53E6;&#x5916;&#xFF0C;&#x5728;spark&#x4E2D;&#xFF0C;&#x4F7F;&#x7528;&#x5230;&#x4E86;&#x5E8F;&#x5217;&#x5316;&#x6765;&#x4FDD;&#x5B58;shuffle&#x7684;&#x4E2D;&#x95F4;&#x7ED3;&#x679C;,&#x51CF;&#x5C11;&#x7F51;&#x7EDC;&#x4F20;&#x8F93;;&#x6709;&#x65F6;&#x4E3A;&#x907F;&#x514D;&#x540C;&#x4E00;&#x4E2A;RDD&#x91CD;&#x590D;&#x8BA1;&#x7B97;&#xFF0C;&#x9700;&#x8981;&#x4FDD;&#x5B58;&#x67D0;&#x4E2A;RDD&#x4E0A;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<a href="https://spark.apache.org/docs/latest/programming-guide.html#rdd-persistence" target="_blank" rel="external">RDD Persist API</a>, &#x4F7F;&#x7528;&#x5E8F;&#x5217;&#x5316;&#x6765;&#x51CF;&#x5C11;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x91CF;(MEMORY_ONLY_SER)&#x6216;&#x8005;disk&#x7684;&#x5360;&#x7528;&#x7A7A;&#x95F4;(MEMORY_AND_DISK_SER)&#x3002;<a href="https://spark.apache.org/docs/latest/tuning.html" target="_blank" rel="external">&#x5BF9;&#x4E8E;&#x5927;&#x591A;&#x6570;&#x5E94;&#x7528;&#x6765;&#x8BF4;&#xFF0C;&#x5C06;&#x5E8F;&#x5217;&#x5316;&#x673A;&#x5236;&#x66F4;&#x6539;&#x6210;kyro&#xFF0C;&#x5C06;&#x6570;&#x636E;&#x4EE5;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x5F62;&#x5F0F;&#x6765;&#x4FDD;&#x5B58;&#xFF0C;&#x53EF;&#x4EE5;&#x89E3;&#x51B3;&#x5927;&#x90E8;&#x5206;&#x5E94;&#x7528;&#x7684;&#x6027;&#x80FD;&#x95EE;&#x9898;&#x3002;</a>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//switch to using Kryo by initializing your job with a SparkConf</span></div><div class="line">conf.set(<span class="string">&quot;spark.serializer&quot;</span>, <span class="string">&quot;org.apache.spark.serializer.KryoSerializer&quot;</span>).</div></pre></td></tr></table></figure>
<p>&#x6765;&#x914D;&#x7F6E;&#x6216;&#x4FEE;&#x6539;&#x8FD9;&#x90E8;&#x5206;Spark&#x7684;&#x5E8F;&#x5217;&#x5316;&#x673A;&#x5236;&#x3002;<br><br>&#x672C;&#x6587;&#x6240;&#x4F5C;&#x7684;&#x5206;&#x6790;&#x4E0D;&#x8FC7;&#x662F;Spark&#x4E2D;&#x7684;&#x51B0;&#x5C71;&#x4E00;&#x89D2;&#xFF0C;&#x6587;&#x4E2D;&#x4E0D;&#x5F53;&#x6216;&#x9519;&#x8BEF;&#x4E4B;&#x5904;&#xFF0C;&#x6B22;&#x8FCE;&#x6279;&#x8BC4;&#x6307;&#x6B63;&#x3002;</p>
<p><strong><em>Useful links: <br></em></strong></p>
<ul><br>  <li><a href="http://jerryshao.me/architecture/2013/10/08/spark-storage-module-analysis/" target="_blank" rel="external">http://jerryshao.me/architecture/2013/10/08/spark-storage-module-analysis/</a></li><br>  <li><a href="https://github.com/JerryLead/SparkInternals" target="_blank" rel="external">https://github.com/JerryLead/SparkInternals</a></li><br>  <li><a href="http://spark.apache.org/docs/latest/programming-guide.html" target="_blank" rel="external">http://spark.apache.org/docs/latest/programming-guide.html</a></li><br>  <li><a href="https://jaceklaskowski.gitbooks.io/mastering-apache-spark/content/spark-overview.html" target="_blank" rel="external">https://jaceklaskowski.gitbooks.io/mastering-apache-spark/content/spark-overview.html</a></li><br>  <li><a href="http://blog.madhukaraphatak.com/kryo-disk-serialization-in-spark/" target="_blank" rel="external">http://blog.madhukaraphatak.com/kryo-disk-serialization-in-spark/</a></li><br>  <li><a href="https://ogirardot.wordpress.com/2015/01/09/changing-sparks-default-java-serialization-to-kryo/" target="_blank" rel="external">https://ogirardot.wordpress.com/2015/01/09/changing-sparks-default-java-serialization-to-kryo/</a></li><br>  <li><a href="http://spark.apache.org/docs/latest/programming-guide.html#understanding-closures-a-nameclosureslinka" target="_blank" rel="external">http://spark.apache.org/docs/latest/programming-guide.html#understanding-closures-a-nameclosureslinka</a></li><br></ul>  

<p>Example:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">&quot;Spark Pi&quot;</span>).setMaster(<span class="string">&quot;local&quot;</span>)</div><div class="line"><span class="keyword">val</span> spark = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</div><div class="line"><span class="keyword">var</span> wcount = spark.textFile(<span class="string">&quot;file:///Users/yixin/test&quot;</span>).flatMap(line =&gt; line.split(<span class="string">&quot;\\s+&quot;</span>))</div><div class="line">      .filter(word =&gt; word.startsWith(<span class="string">&quot;f&quot;</span>)).map(word =&gt; (word, <span class="number">1</span>)).cache()</div><div class="line"></div><div class="line"><span class="keyword">var</span> patitions = wcount.mapPartitions(iter =&gt; {</div><div class="line">  <span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="type">ListBuffer</span>[<span class="type">String</span>]();</div><div class="line">  <span class="keyword">while</span> (iter.hasNext) {</div><div class="line">    <span class="keyword">var</span> (word, count) = iter.next()</div><div class="line">     buf += (word + <span class="string">&quot;_&quot;</span> + count)</div><div class="line">  }</div><div class="line">  buf.toList.toIterator</div><div class="line">})</div><div class="line"></div><div class="line"><span class="keyword">var</span> iter: <span class="type">Iterator</span>[<span class="type">String</span>] = patitions.compute(<span class="keyword">new</span> <span class="type">Partition</span> {</div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">index</span></span>: <span class="type">Int</span> = wcount.partitions.apply(<span class="number">0</span>).index</div><div class="line">},</div><div class="line"> <span class="keyword">new</span> <span class="type">TaskContextImpl</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</div><div class="line">     <span class="keyword">new</span> <span class="type">TaskMemoryManager</span>(<span class="type">SparkEnv</span>.get.memoryManager, <span class="number">0</span>),</div><div class="line">          <span class="type">SparkEnv</span>.get.metricsSystem,</div><div class="line">          internalAccumulators = <span class="type">Seq</span>.empty))</div><div class="line"></div><div class="line"><span class="comment">//How to scan the records in a rdd </span></div><div class="line"><span class="keyword">while</span> (iter.hasNext) {</div><div class="line">    println(<span class="string">&quot;---------&gt;&quot;</span> + iter.next())</div><div class="line">}</div><div class="line">spark.stop()</div></pre></td></tr></table></figure>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="yarn-logaggregator/" class="post-link">另一种支持kerberized yarn对长时间运行的job进行日志归并</a></h2><span class="post-time">Sep 14, 2016</span><div class="post-content"><h3 id="&#x6982;&#x8FF0;"><a href="#&#x6982;&#x8FF0;" class="headerlink" title="&#x6982;&#x8FF0;"></a>&#x6982;&#x8FF0;</h3><p>&#x5728;&#x5DF2;&#x7ECF;&#x89E3;&#x51B3;&#x7684;YARN-2704&#x4E0A;&#xFF0C;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x89E3;&#x51B3;&#x957F;&#x65F6;&#x4EFB;&#x52A1;(long running job)&#x7531;&#x4E8E;hdfs delegation token&#x5931;&#x6548;(token lifetime&gt;7 day)&#x800C;&#x5BFC;&#x81F4;NodeManager&#x5F52;&#x6863;Application&#x65E5;&#x5FD7;&#x5931;&#x8D25;&#x7684;&#x4E00;&#x79CD;&#x601D;&#x8DEF;&#x3002;<br><img src="/yarn-logaggregator/archi-design.png" alt="archi-design.png" title=""><br>&#x5F53;&#x7528;&#x6237;&#x63D0;&#x4EA4;&#x957F;&#x65F6;&#x4F5C;&#x4E1A;&#x540E;&#xFF0C; &#x7531;ResourceManager&#x6765;&#x7EF4;&#x62A4;&#x8BE5;&#x4F5C;&#x4E1A;&#x7684;hdfs delegation token&#xFF0C; &#x5F53;ResourceManager&#x68C0;&#x6D4B;&#x5230;&#x6709;&#x5982;&#x4E0B;&#x4EFB;&#x4E00;&#x6761;&#x4EF6;&#x53D1;&#x751F;&#x65F6;&#xFF1A;<br>  &#xA0;&#xA0;1, &#x7528;&#x6237;&#x63D0;&#x4EA4;&#x4F5C;&#x4E1A;&#x65F6;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x63D0;&#x4F9B;dt(delegation token, &#x4E13;&#x6307;hdfs&#xFF0C;&#x4E0B;&#x540C;)&#x4FE1;&#x606F;&#x3002;<br>  &#xA0;&#xA0;2, dt&#x5373;&#x5C06;&#x5728;10&#x5C0F;&#x65F6;&#x4E4B;&#x540E;&#x8FC7;&#x671F;&#x3002;<br>ResourceManager&#x9700;&#x8981;&#x4EE5;&#x4E00;&#x4E2A;&#x53D7;&#x4FE1;&#x4EFB;&#x7684;&#x4EE3;&#x7406;&#x4EBA;&#x8EAB;&#x4EFD;&#x81EA;&#x52A8;&#x5411;NameNode&#x7533;&#x8BF7;&#x4F5C;&#x4E1A;&#x63D0;&#x4EA4;&#x8005;&#x7684;dt&#x4FE1;&#x606F;&#x3002; &#x83B7;&#x53D6;&#x5230;&#x65B0;&#x7684;dt&#x540E;&#xFF0C;&#x901A;&#x8FC7;&#x4E0E;NodeManager&#x7684;&#x5FC3;&#x8DF3;&#x673A;&#x5236;&#xFF0C;&#x5C06;&#x65B0;&#x83B7;&#x53D6;&#x7684;token&#x544A;&#x77E5;NodeManager&#x3002;&#x7531;&#x6B64;NodeManager&#x53EF;&#x4EE5;&#x89C4;&#x5F8B;&#x6027;&#x7684;&#x66F4;&#x65B0;&#x5173;&#x4E8E;&#x4F5C;&#x4E1A;&#x7684;dt&#x4FE1;&#x606F;&#x3002;&#x5F53;&#x4F5C;&#x4E1A;&#x9000;&#x51FA;&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x8BE5;dt&#x83B7;&#x5F97;NameNode&#x7684;&#x8BA4;&#x8BC1;&#xFF0C;&#x5C06;&#x4F5C;&#x4E1A;&#x76F8;&#x5173;&#x7684;&#x65E5;&#x5FD7;&#x5F52;&#x6863;&#x5230;hdfs&#x7528;&#x6237;&#x7684;&#x76EE;&#x5F55;&#x4E0B;&#x3002;<br>&#x8BE5;&#x65B0;&#x529F;&#x80FD;&#x5DF2;&#x5728;HADOOP2.6.0&#x7248;&#x672C;&#x4E2D;&#x5F97;&#x5230;&#x89E3;&#x51B3;&#xFF0C;&#x8BE5;patch&#x9700;&#x8981;&#x4FEE;&#x6539;&#x6216;&#x6D89;&#x53CA;&#x7684;&#x670D;&#x52A1;&#x6709;&#xFF1A;<br>&#xA0;&#xA0;1, ResourceManager&#x81EA;&#x52A8;&#x66F4;&#x65B0;/&#x83B7;&#x53D6; &#x8FC7;&#x65F6;/&#x4E0D;&#x5B58;&#x5728; &#x7684;dt&#x3002;<br>&#xA0;&#xA0;2, &#x4FEE;&#x6539;RM&#x4E0E;NM&#x7684;&#x901A;&#x4FE1;&#x534F;&#x8BAE;&#xFF0C;&#x4F7F;&#x65B0;&#x7684;dt&#x80FD;&#x591F;&#x53CA;&#x65F6;&#x7684;&#x53D1;&#x5E03;&#x5728;NM&#x4E2D;&#x3002;<br>&#xA0;&#xA0;3, &#x5C06;RM&#x5728;NameNode&#x6807;&#x8BB0;&#x4E3A;&#x4E00;&#x4E2A;&#x53D7;&#x4FE1;&#x4EFB;&#x7684;&#x4EE3;&#x7406;&#x89D2;&#x8272;&#x3002;<br>&#x6D89;&#x53CA;&#x5230;&#x7684;&#x670D;&#x52A1;&#x6709;RM&#x3001;NM&#x4EE5;&#x53CA;NameNode&#xFF0C; &#x66F4;&#x6539;&#x540E;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x542F;&#x52A8;&#x8FD9;&#x4E9B;&#x670D;&#x52A1;&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x7EBF;&#x4E0A;hadoop&#x7248;&#x672C;&#x57FA;&#x4E8E;2.4.1&#xFF0C; &#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x8BE5;patch(YARN-2704)&#xFF0C; &#x8FD9;&#x7ED9;&#x5347;&#x7EA7;&#x8BE5;&#x529F;&#x80FD;&#x5E26;&#x6765;&#x4E00;&#x4E9B;&#x56F0;&#x96BE;&#x3002;&#x76EE;&#x524D;&#x96C6;&#x7FA4;&#x4E0A;&#x8FD0;&#x884C;&#x7684;&#x957F;&#x65F6;&#x4EFB;&#x52A1;&#x4E3B;&#x8981;&#x4E3A;Spark Streaming&#x3002;&#x5728;SPARK-5342&#x4E2D;&#xFF0C;&#x4E3A;&#x4E86;&#x89E3;&#x51B3;spark streaming dt&#x8FC7;&#x671F;&#x7684;&#x95EE;&#x9898;&#xFF0C;spark AppMaster&#x901A;&#x8FC7;&#x7528;&#x6237;&#x4E0A;&#x4F20;&#x7684;keytab&#x6587;&#x4EF6;&#x5468;&#x671F;&#x6027;&#x7684;&#x5237;&#x65B0;dt&#xFF0C;&#x5E76;&#x5C06;&#x5237;&#x65B0;&#x540E;&#x7684;dt&#x6301;&#x4E45;&#x5316;&#x5230;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x4E2D;&#xFF0C;&#x5E76;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x901A;&#x77E5;&#x7ED9;&#x6267;&#x884C;&#x4EFB;&#x52A1;&#x7684;executors&#xFF0C; executors&#x4ECE;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x4E2D;&#x8BFB;&#x53D6;&#x5230;&#x65B0;&#x7684;dt&#xFF0C; &#x66FF;&#x6362;&#x6389;&#x539F;&#x9648;&#x65E7;&#x7684;dt&#x3002;&#x901A;&#x8FC7;&#x8FD9;&#x6837;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x6301;&#x7EED;&#x957F;&#x65F6;&#x95F4;&#x7684;&#x6267;&#x884C;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x3002;<br><img src="/yarn-logaggregator/spark-token-renew.png" alt="spark-token-renew.png" title=""><br>Spark Streaming&#x7684;&#x8BBE;&#x8BA1;&#x65B9;&#x5F0F;&#xFF0C;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x8FD9;&#x4E2A;&#x7ED3;&#x8BBA;&#xFF1A;&#x5F53;Spark Executors&#x6B63;&#x5E38;&#x9000;&#x51FA;&#x65F6;&#xFF0C;&#x5176;&#x7F13;&#x5B58;&#x7684;dt&#x662F;&#x6709;&#x6548;&#x7684;&#xFF0C; &#x53EF;&#x4EE5;&#x7EE7;&#x7EED;&#x7528;&#x4E8E;&#x4E0E;NameNode&#x7684;&#x8BA4;&#x8BC1;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x53EF;&#x4EE5;&#x8BA9;&#x8BE5;executors&#x7684;dt&#x66FF;&#x6362;NM&#x4E0A;&#x5BF9;&#x5E94;&#x7684;&#x5DF2;&#x8FC7;&#x671F;&#x7684;dt&#x6765;&#x652F;&#x6301;NodeManager&#x5BF9;&#x957F;&#x65F6;Spark Streaming&#x4EFB;&#x52A1;&#x7684;container&#x65E5;&#x5FD7;&#x5F52;&#x6863;&#x7684;&#x529F;&#x80FD;&#xFF0C; &#x91C7;&#x7528;&#x5982;&#x4E0B;&#x7684;&#x8BBE;&#x8BA1;&#xFF1A;<br><img src="/yarn-logaggregator/mydesign.png" alt="mydesign.png" title=""><br>Executor&#x5C06;&#x672C;&#x5730;&#x7F13;&#x5B58;&#x4E2D;&#x6700;&#x65B0;&#x7684;token&#x5199;&#x5165;&#x5230;&#x672C;&#x5730;&#x78C1;&#x76D8;&#x7684;&#x4E00;&#x4E2A;&#x76EE;&#x5F55;&#x4E2D;&#x3002;&#x5F53;NM&#x7531;&#x4E8E;dt&#x8FC7;&#x671F;&#x539F;&#x56E0;&#x800C;&#x5BFC;&#x81F4;container&#x65E5;&#x5FD7;&#x5F52;&#x6863;&#x5931;&#x8D25;&#x65F6;&#xFF0C;&#x4ECE;&#x7EA6;&#x5B9A;&#x7684;&#x76EE;&#x5F55;&#x4E2D;&#x8BFB;&#x53D6;dt A&#xFF0C;&#x66FF;&#x6362;&#x6389;&#x5BF9;&#x5E94;&#x5DF2;&#x8FC7;&#x671F;&#x7684;dt B&#xFF0C; &#x4F7F;&#x7528;dt A&#x6765;&#x5B9E;&#x73B0;&#x4E0E;NameNode&#x7684;&#x8BA4;&#x8BC1;&#x8FC7;&#x7A0B;&#x3002;</p>
<p>&#x6682;&#x4E14;&#x5C06;&#x5B98;&#x65B9;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x79F0;&#x4E4B;&#x4E3A;PA&#xFF0C; &#x53E6;&#x4E00;&#x79CD;&#x66FF;&#x8865;&#x7684;&#x65B9;&#x6848;&#x79F0;&#x4E4B;&#x4E3A;PB&#xFF0C; &#x4E0B;&#x9762;&#x6BD4;&#x8F83;PA&#x548C;PB&#x7684;&#x4F18;&#x7F3A;&#x70B9;&#x3002;</p>
<p>&#xA0;&#xA0;1&#xFF0C;&#x5BF9;&#x4E8E;&#x5F52;&#x6863;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x65E5;&#x5FD7;&#x529F;&#x80FD;&#x6765;&#x8BF4;&#xFF0C;&#x8FD9;&#x5C5E;&#x4E8E;YARN&#x672C;&#x8EAB;&#x7684;&#x804C;&#x8D23;&#x4E4B;&#x4E00;&#x3002; &#x4E5F;&#x5C31;&#x662F;&#x4E0D;&#x7BA1;YARN&#x8C03;&#x7528;&#x4EC0;&#x4E48;&#x6837;&#x7684;&#x8BA1;&#x7B97;&#x6846;&#x67B6;&#xFF0C; &#x8BA1;&#x7B97;&#x6846;&#x67B6;&#x4E0D;&#x9700;&#x8981;&#x8003;&#x8651;&#x8FD0;&#x884C;&#x4E8E;&#x5176;&#x4E0A;&#x7684;&#x4E1A;&#x52A1;&#x65E5;&#x5FD7;&#x8BE5;&#x5982;&#x4F55;&#x5904;&#x7406;&#x3002;&#x56E0;&#x6B64;PA&#x5B9E;&#x73B0;&#x66F4;&#x5177;&#x5907;&#x901A;&#x7528;&#x6027;&#xFF0C;&#x800C;PB&#x9700;&#x8981;&#x8003;&#x8651;&#x4E0D;&#x540C;&#x7684;&#x6846;&#x67B6;&#x3002;&#x5982;&#x679C;&#x5C06;&#x8BA1;&#x7B97;&#x6846;&#x67B6;&#x66FF;&#x6362;&#x6210;storm&#xFF0C;&#x5219;&#x8FD8;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x989D;&#x5916;&#x7684;&#x4EE3;&#x7801;&#x4FEE;&#x6539;&#x64CD;&#x4F5C;&#x3002;<br>&#xA0;&#xA0;2&#xFF0C;PA&#x5728;&#x5B9E;&#x73B0;&#x4E0A;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#xFF0C;&#x6D89;&#x53CA;&#x5230;&#x7684;&#x670D;&#x52A1;&#x6709;NameNode&#xFF0C;ResourceManager&#xFF0C; NodeManager&#xFF0C;&#x8FD9;&#x4E9B;&#x670D;&#x52A1;&#x9700;&#x8981;&#x91CD;&#x542F;&#x4EE5;&#x652F;&#x6301;&#x8FD9;&#x6837;&#x7684;&#x9700;&#x6C42;&#xFF0C;&#x8FD8;&#x9700;&#x8981;&#x5C06;RM&#x8EAB;&#x4EFD;&#x8BBE;&#x7F6E;&#x4E3A;&#x7C7B;&#x4F3C;&#x4E8E;root&#x7684;&#x89D2;&#x8272;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x7533;&#x8BF7;&#x4EFB;&#x4F55;&#x7528;&#x6237;&#x7684;dt&#x4FE1;&#x606F;&#x3002;&#x53E6;&#x5916;&#xFF0C;PA &#x65B9;&#x6848;&#x7684;&#x5B9E;&#x73B0;&#x4E5F;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x5E94;&#x7528;&#x4E8E;&#x7EBF;&#x4E0A;&#x7684;hadoop2.4.1&#x7248;&#x672C;&#xFF0C;&#x9700;&#x8981;&#x989D;&#x5916;&#x7684;&#x4FEE;&#x6539;&#x4EE3;&#x7801;&#x5DE5;&#x4F5C;&#x3002;&#x800C;PB&#x5728;&#x5B9E;&#x73B0;&#x4E0A;&#xFF0C;&#x5219;&#x76F8;&#x5BF9;&#x7B80;&#x5355;&#xFF0C;&#x4E14;&#x4FDD;&#x62A4;&#x4E86;&#x89D2;&#x8272;&#x4E4B;&#x95F4;&#x7684;&#x72EC;&#x7ACB;&#x6027;&#x548C;&#x79C1;&#x5BC6;&#x6027;&#x3002;</p>
<p>&#x4E0D;&#x7BA1;yarn&#x4E2D;&#x8FD0;&#x884C;&#x7684;&#x957F;&#x65F6;&#x4EFB;&#x52A1;&#x662F;&#x5982;&#x4F55;&#x4FDD;&#x8BC1;dt&#x6709;&#x6548;(&#x8FD9;&#x53EF;&#x4EE5;&#x662F;&#x57FA;&#x4E8E;RM&#x4EE3;&#x7406;&#x7533;&#x8BF7;&#xFF0C;&#x6216;&#x662F;&#x7C7B;&#x4F3C;&#x4E8E;Spark keytab&#x767B;&#x9646;&#x8BF7;&#x6C42;)&#xFF0C;&#x5728;&#x4E0D;&#x5347;&#x7EA7;yarn&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x53EF;&#x4EE5;&#x8BA4;&#x4E3A;container/executor&#x4E0A;&#x7F13;&#x5B58;&#x7684;dt&#x662F;&#x6709;&#x6548;&#x7684;(&#x8FD9;&#x4E5F;&#x662F;&#x8BA1;&#x7B97;&#x6846;&#x67B6;&#x9700;&#x8981;&#x8003;&#x8651;&#x7684;&#x5B89;&#x5168;&#x9700;&#x6C42;)&#xFF0C;&#x56E0;&#x6B64;&#x4E0D;&#x7BA1;&#x4F7F;&#x7528;&#x4F55;&#x79CD;&#x8BA1;&#x7B97;&#x6846;&#x67B6;&#xFF0C;PB&#x672C;&#x8EAB;&#x4E5F;&#x5177;&#x5907;&#x4E00;&#x5B9A;&#x7684;&#x901A;&#x7528;&#x6027;&#x3002;<br>&#x57FA;&#x4E8E;&#x6B64;&#xFF0C; &#x91C7;&#x7528;PB&#x65B9;&#x6848;&#x6765;&#x5B9E;&#x73B0;&#x957F;&#x65F6;&#x4EFB;&#x52A1;&#x5F52;&#x6863;app&#x65E5;&#x5FD7;&#x7684;&#x5B89;&#x5168;&#x9700;&#x6C42;&#x3002;</p>
<h3 id="&#x9700;&#x6C42;&#x89C4;&#x8303;"><a href="#&#x9700;&#x6C42;&#x89C4;&#x8303;" class="headerlink" title="&#x9700;&#x6C42;&#x89C4;&#x8303;"></a>&#x9700;&#x6C42;&#x89C4;&#x8303;</h3><p><li> &#x65B0;&#x52A0;&#x5165;&#x7684;&#x529F;&#x80FD;&#x4E0D;&#x80FD;&#x5F71;&#x54CD;&#x5F53;&#x524D;&#x7684;&#x65E5;&#x5FD7;&#x5F52;&#x6863;&#x903B;&#x8F91;&#xFF0C;&#x5982;dt &lt; 7&#x5929;&#x7684;&#x60C5;&#x51B5;&#xFF0C; &#x5927;&#x90E8;&#x5206;&#x975E;&#x957F;&#x65F6;&#x4EFB;&#x52A1;&#x53EF;&#x4EE5;&#x7EE7;&#x7EED;&#x6CBF;&#x7740;&#x76EE;&#x524D;&#x7684;&#x903B;&#x8F91;&#x6267;&#x884C;&#x65E5;&#x5FD7;&#x5F52;&#x6863;&#x5DE5;&#x4F5C;&#x3002;</li></p>
<p><li> &#x52A0;&#x5165;&#x7684;&#x4EE3;&#x7801;&#x5C3D;&#x91CF;&#x4E0E;hadoop/spark&#x4EE3;&#x7801;&#x4FDD;&#x6301;&#x9694;&#x79BB;&#xFF0C;&#x51CF;&#x5C11;&#x65B0;&#x589E;&#x4EE3;&#x7801;&#x4E0E;&#x6E90;&#x4EE3;&#x7801;&#x7684;&#x6DF7;&#x6742;&#x5EA6;&#x3002;</li></p>
<p><li> &#x4EE3;&#x7801;&#x89C4;&#x8303;&#x7B26;&#x5408;hadoop&#x5B9A;&#x4E49;&#xFF0C;&#x7F16;&#x5199;&#x57FA;&#x672C;&#x7684;&#x6D4B;&#x8BD5;&#x7528;&#x4F8B;&#x6D4B;&#x8BD5;&#x65B0;&#x589E;&#x7684;&#x4EE3;&#x7801;&#x3002;</li></p>
<h3 id="&#x5B9E;&#x73B0;&#x8981;&#x70B9;"><a href="#&#x5B9E;&#x73B0;&#x8981;&#x70B9;" class="headerlink" title="&#x5B9E;&#x73B0;&#x8981;&#x70B9;"></a>&#x5B9E;&#x73B0;&#x8981;&#x70B9;</h3><p>1, &#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x5C06;executor&#x7F13;&#x5B58;&#x7684;dt&#x5199;&#x5165;&#x672C;&#x5730;&#x78C1;&#x76D8;&#x4E2D;?<br> &#x5F53;executor&#x83B7;&#x53D6;&#x5230;&#x4E00;&#x4E2A;&#x65B0;&#x7684;token&#x65F6;&#xFF0C;&#x5C06;dt&#x5E8F;&#x5217;&#x5316;&#x5230;&#x8BE5;container&#x7684;&#x4E34;&#x65F6;&#x76EE;&#x5F55;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x6587;&#x4EF6;&#x53EF;&#x547D;&#x540D;&#x4E3A;container_tokens_update&#x3002;</p>
<p>2, &#x4EC0;&#x4E48;&#x65F6;&#x5019;NM&#x9700;&#x8981;&#x4ECE;&#x672C;&#x5730;&#x78C1;&#x76D8;&#x4E2D;&#x8BFB;&#x53D6;&#x8BE5;dt&#x66FF;&#x6362;&#x5DF2;&#x8FC7;&#x671F;&#x7684;&#x5BF9;&#x5E94;&#x7684;token?<br>&#x5F53;NM&#x5728;&#x505A;app&#x65E5;&#x5FD7;&#x5F52;&#x6863;&#x65F6;&#xFF0C;&#x53D1;&#x751F;RemoteException&#xFF0C;&#x4E14;&#x5224;&#x65AD;&#x8BE5;exception&#x662F;&#x7531;dt&#x8FC7;&#x671F;&#x800C;&#x5F15;&#x8D77;&#x7684;&#xFF0C;&#x6B64;&#x65F6;NM&#x4ECE;&#x7EA6;&#x5B9A;&#x7684;&#x6587;&#x4EF6;&#x4E2D;&#x8BFB;&#x53D6;&#x5BF9;&#x5E94;&#x5E94;&#x7528;&#x7684;dt&#x4FE1;&#x606F;&#xFF0C;&#x4F7F;&#x7528;&#x8BE5;dt&#x5B8C;&#x6210;&#x4E0E;NN&#x8BA4;&#x8BC1;&#x8FC7;&#x7A0B;&#x3002;</p>
<p>3, &#x5982;&#x4F55;&#x6E05;&#x9664;executor&#x5199;&#x5165;&#x7684;dt&#x6587;&#x4EF6;&#x4FE1;&#x606F;?<br>&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x4EA4;&#x7ED9;NM&#x6765;&#x505A;, &#x5728;yarn-site.xml&#x6587;&#x4EF6;&#x4E2D;&#x901A;&#x8FC7;&#x914D;&#x7F6E; yarn.nodemanager.delete.debug-delay-sec &#x6765;&#x63A7;&#x5236;Application&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x4F1A;&#x88AB;&#x6E05;&#x9664;&#x3002;</p>
<p>4, &#x5982;&#x4F55;&#x4FDD;&#x8BC1;&#x4EE3;&#x7801;&#x7684;&#x5BF9;&#x539F;&#x6846;&#x67B6;&#x7684;&#x4FB5;&#x5165;&#x6027;&#x6700;&#x5C0F;?<br>NM&#x53EF;&#x4EE5;&#x901A;&#x8FC7;yarn.nodemanager.delegationtoken.retry.enabled&#x914D;&#x7F6E;&#x9879;&#x914D;&#x7F6E;&#x662F;&#x5426;&#x652F;&#x6301;&#x8BE5;&#x9879;&#x5C5E;&#x6027;&#xFF0C;&#x8BE5;&#x5C5E;&#x6027;&#x9ED8;&#x8BA4;&#x4E3A;false(&#x5173;&#x95ED;)&#x3002;</p>
<p>5, &#x5BF9;&#x4E8E;spark streaming&#x6765;&#x8BF4;&#xFF0C;&#x5982;&#x4F55;&#x4FDD;&#x8BC1;&#x6700;&#x65B0;&#x7684;dt&#x5E8F;&#x5217;&#x5316;&#x5230;&#x78C1;&#x76D8;&#x4E2D;? &#x8BE5;&#x64CD;&#x4F5C;&#x662F;&#x5426;&#x4F1A;&#x5F71;&#x54CD;&#x5230;&#x8282;&#x70B9;&#x7684;IO&#x6027;&#x80FD;?<br>&#x5F53;executor&#x83B7;&#x53D6;&#x5230;&#x4E00;&#x4E2A;&#x65B0;&#x7684;token&#x65F6;&#xFF0C;&#x5373;&#x5C06;&#x8BE5;token&#x5199;&#x5165;&#x5230;&#x78C1;&#x76D8;&#x4E2D;&#xFF0C;&#x6309;&#x7167;spark&#x5B89;&#x5168;&#x8BBE;&#x8BA1;&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x79CD;&#x5468;&#x671F;&#x6027;&#x7684;&#x884C;&#x4E3A;&#xFF0C;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x5E8F;&#x5217;&#x5316;&#x5230;&#x78C1;&#x76D8;&#x4E2D;&#x7684;token&#x662F;&#x6700;&#x65B0;&#x7684;&#x3002;<br>&#x6309;&#x7167;&#x7EBF;&#x4E0A;&#x96C6;&#x7FA4;&#x7684;&#x914D;&#x7F6E;&#xFF0C; &#x6BCF;&#x4E00;&#x4E2A;Spark Executor&#x6BCF;&#x4E00;&#x5929;&#x90FD;&#x5C06;&#x4F1A;&#x6709;&#x4E00;&#x6B21;&#x5199;&#x78C1;&#x76D8;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x5BF9;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x6765;&#x8BF4;&#xFF0C; &#x5047;&#x8BBE;&#x5728;&#x67D0;&#x4E00;&#x65F6;&#x523B;&#x8BE5;&#x53F0;&#x673A;&#x5668;&#x4E0A;&#x8FD0;&#x884C;&#x6709;100&#x4E2A;Spark Executor&#x4F5C;&#x4E1A;&#xFF0C; &#x90A3;&#x4E48;&#x4E00;&#x5929;&#x6700;&#x591A;&#x6709;100&#x6B21;&#x8FD9;&#x6837;&#x7684;&#x5199;&#x78C1;&#x76D8;&#x7684;&#x64CD;&#x4F5C;(&#x5206;&#x522B;&#x5199;&#x4E0D;&#x540C;&#x7684;&#x6587;&#x4EF6;)&#xFF0C;&#x5728;hadoop2.4.1&#x6D4B;&#x8BD5;&#x96C6;&#x7FA4;&#x4E0A;&#xFF0C;&#x5199;&#x5165;&#x7684;&#x6570;&#x636E;&#x91CF;&#x7EA6;&#x5728;200&#x5B57;&#x8282;&#x5DE6;&#x53F3;&#x3002;&#x5F53;Spark App&#x9000;&#x51FA;&#x65F6;&#xFF0C;NM&#x53EA;&#x9700;&#x4E00;&#x6B21;&#x8BFB;&#x64CD;&#x4F5C;(&#x5BF9;&#x4E8E;&#x4E00;&#x4E2A;&#x5E94;&#x7528;)&#x3002; &#x8FD9;&#x6837;&#x7684;&#x64CD;&#x4F5C;&#x5BF9;&#x8282;&#x70B9;&#x7684;IO&#x538B;&#x529B;&#x53EF;&#x4EE5;&#x8BF4;&#x5F88;&#x5C0F;&#x3002;</p>
<p>6, NM&#x53EF;&#x80FD;&#x6CA1;&#x6709;&#x6743;&#x9650;&#x8BBF;&#x95EE;&#x8BE5;&#x76EE;&#x5F55;&#xFF0C;&#x5982;&#x4F55;&#x786E;&#x4FDD;NM&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#x8BE5;&#x76EE;&#x5F55;?<br>&#x4ECE;NM&#x53EF;&#x4EE5;&#x5220;&#x9664;App&#x7684;&#x76EE;&#x5F55;&#x6765;&#x770B;&#xFF0C;&#x8BBF;&#x95EE;App&#x79C1;&#x6709;&#x7684;&#x76EE;&#x5F55;&#x8FD8;&#x662F;&#x6709;&#x53EF;&#x80FD;&#x7684;&#x3002;<br>executor jvm&#x5B9E;&#x4F8B;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#xFF1A;<br>-Djava.io.tmpdir=/home/hadoop/tmp/hadoop-root/nm-local-dir/usercache/root/appcache/application_1461156446723_0057/container_1461156446723_0057_01_000003/tmp<br>&#x83B7;&#x5F97;&#x672C;&#x5730;&#x79C1;&#x6709;&#x76EE;&#x5F55;&#x3002;</p>
<p>7, &#x66F4;&#x6539;&#x6D89;&#x53CA;&#x5230;&#x4EC0;&#x4E48;&#x670D;&#x52A1;?<br>NodeManager&#x548C;Spark Executor</p>
<p>8, Spark&#x52A8;&#x6001;&#x8D44;&#x6E90;&#x8C03;&#x5EA6;&#x662F;&#x5426;&#x4F1A;&#x5BF9;&#x8BE5;&#x5B9E;&#x73B0;&#x65B9;&#x6848;(PB)&#x4EA7;&#x751F;&#x5F71;&#x54CD;?<br>spark&#x52A8;&#x6001;&#x8D44;&#x6E90;&#x8C03;&#x5EA6;&#x5305;&#x62EC;&#x521B;&#x5EFA;&#x65B0;&#x7684;executor&#x6216;&#x8005;&#x56DE;&#x6536;&#x591A;&#x4F59;&#x7684;executor&#x3002;Yarn&#x5F52;&#x6863;container&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x662F;&#x5728;&#x6574;&#x4E2A;App&#x9000;&#x51FA;&#x65F6;&#x8FDB;&#x884C;&#x7684;&#xFF0C; &#x53EF;&#x80FD;&#x5B58;&#x5728;&#x67D0;&#x4E9B;container&#x7531;&#x4E8E;&#x9000;&#x51FA;&#x65F6;&#x95F4;&#x65E9;&#x800C;&#x5BFC;&#x81F4;&#x5E8F;&#x5217;&#x5316;&#x5230;&#x672C;&#x5730;&#x7684;dt&#x8FC7;&#x671F;&#xFF0C;&#x8FD9;&#x5BFC;&#x81F4;NM&#x65E0;&#x6CD5;&#x56DE;&#x6536;&#x8FD9;&#x4E9B;container&#x7684;&#x65E5;&#x5FD7;&#x3002;&#x8BE5;&#x65B9;&#x6848;&#x5C3D;&#x6700;&#x5927;&#x7684;&#x52AA;&#x529B;&#x6536;&#x96C6;App&#x9000;&#x51FA;&#x65F6;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#x6216;&#x8005;&#x521A;&#x9000;&#x51FA;&#x4E0D;&#x4E45;&#x7684;&#x5BB9;&#x5668;(Executor)&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x8FD9;&#x90E8;&#x5206;&#x65E5;&#x5FD7;&#x53EF;&#x4EE5;&#x8F85;&#x52A9;&#x67E5;&#x660E;App&#x9000;&#x51FA;&#x7684;&#x539F;&#x56E0;&#x3002;</p>
<h3 id="&#x6D4B;&#x8BD5;"><a href="#&#x6D4B;&#x8BD5;" class="headerlink" title="&#x6D4B;&#x8BD5;"></a>&#x6D4B;&#x8BD5;</h3><p>1, &#x6D4B;&#x8BD5;Spark executor&#x662F;&#x5426;&#x5C06;credentials&#x5E8F;&#x5217;&#x5316;&#x5230;&#x78C1;&#x76D8;&#x4E2D;&#x3002;<br>2, &#x975E;&#x5B89;&#x5168;&#x96C6;&#x7FA4;&#x4E0A;&#x7684;&#x6D4B;&#x8BD5;&#x3002;<br>3, &#x5B89;&#x5168;&#x96C6;&#x7FA4;&#x4E0A;&#xFF0C;&#x6B63;&#x5E38;&#x4F5C;&#x4E1A;&#x7ED3;&#x675F;&#x65F6;&#x65E5;&#x5FD7;&#x5F52;&#x6863;&#x6D4B;&#x8BD5;&#x3002;<br>4, Spark Streaming&#x4E0E;NodeManager&#x96C6;&#x6210;&#x6D4B;&#x8BD5;&#x3002;<br>5, NM&#x5BB9;&#x9519;&#x5904;&#x7406;&#x3002;<br>&#x672C;&#x6587;&#x63CF;&#x8FF0;&#x4E3B;&#x8981;&#x9488;&#x5BF9;NM&#x5BB9;&#x9519;&#x5904;&#x7406;&#xFF0C;&#x8003;&#x8651;&#x53EF;&#x80FD;&#x6709;&#x5982;&#x4E0B;&#x60C5;&#x51B5;&#xFF1A;<br>  &#xA0;&#xA0;&#xA0;&#xA0;a, App Executor&#x91CD;&#x542F;&#x591A;&#x6B21;&#x3002;<br>  &#xA0;&#xA0;&#xA0;&#xA0;b, App AM&#x91CD;&#x542F;&#x591A;&#x6B21;&#x3002;<br>&#xA0;&#xA0;<strong>App Executor&#x91CD;&#x542F;&#x591A;&#x6B21;</strong><br>&#x5047;&#x8BBE;&#x4E00;&#x4E2A;Executor&#x53EF;&#x80FD;&#x88AB;&#x91CD;&#x542F;&#x591A;&#x6B21;&#xFF0C;&#x5148;NM A&#x540E;NM B&#xFF0C; &#x5BF9;&#x4E8E;&#x8FD9;&#x6837;&#x7684;&#x60C5;&#x51B5;&#x5F53;NM A&#x4E2D;dt&#x8FC7;&#x671F;&#x540E;&#xFF08;&#x5305;&#x62EC;&#x5DF2;&#x88AB;&#x6301;&#x4E45;&#x5316;&#x540E;&#x7684;&#x65B0;dt&#xFF09;, &#x5F53;&#x8BE5;App&#x9000;&#x51FA;&#x65F6;&#xFF0C;&#x8BE5;Executor&#x4F4D;&#x4E8E;NM A&#x4E0A;&#x7684;&#x65E5;&#x5FD7;&#x5C06;&#x88AB;&#x4E22;&#x5931;&#x3002;&#x901A;&#x8FC7;&#x8FD9;&#x6837;&#x7684;&#x65B9;&#x6848;&#x6765;&#x5F52;&#x5E76;&#x65E5;&#x5FD7;&#xFF0C;&#x76EE;&#x524D;&#x7684;&#x5B9E;&#x73B0;&#x53EA;&#x80FD;&#x505A;&#x5230;&#x5728;App&#x9000;&#x51FA;&#x7684;&#x90A3;&#x4E00;&#x523B;&#xFF0C;&#x5C06;&#x8BE5;App&#x5728;&#x96C6;&#x7FA4;&#x8303;&#x56F4;&#x5185;&#x6B63;&#x5728;&#x8FD0;&#x884C;(&#x6216;&#x6700;&#x8FD1;&#x9000;&#x51FA;&#xFF0C;&#x6216;&#x8BE5;NM&#x5305;&#x542B;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#x6216;&#x6700;&#x8FD1;&#x9000;&#x51FA;)&#x7684;container&#x65E5;&#x5FD7;&#x5F52;&#x6863;&#x3002;&#x8FD9;&#x5BF9;&#x4E8E;&#x957F;&#x65F6;Spark&#x52A8;&#x6001;&#x8C03;&#x5EA6;&#x673A;&#x5236;&#x6765;&#x8BF4;&#xFF0C; &#x53EF;&#x80FD;&#x662F;&#x4E00;&#x4E2A;&#x5E76;&#x4E0D;&#x53CB;&#x597D;&#x7684;&#x65E5;&#x5FD7;&#x5F52;&#x6863;&#x65B9;&#x6848;&#xFF0C; &#x96C6;&#x7FA4;&#x7528;&#x6237;&#x53EF;&#x80FD;&#x53D1;&#x73B0;&#x67D0;&#x4E9B;Executor&#x51FA;&#x73B0;&#x65E5;&#x5FD7;&#x4E22;&#x5931;&#x7684;&#x60C5;&#x51B5;&#x3002;<br>  &#x5F53;App&#x9000;&#x51FA;&#x65F6;&#xFF0C;&#x76F8;&#x5173;&#x7684;NM&#x624D;&#x4F1A;&#x6267;&#x884C;container&#x65E5;&#x5FD7;&#x5F52;&#x6863;&#x7684;&#x903B;&#x8F91;&#xFF0C;&#x5C06;NM&#x4E0A;&#x8FD0;&#x884C;&#x8FC7;&#x7684;container&#x65E5;&#x5FD7;&#x6279;&#x91CF;&#x5199;&#x5165;&#x5230;hdfs&#x4E2D;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x5F52;&#x6863;&#x5B8C;&#x6BD5;&#x65F6;&#xFF0C;&#x5C06;&#x8BE5;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x91CD;&#x547D;&#x540D;&#x4E3A;&#x6700;&#x7EC8;&#x7684;&#x65E5;&#x5FD7;&#x6587;&#x4EF6;&#x540D;&#x5B57;&#xFF0C; &#x8FD9;&#x8FB9;&#x6D89;&#x53CA;&#x5230;&#x7684;hdfs&#x64CD;&#x4F5C;&#x6709;append&#x4EE5;&#x53CA;rename&#x3002;<br>&#x4E3A;&#x4E86;&#x4E0D;&#x8BA9;App&#x7684;&#x65E5;&#x5FD7;&#x53D1;&#x751F;&#x4E22;&#x5931;&#xFF0C;&#x5F53;NM&#x53D1;&#x73B0;&#x4E00;&#x4E2A;container&#x7ED3;&#x675F;&#x65F6;&#xFF0C;&#x5373;&#x53EF;&#x5C06;&#x8BE5;container&#x65E5;&#x5FD7;&#x4E0A;&#x4F20;&#xFF0C;&#x7531;&#x4E8E;NM&#x5E76;&#x672A;&#x77E5;&#x9053;&#x8BE5;container&#x662F;&#x5426;&#x662F;App&#x5728;&#x8BE5;&#x96C6;&#x7FA4;&#x4E0A;&#x8FD0;&#x884C;&#x7684;&#x6700;&#x540E;&#x7684;&#x4E00;&#x4E2A;container&#xFF0C;&#x52A0;&#x5165;&#x5C06;&#x8BE5;&#x65E5;&#x5FD7;&#x6587;&#x4EF6;append&#x5230;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#xFF0C;&#x90A3;&#x4E48;&#x53EF;&#x80FD;NM&#x5728;&#x6267;&#x884C;rename&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x629B;&#x51FA;&#x540C;&#x6837;&#x7684;TokenInvalid(Token not found in cache)&#x5F02;&#x5E38;&#x3002;<br>&#xA0;&#xA0;<strong>App AM&#x91CD;&#x542F;&#x591A;&#x6B21;</strong><br>&#x5F53;AM&#x91CD;&#x542F;&#x65F6;&#xFF0C;&#x53EF;&#x80FD;&#x56E0;&#x4E3A;&#x4F7F;&#x7528;&#x65E7;&#x6709;&#x7684;token&#x800C;&#x5BFC;&#x81F4;&#x91CD;&#x542F;&#x5931;&#x8D25;(yarn&#x95EE;&#x9898;)&#x3002;&#x5728;&#x6D4B;&#x8BD5;&#x65F6;&#xFF0C;&#x53D1;&#x73B0;&#x5728;Spark1.4.1&#x7684;&#x7248;&#x672C;&#x4E0A;&#xFF0C;&#x7F13;&#x5B58;&#x7684;FileSystem&#x5B9E;&#x4F8B;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x9648;&#x65E7;&#x7684;dt&#xFF0C;&#x8FD9;&#x5728;token&#x7684;&#x6709;&#x6548;&#x671F;&#x6BD4;&#x8F83;&#x77ED;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x9020;&#x6210;Executor&#x5C06;&#x6C38;&#x4E45;&#x4E0D;&#x80FD;&#x83B7;&#x5F97;AM&#x7684;&#x65B0;&#x7684;token&#x3002;&#x5F15;&#x5165;&#x793E;&#x533A;&#x7684;patch&#x6765;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;(SPARK-8688)&#x3002;&#x5728;SPARK1.5.2&#x7248;&#x672C;&#x4E0A;&#xFF0C;&#x89E3;&#x51B3;&#x4E86;&#x8BE5;&#x95EE;&#x9898;&#x3002;</p>
<h3 id="More"><a href="#More" class="headerlink" title="More"></a>More</h3><p>&#xA0;&#xA0;<strong>&#x9648;&#x65E7;Executor&#x7684;&#x65E5;&#x5FD7;&#x5B58;&#x5728;&#x7531;&#x4E8E;token&#x8FC7;&#x671F;&#x800C;&#x5BFC;&#x81F4;&#x5F52;&#x6863;&#x5931;&#x8D25;&#x7684;&#x53EF;&#x80FD;</strong><br>&#x5BF9;&#x4E8E;&#x96C6;&#x7FA4;&#x4E0A;&#x5927;&#x90E8;&#x5206;&#x5E94;&#x7528;(95%&#x4EE5;&#x4E0A;)&#x6765;&#x8BF4;&#xFF0C; &#x5728;token&#x5931;&#x6548;&#x4E4B;&#x524D;(&gt;7d)&#x53EF;&#x4EE5;&#x6267;&#x884C;&#x5B8C;&#x6BD5;&#xFF0C;NM&#x53EF;&#x4EE5;&#x5728;dt&#x7684;&#x6709;&#x6548;&#x671F;&#x5185;&#x5C06;&#x5E94;&#x7528;&#x7684;&#x65E5;&#x5FD7;&#x5F52;&#x6863;&#x5230;hdfs&#x4E0A;&#x3002;&#x5BF9;&#x4E8E;&#x957F;&#x65F6;&#x4EFB;&#x52A1;(&gt;7d)&#xFF0C;&#x5C24;&#x5176;&#x662F;&#x5F53;&#x4EFB;&#x52A1;&#x5F00;&#x542F;Spark&#x52A8;&#x6001;&#x8D44;&#x6E90;&#x8C03;&#x5EA6;&#x7684;&#x60C5;&#x5F62;&#x4E0B;&#xFF0C;&#x90A3;&#x4E48;&#x65E5;&#x5FD7;&#x4E22;&#x5931;&#x7684;&#x60C5;&#x51B5;&#x5C06;&#x6781;&#x6709;&#x53EF;&#x80FD;&#x4F1A;&#x666E;&#x904D;&#x5B58;&#x5728;&#x3002;<br>Executor&#x4E0A;&#x7684;&#x65E5;&#x5FD7;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x5B9A;&#x4F4D;&#x4E1A;&#x52A1;&#x95EE;&#x9898;&#x6240;&#x7528;&#xFF0C; &#x6709;&#x5982;&#x4E0B;&#x573A;&#x666F;&#xFF1A;<br>&#xA0;&#xA0;1, Executor&#x6B63;&#x5728;&#x8FD0;&#x884C;&#x65F6;&#xFF0C;&#x4E1A;&#x52A1;&#x51FA;&#x73B0;&#x95EE;&#x9898;&#x6216;&#x8005;&#x8FD0;&#x884C;&#x72B6;&#x51B5;&#x8868;&#x73B0;&#x4E0D;&#x6B63;&#x5E38;&#xFF0C;&#x9700;&#x8981;&#x5B9A;&#x4F4D;&#x8FD0;&#x884C;&#x65F6;&#x5B58;&#x5728;&#x7684;&#x95EE;&#x9898;&#x3002;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#xFF0C;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x73B0;&#x6709;&#x7684;&#x6280;&#x672F;&#x624B;&#x6BB5;&#x6765;&#x5206;&#x6790;&#xFF0C;&#x53EF;&#x4EE5;&#x4E0D;&#x9700;&#x8981;NM&#x8FDB;&#x884C;&#x65E5;&#x5FD7;&#x5F52;&#x6863;&#x540E;&#x5728;&#x6765;&#x5206;&#x6790;&#x3002;<br>&#xA0;&#xA0;2, Executor&#x5F02;&#x5E38;&#x9000;&#x51FA;&#xFF0C;&#x9700;&#x8981;&#x67E5;&#x660E;&#x5BFC;&#x81F4;&#x5176;&#x5F02;&#x5E38;&#x9000;&#x51FA;&#x7684;&#x539F;&#x56E0;&#x3002;&#x5BFC;&#x81F4;&#x5F02;&#x5E38;&#x9000;&#x51FA;&#x7684;&#x539F;&#x56E0;&#x53EF;&#x4EE5;&#x5F52;&#x7EB3;&#x4E3A;&#x91CD;&#x590D;&#x6027;&#x7684;(&#x5982;&#x4EE3;&#x7801;bug&#xFF0C;&#x8FD0;&#x884C;&#x6240;&#x9700;&#x73AF;&#x5883;&#x5B58;&#x5728;&#x95EE;&#x9898;)&#x4EE5;&#x53CA;&#x5076;&#x7136;&#x6027;&#x7684;(&#x7F51;&#x7EDC;&#x95EE;&#x9898;&#xFF0C;GC&#x95EE;&#x9898;&#x7B49;)&#x3002;&#x5BF9;&#x4E8E;&#x8FD9;&#x4E9B;&#x573A;&#x666F;&#xFF0C;NM&#x65E5;&#x5FD7;&#x5F52;&#x6863;&#x8FD9;&#x90E8;&#x5206;&#x529F;&#x80FD;&#x5E76;&#x4E0D;&#x4F1A;&#x5F71;&#x54CD;&#x5F02;&#x5E38;&#x539F;&#x56E0;&#x63A2;&#x67E5;&#x4EE5;&#x53CA;&#x4E1A;&#x52A1;&#x8FD0;&#x884C;&#xFF0C; &#x8FD9;&#x4E9B;&#x65E5;&#x5FD7;&#x8FD8;&#x5B58;&#x5728;&#x4E8E;&#x8FD0;&#x884C;&#x7684;&#x5404;&#x4E2A;&#x8282;&#x70B9;&#x4E4B;&#x4E0A;&#x3002;<br>&#xA0;&#xA0;3, App&#x5F02;&#x5E38;&#x9000;&#x51FA;&#xFF0C; &#x9700;&#x8981;&#x67E5;&#x660E;&#x5BFC;&#x81F4;App&#x5F02;&#x5E38;&#x9000;&#x51FA;&#x7684;&#x539F;&#x56E0;&#x3002;&#x8BE5;&#x65B9;&#x6848;&#x5C3D;&#x6700;&#x5927;&#x7684;&#x52AA;&#x529B;&#x6536;&#x96C6;App&#x9000;&#x51FA;&#x65F6;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#x6216;&#x8005;&#x521A;&#x9000;&#x51FA;&#x4E0D;&#x4E45;&#x7684;&#x5BB9;&#x5668;(Executor)&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x8FD9;&#x90E8;&#x5206;&#x65E5;&#x5FD7;&#x53EF;&#x4EE5;&#x8F85;&#x52A9;&#x67E5;&#x660E;App&#x9000;&#x51FA;&#x7684;&#x539F;&#x56E0;&#x3002;<br>&#xA0;&#xA0;<strong>&#x5F53;App AM&#x5F02;&#x5E38;&#x9000;&#x51FA;&#x800C;&#x91CD;&#x65B0;&#x542F;&#x52A8;&#x65F6;&#xFF0C;&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x7531;&#x4E8E;token&#x8FC7;&#x671F;&#x800C;&#x5BFC;&#x81F4;AM&#x91CD;&#x542F;&#x5931;&#x8D25;</strong><br>&#x8FD9;&#x548C;&#x8BE5;&#x65B9;&#x6848;&#x5176;&#x5B9E;&#x6CA1;&#x4EC0;&#x4E48;&#x5173;&#x7CFB;&#x3002;&#x5373;&#x4F7F;&#x6CA1;&#x6709;&#x8BE5;&#x65B9;&#x6848;&#xFF0C;&#x5F53;AM&#x91CD;&#x542F;&#x65F6;&#xFF0C;&#x540C;&#x6837;&#x7684;&#x9519;&#x8BEF;&#x8FD8;&#x662F;&#x4F1A;&#x53D1;&#x751F;&#x3002; &#x8FD9;&#x4E5F;&#x662F;&#x8BE5;&#x65B9;&#x6848;&#x7684;&#x4E00;&#x4E2A;&#x5C40;&#x9650;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6848;&#x5176;&#x672C;&#x8D28;&#x5728;&#x4E8E;&#x89E3;&#x51B3;App&#x9000;&#x51FA;&#x65F6;&#xFF0C;NM&#x7531;&#x4E8E;dt&#x5931;&#x6548;&#x800C;&#x5BFC;&#x81F4;&#x5F52;&#x6863;&#x65E5;&#x5FD7;&#x5931;&#x8D25;&#x8FD9;&#x4E00;&#x95EE;&#x9898;&#x57DF;&#x3002;&#x5E76;&#x672A;&#x7275;&#x6D89;&#x5230;&#x66F4;&#x591A;&#x7684;yarn&#x5BB9;&#x9519;&#x7EC6;&#x8282;&#x3002;</p>
</div></article></li></ul><div class="paginator"><a href="page/2/" class="next"><span>Next</span><i class="iconfont icon-right"></i></a></div></section><footer><div class="social"><a href="mailto:dengzhhu653@163.com" title="email" class="iconfont icon-email"></a><a href="https://github.com/dengzhhu653" title="github" class="iconfont icon-github"></a><a href="/atom.xml" title="rss" class="iconfont icon-rss"></a></div><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2017<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Zhihua Deng</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>