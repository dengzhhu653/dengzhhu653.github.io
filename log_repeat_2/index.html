<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Zhihua Deng"><meta name="description" content="&amp;#x89E3;&amp;#x51B3;&amp;#x601D;&amp;#x8DEF;&amp;#x53CA;&amp;#x65B9;&amp;#x6848;&amp;#x4ECE;&amp;#x7B2C;&amp;#x4E00;&amp;#x7BC7;&amp;#x6587;&amp;#x7AE0;&amp;#x4E2D;&amp;#xFF0C;&amp;#x6211;&amp;#x4EEC;&amp;"><meta name="keywords" content=""><title>HDFS 日志刷屏问题探究（2） · null</title><link rel="icon" href="../favicon.ico"><link rel="canonical" href="https://dengzhhu653.github.io/log_repeat_2/"><link rel="alternate" href="../atom.xml" title="null"><link rel="stylesheet" href="../fonts/iconfont/iconfont.css"><link rel="stylesheet" href="../css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?Your baidu Analytics ID";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'Your Google Analytics ID', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="../." class="logo"></a><ul class="nav"><li class="nav-link"><a href="/archives/" target="_self">归档</a></li><li class="nav-link"><a href="/about/" target="_self">关于</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">HDFS 日志刷屏问题探究（2）</h1><span class="post-time">Sep 24, 2017</span><div id="sidebar" class="post-sidebar"><h3 class="heading">目录</h3><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#解决思路及方案"><span class="toc-text">解决思路及方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决方案"><span class="toc-text">解决方案</span></a></li></ol></div><div class="post-content"><h3 id="&#x89E3;&#x51B3;&#x601D;&#x8DEF;&#x53CA;&#x65B9;&#x6848;"><a href="#&#x89E3;&#x51B3;&#x601D;&#x8DEF;&#x53CA;&#x65B9;&#x6848;" class="headerlink" title="&#x89E3;&#x51B3;&#x601D;&#x8DEF;&#x53CA;&#x65B9;&#x6848;"></a>&#x89E3;&#x51B3;&#x601D;&#x8DEF;&#x53CA;&#x65B9;&#x6848;</h3><p>   &#x4ECE;&#x7B2C;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4E0D;&#x65AD;&#x590D;&#x73B0;&#x95EE;&#x9898;&#xFF0C;&#x5206;&#x6790;&#x65E5;&#x5FD7;&#x548C;&#x6E90;&#x7801;&#xFF0C;&#x589E;&#x52A0;&#x65E5;&#x5FD7;&#x7684;&#x4E30;&#x5BCC;&#x6027;&#xFF0C;&#x4E0D;&#x65AD;&#x7F29;&#x5C0F;&#x95EE;&#x9898;&#x53EF;&#x80FD;&#x7684;&#x8303;&#x56F4;&#xFF0C;&#x8FD9;&#x7BC7;&#x6587;&#x4EF6;&#x5C06;&#x7EE7;&#x7EED;&#x8BB0;&#x5F55;&#x5206;&#x6790;&#x95EE;&#x9898;&#x7684;&#x8FC7;&#x7A0B;&#x4EE5;&#x53CA;&#x89E3;&#x51B3;&#x601D;&#x8DEF;&#x3002;<br>   &#x4E0A;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x672B;&#x5C3E;&#x4E2D;&#x5931;&#x8D25;&#x7684;&#x5047;&#x8BBE;&#x5E76;&#x975E;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x5F71;&#x54CD;&#xFF0C;&#x5728;&#x786E;&#x5B9A;DFSInputStream&#x7684;pos&#x53EF;&#x80FD;&#x4F1A;&#x5F71;&#x54CD;&#x8FDE;&#x63A5;&#x91CD;&#x5EFA;&#x540E;&#xFF0C;&#x5728;DFSInputStream#seek(long position)&#x4E0A;&#x52A0;&#x4E0A;&#x4E00;&#x4E9B;LOG&#x65E5;&#x5FD7;,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">if (pos &gt; targetPos) {</div><div class="line">   DFSClient.LOG.info(dfsClient.getClientName() + &quot; seek &quot; + getCurrentDatanode() + &quot; for &quot; + getCurrentBlock() +</div><div class="line">     &quot;. pos: &quot; + pos + &quot;, targetPos: &quot; + targetPos);</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x5F53;&#x7528;&#x6237;&#x8981;seek&#x7684;&#x6D41;&#x4F4D;&#x7F6E;&#x5C0F;&#x4E8E;&#x5F53;&#x524D;&#x6D41;&#x5DF2;&#x88AB;&#x8BFB;&#x53D6;&#x7684;&#x4F4D;&#x7F6E;&#x65F6;(&#x6B64;&#x65F6;&#x8F93;&#x5165;&#x6D41;&#x5DF2;&#x88AB;&#x8D85;&#x524D;&#x8BFB;)&#xFF0C; DFSInputStream&#x7684;seek&#x65B9;&#x6CD5;&#x4F1A;&#x5C06; blockEnd &#x7F6E;&#x6210; &#xFF0D;1&#xFF1B;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">if (!done) {</div><div class="line">  pos = targetPos;</div><div class="line">  blockEnd = -1;</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x7528;&#x6237;&#x8C03;&#x7528;read&#x65B9;&#x6CD5;&#x4ECE;&#x6D41;&#x4E2D;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x65F6;&#xFF0C; &#x7B26;&#x5408;&#x91CD;&#x65B0;&#x9009;&#x53D6;DataNode&#x7684;&#x6761;&#x4EF6;: pos &gt; blockEnd,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">if (pos &gt; blockEnd || currentNode == null) {</div><div class="line">  currentNode = blockSeekTo(pos);</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x63A5;&#x7740;&#xFF0C;&#x6839;&#x636E;&#x9009;&#x62E9;DataNode&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x91CD;&#x65B0;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;reader&#xFF0C; &#x5728;&#x8FD9;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x52A0;&#x5165;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#x89C2;&#x5BDF;&#x8FDE;&#x63A5;&#xFF1A;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if (getCurrentDatanode()!= null &amp;&amp; getCurrentDatanode() == chosenNode) {</div><div class="line">    DFSClient.LOG.info(dfsClient.getClientName() + &quot; close current block reader for &quot; + getCurrentBlock().getBlockId() + &quot; stored in &quot; +</div><div class="line">      getCurrentDatanode() + &quot;, a new  block reader for &quot; + targetBlock.getBlock().getBlockId() + &quot; stored in &quot; +</div><div class="line">      chosenNode + &quot; is created. pos =&quot; + target);</div><div class="line"> }</div></pre></td></tr></table></figure></p>
<p>&#x5373;&#xFF1A;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x8BFB;&#x8BF7;&#x6C42;&#x5728;&#x8F93;&#x5165;&#x6D41;&#x4E2D;&#x8BFB;&#x53D6;&#x7684;&#x5F00;&#x59CB;&#x4F4D;&#x7F6E;(seek)&#x5C0F;&#x4E8E;&#x8BE5;&#x6D41;&#x5DF2;&#x88AB;&#x8BFB;&#x53D6;&#x7684;&#x5B57;&#x8282;&#x6570;&#x65F6;&#xFF0C;&#x8BE5;&#x6D41;&#x5BF9;&#x5E94;&#x7684;&#x8FDE;&#x63A5;&#x4F1A;&#x88AB;&#x5173;&#x95ED;&#x6389;&#xFF0C;&#x91CD;&#x65B0;&#x65B0;&#x5EFA;&#x4E00;&#x6761;&#x8FDE;&#x63A5;&#x3002;&#x800C;&#x5728;DataNode&#x4E2D;&#x8BA4;&#x4E3A;&#x65E7;&#x7684;&#x8FDE;&#x63A5;&#x6240;&#x5BF9;&#x5E94;&#x7684;&#x8BF7;&#x6C42;&#x6570;&#x636E;&#x8FD8;&#x672A;&#x88AB;&#x5B8C;&#x5168;&#x5199;&#x5B8C;&#xFF0C;&#x5F53;&#x5F80;&#x4E00;&#x6761;&#x88AB;&#x5BA2;&#x6237;&#x7AEF;&#x5173;&#x95ED;&#x7684;&#x8FDE;&#x63A5;&#x7EE7;&#x7EED;&#x5199;&#x5165;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x5219;&#x629B;&#x51FA;IOException: Connection reset by peer&#x7684;&#x5F02;&#x5E38;&#x3002; &#x5F53;&#x8FDE;&#x7EED;&#x51FA;&#x73B0;&#x8FD9;&#x6837;&#x7684;&#x95EE;&#x9898;&#x65F6;&#xFF0C;&#x5219;&#x51FA;&#x73B0;DataNode&#x9891;&#x7E41;&#x5199;&#x51FA;&#x201D;datanode.VolumeScanner: VolumeScanner(xxx) Not scheduling suspect block $block for rescanning, because we rescanned it recently.&#x201C;&#x7684;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#x3002;<br>&#x52A0;&#x5165;&#x8FD9;&#x4E9B;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#xFF0C;&#x91CD;&#x542F;&#x4E00;&#x53F0;RegionServer&#x4E4B;&#x540E;&#xFF0C;&#x5728;RegionServer&#x7684;&#x65E5;&#x5FD7;&#x4E2D;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x4EE5;&#x4E0B;&#x65E5;&#x5FD7;&#xFF1A;</p>
<pre>
2016-07-10 21:31:42,147 INFO  [B.defaultRpcServer.handler=22,queue=1,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 111506876, targetPos: 111506843
2016-07-10 21:31:42,715 INFO  [B.defaultRpcServer.handler=25,queue=1,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 113544644, targetPos: 113544611
2016-07-10 21:31:43,341 INFO  [B.defaultRpcServer.handler=27,queue=0,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 115547269, targetPos: 115547236
2016-07-10 21:31:43,950 INFO  [B.defaultRpcServer.handler=16,queue=1,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 117532235, targetPos: 117532202
2016-07-10 21:31:43,988 INFO  [B.defaultRpcServer.handler=7,queue=1,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 119567867, targetPos: 119567834
2016-07-10 21:31:45,228 INFO  [B.defaultRpcServer.handler=19,queue=1,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 121787264, targetPos: 121787231
2016-07-10 21:31:45,254 INFO  [B.defaultRpcServer.handler=0,queue=0,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 123910032, targetPos: 123909999
2016-07-10 21:31:46,402 INFO  [B.defaultRpcServer.handler=26,queue=2,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 125905163, targetPos: 125905130
2016-07-10 21:31:47,027 INFO  [B.defaultRpcServer.handler=24,queue=0,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 128028947, targetPos: 128028914
2016-07-10 21:31:47,649 INFO  [B.defaultRpcServer.handler=10,queue=1,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 seek DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] for BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143. pos: 130057763, targetPos: 130057730
</pre>

<p>DataNode&#x7684;&#x65E5;&#x5FD7;&#xFF1A;</p>
<pre>
DataNode&#x65E5;&#x5FD7;&#xFF1A;
2016-07-10 21:31:34,263 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55243, bytes: 2555904, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 82832384, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 1083375057
2016-07-10 21:31:35,080 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55248, bytes: 3080192, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 84848128, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 815747374
2016-07-10 21:31:36,197 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55256, bytes: 3080192, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 88945152, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 1090853556
2016-07-10 21:31:36,223 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55263, bytes: 2293760, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 91109888, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 25682183
2016-07-10 21:31:38,693 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55272, bytes: 2949120, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 97212928, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 1184669690
2016-07-10 21:31:38,718 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55278, bytes: 2424832, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 99258880, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 25330867
2016-07-10 21:31:41,033 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55296, bytes: 2686976, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 107441152, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 30907800
attractive feature
2016-07-10 21:31:43,343 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55304, bytes: 2621440, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 113544192, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 625555154
2016-07-10 21:31:43,953 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55309, bytes: 2752512, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 115547136, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 608916868
2016-07-10 21:31:45,230 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55316, bytes: 2949120, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 119567360, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 1239121220
2016-07-10 21:31:47,679 DEBUG org.apache.hadoop.hdfs.server.datanode.DataNode.clienttrace: src: /10.130.1.29:50010, dest: /10.130.1.28:55338, bytes: 2490368, op: HDFS_READ, cliID: DFSClient_NONMAPREDUCE_1984924661_1, offset: 130057728, srvID: f3d795cc-2b3b-43b9-90c3-e4157c031d2c, blockid: BP-360285305-10.130.1.11-1444619256876:blk_1109360829_35627143, duration: 26523774
</pre>
&#x7531;hbase&#x4E0E;DataNode&#x4E2D;&#x7684;clientId&#x53EF;&#x4EE5;&#x786E;&#x5B9A;&#x5728;&#x8FD9;&#x7247;&#x65E5;&#x5FD7;&#x4E2D;&#x8BE5;DataNode&#x4E2D;&#x8BFB;&#x8BF7;&#x6C42;&#x6765;&#x81EA;regionserver&#x3002;&#x5728;DataNode&#x4E2D;&#x6839;&#x636E;&#x65E5;&#x5FD7;&#x8F93;&#x51FA;&#x7684;&#x65F6;&#x95F4; &#x52A0;&#x4E0A;&#x65E5;&#x5FD7;&#x4E2D;duration&#x7684;&#x503C;&#xFF0C;&#x53EF;&#x4EE5;&#x786E;&#x5B9A;DataNode&#x6536;&#x5230;&#x8BFB;&#x8BF7;&#x6C42;&#x7684;&#x65F6;&#x95F4;&#x3002;&#x5728;hbase&#x7684;&#x65E5;&#x5FD7;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x65B0;&#x65E7;&#x8FDE;&#x63A5;&#x521B;&#x5EFA;&#x7684;&#x8FC7;&#x7A0B;&#xFF1A;
2016-07-10 21:31:47,649 INFO  [B.defaultRpcServer.handler=10,queue=1,port=16020] hdfs.DFSClient: DFSClient_NONMAPREDUCE_1984924661_1 close current block reader for 1109360829 stored in DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK], a new  block reader for 1109360829 stored in DatanodeInfoWithStorage[10.130.1.29:50010,DS-086bc494-d862-470c-86e8-9cb7929985c6,DISK] is created. pos =130057730

&#x7ED3;&#x679C;&#x8BBA;&#x8BC1;&#x4E86;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x7684;&#x5047;&#x8BBE;&#xFF0C;&#x65E5;&#x5FD7;&#x5927;&#x91CF;&#x5237;&#x5C4F;&#x7684;&#x539F;&#x56E0;&#x662F;&#x7531;&#x4E8E;RegionServer&#x8BFB;&#x53D6;HFile&#x6587;&#x4EF6;&#x5BFC;&#x81F4;&#x7684;&#x3002; &#x5728;HBase&#x96C6;&#x7FA4;&#x4E0A;&#xFF0C;&#x6709;&#x4E00;&#x4E9B;Scan&#x64CD;&#x4F5C;&#x53EF;&#x80FD;&#x662F;&#x5BFC;&#x81F4;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x7684;&#x4E3B;&#x56E0;&#x3002; &#x90A3;&#x4E48;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x662F;&#x5982;&#x4F55;&#x5F15;&#x8D77;&#x7684;&#x5462;&#xFF1F;

&#x91CD;&#x65B0;&#x5728;&#x5206;&#x6790;&#x4E00;&#x4E0B;&#x4E0A;&#x9762;&#x7684;HBase&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;pos&#x548C;targetPos&#x4E24;&#x4E2A;&#x72B6;&#x6001;&#x7684;&#x4E00;&#x4E9B;&#x89C4;&#x5F8B;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#xFF1A;<strong>pos - targetPos = 33</strong>, &#x5206;&#x6790;HBase&#x6E90;&#x7801;(HFileBlock)&#x53EF;&#x77E5;, 33&#x5B57;&#x8282;&#x5927;&#x5C0F;&#x7684;&#x957F;&#x5EA6;&#x7B49;&#x4E8E;&#x4E00;&#x4E2A;HFileBlock header&#x7684;&#x957F;&#x5EA6;&#xFF0C;&#x5728;33&#x4E2A;&#x5B57;&#x8282;&#x7684;&#x4FE1;&#x606F;&#x4E2D;&#xFF0C;&#x7EF4;&#x62A4;&#x4E86;HFileBlock onDiskSize&#x7B49;&#x4E00;&#x4E9B;&#x4FE1;&#x606F;&#x3002;&#x5F53;&#x8BFB;&#x53D6;&#x5F53;&#x524D;&#x7684;block&#x4FE1;&#x606F;&#x65F6;&#xFF0C;HBase&#x53EF;&#x4EE5;&#x9884;&#x5148;&#x8BFB;&#x53D6;&#x4E0B;&#x4E00;&#x5757;&#x7684;&#x5934;&#x4FE1;&#x606F;&#xFF0C;&#x8FD9;&#x6837;&#x53EF;&#x4EE5;&#x51CF;&#x5C11;&#x4E00;&#x4E9B;IO&#x64CD;&#x4F5C;&#xFF0C;&#x63D0;&#x9AD8;RegionServer&#x7684;&#x8BFB;&#x6027;&#x80FD;&#x3002;<br>
&#x5728;hbase&#x7684; HFileBlock#readAtOffset&#x7684;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x5728;&#x5728;&#x6D41;&#x4E2D;&#x6267;&#x884C;seek&#x64CD;&#x4F5C;&#xFF0C;&#x7136;&#x540E;&#x5728;read&#xFF1A;

<pre>
protected int readAtOffset(FSDataInputStream istream,
                                          byte[] dest, int destOffset, int size,
                                           boolean peekIntoNextBlock, long fileOffset, boolean pread) throws IOException {

    ...
    if (!pread &amp;&amp; streamLock.tryLock()) {
       // Seek + read. Better for scanning.
       try {
         istream.seek(fileOffset);
        }
         // Try to read the next block header.
         if (!readWithExtra(istream, dest, destOffset, size, hdrSize))
           return -1;
         } finally {
           streamLock.unlock();
         }
       ...
    }
</pre>

<p>&#x8FD9;&#x6837;&#x4ECD;&#x7136;&#x8BF4;&#x670D;&#x4E0D;&#x4E86;&#xFF0C; &#x5728;&#x5206;&#x6790;&#x4E00;&#x4E0B;HBase RegionServer&#x4E2D;&#x7684;&#x65E5;&#x5FD7;(&#x8FD9;&#x4E2A;&#x5728;&#x6CA1;&#x6709;&#x5177;&#x4F53;&#x601D;&#x8DEF;&#x7684;&#x65F6;&#x5019;&#x53D1;&#x73B0;&#x7684;), &#x53D1;&#x73B0;&#x8FD9;&#x4E9B;&#x65E5;&#x5FD7;&#x7684;&#x7EBF;&#x7A0B;&#x662F;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#xFF0C;</p>
<p><pre><br> [B.defaultRpcServer.handler=22,queue=1,port=16020]<br> [B.defaultRpcServer.handler=25,queue=1,port=16020]<br> &#x2026;<br></pre><br>&#x5728;HFileBlock#FsReader&#x4E2D;&#xFF0C;&#x9884;&#x8BFB;&#x53D6;&#x7684;33&#x4E2A;&#x5B57;&#x8282;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;HFileBlock&#x7684;&#x5934;&#x4FE1;&#x606F;&#x7F13;&#x5B58;&#x5728;&#x4E00;&#x4E2A;ThreadLocal&#x7684;&#x7F13;&#x5B58;&#x4E2D;&#xFF0C;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">PrefetchedHeader prefetchedHeader =&#xA0;prefetchedHeaderForThread.get();</div><div class="line">ByteBuffer&#xA0;headerBuf = prefetchedHeader.offset&#xA0;== offset? prefetchedHeader.buf:&#xA0;null;</div></pre></td></tr></table></figure></p>
<p>&#x5728;&#x8FDB;&#x884C;&#x8BFB;block&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x9996;&#x5148;&#x4ECE;ThreadLocal&#x4E2D;&#x53D6;&#x51FA;&#x4E0A;&#x4E00;&#x6B21;&#x9884;&#x8BFB;&#x7684;block&#x5934;&#x4FE1;&#x606F;&#x3002; &#x6839;&#x636E;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#xFF0C;&#x8FD9;&#x4E9B;&#x64CD;&#x4F5C;&#x53EF;&#x80FD;&#x5728;&#x4E0D;&#x540C;&#x7684;&#x7EBF;&#x7A0B;&#x4E0A;&#x8FD0;&#x884C;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF1A;</p>
<p><pre><br>   A&#x7EBF;&#x7A0B;&#x9884;&#x8BFB;&#x4E86;&#x4E0B;&#x4E00;&#x4E2A;block blk&#x7684;&#x5934;&#x4FE1;&#x606F;&#xFF0C;<br>   B&#x7EBF;&#x7A0B;&#x4ECE;threadlocal&#x4E2D;&#x53D6;&#x51FA;&#x5934;&#x4FE1;&#x606F;&#xFF0C;&#x7531;&#x4E8E;B&#x7EBF;&#x7A0B;&#x7684;prefetchedHeader.offset &#xFF1D; &#xFF0D;1&#xFF0C; &#x6B64;&#x65F6;prefetchedHeader.offset == offset &#x7B49;&#x5F0F;&#x4E0D;&#x6210;&#x7ACB;&#xFF0C; &#x56E0;&#x6B64;&#x6B64;&#x6B21;&#x64CD;&#x4F5C;&#x9700;&#x8981;&#x8BFB;&#x53D6;blk&#x7684;&#x5934;&#x4FE1;&#x606F;&#x3002;<br>   &#x540C;&#x4E00;&#x4E2A;&#x8F93;&#x5165;&#x6D41;&#x5728;&#x5E95;&#x5C42;&#x5B9E;&#x73B0;&#x4E0A;,&#x7531;&#x4E8E;&#x9884;&#x8BFB;&#x4E86;blk&#x7684;&#x5934;&#x4FE1;&#x606F;&#x3002;&#x56E0;&#x6B64;&#xFF0C; &#x6B64;&#x65F6;&#x51FA;&#x73B0; pos &gt; targetPos&#x7684;&#x73B0;&#x8C61;, &#x4E14;&#x5DEE;&#x503C;&#x6070;&#x597D;&#x4E3A;33&#x3002;<br>&#x4E8E;&#x662F;&#x51FA;&#x73B0;&#x4E86;&#x7C7B;&#x4F3C;&#x4E8E;&#x6587;&#x4E2D;&#x63CF;&#x8FF0;&#x7684;&#x73B0;&#x8C61;&#x3002;<br></pre></p>
<h3 id="&#x89E3;&#x51B3;&#x65B9;&#x6848;"><a href="#&#x89E3;&#x51B3;&#x65B9;&#x6848;" class="headerlink" title="&#x89E3;&#x51B3;&#x65B9;&#x6848;"></a>&#x89E3;&#x51B3;&#x65B9;&#x6848;</h3><p>&#x4E00;&#x4E9B;&#x63CF;&#x8FF0;&#x548C;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x53EF;&#x89C1;<a href="https://issues.apache.org/jira/browse/HBASE-16212" target="_blank" rel="external">HBASE-16212</a>&#x3002;</p>
</div></article><div class="tags"></div><div class="paginator"><a href="../hive_issues/" class="prev"><i class="iconfont icon-left"></i><span> 上一页</span></a><a href="../hdfs_log_repeat/" class="next"><span>下一页</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div id="disqus_thread"></div></section><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://dengzhhu653.github.io/log_repeat_2/';
    this.page.identifier = 'log_repeat_2/';
    this.page.title = 'HDFS 日志刷屏问题探究（2）';
};
(function() {
var d = document, s = d.createElement('script');

s.src = '//dengzhhu653.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();</script></section><footer><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2018<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Zhihua Deng</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>