<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Zhihua Deng"><meta name="description" content="&amp;#x73B0;&amp;#x8C61;&amp;#x5F53;&amp;#x6211;&amp;#x4EEC;&amp;#x9700;&amp;#x8981;&amp;#x91CD;&amp;#x542F;&amp;#x4E00;&amp;#x53F0;&amp;#x5DF2;&amp;#x7ECF;&amp;#x9000;&amp;#x51FA;&amp;#x7684;NameNode&amp;#xF"><meta name="keywords" content=""><title>StandBy NameNode启动失败原因分析 · null</title><link rel="icon" href="../favicon.ico"><link rel="canonical" href="https://dengzhhu653.github.io/namenode-blockreport-storm/"><link rel="alternate" href="../atom.xml" title="null"><link rel="stylesheet" href="../fonts/iconfont/iconfont.css"><link rel="stylesheet" href="../css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?Your baidu Analytics ID";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'Your Google Analytics ID', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="../." class="logo"></a><ul class="nav"><li class="nav-link"><a href="/archives/" target="_self">归档</a></li><li class="nav-link"><a href="/about/" target="_self">关于</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">StandBy NameNode启动失败原因分析</h1><span class="post-time">Sep 14, 2016</span><div id="sidebar" class="post-sidebar"><h3 class="heading">目录</h3><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#现象"><span class="toc-text">现象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分析"><span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NN处理blockreport逻辑问题"><span class="toc-text">NN处理blockreport逻辑问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NN启动后IPC超时"><span class="toc-text">NN启动后IPC超时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NameNode内存开销分析"><span class="toc-text">NameNode内存开销分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决方案"><span class="toc-text">解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其他"><span class="toc-text">其他</span></a></li></ol></div><div class="post-content"><h3 id="&#x73B0;&#x8C61;"><a href="#&#x73B0;&#x8C61;" class="headerlink" title="&#x73B0;&#x8C61;"></a>&#x73B0;&#x8C61;</h3><p>&#x5F53;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x91CD;&#x542F;&#x4E00;&#x53F0;&#x5DF2;&#x7ECF;&#x9000;&#x51FA;&#x7684;NameNode&#xFF0C;&#x53D1;&#x73B0;NameNode&#x957F;&#x65F6;&#x95F4;&#x5904;&#x4E8E;Safemode&#x72B6;&#x6001;&#xFF0C;&#x76F4;&#x5230;NameNode&#x518D;&#x6B21;&#x5F02;&#x5E38;&#x9000;&#x51FA;&#xFF0C;&#x65E0;&#x6CD5;&#x5C06;NameNode&#x53D8;&#x6210;&#x4E00;&#x4E2A;&#x6B63;&#x5E38;&#x7684;StandBy NameNode&#x3002;</p>
<h3 id="&#x5206;&#x6790;"><a href="#&#x5206;&#x6790;" class="headerlink" title="&#x5206;&#x6790;"></a>&#x5206;&#x6790;</h3><p>&#x7ECF;&#x8FC7;&#x5206;&#x6790;,&#x8BA4;&#x4E3A;SBN&#x542F;&#x52A8;&#x7F13;&#x6162;&#x95EE;&#x9898;&#x4E3B;&#x8981;&#x6709;&#x4EE5;&#x4E0B;2&#x4E2A;&#x95EE;&#x9898;&#x5BFC;&#x81F4;&#xFF0C;&#x5206;&#x522B;&#x662F;:</p>
<p><li>NN&#x5904;&#x7406;DataNode&#x7684;blockreport&#x903B;&#x8F91;&#x95EE;&#x9898;&#xFF1B;</li></p>
<p><li>&#x542F;&#x52A8;&#x540E;NN&#x7531;&#x4E8E;&#x5927;&#x91CF;&#x7684;DateNode&#x7684;blockReport&#x8BF7;&#x6C42;&#xFF0C;&#x9020;&#x6210;&#x6709;&#x4E9B;&#x4E0D;&#x80FD;&#x53CA;&#x65F6;&#x5904;&#x7406;&#xFF0C;&#x5BFC;&#x81F4;&#x65E0;&#x6CD5;&#x54CD;&#x5E94;&#x7528;&#x6237;&#x548C;DataNode&#x8BF7;&#x6C42;&#x3002;</li></p>
<p><li>&#x5927;&#x91CF;BlockReport&#x65E5;&#x5FD7;&#x5728;&#x5176;&#x72EC;&#x5360;&#x9501;&#x5185;&#x8F93;&#x51FA;&#xFF0C;&#x5F71;&#x54CD;&#x8BE5;&#x9501;&#x91CA;&#x653E;&#x7684;&#x901F;&#x7387;&#xFF0C;&#x8FDF;&#x6EDE;&#x5176;&#x4ED6;BlockReport&#x7684;&#x5904;&#x7406;&#xFF0C;&#x540C;&#x65F6;&#x7701;&#x53BB;&#x5728;standbyNN &#x5904;&#x7406;BlockReport&#x65F6;&#x68C0;&#x6D4B;&#x4E0D;&#x5408;&#x6CD5;&#x5757;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x52A0;&#x5FEB;BlockReport&#x7684;&#x5904;&#x7406;&#x901F;&#x5EA6;&#x3002;</li></p>
<p><li>&#x5185;&#x5B58;&#x5F00;&#x9500;&#x3001;gc&#x9891;&#x7E41;&#x95EE;&#x9898;&#x3002;<br>&#x5176;&#x4E2D;&#xFF0C;&#x5C24;&#x5176;&#x662F;&#x7B2C;&#x4E8C;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x5927;&#x91CF;&#x7684;BlockReport&#x8BF7;&#x6C42;&#x8017;&#x5C3D;&#x4E86;NN server&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x7684;&#x7EBF;&#x7A0B;&#x8D44;&#x6E90;&#x3001;&#x8FD9;&#x5BFC;&#x81F4;NN Server&#x4E0D;&#x80FD;&#x53CA;&#x65F6;&#x5730;&#x5904;&#x7406;DataNode&#x7684;&#x5FC3;&#x8DF3;&#x548C;&#x8BE5;&#x8282;&#x70B9;(&#x6216;&#x5176;&#x4ED6;&#x8282;&#x70B9;)&#x7684;BlockReport&#xFF0C;&#x76F4;&#x63A5;&#x5BFC;&#x81F4;&#x8BE5;&#x8282;&#x70B9;&#x6B63;&#x7B49;&#x5F85;&#x88AB;NN Server&#x5904;&#x7406;&#x7684;BlockReport&#x88AB;Client&#xFF08;&#x5373;&#x8BE5;&#x8282;&#x70B9;&#xFF09;&#x8D85;&#x65F6;&#x5904;&#x7406;&#xFF0C;&#x8BE5;Client&#x5C06;&#x4F1A;&#x91CD;&#x65B0;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x65B0;&#x7684;BlockReport&#x8BF7;&#x6C42;&#xFF0C;&#x8FD9;&#x65E0;&#x7591;&#x66F4;&#x52A0;&#x91CD;&#x4E86;NN Server&#x7684;&#x8D1F;&#x62C5;&#xFF1B;&#x540C;&#x65F6;&#x4E0D;&#x65AD;&#x7684;&#x63A5;&#x6536;BlockReport&#xFF0C;&#x5BFC;&#x81F4;NN &#x5185;&#x5B58;&#x5F00;&#x9500;&#x6301;&#x7EED;&#x589E;&#x957F;&#xFF0C;&#x800C;&#x8FC7;&#x5927;&#x7684;&#x5185;&#x5B58;&#x9700;&#x6C42;(&#x4E00;&#x4E2A;BlockReport long[]&#x5E73;&#x5747;&#x9700;&#x8981;18M&#x7684;&#x8FDE;&#x7EED;&#x5185;&#x5B58;&#x7A7A;&#x95F4;)&#x4EE5;&#x53CA;&#x6570;&#x636E;&#x5904;&#x7406;&#x9020;&#x6210;NN &#x8FDB;&#x7A0B;gc&#x9891;&#x7E41;&#x3002;</li></p>
<h4 id="NN&#x5904;&#x7406;blockreport&#x903B;&#x8F91;&#x95EE;&#x9898;"><a href="#NN&#x5904;&#x7406;blockreport&#x903B;&#x8F91;&#x95EE;&#x9898;" class="headerlink" title="NN&#x5904;&#x7406;blockreport&#x903B;&#x8F91;&#x95EE;&#x9898;"></a>NN&#x5904;&#x7406;blockreport&#x903B;&#x8F91;&#x95EE;&#x9898;</h4><p>&#x8BE5;&#x95EE;&#x9898;&#x5728;<a href="https://issues.apache.org/jira/browse/HDFS-7980&#x4E5F;&#x6709;&#x76F8;&#x5173;&#x7684;&#x63CF;&#x8FF0;&#xFF0C;&#x4ECE;&#x5BA2;&#x6237;&#x7AEF;&#x4E5F;&#x5C31;&#x662F;&#x96C6;&#x7FA4;&#x7684;DataNode&#x6765;&#x8BF4;&#xFF0C;&#x5F53;NN&#x91CD;&#x542F;&#x540E;&#xFF0C;DataNode&#x901A;&#x8FC7;&#x548C;NN&#x7684;&#x5FC3;&#x8DF3;&#x83B7;&#x5F97;&#x4E00;&#x4E2A;&#x5411;NN&#x6CE8;&#x518C;&#x7684;&#x6307;&#x4EE4;&#xFF0C;DataNode&#x6839;&#x636E;&#x8FD9;&#x4E2A;&#x4FE1;&#x606F;&#xFF0C;&#x5237;&#x65B0;&#x672C;&#x5730;&#x7F13;&#x5B58;&#x4E2D;&#x7684;&#x4E0A;&#x6B21;blockReport&#x7684;&#x7684;&#x65F6;&#x95F4;&#x503C;&#xFF0C;" target="_blank" rel="external">https://issues.apache.org/jira/browse/HDFS-7980&#x4E5F;&#x6709;&#x76F8;&#x5173;&#x7684;&#x63CF;&#x8FF0;&#xFF0C;&#x4ECE;&#x5BA2;&#x6237;&#x7AEF;&#x4E5F;&#x5C31;&#x662F;&#x96C6;&#x7FA4;&#x7684;DataNode&#x6765;&#x8BF4;&#xFF0C;&#x5F53;NN&#x91CD;&#x542F;&#x540E;&#xFF0C;DataNode&#x901A;&#x8FC7;&#x548C;NN&#x7684;&#x5FC3;&#x8DF3;&#x83B7;&#x5F97;&#x4E00;&#x4E2A;&#x5411;NN&#x6CE8;&#x518C;&#x7684;&#x6307;&#x4EE4;&#xFF0C;DataNode&#x6839;&#x636E;&#x8FD9;&#x4E2A;&#x4FE1;&#x606F;&#xFF0C;&#x5237;&#x65B0;&#x672C;&#x5730;&#x7F13;&#x5B58;&#x4E2D;&#x7684;&#x4E0A;&#x6B21;blockReport&#x7684;&#x7684;&#x65F6;&#x95F4;&#x503C;&#xFF0C;</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleBlockReport</span><span class="params">(<span class="keyword">long</span> delay)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (delay &gt; <span class="number">0</span>) { <span class="comment">// send BR after random delay</span></div><div class="line">      lastBlockReport = Time.now()</div><div class="line">      - ( dnConf.blockReportInterval - DFSUtil.getRandom().nextInt((<span class="keyword">int</span>)(delay)));</div><div class="line">    } <span class="keyword">else</span> { <span class="comment">// send at next heartbeat</span></div><div class="line">      lastBlockReport = lastHeartbeat - dnConf.blockReportInterval;</div><div class="line">    }</div><div class="line">    resetBlockReportTime = <span class="keyword">true</span>; <span class="comment">// reset future BRs for randomness</span></div><div class="line">  }</div></pre></td></tr></table></figure>
<p>&#x8FD9;&#x4E2A;delay&#x4E5F;&#x5C31;&#x662F;&#x914D;&#x7F6E;dfs.blockreport.initialDelay&#x7684;&#x503C;&#xFF0C;&#x9ED8;&#x8BA4;120s&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x96C6;&#x7FA4;&#x8303;&#x56F4;&#x5185;&#x7684;DataNode&#x4ECE;NN&#x542F;&#x52A8;&#x540E;120s&#x4E4B;&#x5185;&#x5411;NN&#x53D1;&#x9001;&#x4E00;&#x4E2A;blockReport.<br>&#x5728;&#x53D1;&#x9001;blockReport&#x65F6;&#xFF0C;DataNode&#x4F1A;&#x9996;&#x5148;&#x53D1;&#x9001;&#x4E00;&#x4E2A;IBR(Incremental Block Report)&#x62A5;&#x544A;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x53D1;&#x9001;&#x4E00;&#x4E2A;blockReport&#xFF0C;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function">List&lt;DatanodeCommand&gt; <span class="title">blockReport</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</div><div class="line">    <span class="comment">// send block report if timer has expired.</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">long</span> startTime = now();</div><div class="line">    <span class="keyword">if</span> (startTime - lastBlockReport &lt;= dnConf.blockReportInterval) {</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">final</span> ArrayList&lt;DatanodeCommand&gt; cmds = <span class="keyword">new</span> ArrayList&lt;DatanodeCommand&gt;();</div><div class="line"></div><div class="line">    <span class="comment">// Flush any block information that precedes the block report. Otherwise</span></div><div class="line">    <span class="comment">// we have a chance that we will miss the delHint information</span></div><div class="line">    <span class="comment">// or we will report an RBW replica after the BlockReport already reports</span></div><div class="line">    <span class="comment">// a FINALIZED one.</span></div><div class="line">    reportReceivedDeletedBlocks();</div><div class="line">    lastDeletedReport = startTime;</div><div class="line">    .........</div><div class="line">        <span class="comment">// Send the reports to the NN.</span></div><div class="line">    <span class="keyword">int</span> numReportsSent = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> numRPCs = <span class="number">0</span>;</div><div class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">long</span> brSendStartTime = now();</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">      <span class="keyword">if</span> (totalBlockCount &lt; dnConf.blockReportSplitThreshold) {</div><div class="line">        <span class="comment">// Below split threshold, send all reports in a single message.</span></div><div class="line">        DatanodeCommand cmd = bpNamenode.blockReport(</div><div class="line">            bpRegistration, bpos.getBlockPoolId(), reports);</div></pre></td></tr></table></figure>
<p> &#x5F53;&#x91CD;&#x542F;&#x540E;&#x7684;NN&#x54CD;&#x5E94;&#x7528;&#x6237;&#x7684;blockReport(BlockManager#processReport)&#x65F6;&#xFF0C;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (storageInfo.numBlocks() == <span class="number">0</span>) { </div><div class="line">       <span class="comment">// The first block report can be processed a lot more efficiently than</span></div><div class="line">       <span class="comment">// ordinary block reports.  This shortens restart times.</span></div><div class="line">       processFirstBlockReport(storageInfo, newReport);</div><div class="line">     } <span class="keyword">else</span> {</div><div class="line">       invalidatedBlocks = processReport(storageInfo, newReport);</div><div class="line">     }</div></pre></td></tr></table></figure>
<p>&#x67D0;&#x4E9B;DataNode&#x7684; storageInfo.numBlocks()==0&#x8FD9;&#x4E2A;&#x6761;&#x4EF6;&#x4E0D;&#x5728;&#x6210;&#x7ACB;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;DataNode&#x7684;IBR&#x7684;&#x62A5;&#x544A;&#x4F7F;&#x5F97;NN&#x8BB0;&#x5F55;&#x4E86;&#x76F8;&#x5E94;DataNode&#x7684;storage&#x4FE1;&#x606F;&#xFF0C;&#x4ECE;&#x800C;&#x4F7F;&#x5F97;NN&#x5904;&#x7406;blockReport&#x7684;&#x7A0B;&#x5E8F;&#x903B;&#x8F91;&#x8FDB;&#x5165;&#x5230;else&#x8FD9;&#x4E00;&#x5206;&#x652F;&#x4E0A;&#xFF1A;<br>   <center> invalidatedBlocks = processReport(storageInfo, newReport); </center></p>
<p> processReport&#x548C;processFirstBlockReport&#x5904;&#x7406;&#x6700;&#x5927;&#x7684;&#x4E0D;&#x540C;&#x662F;&#xFF1A; processReport&#x9700;&#x8981;&#x5C06;DataNode&#x6C47;&#x62A5;&#x4E0A;&#x6765;&#x7684;storage&#x5B58;&#x50A8;&#x7684;&#x5757;&#x4FE1;&#x606F;&#x4E0E;NN&#x4E0A;&#x7F13;&#x5B58;&#x7684;&#x8BE5;DataNode&#x7684;&#x5757;&#x4FE1;&#x606F;&#x8FDB;&#x884C;&#x6BD4;&#x5BF9;&#xFF0C;&#x627E;&#x51FA;&#x4E0D;&#x540C;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x8FD9;&#x91CC;&#x6D89;&#x53CA;&#x5230;&#x5757;&#x7684;&#x589E;&#x5220;&#x6539;&#x7B49;&#x4FE1;&#x606F;&#xFF0C;&#x7136;&#x540E;&#x6839;&#x636E;&#x5177;&#x4F53;&#x7684;&#x60C5;&#x51B5;&#x901A;&#x8FC7;&#x8BE5;blockReport&#x5237;&#x65B0;NN&#x7F13;&#x5B58;&#x7684;DataNode&#x7684;&#x5B58;&#x50A8;&#x7684;&#x5757;&#x4FE1;&#x606F;&#x3002;&#x5BF9;&#x4E8E;&#x91CD;&#x542F;&#x7684;NN&#x6765;&#x8BF4;&#xFF0C;&#x5176;&#x672C;&#x8EAB;&#x5E76;&#x6CA1;&#x6709;&#x7F13;&#x5B58;&#x6709;&#x96C6;&#x7FA4;&#x5185;DataNode&#x7684;&#x5757;&#x8BB0;&#x5F55;&#x60C5;&#x51B5;&#xFF0C;DataNode&#x4E0A;&#x62A5;&#x7684;blockReport&#x5DF2;&#x7ECF;&#x662F;&#x8BE5;DataNode&#x76EE;&#x524D;&#x6700;&#x65B0;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x56E0;&#x800C;&#x5728;processFirstBlockReport&#x65B9;&#x6CD5;&#x5185;&#x7F3A;&#x5C11;&#x4E86;&#x6BD4;&#x5BF9;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;NN&#x53EA;&#x662F;&#x6839;&#x636E;&#x8FD9;&#x4E2A;&#x62A5;&#x544A;&#x548C;&#x6709;&#x5173;&#x7684;IBR&#x91CD;&#x5EFA;NN&#x5173;&#x4E8E;&#x8BE5;DataNode&#x7684;&#x6700;&#x65B0;&#x7684;&#x5757;&#x8BB0;&#x5F55;&#x3002;</p>
<p>   &#x7EFC;&#x4E0A;&#x6240;&#x8FF0;&#xFF0C;&#x5728;NN&#x91CD;&#x542F;&#x540E;&#xFF0C;&#x5E94;&#x8BE5;&#x8BA9;NN&#x5904;&#x7406;blockReport&#x7684;&#x903B;&#x8F91;&#x8FDB;&#x5165;&#x5230;if&#x5206;&#x652F;&#x4E0A;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5C06;&#x5904;&#x7406;&#x903B;&#x8F91;&#x4EA4;&#x7ED9;processFirstBlockReport&#xFF0C;&#x5B9E;&#x73B0;&#x7F29;&#x77ED;NN&#x91CD;&#x542F;&#x65F6;&#x95F4;&#x3002;</p>
<h4 id="NN&#x542F;&#x52A8;&#x540E;IPC&#x8D85;&#x65F6;"><a href="#NN&#x542F;&#x52A8;&#x540E;IPC&#x8D85;&#x65F6;" class="headerlink" title="NN&#x542F;&#x52A8;&#x540E;IPC&#x8D85;&#x65F6;"></a>NN&#x542F;&#x52A8;&#x540E;IPC&#x8D85;&#x65F6;</h4><p>&#x5F53;NN&#x79BB;&#x5F00;safemode&#x4E4B;&#x540E;&#xFF0C;&#x53D1;&#x73B0;NN&#x4ECD;&#x7136;&#x96BE;&#x4EE5;&#x54CD;&#x5E94;&#x7528;&#x6237;&#x8BF7;&#x6C42;&#x548C;&#x8FDB;&#x7A0B;&#x9891;&#x7E41;GC&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x591A;&#x6B21;&#x5BF9;NN&#x8FDB;&#x884C;&#x7684;&#x7EBF;&#x7A0B;&#x8FD0;&#x884C;&#x6808;&#x5206;&#x6790;&#xFF0C;&#x53D1;&#x73B0;NN Server &#x4E2D;&#x7684;rpc handler&#xFF0C;&#x4E5F;&#x5373;NN&#x5904;&#x7406;rpc&#x8BF7;&#x6C42;&#x7684;&#x7EBF;&#x7A0B;&#x90FD;&#x5728;&#x7B49;&#x5F85;&#x83B7;&#x53D6;FSNameSystem#writeLock(),<br>&#x8FD9;&#x6B21;&#x67D0;&#x4E00;&#x6B21;&#x62BD;&#x6837;&#x5BFC;&#x51FA;10&#x6B21;NN&#x8FDB;&#x884C;&#x8FD0;&#x884C;&#x6808;&#x540E;&#x7684;&#x5206;&#x6790;&#x7ED3;&#x679C;&#xFF1A;<br>NameNode rpc handler&#x7684;&#x6570;&#x91CF;&#xFF1A;<br><img src="/namenode-blockreport-storm/rpc-handler.png" alt="rpc-handler.png" title=""></p>
<p>rpc handler&#x4E2D;&#x5904;&#x7406;blockReport&#x7684;&#x6570;&#x91CF;:<br><img src="/namenode-blockreport-storm/blockreport.png" alt="blockreport.png" title=""></p>
<p>rpc handler&#x4E2D;&#x5904;&#x7406;IBR&#x7684;&#x6570;&#x91CF;&#xFF1A;<br><img src="/namenode-blockreport-storm/ibr.png" alt="ibr.png" title=""></p>
<p> &#x901A;&#x8FC7;&#x6BD4;&#x5BF9;&#x53D1;&#x73B0;&#xFF0C;NN&#x5728;&#x67D0;&#x4E00;&#x65F6;&#x523B;&#x5904;&#x7406;blockReport&#x7684;server handler&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x800C;&#x8FD9;&#x4E9B;&#x5904;&#x7406;&#x9700;&#x8981;&#x83B7;&#x5F97;FSNameSystem&#x7684;&#x4E00;&#x4E2A;&#x9501;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x610F;&#x5473;&#x7740;&#x5FC5;&#x987B;&#x8981;&#x7B49;&#x4E00;&#x4E2A;&#x83B7;&#x53D6;&#x8FD9;&#x4E2A;&#x9501;&#x8D44;&#x6E90;&#x7684;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x5B8C;&#x91CA;&#x653E;&#x8FD9;&#x4E2A;&#x9501;&#x65F6;&#xFF0C;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x624D;&#x53EF;&#x80FD;&#x6709;&#x673A;&#x4F1A;&#x83B7;&#x5F97;&#x6267;&#x884C;&#x7684;&#x673A;&#x4F1A;&#xFF0C;&#x4ECE;&#x8FD9;&#x4E2A;&#x610F;&#x4E49;&#x4E0A;&#x6765;&#x8BF4;&#xFF0C;NN server&#x5E76;&#x6CA1;&#x6709;&#x53D1;&#x6325;&#x5E76;&#x884C;&#x5904;&#x7406;&#x7684;&#x4F18;&#x52BF;&#xFF0C;&#x800C;&#x662F;&#x5927;&#x90E8;&#x5206;&#x7EBF;&#x7A0B;&#x88AB;&#x7B49;&#x5F85;&#xFF0C;&#x800C;NN server&#x5E76;&#x6CA1;&#x6709;&#x5269;&#x4F59;&#x7684;server handler&#x6765;&#x5904;&#x7406;&#x65B0;&#x7684;rpc request&#x3002;<br> &#x901A;&#x8FC7;NN&#x7AEF;&#x65E5;&#x5FD7;&#xFF0C;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x4E00;&#x4E2A;DataNode&#x7684; blockReport&#x7684;&#x5904;&#x7406;&#x65F6;&#x95F4;&#x5927;&#x81F4;&#x5728;12<em>50ms~12</em>60ms&#xFF08;&#x5E73;&#x5747;&#x65F6;&#x95F4;&#x4E3A;59ms&#xFF09;&#x4E4B;&#x95F4;&#xFF0C;(12&#x662F;DataNode storage&#x7684;&#x4E2A;&#x6570;)&#xFF0C;&#x5373;0.6s~0.7s, &#x4E0D;&#x8003;&#x8651;&#x5176;&#x4ED6;&#x56E0;&#x7D20;&#xFF0C;&#x91CD;&#x542F;NN&#x540E;&#x5168;&#x90E8;&#x5904;&#x7406;&#x5B8C;DataNode&#x7684;blockReport&#x7684;&#x65F6;&#x95F4;&#x5927;&#x81F4;&#x5728;355(DataNode)*(0.6~0.7s)&#xFF0C;&#x4E5F;&#x5C31;&#x662F;213~248.5s&#x4E4B;&#x95F4;&#x3002;</p>
<p>&#x7ED3;&#x5408;&#x6808;&#x7684;&#x8FD0;&#x884C;&#x60C5;&#x51B5;&#x8003;&#x8651;&#xFF0C;&#x6392;&#x9664;&#x5176;&#x4ED6;&#x56E0;&#x7D20;&#xFF0C;&#x4EC5;&#x4EC5;&#x8003;&#x8651;processReport&#x7684;&#x6267;&#x884C;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5728;&#x67D0;&#x4E00;&#x65F6;&#x523B;&#xFF0C;&#x4F8B;&#x5982;&#x5047;&#x5B9A;Server&#x6709;146&#x4E2A;&#x6B63;&#x5728;&#x5904;&#x7406;processReport&#x7684;&#x60C5;&#x51B5;&#xFF0C;<br>&#x6700;&#x540E;&#x4E00;&#x4E2A;DataNode&#x7684;blockReport&#x88AB;&#x5904;&#x7406;&#x7684;&#x65F6;&#x95F4;&#x6700;&#x65E9;&#x51FA;&#x73B0;&#x5728;&#xFF1A;<br>(146-1)*0.6 = 87.6s &#x4E4B;&#x540E;&#x3002;<br>&#x6211;&#x4EEC;&#x4ECD;&#x4EE5;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x88AB;&#x5904;&#x7406;&#x7684;blockReport&#x4E3A;&#x4F8B;&#xFF0C;&#x8003;&#x8651;&#x8FD9;&#x4E2A;DataNode&#x5728;&#x53D1;&#x9001;blockReport 87.6s&#x4E4B;&#x540E;&#x7684;&#x884C;&#x4E3A;&#x662F;&#x600E;&#x6837;&#x7684;&#x3002;<br>&#x4ECE;DataNode&#x7684;&#x89D2;&#x5EA6;&#x6765;&#x770B;&#xFF0C;&#x5F53;&#x901A;&#x8FC7;TCP/IP&#x53D1;&#x9001;&#x4E00;&#x4E2A;rpc&#x8BF7;&#x6C42;&#x4E4B;&#x540E;&#xFF0C;&#x7B49;&#x5F85;&#x4E00;&#x5B9A;&#x65F6;&#x95F4;&#x4EE5;&#x83B7;&#x5F97;&#x8BF7;&#x6C42;&#x7684;&#x53CD;&#x9988;&#x7ED3;&#x679C;&#xFF0C;&#x82E5;&#x8D85;&#x8FC7;&#x8FD9;&#x4E2A;&#x65F6;&#x95F4;&#x4ECD;&#x7136;&#x65E0;&#x7ED3;&#x679C;&#x8FD4;&#x56DE;&#xFF0C;&#x90A3;&#x4E48;&#x5C06;&#x629B;&#x51FA;&#x4E00;&#x4E2A;&#x5F02;&#x5E38;&#xFF0C;&#x65F6;&#x95F4;&#x53EF;&#x4EE5;&#x5728;Client.java&#x7C7B;&#x4E2D;getTimeout&#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * The time after which a RPC will timeout.</div><div class="line">   * If ping is not enabled (via ipc.client.ping), then the timeout value is the </div><div class="line">   * same as the pingInterval.</div><div class="line">   * If ping is enabled, then there is no timeout value.</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> conf Configuration</div><div class="line">   * <span class="doctag">@return</span> the timeout period in milliseconds. -1 if no timeout value is set</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getTimeout</span><span class="params">(Configuration conf)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (!conf.getBoolean(CommonConfigurationKeys.IPC_CLIENT_PING_KEY, <span class="keyword">true</span>)) {</div><div class="line">      <span class="keyword">return</span> getPingInterval(conf);</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">  }</div></pre></td></tr></table></figure>
<p>&#x7ED3;&#x5408;DataNode&#x4E0A;&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;rpc socket&#x8BF7;&#x6C42;&#x7684;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x662F;60s&#xFF0C;</p>
<p>&#x4E5F;&#x5C31;&#x662F;NN 87.6s&#x4E4B;&#x540E;&#x5904;&#x7406;&#x8BE5;DataNode&#x7684;blockReport&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x5C06;&#x8FD9;&#x4E2A;blockReport&#x5B9A;&#x4E49;&#x4E3A;&#x8BF7;&#x6C42;A&#xFF0C;DataNode&#x8BA4;&#x4E3A;&#x8BE5;&#x8BF7;&#x6C42;&#x5DF2;&#x7ECF;timeout&#xFF0C;&#x5229;&#x7528;&#x672C;&#x8EAB;&#x7684;&#x91CD;&#x8BD5;&#x673A;&#x5236;&#x6216;&#x8005;&#x901A;&#x8FC7;&#x5FC3;&#x8DF3;&#x7EBF;&#x7A0B;&#x7EE7;&#x7EED;&#x5411;NN&#x53D1;&#x9001;&#x4E00;&#x4E2A;blockReport&#xFF0C;&#x6211;&#x4EEC;&#x8BBE;&#x4E3A;&#x8BF7;&#x6C42;B&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x8BF7;&#x6C42;A&#x548C;&#x8BF7;&#x6C42;B&#x90FD;&#x662F;&#x6765;&#x6E90;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;DataNode blockReport&#x7684;&#x8BF7;&#x6C42;&#x3002;<br>&#x5F53;&#x8BF7;&#x6C42;A&#x7ECF;&#x8FC7;60s&#x540E;&#xFF0C;&#x6B64;&#x65F6;DataNode&#x8BA4;&#x4E3A;&#x8BF7;&#x6C42;A&#x5DF2;&#x7ECF;&#x5931;&#x6548;&#xFF0C;&#x4F1A;&#x5728;&#x5C06;&#x6765;&#x7684;&#x67D0;&#x4E2A;&#x65F6;&#x523B;&#x7EE7;&#x7EED;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;B&#xFF0C;&#x6B64;&#x65F6;&#x8BF7;&#x6C42;A&#x5DF2;&#x7ECF;&#x52A0;&#x5165;&#x5230;NN server handler&#x5904;&#x7406;&#x7EBF;&#x7A0B;&#x4E2D;&#xFF0C;&#x662F;&#x4E0D;&#x4F1A;&#x611F;&#x77E5;DataNode&#x5DF2;&#x7ECF;&#x5C06;&#x8BE5;&#x8BF7;&#x6C42;&#x6807;&#x8BB0;&#x4E3A;&#x5931;&#x6548;&#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF7;&#x6C42;A&#x5728;87.6s&#x4E4B;&#x540E;&#x4F1A;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#xFF0C;&#x4E5F;&#x5373;&#x610F;&#x5473;&#x7740;&#xFF0C;&#x540C;&#x4E00;&#x4E2A;DataNode&#x7684;blockReport&#x53EF;&#x80FD;&#x4F1A;&#x88AB;&#x6267;&#x884C;&#x591A;&#x6B21;&#xFF0C;&#x9020;&#x6210;blockReport storm&#x73B0;&#x8C61;&#x3002;<br>&#x76F8;&#x5E94;&#x9A8C;&#x8BC1;&#x65E5;&#x5FD7;&#xFF1A;</p>
<pre>
2015-08-27 21:07:50,058 INFO org.apache.hadoop.ipc.Server: IPC Server handler 3 on 8020 caught an exception
java.nio.channels.ClosedChannelException
        at sun.nio.ch.SocketChannelImpl.ensureWriteOpen(SocketChannelImpl.java:265)
       at sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:474)
        at org.apache.hadoop.ipc.Server.channelWrite(Server.java:2538)
        at org.apache.hadoop.ipc.Server.access$1900(Server.java:130)
        at org.apache.hadoop.ipc.Server$Responder.processResponse(Server.java:965)
        at org.apache.hadoop.ipc.Server$Responder.doRespond(Server.java:1030)
        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:2068)
</pre>

<p>NN Server&#x5199;&#x56DE;&#x7ED3;&#x679C;&#x65F6;&#xFF0C;SocketChannel&#x5DF2;&#x7ECF;&#x5173;&#x95ED;&#x3002;&#x5BF9;&#x5E94;&#x7684;&#x65E5;&#x5FD7;&#xFF1A;</p>
<pre>
2015-08-27 21:07:50,114 WARN org.apache.hadoop.ipc.Server: IPC Server handler 87 on 8020, call org.apache.hadoop.hdfs.server.protocol.DatanodeProtocol.blockReport from 10.31.75.88:47215 Call#7732155 Retry#0: output error
2015-08-27 21:07:50,115 INFO org.apache.hadoop.ipc.Server: IPC Server handler 87 on 8020: skipped org.apache.hadoop.hdfs.server.protocol.DatanodeProtocol.blockReport from 10.31.75.158:35223 Call#4328162 Retry#0
&#x2026;
015-08-27 21:50:11,269 WARN org.apache.hadoop.ipc.Server: IPC Server handler 67 on 8020, call org.apache.hadoop.hdfs.server.protocol.DatanodeProtocol.blockReport from 10.31.74.204:51987 Call#7889446 Retry#0: output error
</pre>

<p>hadoop Server&#x7ED3;&#x6784;(&#x8FD9;&#x662F;&#x4E00;&#x5F20;&#x6765;&#x81EA;javaEye&#x7684;&#x4E00;&#x7BC7;&#x535A;&#x5BA2;&#x603B;&#x7ED3;&#x7684;&#x56FE;&#x7247;&#xFF0C;&#x611F;&#x8C22;&#x539F;&#x4F5C;&#x8005;&#xFF09;:<br><img src="/namenode-blockreport-storm/server.png" alt="server.png" title=""></p>
<p>NN &#x5927;&#x91CF;rpc server handler&#x7531;&#x4E8E;&#x957F;&#x671F;&#x88AB;&#x5360;&#x7528;&#xFF0C;&#x8FD9;&#x5F15;&#x53D1;&#x4E00;&#x7CFB;&#x5217;&#x540E;&#x679C;&#xFF0C;&#x5BFC;&#x81F4;&#x5728;server&#x7B49;&#x5F85;&#x88AB;&#x5904;&#x7406;&#x7684;&#x8BF7;&#x6C42;(&#x8FD9;&#x4E9B;&#x8BF7;&#x6C42;&#x88AB;&#x7F13;&#x5B58;&#x5728;Server&#x7684;&#x961F;&#x5217;&#x4E2D;,&#x5373;&#x4E0A;&#x56FE;&#x7684;call queue)&#x957F;&#x65F6;&#x95F4;&#x65E0;&#x6CD5;&#x5F97;&#x5230;&#x54CD;&#x5E94;&#xFF0C;&#x5F53;&#x7B49;&#x5F85;&#x7684;&#x65F6;&#x95F4;&#x8D85;&#x8FC7;60s&#x540E;&#xFF0C;&#x5F15;&#x8D77;&#x53D1;&#x9001;&#x8BF7;&#x6C42;&#x7684;DataNode&#x8BA4;&#x4E3A;&#x8BF7;&#x6C42;&#x5931;&#x6548;&#xFF0C;&#x5173;&#x95ED;socket&#xFF0C;&#x8FD9;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;NN Server&#x7AEF;&#x7684;&#x65E5;&#x5FD7;&#x53EF;&#x4EE5;&#x9A8C;&#x8BC1;&#xFF1A;</p>
<pre>
2015-08-27 21:45:17,528 INFO org.apache.hadoop.ipc.Server: IPC Server handler 136 on 8020: skipped org.apache.hadoop.hdfs.server.protocol.DatanodeProtocol.sendHeartbeat from 10.31.x.x:59155 Call#7904083 Retry#0
2015-08-27 21:45:17,528 INFO org.apache.hadoop.ipc.Server: IPC Server handler 136 on 8020: skipped org.apache.hadoop.hdfs.server.protocol.DatanodeProtocol.sendHeartbeat from 10.31.x.x:40573 Call#8040659 Retry#0
2015-08-27 21:45:17,528 INFO org.apache.hadoop.ipc.Server: IPC Server handler 136 on 8020: skipped org.apache.hadoop.hdfs.server.protocol.DatanodeProtocol.sendHeartbeat from 10.31.x.x:47194 Call#7929722 Retry#0
2015-08-27 21:45:17,528 INFO org.apache.hadoop.ipc.Server: IPC Server handler 136 on 8020: skipped org.apache.hadoop.hdfs.server.protocol.DatanodeProtocol.sendHeartbeat from 10.31.x.x:36714 Call#7835318 Retry#0
</pre>

<p>&#x5BF9;&#x5E94;&#x4E8E;Server&#x7AEF;&#x7684;&#xFF1A;<br><img src="/namenode-blockreport-storm/outputerror.png" alt="outputerror.png" title=""></p>
<p>&#x800C;NN&#x7531;&#x4E8E;&#x65E0;&#x6CD5;&#x53CA;&#x65F6;&#x5904;&#x7406;DataNode&#x7684;&#x5FC3;&#x8DF3;&#xFF0C;&#x5BFC;&#x81F4;NN&#x8BA4;&#x4E3A;DataNode&#x662F;stale&#x7684;&#xFF0C;&#x800C;NN&#x5904;&#x7406;&#x5B8C;&#x6210;&#x8BE5;DataNode&#x7684;blockReport&#x540E;&#xFF0C;&#x53C8;&#x5C06;&#x8BE5;DataNode&#x6807;&#x8BB0;&#x4E3A;&#x975E;stale&#x7684;&#xFF0C;&#x7136;&#x800C;&#x4ECE;&#x603B;&#x4F53;&#x4E0A;&#x770B;&#xFF0C;&#x7531;&#x4E8E;NN server&#x5904;&#x7406;&#x80FD;&#x529B;&#x6709;&#x9650;&#xFF0C;&#x8FD9;&#x4E00;&#x4E2A;&#x6307;&#x6807;&#x4F1A;&#x968F;&#x7740;&#x65F6;&#x95F4;&#x800C;&#x589E;&#x52A0;&#xFF1A;</p>
<img src="/namenode-blockreport-storm/metrics.png" alt="metrics.png" title="">
<p>&#x7EFC;&#x4E0A;&#x6240;&#x8FF0;&#xFF0C;&#x5BFC;&#x81F4;NN server&#x7E41;&#x5FD9;&#x7684;&#x539F;&#x56E0;&#x662F;NN server handler&#x90FD;&#x5728;&#x5904;&#x7406;&#x5927;&#x91CF;&#x7684;DataNode &#x7684;blockReport&#x8BF7;&#x6C42;&#xFF0C;&#x800C;&#x5927;&#x591A;&#x6570;handler&#x7531;&#x4E8E;FSNameSystem&#x9501;&#x7684;&#x539F;&#x56E0;&#x4EE5;&#x53CA;&#x5BA2;&#x6237;&#x7AEF;&#x8BF7;&#x6C42;&#x8D85;&#x65F6;&#x7684;&#x539F;&#x56E0;&#x9677;&#x5165;&#x6BEB;&#x65E0;&#x610F;&#x4E49;&#x7B49;&#x5F85;&#x72B6;&#x6001;&#x4E2D;&#xFF0C;&#x4F7F;&#x5F97;NN server&#x65E0;&#x6CD5;&#x817E;&#x51FA;&#x624B;&#x6765;&#x5904;&#x7406;&#x65B0;request&#x3002;&#x8BA4;&#x4E3A;&#xFF0C;&#x6839;&#x672C;&#x7684;&#x89E3;&#x51B3;&#x529E;&#x6CD5;&#x662F;&#x91CD;&#x542F;DataNode&#xFF0C;&#x5C06;dfs.blockreport.initialDelay&#x7684;&#x503C;&#x8BBE;&#x4E3A;251s(355<em>12</em>59ms)&#x4EE5;&#x4E0A;, &#x540C;&#x65F6;&#x517C;&#x987E;&#x672A;&#x6765;&#x53EF;&#x80FD;&#x53D1;&#x751F;&#x7684;&#x96C6;&#x7FA4;&#x62D3;&#x5C55;&#x9700;&#x6C42;&#x3002;</p>
<h4 id="NameNode&#x5185;&#x5B58;&#x5F00;&#x9500;&#x5206;&#x6790;"><a href="#NameNode&#x5185;&#x5B58;&#x5F00;&#x9500;&#x5206;&#x6790;" class="headerlink" title="NameNode&#x5185;&#x5B58;&#x5F00;&#x9500;&#x5206;&#x6790;"></a>NameNode&#x5185;&#x5B58;&#x5F00;&#x9500;&#x5206;&#x6790;</h4><p> DataNode&#x5411;NN&#x6C47;&#x62A5;&#x4E00;&#x6B21;blockReport&#xFF0C;&#x5E73;&#x5747;&#x6BCF;&#x4E00;&#x4E2A;storage&#x5305;&#x542B;&#x6709;63000&#x4E2A;&#x5757;&#xFF0C;&#x6BCF;&#x4E2A;&#x5757;&#x81F3;&#x5C11;&#x5360;3<em>8 =24&#x4E2A;&#x5B57;&#x8282;(3&#x4E2A;long&#x5B57;&#x8282;&#x8868;&#x793A;&#x4E00;&#x4E2A;&#x5757;)&#xFF0C;&#x6BCF;&#x6B21;blockReport&#x5305;&#x542B;&#x6709;12&#x4E2A;storage&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x6BCF;&#x4E00;&#x6B21;&#x5411;blockReport&#x6C47;&#x62A5;&#x65F6;&#xFF0C;&#x81F3;&#x5C11;&#x8981;&#x7528;&#xFF1A;12</em>24<em>63k =18M&#xFF0C;355&#x53F0;&#x673A;&#x5668;&#x5168;&#x91CF;&#x6C47;&#x62A5;&#x4E00;&#x6B21;&#x81F3;&#x5C11;&#x5360;&#x7528;&#xFF1A;18M</em>355=6.4g&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x81F3;&#x5C11;&#x8981;&#x5360;&#x7528;6.4g&#x7684;&#x5185;&#x5B58;&#x3002;<br> &#x8FD9;&#x662F;&#x4E00;&#x6B21;&#x62BD;&#x6837;jmx NN 8020&#x7AEF;&#x53E3;&#x63A5;&#x6536;&#x5230;&#x7684;&#x6570;&#x636E;&#x7EDF;&#x8BA1;&#xFF0C;&#x6B64;&#x6B21;jmx&#x83B7;&#x53D6;&#x7EA6;&#x5728;NN&#x542F;&#x52A8;&#x540E;2&#x5C0F;&#x65F6;&#x4E4B;&#x5185;.<br> <img src="/namenode-blockreport-storm/8020.png" alt="8020.png" title=""></p>
<p>rpc 8020&#x7AEF;&#x53E3;&#x63A5;&#x6536;&#x5230;&#x7684;&#x6570;&#x636E;&#x8FBE;&#x5230;28g&#xFF0C;<br> <img src="/namenode-blockreport-storm/cnt.png" alt="cnt.png" title=""></p>
<p> &#x5728; &#x201C;modelerType&#x201D; : &#x201C;RpcDetailedActivityForPort8020&#x201D; &#x6307;&#x6807;&#x5185;&#xFF0C; BlockReportNumOps&#x8FBE;&#x5230;2286&#x6B21;&#xFF0C;(&#x6B63;&#x5E38;&#x60C5;&#x51B5;&#x7EA6;&#x4E3A;355&#x6B21;&#x5DE6;&#x53F3;(2&#x5C0F;&#x65F6;&#x4E4B;&#x5185;))&#x3002;<br>&#x5927;&#x91CF;&#x7684;BlockReport&#xFF0C;&#x6309;&#x7167;&#x4E00;&#x6B21;BlockReport&#x5E73;&#x5747;&#x5360;&#x7528;18M&#x8BA1;&#x7B97;&#xFF0C;&#x7EA6;&#x9700;&#x8981;&#x5185;&#x5B58;2286<em>18M, &#x7EA6;&#x4E3A;41g&#x3002;<br> NameNode&#x4FDD;&#x5B58;{file blocksList} &#x4EE5;&#x53CA;{block dataNode}&#x7684;&#x4FE1;&#x606F;&#xFF0C;<br> &#x5176;&#x4E2D; {block &#x2013;&gt;dataNode}(blocksMap), &#x4F7F;&#x7528;3</em>16 byte(3&#x4E2A;Object)&#x5F15;&#x7528;&#x8868;&#x793A;&#x4E00;&#x4E2A;block replica&#xFF0C;&#x76EE;&#x524D;&#x96C6;&#x7FA4;&#x4E0A;&#x7EA6;&#x6709;&#xFF1A;<br>268739622&#x4E2A;&#x5757;&#xFF0C;&#x5360;&#x7528;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x7EA6;&#x4E3A;&#xFF1A;268739622<em>48byte =12899501856, &#x7EA6;&#x4E3A;13g&#x3002;<br>&#x4E00;&#x4E2A;Block&#x81F3;&#x5C11;&#x9700;&#x8981;24&#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x56E0;&#x6B64;&#x8FD9;&#x90E8;&#x5206;&#x603B;&#x5171;&#x9700;&#x8981; 13+13/(2</em>3) = 15g (3&#x4E3A;block replica&#x7684;&#x6570;&#x91CF;)&#x3002;</p>
<p>&#x53E6;&#x5916;{file blocksList} &#x8FD9;&#x4E00;&#x90E8;&#x5206;&#x4FE1;&#x606F;&#xFF0C;&#x5728;NameNode&#x542F;&#x52A8;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;NameNode&#x9996;&#x5148;&#x4F1A;&#x52A0;&#x8F7D;FSImage, &#x8FD9;&#x90E8;&#x5206;&#x4F1A;&#x5360;&#x7528;30g&#x3002;<br>&#x6309;&#x7167;&#x8FD9;&#x6837;&#x7684;&#x8BA1;&#x7B97;&#xFF0C;&#x5185;&#x5B58;&#x5F00;&#x9500;&#x603B;&#x5171;&#x7EA6;&#x8981;&#xFF1A;28g+41g+15g+30g = 114g&#x3002;</p>
<p>&#x4ECE;rpc 8020 &#x63A5;&#x6536;&#x5230;byte&#x6570;&#x636E;&#xFF0C;&#x4ECE;byte&#x6570;&#x636E;&#x4E2D;&#x89E3;&#x6790;&#x51FA;long<a href="blocks"></a>&#xFF0C;&#x56E0;&#x6B64;&#x5185;&#x5B58;&#x6D88;&#x8017;&#x4F1A;&#x53E0;&#x52A0;&#xFF0C;&#x4E5F;&#x5373;28g+41g&#x3002;</p>
<h3 id="&#x89E3;&#x51B3;&#x65B9;&#x6848;"><a href="#&#x89E3;&#x51B3;&#x65B9;&#x6848;" class="headerlink" title="&#x89E3;&#x51B3;&#x65B9;&#x6848;"></a>&#x89E3;&#x51B3;&#x65B9;&#x6848;</h3><p><li>&#x9488;&#x5BF9;NN&#x542F;&#x52A8;&#x6162;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x53C2;&#x7167;&#x4E86;HDFS-7980&#x7684;&#x5206;&#x6790;&#x5B9E;&#x73B0;&#xFF0C;&#x4FEE;&#x6B63;NN&#x91CD;&#x542F;&#x540E;&#x5904;&#x7406;BlockReport&#x7684;&#x76F8;&#x5173;&#x903B;&#x8F91;&#xFF0C;&#x52A0;&#x901F;NameNode&#x6062;&#x590D;&#x8FC7;&#x7A0B;&#x3002;</li></p>
<p><li>&#x9488;&#x5BF9;NN&#x542F;&#x52A8;&#x540E;FSNameSystem#writeLock()&#x9891;&#x7E41;&#x4F7F;&#x7528;&#x7B49;&#x5F85;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x53C2;&#x7167;HDFS-7097&#x7684;&#x5206;&#x6790;&#x5B9E;&#x73B0;&#xFF0C;&#x5B9E;&#x73B0;standby checkpoint&#x9501;&#x548C;FSNameSystem&#x7684;&#x9501;&#x5206;&#x79BB;&#xFF0C;&#x51CF;&#x5C11;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#x9501;&#x7B49;&#x5F85;&#x62E5;&#x5835;&#x3002;</li></p>
<p><li>&#x5982;&#x679C;&#x53EF;&#x4EE5;&#x91CD;&#x542F;datanode&#xFF0C;&#x4EE5;&#x4E0B;&#x53C2;&#x6570;&#x53EF;&#x4EE5;&#x8003;&#x8651;&#x4F18;&#x5316;<br>dfs.blockreport.initialDelay: &#x5EFA;&#x8BAE;&#x8BBE;&#x4E3A;251&#x4EE5;&#x4E0A;&#xFF0C;&#x517C;&#x987E;&#x672A;&#x6765;&#x53EF;&#x80FD;&#x53D1;&#x751F;&#x7684;&#x96C6;&#x7FA4;&#x62D3;&#x5C55;&#x6027;&#x9700;&#x6C42;&#x3002;<br>ipc.ping.interval:&#x9ED8;&#x8BA4;&#x662F;60s&#xFF0C;&#x53EF;&#x4EE5;&#x8003;&#x8651;&#x8BBE;&#x7F6E;&#x5927;&#x4E00;&#x70B9;</li></p>
<p><li><strong>&#x5982;&#x4E0D;&#x80FD;&#x6682;&#x505C;DataNode&#xFF0C;&#x53EF;&#x4EE5;&#x8003;&#x8651;NameNode&#x7684;rpc server handler&#x7EBF;&#x7A0B;&#x6570;&#x51CF;&#x5C11;&#x81F3;100&#xFF08;60s/0.6=100&#xFF09;&#xFF0C;&#x6216;&#x8005;&#x66F4;&#x4F4E;&#x3002;</strong></li></p>
<p><li>&#x9488;&#x5BF9;&#x65E5;&#x5FD7;&#x95EE;&#x9898;&#xFF0C;&#x5C06;BlockReport&#x8F93;&#x51FA;&#x65E5;&#x5FD7;&#x7684;&#x8FC7;&#x7A0B;&#x79FB;&#x5230;&#x9501;&#x5916;&#x53BB;&#x8F93;&#x51FA;&#x3002;&#x540C;&#x65F6;&#x4E3A;&#x4E86;&#x51CF;&#x5C11;&#x542F;&#x52A8;&#x8FC7;&#x7A0B;&#x7684;&#x8F93;&#x51FA;&#x91CF;&#xFF0C;&#x901A;&#x8FC7;&#x63A5;&#x53E3;&#x6539;&#x53D8;&#x65E5;&#x5FD7;&#x53E5;&#x67C4;(blockStateChangeLog)&#x7684;&#x8F93;&#x51FA;&#x7EA7;&#x522B;&#x3002;<br>&#x4F18;&#x5316;standby NN &#x5904;&#x7406;BlockReport&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x5177;&#x4F53;&#x53C2;&#x8003;&#xFF1A;<br>                   <a href="https://issues.apache.org/jira/browse/HDFS-6424" target="_blank" rel="external">https://issues.apache.org/jira/browse/HDFS-6424</a></li></p>
<h3 id="&#x5176;&#x4ED6;"><a href="#&#x5176;&#x4ED6;" class="headerlink" title="&#x5176;&#x4ED6;"></a>&#x5176;&#x4ED6;</h3><p>  <a href="http://stackoverflow.com/questions/32251192/restarted-namenode-suffer-from-block-report-storm/34288804#34288804" target="_blank" rel="external">http://stackoverflow.com/questions/32251192/restarted-namenode-suffer-from-block-report-storm/34288804#34288804</a>                   </p>
</div></article><div class="tags"></div><div class="paginator"><a href="../yarn-logaggregator/" class="prev"><i class="iconfont icon-left"></i><span> 上一页</span></a><a href="../streaming-pipeline/" class="next"><span>下一页</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div id="disqus_thread"></div></section><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://dengzhhu653.github.io/namenode-blockreport-storm/';
    this.page.identifier = 'namenode-blockreport-storm/';
    this.page.title = 'StandBy NameNode启动失败原因分析';
};
(function() {
var d = document, s = d.createElement('script');

s.src = '//dengzhhu653.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();</script></section><footer><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2018<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Zhihua Deng</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>